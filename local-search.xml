<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Hexo Update From 3.5 to 5.4</title>
    <link href="/2021/04/24/Hexo%20Update%20From%203.5%20to%205.4/"/>
    <url>/2021/04/24/Hexo%20Update%20From%203.5%20to%205.4/</url>
    
    <content type="html"><![CDATA[<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><ul><li>NexT 主题由之前的 5.1.x 更新至 7.x.</li><li>主仓库从 <a href="https://github.com/iissnan/hexo-theme-next">iissnan</a> 迁移至 <a href="https://github.com/theme-next">theme-next</a> 组织下.</li><li>从 v6.0.3 版本起，zh-Hans 改名为 zh-CN：<a href="https://github.com/theme-next/hexo-theme-next/releases/tag/v6.0.3">https://github.com/theme-next/hexo-theme-next/releases/tag/v6.0.3</a><br>升级到 v6.0.3 及以后版本的用户，需要显式修改 Hexo 主配置文件 _config.yml 里的 language 配置，否则语言显示不正确。</li></ul><h2 id="update-method"><a href="#update-method" class="headerlink" title="update method"></a>update method</h2><p>Hexo Version Update can through the npm tool to achieve</p><h3 id="update-Hexo-Version"><a href="#update-Hexo-Version" class="headerlink" title="update Hexo Version"></a>update Hexo Version</h3><html><font color=#A52A2A size=3 >Notice: update under the hexo init 仓库下</font></html>.<h4 id="1、Check-the-New-Hexo-Version"><a href="#1、Check-the-New-Hexo-Version" class="headerlink" title="1、Check the New Hexo Version"></a>1、Check the New Hexo Version</h4><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">➜  init hexo version<br><span class="hljs-symbol">hexo:</span> <span class="hljs-number">3.5</span><span class="hljs-number">.0</span><br>hexo-<span class="hljs-keyword">cli</span>: <span class="hljs-number">4.2</span><span class="hljs-number">.0</span><br><span class="hljs-symbol">os:</span> Linux <span class="hljs-number">4.18</span><span class="hljs-number">.16</span><span class="hljs-number">-1.</span>el7.elrepo.x86_64 linux x64<br><span class="hljs-symbol">node:</span> <span class="hljs-number">15.5</span><span class="hljs-number">.1</span><br><span class="hljs-symbol">v8:</span> <span class="hljs-number">8.6</span><span class="hljs-number">.395</span><span class="hljs-number">.17</span>-node<span class="hljs-number">.23</span><br><span class="hljs-symbol">uv:</span> <span class="hljs-number">1.40</span><span class="hljs-number">.0</span><br><span class="hljs-symbol">zlib:</span> <span class="hljs-number">1.2</span><span class="hljs-number">.11</span><br><span class="hljs-symbol">brotli:</span> <span class="hljs-number">1.0</span><span class="hljs-number">.9</span><br><span class="hljs-symbol">ares:</span> <span class="hljs-number">1.17</span><span class="hljs-number">.1</span><br><span class="hljs-symbol">modules:</span> <span class="hljs-number">88</span><br><span class="hljs-symbol">nghttp2:</span> <span class="hljs-number">1.41</span><span class="hljs-number">.0</span><br><span class="hljs-symbol">napi:</span> <span class="hljs-number">7</span><br><span class="hljs-symbol">llhttp:</span> <span class="hljs-number">2.1</span><span class="hljs-number">.3</span><br><span class="hljs-symbol">openssl:</span> <span class="hljs-number">1.1</span><span class="hljs-number">.1</span>i<br><span class="hljs-symbol">cldr:</span> <span class="hljs-number">38.0</span><br><span class="hljs-symbol">icu:</span> <span class="hljs-number">68.1</span><br><span class="hljs-symbol">tz:</span> <span class="hljs-number">2020</span>b<br><span class="hljs-symbol">unicode:</span> <span class="hljs-number">13.0</span><br></code></pre></td></tr></table></figure><h4 id="2、Global-Update-hexo-cli"><a href="#2、Global-Update-hexo-cli" class="headerlink" title="2、Global Update hexo-cli"></a>2、Global Update hexo-cli</h4><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs tap">➜  init npm install hexo-cli -g<br><br>changed<span class="hljs-number"> 22 </span>packages, and audited<span class="hljs-number"> 59 </span>packages in 5s<br><br>11 packages are looking for funding<br>  run `npm fund` for details<br><br>found<span class="hljs-number"> 0 </span>vulnerabilities<br></code></pre></td></tr></table></figure><h4 id="3、检查系统中的插件是否有升级的，可以看到自己前面都安装了那些插件"><a href="#3、检查系统中的插件是否有升级的，可以看到自己前面都安装了那些插件" class="headerlink" title="3、检查系统中的插件是否有升级的，可以看到自己前面都安装了那些插件"></a>3、检查系统中的插件是否有升级的，可以看到自己前面都安装了那些插件</h4><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript">➜  init <span class="hljs-built_in">npm</span> install -g <span class="hljs-built_in">npm</span>-check<br>➜  init <span class="hljs-built_in">npm</span>-check               <br></code></pre></td></tr></table></figure><h4 id="4、升级系统中的插件"><a href="#4、升级系统中的插件" class="headerlink" title="4、升级系统中的插件"></a>4、升级系统中的插件</h4><figure class="highlight parser3"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs parser3"><span class="xml">➜  init npm install -g npm-upgrade</span><br><span class="xml">npm WARN deprecated uuid@</span><span class="hljs-number">3.4</span><span class="hljs-number">.0</span><span class="xml">: Please upgrade  to version </span><span class="hljs-number">7</span><span class="xml"> or higher.  Older versions may use Math.random() in certain circumstances, which is known to be problematic.  See https://v8.dev/blog/math-random for details.</span><br><span class="xml">npm WARN deprecated har-validator@</span><span class="hljs-number">5.1</span><span class="hljs-number">.5</span><span class="xml">: this library is no longer supported</span><br><span class="xml">npm WARN deprecated request@</span><span class="hljs-number">2.88</span><span class="hljs-number">.2</span><span class="xml">: request has been deprecated, see https://github.com/request/request/issues/</span><span class="hljs-number">3142</span><span class="xml"></span><br><span class="xml"></span><br><span class="xml">added </span><span class="hljs-number">369</span><span class="xml"> packages, and audited </span><span class="hljs-number">370</span><span class="xml"> packages in </span><span class="hljs-number">1</span><span class="xml">m</span><br><span class="xml"></span><br><span class="xml"></span><span class="hljs-number">42</span><span class="xml"> packages are looking for funding</span><br><span class="xml">  run `npm fund` for details</span><br><span class="xml"></span><br><span class="xml">found </span><span class="hljs-number">0</span><span class="xml"> vulnerabilities</span><br><span class="xml">➜  init </span><br><span class="xml">➜  init npm-upgrade               </span><br><span class="xml">Checking for outdated dependencies for &quot;/data/martin/martinsev/wwwroot/init/package.json&quot;...</span><br><span class="xml">[====================] </span><span class="hljs-number">15</span><span class="xml">/</span><span class="hljs-number">15</span><span class="xml"> </span><span class="hljs-number">100</span><span class="xml">%</span><br><span class="xml"></span><br><span class="xml">New versions of active modules available:</span><br><span class="xml">  hexo                      </span><span class="hljs-keyword">^3.2.0</span><span class="xml">   →   </span><span class="hljs-keyword">^5.4.0</span><span class="xml"> </span><br><span class="xml">  hexo-deployer-git         </span><span class="hljs-keyword">^0.3.1</span><span class="xml">   →   </span><span class="hljs-keyword">^3.0.0</span><span class="xml"> </span><br><span class="xml">  hexo-fs                   </span><span class="hljs-keyword">^0.2.2</span><span class="xml">   →   </span><span class="hljs-keyword">^3.1.0</span><span class="xml"> </span><br><span class="xml">  hexo-generator-archive    </span><span class="hljs-keyword">^0.1.4</span><span class="xml">   →   </span><span class="hljs-keyword">^1.0.0</span><span class="xml"> </span><br><span class="xml">  hexo-generator-category   </span><span class="hljs-keyword">^0.1.3</span><span class="xml">   →   </span><span class="hljs-keyword">^1.0.0</span><span class="xml"> </span><br><span class="xml">  hexo-generator-feed       </span><span class="hljs-keyword">^1.2.2</span><span class="xml">   →   </span><span class="hljs-keyword">^3.0.0</span><span class="xml"> </span><br><span class="xml">  hexo-generator-index      </span><span class="hljs-keyword">^0.2.0</span><span class="xml">   →   </span><span class="hljs-keyword">^2.0.0</span><span class="xml"> </span><br><span class="xml">  hexo-generator-searchdb   </span><span class="hljs-keyword">^1.0.8</span><span class="xml">   →   </span><span class="hljs-keyword">^1.3.4</span><span class="xml"> </span><br><span class="xml">  hexo-generator-sitemap    </span><span class="hljs-keyword">^1.2.0</span><span class="xml">   →   </span><span class="hljs-keyword">^2.1.0</span><span class="xml"> </span><br><span class="xml">  hexo-generator-tag        </span><span class="hljs-keyword">^0.2.0</span><span class="xml">   →   </span><span class="hljs-keyword">^1.0.0</span><span class="xml"> </span><br><span class="xml">  hexo-renderer-ejs         </span><span class="hljs-keyword">^0.3.0</span><span class="xml">   →   </span><span class="hljs-keyword">^1.0.0</span><span class="xml"> </span><br><span class="xml">  hexo-renderer-marked      </span><span class="hljs-keyword">^0.3.0</span><span class="xml">   →   </span><span class="hljs-keyword">^4.0.0</span><span class="xml"> </span><br><span class="xml">  hexo-renderer-stylus      </span><span class="hljs-keyword">^0.3.1</span><span class="xml">   →   </span><span class="hljs-keyword">^2.0.1</span><span class="xml"> </span><br><span class="xml">  hexo-server               </span><span class="hljs-keyword">^0.2.0</span><span class="xml">   →   </span><span class="hljs-keyword">^2.0.0</span><span class="xml"> </span><br><span class="xml"></span><br><span class="xml">? Update &quot;hexo&quot; in package.json from </span><span class="hljs-keyword">^3.2.0</span><span class="xml"> to </span><span class="hljs-keyword">^5.4.0</span><span class="xml">? Yes</span><br><span class="xml">? Update &quot;hexo-deployer-git&quot; in package.json from </span><span class="hljs-keyword">^0.3.1</span><span class="xml"> to </span><span class="hljs-keyword">^3.0.0</span><span class="xml">? Finish update process</span><br><span class="xml"></span><br><span class="xml">These packages will be updated:</span><br><span class="xml">  hexo   </span><span class="hljs-keyword">^3.2.0</span><span class="xml">   →   </span><span class="hljs-keyword">^5.4.0</span><span class="xml"> </span><br><span class="xml">? Update package.json? Yes</span><br><span class="xml"></span><br><span class="xml">➜  init npm-upgrade      </span><br><span class="xml">Checking for outdated dependencies for &quot;/data/martin/martinsev/wwwroot/init/package.json&quot;...</span><br><span class="xml">[====================] </span><span class="hljs-number">15</span><span class="xml">/</span><span class="hljs-number">15</span><span class="xml"> </span><span class="hljs-number">100</span><span class="xml">%</span><br><span class="xml">All dependencies are up-to-date!</span><br></code></pre></td></tr></table></figure><h4 id="5、更新全局包"><a href="#5、更新全局包" class="headerlink" title="5、更新全局包"></a>5、更新全局包</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">➜  init npm <span class="hljs-keyword">update</span> -g<br>up <span class="hljs-keyword">to</span> <span class="hljs-type">date</span>, audited <span class="hljs-number">1</span> package <span class="hljs-keyword">in</span> <span class="hljs-number">184</span>ms<br><span class="hljs-built_in">found</span> <span class="hljs-number">0</span> vulnerabilities<br></code></pre></td></tr></table></figure><h4 id="6、更新生产环境依赖包"><a href="#6、更新生产环境依赖包" class="headerlink" title="6、更新生产环境依赖包"></a>6、更新生产环境依赖包</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">➜  init npm update --save<br>npm WARN deprecated urix@<span class="hljs-number">0.1</span>.<span class="hljs-number">0</span>: Please see https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/lydell/u</span>rix<span class="hljs-comment">#deprecated</span><br>npm WARN deprecated resolve-url@<span class="hljs-number">0.2</span>.<span class="hljs-number">1</span>: https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/lydell/</span>resolve-url<span class="hljs-comment">#deprecated</span><br>...<br>...<br><br></code></pre></td></tr></table></figure><h4 id="7、Check-the-New-Hexo-Version"><a href="#7、Check-the-New-Hexo-Version" class="headerlink" title="7、Check the New Hexo Version"></a>7、Check the New Hexo Version</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs dts">➜  init hexo v<br>INFO  Validating config<br>WARN  Deprecated config detected: <span class="hljs-string">&quot;external_link&quot;</span> with a Boolean value is deprecated. See https:<span class="hljs-comment">//hexo.io/docs/configuration for more details.</span><br><span class="hljs-symbol">hexo:</span> <span class="hljs-number">5.4</span><span class="hljs-number">.0</span>  <span class="hljs-meta">#New Updated Version</span><br>hexo-cli: <span class="hljs-number">4.3</span><span class="hljs-number">.0</span><br><span class="hljs-symbol">os:</span> linux <span class="hljs-number">4.18</span><span class="hljs-number">.16</span><span class="hljs-number">-1.</span>el7.elrepo.x86_64 CentOS Linux <span class="hljs-number">7</span> (Core)<br><span class="hljs-symbol">node:</span> <span class="hljs-number">15.5</span><span class="hljs-number">.1</span><br><span class="hljs-symbol">v8:</span> <span class="hljs-number">8.6</span><span class="hljs-number">.395</span><span class="hljs-number">.17</span>-node<span class="hljs-number">.23</span><br><span class="hljs-symbol">uv:</span> <span class="hljs-number">1.40</span><span class="hljs-number">.0</span><br><span class="hljs-symbol">zlib:</span> <span class="hljs-number">1.2</span><span class="hljs-number">.11</span><br><span class="hljs-symbol">brotli:</span> <span class="hljs-number">1.0</span><span class="hljs-number">.9</span><br><span class="hljs-symbol">ares:</span> <span class="hljs-number">1.17</span><span class="hljs-number">.1</span><br><span class="hljs-symbol">modules:</span> <span class="hljs-number">88</span><br><span class="hljs-symbol">nghttp2:</span> <span class="hljs-number">1.41</span><span class="hljs-number">.0</span><br><span class="hljs-symbol">napi:</span> <span class="hljs-number">7</span><br><span class="hljs-symbol">llhttp:</span> <span class="hljs-number">2.1</span><span class="hljs-number">.3</span><br><span class="hljs-symbol">openssl:</span> <span class="hljs-number">1.1</span><span class="hljs-number">.1</span>i<br><span class="hljs-symbol">cldr:</span> <span class="hljs-number">38.0</span><br><span class="hljs-symbol">icu:</span> <span class="hljs-number">68.1</span><br><span class="hljs-symbol">tz:</span> <span class="hljs-number">2020</span>b<br><span class="hljs-symbol">unicode:</span> <span class="hljs-number">13.0</span><br></code></pre></td></tr></table></figure><h4 id="8、Check-the-Package-json"><a href="#8、Check-the-Package-json" class="headerlink" title="8、Check the Package.json"></a>8、Check the Package.json</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs gradle">➜  init cat <span class="hljs-regexp">/data/m</span>artin<span class="hljs-regexp">/martinsev/</span>wwwroot<span class="hljs-regexp">/init/</span><span class="hljs-keyword">package</span>.json   <br>&#123;<br>  <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;hexo-site&quot;</span>,<br>  <span class="hljs-string">&quot;version&quot;</span>: <span class="hljs-string">&quot;0.0.0&quot;</span>,<br>  <span class="hljs-string">&quot;private&quot;</span>: <span class="hljs-keyword">true</span>,<br>  <span class="hljs-string">&quot;hexo&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;version&quot;</span>: <span class="hljs-string">&quot;5.4.0&quot;</span><br>  &#125;,<br>  <span class="hljs-string">&quot;dependencies&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;hexo&quot;</span>: <span class="hljs-string">&quot;^5.4.0&quot;</span>,<br>    <span class="hljs-string">&quot;hexo-admin&quot;</span>: <span class="hljs-string">&quot;^2.3.0&quot;</span>,<br>    <span class="hljs-string">&quot;hexo-deployer-git&quot;</span>: <span class="hljs-string">&quot;^3.0.0&quot;</span>,<br>    <span class="hljs-string">&quot;hexo-fs&quot;</span>: <span class="hljs-string">&quot;^3.1.0&quot;</span>,<br>    <span class="hljs-string">&quot;hexo-generator-archive&quot;</span>: <span class="hljs-string">&quot;^1.0.0&quot;</span>,<br>    <span class="hljs-string">&quot;hexo-generator-category&quot;</span>: <span class="hljs-string">&quot;^1.0.0&quot;</span>,<br>    <span class="hljs-string">&quot;hexo-generator-feed&quot;</span>: <span class="hljs-string">&quot;^3.0.0&quot;</span>,<br>    <span class="hljs-string">&quot;hexo-generator-index&quot;</span>: <span class="hljs-string">&quot;^2.0.0&quot;</span>,<br>    <span class="hljs-string">&quot;hexo-generator-searchdb&quot;</span>: <span class="hljs-string">&quot;^1.3.4&quot;</span>,<br>    <span class="hljs-string">&quot;hexo-generator-sitemap&quot;</span>: <span class="hljs-string">&quot;^2.1.0&quot;</span>,<br>    <span class="hljs-string">&quot;hexo-generator-tag&quot;</span>: <span class="hljs-string">&quot;^1.0.0&quot;</span>,<br>    <span class="hljs-string">&quot;hexo-renderer-ejs&quot;</span>: <span class="hljs-string">&quot;^1.0.0&quot;</span>,<br>    <span class="hljs-string">&quot;hexo-renderer-marked&quot;</span>: <span class="hljs-string">&quot;^4.0.0&quot;</span>,<br>    <span class="hljs-string">&quot;hexo-renderer-stylus&quot;</span>: <span class="hljs-string">&quot;^2.0.1&quot;</span>,<br>    <span class="hljs-string">&quot;hexo-server&quot;</span>: <span class="hljs-string">&quot;^2.0.0&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="update-Hexo-Themes"><a href="#update-Hexo-Themes" class="headerlink" title="update Hexo Themes:"></a>update Hexo Themes:</h3><h4 id="1、backup-old-hexo仓库"><a href="#1、backup-old-hexo仓库" class="headerlink" title="1、backup old hexo仓库."></a>1、backup old hexo仓库.</h4><ul><li>public</li><li>config yml</li></ul><h4 id="2、Init-new-hexo仓库"><a href="#2、Init-new-hexo仓库" class="headerlink" title="2、Init new hexo仓库."></a>2、Init new hexo仓库.</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">➜  wwwroot hexo init leiyawu<br><span class="hljs-keyword">INFO</span>  Cloning hexo-starter https://github.com/hexojs/hexo-starter.git<br><span class="hljs-keyword">INFO</span>  Install dependencies<br>npm <span class="hljs-keyword">notice</span> <br>  m <span class="hljs-keyword">notice</span> <span class="hljs-built_in">New</span> minor <span class="hljs-keyword">version</span> <span class="hljs-keyword">of</span> npm available! <span class="hljs-number">7.3</span><span class="hljs-number">.0</span> -&gt; <span class="hljs-number">7.20</span><span class="hljs-number">.3</span><br>▽pm <span class="hljs-keyword">notice</span> Changelog: https://github.com/npm/cli/releases/tag/v7<span class="hljs-number">.20</span><span class="hljs-number">.3</span><br>npm <span class="hljs-keyword">notice</span> Run npm install -g npm@<span class="hljs-number">7.20</span><span class="hljs-number">.3</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">update</span>!<br>npm <span class="hljs-keyword">notice</span> <br><span class="hljs-keyword">INFO</span>  <span class="hljs-keyword">Start</span> blogging <span class="hljs-keyword">with</span> Hexo!<br></code></pre></td></tr></table></figure><h4 id="3、cp-old-to-new-仓库"><a href="#3、cp-old-to-new-仓库" class="headerlink" title="3、cp old to new 仓库."></a>3、cp old to new 仓库.</h4><ul><li>将备份的静态文件目录:public拷贝至新的仓库下</li><li>对比旧版本的_config.yml. 修改新版的_config.yml配置</li></ul><h4 id="4、git-clone-theme-to-任一异于next的目录"><a href="#4、git-clone-theme-to-任一异于next的目录" class="headerlink" title="4、git clone theme to 任一异于next的目录."></a>4、git clone theme to 任一异于next的目录.</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">➜  themes pwd<br><span class="hljs-regexp">/data/m</span>artin<span class="hljs-regexp">/martinsev/</span>wwwroot<span class="hljs-regexp">/init/</span>themes<br>➜  themes git clone https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/fluid-dev/</span>hexo-theme-fluid.git fluid<br></code></pre></td></tr></table></figure><h4 id="5、在-Hexo-config-yml主文件中设置主题"><a href="#5、在-Hexo-config-yml主文件中设置主题" class="headerlink" title="5、在 Hexo _config.yml主文件中设置主题."></a>5、在 Hexo _config.yml主文件中设置主题.</h4><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vbnet"><span class="hljs-symbol">theme:</span> <span class="hljs-keyword">next</span>-reloaded<br></code></pre></td></tr></table></figure><h4 id="6、生成静态文件并发布"><a href="#6、生成静态文件并发布" class="headerlink" title="6、生成静态文件并发布."></a>6、生成静态文件并发布.</h4><ul><li>执行：hexo g -d重新生成静态目录：</li><li>hexo clean: 清空现有public缓存以及静态文件，慎用(注意backup and Do not use it until a critical moment).<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">➜  init hexo clean<br><span class="hljs-keyword">INFO</span>  Deleted <span class="hljs-keyword">database</span>.<br><span class="hljs-keyword">INFO</span>  Deleted <span class="hljs-built_in">public</span> folder.<br>➜  init hexo g -d<br><span class="hljs-keyword">INFO</span>  <span class="hljs-keyword">Start</span> processing<br><span class="hljs-keyword">INFO</span>  Files loaded <span class="hljs-keyword">in</span> <span class="hljs-number">3.62</span> s<br>(node:<span class="hljs-number">350113</span>) <span class="hljs-built_in">Warning</span>: Accessing non-existent property <span class="hljs-string">&#x27;lineno&#x27;</span> <span class="hljs-keyword">of</span> module exports inside circular dependency<br></code></pre></td></tr></table></figure></li><li>通过nginx指向public，进行访问</li></ul><h3 id="常见报错："><a href="#常见报错：" class="headerlink" title="常见报错："></a>常见报错：</h3><ul><li>Error1:</li></ul><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">ssh: connect to host github.com port <span class="hljs-number">22</span>: Connection timed out<br>fatal: Could not <span class="hljs-keyword">read</span> from remote repository.<br><br>Please make sure you have the correct access rights<br><span class="hljs-keyword">and</span> the repository exists.<br>FATAL Something&#x27;s wrong. Maybe you can find the solution here: http://hexo.io/docs/troubleshooting.html<br>Error<br>    at ChildProcess.<span class="hljs-tag">&lt;anonymous&gt;</span> (/data/martin/martinsev/wwwroot/init/node_modules/hexo-util/lib/spawn.js:<span class="hljs-number">37</span>:<span class="hljs-number">17</span>)<br>    at ChildProcess.emit (<span class="hljs-keyword">node</span><span class="hljs-title">:events</span>:<span class="hljs-number">376</span>:<span class="hljs-number">20</span>)<br>    at maybeClose (<span class="hljs-keyword">node</span><span class="hljs-title">:internal</span>/child_process:<span class="hljs-number">1063</span>:<span class="hljs-number">16</span>)<br>    at Process.ChildProcess._handle.onexit (<span class="hljs-keyword">node</span><span class="hljs-title">:internal</span>/child_process:<span class="hljs-number">295</span>:<span class="hljs-number">5</span>)<br></code></pre></td></tr></table></figure><p>解决方法： 打开主机ssh port.</p><ul><li>Error2:</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs gradle">Permission denied (publickey).<br>fatal: Could not <span class="hljs-keyword">read</span> <span class="hljs-keyword">from</span> remote repository.<br><br>Please make sure you have the correct access rights<br>and the repository exists.<br>FATAL &#123;<br>  err: Error: Spawn failed<br>      at ChildProcess.&lt;anonymous&gt; (<span class="hljs-regexp">/data/m</span>artin<span class="hljs-regexp">/martinsev/</span>wwwroot<span class="hljs-regexp">/leiyawu/</span>node_modules<span class="hljs-regexp">/hexo-util/</span>lib/spawn.js:<span class="hljs-number">51</span>:<span class="hljs-number">21</span>)<br>      at ChildProcess.emit (node:events:<span class="hljs-number">376</span>:<span class="hljs-number">20</span>)<br>      at Process.ChildProcess._handle.onexit (node:internal/child_process:<span class="hljs-number">284</span>:<span class="hljs-number">12</span>) &#123;<br>    code: <span class="hljs-number">128</span><br>  &#125;<br>&#125; Something<span class="hljs-string">&#x27;s wrong. Maybe you can find the solution here: %s https://hexo.io/docs/troubleshooting.html</span><br></code></pre></td></tr></table></figure><p>因_config.yml的deploy中配置了git仓库同步，而git仓库无法访问，故报错.</p><p>解决方法： 将主机公钥添加进github中.</p>]]></content>
    
    
    <categories>
      
      <category>hexo</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Jenkins use ca_https to access kubernetes_cluster api</title>
    <link href="/2020/08/03/Jenkins-use-ca-https-to-access-kubernetes-cluster-api/"/>
    <url>/2020/08/03/Jenkins-use-ca-https-to-access-kubernetes-cluster-api/</url>
    
    <content type="html"><![CDATA[<ol><li><p>通过之前生成的admin的证书访问api server:</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">➜  pipeline curl --insecure --cacert <span class="hljs-regexp">/data/</span>kubernetes<span class="hljs-regexp">/ssl/</span>ca.crt --key <span class="hljs-regexp">/data/</span>kubernetes<span class="hljs-regexp">/ssl/</span>admin-key.pem --cert <span class="hljs-regexp">/data/</span>kubernetes<span class="hljs-regexp">/ssl/</span>admin.pem https:<span class="hljs-regexp">//</span><span class="hljs-number">192.168</span>.<span class="hljs-number">0.14</span>:<span class="hljs-number">6443</span> <br></code></pre></td></tr></table></figure></li><li><p>在kubernetes master上调用本地接口8080访问api server:</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">➜  pipeline curl http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8080</span><br>&#123;<br>  <span class="hljs-string">&quot;paths&quot;</span>: [<br>    <span class="hljs-string">&quot;/api&quot;</span>,<br>    <span class="hljs-string">&quot;/api/v1&quot;</span>,<br>    ....<br></code></pre></td></tr></table></figure></li><li><p>通过”~/.kube/config”配置文件(base64 -d转码后生成的证书)(如下)访问api server:</p></li></ol><p>If you are not hosting Jenkins on the same Kubernetes cluster (or not hosting it on Kubernetes at all), then you need to perform a few extra steps to configure the access to your Kubernetes cluster.</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">curl <span class="hljs-params">--insecure</span> <span class="hljs-params">--cacert</span> <span class="hljs-string">./ca.crt</span> <span class="hljs-params">--key</span> <span class="hljs-string">./client.key</span> -cert <span class="hljs-string">./client.crt</span> https:<span class="hljs-string">//192.168.0.14</span><span class="hljs-function">:6443</span><br></code></pre></td></tr></table></figure><p>详细步骤如下：</p><ul><li><p>cat ~/.kube/config</p></li><li><p>将”certificate-authority-data”的值保存在一个文件ca中<br>然后:cat ca|base64 -d &gt; ca.crt,生成ca证书文件</p></li><li><p>we need to grab the base64 encoded client-certificate-data,同样：将”client-certificate-data”的值保存在1.client.crt中，cat 1.client.crt |base64 -d &gt; client.crt</p></li><li><p>将”client-key-data”的值保存在1.client.key中，cat 1.client.key |base64 -d &gt; client.key</p></li><li><p>执行:”openssl pkcs12 -export -out cert.pfx -inkey client.key -in client.crt -certfile ca.crt -passout pass:passwd”其中cert.pfx上传给Jenkins，其密码为passwd</p></li><li><p>jenkins新建Credentials,Kind选择”Certificate”,通过”Upload PKCS#12 certificate”将生成的cert.pfx上传上来，Password为刚才pass后面指定的值”passwd”</p></li><li><p>Kubernetes URL:由”<a href="http://127.0.0.1:8080&quot;更改为：&quot;https://192.168.0.14:6443&quot;">http://127.0.0.1:8080&quot;更改为：&quot;https://192.168.0.14:6443&quot;</a><br>“127.0.0.1:8080”为本地验证的url,类型为:http;”192.168.0.14:6443”则为远程连接接口，类型为:https<br>至此需要认证的https ca证书配置完成。</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>jenkins</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jenkins</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>bootstrap.memory_lock简要说明</title>
    <link href="/2019/10/17/bootstrap-memory-lock/"/>
    <url>/2019/10/17/bootstrap-memory-lock/</url>
    
    <content type="html"><![CDATA[<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/setup-configuration-memory.html#mlockall">https://www.elastic.co/guide/en/elasticsearch/reference/current/setup-configuration-memory.html#mlockall</a></p><h5 id="bootstrap-memory-lock"><a href="#bootstrap-memory-lock" class="headerlink" title="bootstrap.memory_lock"></a>bootstrap.memory_lock</h5><p>由于当jvm开始swapping时es的效率会降低，所以要保证它不swap，这对节点健康极其重要。实现这一目标的一种方法是将 bootstrap.memory_lock 设置为true。<br>要使此设置有效，首先需要配置其他系统设置。有关如何正确设置内存锁定的更多详细信息，请参阅启用bootstrap.memory_lock。</p><p>bootstrap.memory_lock: 是否锁住内存，避免交换(swapped)带来的性能损失,默认值是: false<br>bootstrap.system_call_filter: 是否支持过滤掉系统调用。elasticsearch 5.2以后引入的功能，在bootstrap的时候check是否支持seccomp。</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">检查bootstrap.memory_lock设置是否生效:<br><span class="hljs-keyword">get</span> http:<span class="hljs-comment">//10.127.0.1:9200/_nodes?filter_path=**.mlockall</span><br>响应：<br>&#123;<br>    <span class="hljs-string">&quot;nodes&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;9giihmDNRdS136KT52Gl5g&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;process&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;mlockall&quot;</span>: <span class="hljs-literal">true</span><br>            &#125;<br>        &#125;,<br>        <span class="hljs-string">&quot;X0zQESeeT8uJ9kVXvHpl-w&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;process&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;mlockall&quot;</span>: <span class="hljs-literal">true</span><br>            &#125;<br>        &#125;,<br>        <span class="hljs-string">&quot;w4hYw86rQhqL1ayGyUK1Kw&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;process&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;mlockall&quot;</span>: <span class="hljs-literal">true</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>如果看到mlockall为false，则表示mlockall请求失败。还将在日志中看到一行”Unable to lock JVM Memory”。</p><h5 id="elasticsearch报错之-memory-locking-requested-for-elasticsearch-process-but-memory-is-not-locked"><a href="#elasticsearch报错之-memory-locking-requested-for-elasticsearch-process-but-memory-is-not-locked" class="headerlink" title="elasticsearch报错之 memory locking requested for elasticsearch process but memory is not locked:"></a>elasticsearch报错之 memory locking requested for elasticsearch process but memory is not locked:</h5><p>安装elasticsearch报错如下：</p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs inform7"><span class="hljs-comment">[2019-01-14T03:57:16,453]</span><span class="hljs-comment">[ERROR]</span><span class="hljs-comment">[o.e.b.Bootstrap          ]</span> <span class="hljs-comment">[ip-172-31-30-62.ec2.internal]</span> node validation exception<br><span class="hljs-comment">[1]</span> bootstrap checks failed<br><span class="hljs-comment">[1]</span>: memory locking requested for elasticsearch process but memory <span class="hljs-keyword">is</span> not <span class="hljs-keyword">locked</span><br></code></pre></td></tr></table></figure><p>网上查找资料，发现都不是适应自己的环境。最后在官网找到了方法：</p><p>不过先跟大家声明一点就是：环境不一样解决的方法也不一样，这里是Centos7.5版本的系统，所有的服务都由systemd来管理。elasticsearch是6.5.4版本，使用RPM包的方式安装的。</p><p>现在我们开始解决问题：</p><h6 id="1、修改-etc-sysconfig-elasticsearch文件调整JVM内存大小"><a href="#1、修改-etc-sysconfig-elasticsearch文件调整JVM内存大小" class="headerlink" title="1、修改/etc/sysconfig/elasticsearch文件调整JVM内存大小"></a>1、修改/etc/sysconfig/elasticsearch文件调整JVM内存大小</h6><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment">#ES_JAVA_OPTS=&quot;-Xms16g -Xmx16g&quot; (内存大小也可以在/etc/elasticsearch/jvm.options配置文件中定义，或者ES_HEAP_SIZE=16g)</span><br><span class="hljs-attr">JAVA_HOME</span>=/usr/java/jdk1.<span class="hljs-number">8.0</span>_51<br><span class="hljs-attr">ES_HEAP_SIZE</span>=<span class="hljs-number">16</span>g<br><span class="hljs-attr">MAX_OPEN_FILES</span>=<span class="hljs-number">655350</span><br><span class="hljs-attr">MAX_LOCKED_MEMORY</span>=unlimited<br></code></pre></td></tr></table></figure><p>替换16g为总内存的一半（Elasticsearch官方建议是主机总内存的一半）</p><h6 id="2、修改-etc-security-limits-conf文件内容"><a href="#2、修改-etc-security-limits-conf文件内容" class="headerlink" title="2、修改/etc/security/limits.conf文件内容"></a>2、修改/etc/security/limits.conf文件内容</h6><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs aspectj">elasticsearch <span class="hljs-keyword">soft</span> memlock unlimited<br>elasticsearch hard memlock unlimited<br></code></pre></td></tr></table></figure><p>需要将elasticsearch替换为运行Elasticsearch程序的用户,使用root执行：service elasticsearch start实际上是以elasticsearch用户来执行</p><h6 id="3、在-etc-systemd-system-elasticsearch-service-d目录下创建一个文件override-conf，并添加下列内容"><a href="#3、在-etc-systemd-system-elasticsearch-service-d目录下创建一个文件override-conf，并添加下列内容" class="headerlink" title="3、在/etc/systemd/system/elasticsearch.service.d目录下创建一个文件override.conf，并添加下列内容"></a>3、在/etc/systemd/system/elasticsearch.service.d目录下创建一个文件override.conf，并添加下列内容</h6><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">[Service]<br>LimitMEMLOCK=infinity<br>详情可以参考：https:<span class="hljs-regexp">//</span>www.elastic.co<span class="hljs-regexp">/guide/</span>en<span class="hljs-regexp">/elasticsearch/</span>reference<span class="hljs-regexp">/current/</span>setting-system-settings.html<span class="hljs-comment">#systemd</span><br></code></pre></td></tr></table></figure><h6 id="4、最后重新载入配置文件更新服务"><a href="#4、最后重新载入配置文件更新服务" class="headerlink" title="4、最后重新载入配置文件更新服务"></a>4、最后重新载入配置文件更新服务</h6><p>systemctl daemon-reload</p><h6 id="5、重启elasticsearch"><a href="#5、重启elasticsearch" class="headerlink" title="5、重启elasticsearch"></a>5、重启elasticsearch</h6><p>service elasticsearch restart</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Windows batch编程常用语法及命令</title>
    <link href="/2019/01/21/Windows-batch%E7%BC%96%E7%A8%8B%E5%B8%B8%E7%94%A8%E8%AF%AD%E6%B3%95%E5%8F%8A%E5%91%BD%E4%BB%A4/"/>
    <url>/2019/01/21/Windows-batch%E7%BC%96%E7%A8%8B%E5%B8%B8%E7%94%A8%E8%AF%AD%E6%B3%95%E5%8F%8A%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">1 <span class="hljs-keyword">echo</span> 和 @<br>回显命令<br>@                     <span class="hljs-comment">#关闭单行回显</span><br><span class="hljs-keyword">echo</span> off              <span class="hljs-comment">#从下一行开始关闭回显</span><br>@<span class="hljs-keyword">echo</span> off             <span class="hljs-comment">#从本行开始关闭回显。一般批处理第一行都是这个</span><br><span class="hljs-keyword">echo</span> on               <span class="hljs-comment">#从下一行开始打开回显</span><br><span class="hljs-keyword">echo</span>                  <span class="hljs-comment">#显示当前是 echo off 状态还是 echo on 状态</span><br><span class="hljs-keyword">echo</span>.                 <span class="hljs-comment">#输出一个”回车换行”，空白行</span><br>                         <span class="hljs-comment">#(同echo, echo; echo+ echo[ echo] echo/ echo)</span><br><br>2 errorlevel<br><span class="hljs-keyword">echo</span> %errorlevel%<br>每个命令运行结束，可以用这个命令行格式查看返回码<br>默认值为0，一般命令执行出错会设 errorlevel 为1<br><br>3 dir<br>显示文件夹内容<br>dir                  <span class="hljs-comment">#显示当前目录中的文件和子目录</span><br>dir <span class="hljs-string">/a</span>               <span class="hljs-comment">#显示当前目录中的文件和子目录，包括隐藏文件和系统文件</span><br>dir c: <span class="hljs-string">/a</span><span class="hljs-function">:d</span>          <span class="hljs-comment">#显示 C 盘当前目录中的目录</span><br>dir c: <span class="hljs-string">/a</span><span class="hljs-function">:-d</span>         <span class="hljs-comment">#显示 C 盘根目录中的文件</span><br>dir c: <span class="hljs-string">/b/p</span>         <span class="hljs-comment">#/b只显示文件名，/p分页显示</span><br>dir *<span class="hljs-string">.exe</span> <span class="hljs-string">/s</span>         <span class="hljs-comment">#显示当前目录和子目录里所有的.exe文件</span><br><br>4 <span class="hljs-keyword">cd</span><br>切换目录<br><span class="hljs-keyword">cd</span>  \             <span class="hljs-comment">#进入根目录</span><br><span class="hljs-keyword">cd</span>                   <span class="hljs-comment">#显示当前目录</span><br><span class="hljs-keyword">cd</span> <span class="hljs-string">/d</span> d<span class="hljs-function">:sdk</span>        <span class="hljs-comment">#可以同时更改盘符和目录</span><br><span class="hljs-keyword">cd</span> <span class="hljs-string">/d</span> %~dp0<br>更改当前目录为批处理本身的目录<br>比如你有个批处理a.bat在D:\qq文件夹下<br>a.bat内容为<br><span class="hljs-keyword">cd</span> <span class="hljs-string">/d</span> %~dp0<br>在这里<br><span class="hljs-keyword">cd</span> <span class="hljs-string">/d</span> %~dp0的意思就是<span class="hljs-keyword">cd</span> <span class="hljs-string">/d</span> d:\qq<br>%0代表批处理本身 d:\qq\a.bat<br>~dp是变量扩充<br>d既是扩充到分区号 d:<br>p就是扩充到路径 \qq<br>dp就是扩充到分区号路径 d:\qq <br><br>5 md<br>创建目录<br>md d<span class="hljs-function">:abc</span>          <span class="hljs-comment">#如果 d:a 不存在，将会自动创建中级目录</span><br><span class="hljs-comment">#如果命令扩展名被停用，则需要键入 mkdir abc。</span><br><br>6 rd<br>删除目录<br>rd abc               <span class="hljs-comment">#删除当前目录里的 abc 子目录，要求为空目录</span><br>rd <span class="hljs-string">/s/q</span> d<span class="hljs-function">:temp</span>      <span class="hljs-comment">#删除 d:temp 文件夹及其子文件夹和文件，/q安静模式</span><br><br>7 del<br>删除文件<br>del d<span class="hljs-function">:test.txt</span>      <span class="hljs-comment">#删除指定文件，不能是隐藏、系统、只读文件</span><br>del <span class="hljs-string">/q/a/f</span> d<span class="hljs-function">:temp</span>*.*<br>删除 d<span class="hljs-function">:temp</span> 文件夹里面的所有文件，包括隐藏、只读、系统文件，不包括子目录<br>del <span class="hljs-string">/q/a/f/s</span> d<span class="hljs-function">:temp</span>*.*<br>删除 d<span class="hljs-function">:temp</span> 及子文件夹里面的所有文件，包括隐藏、只读、系统文件，不包括子目录<br><br>8 ren<br>重命名命令<br>ren d<span class="hljs-function">:temp</span> tmp      <span class="hljs-comment">#支持对文件夹的重命名</span><br><br>9 cls<br>清屏<br><br>10 type<br>显示文件内容<br>type c<span class="hljs-function">:boot.ini</span>     <span class="hljs-comment">#显示指定文件的内容，程序文件一般会显示乱码</span><br>type *<span class="hljs-string">.txt</span>           <span class="hljs-comment">#显示当前目录里所有.txt文件的内容</span><br><br>11 copy<br>拷贝文件<br>copy c<span class="hljs-function">:test.txt</span> d<span class="hljs-function">:test.bak</span><br>复制 c<span class="hljs-function">:test.txt</span> 文件到 d: ，并重命名为 test.bak<br>copy con test.txt<br>从屏幕上等待输入，按 Ctrl+Z 结束输入，输入内容存为test.txt文件<br>con代表屏幕，prn代表打印机，nul代表空设备<br>copy 1.txt + 2.txt 3.txt<br>合并 1.txt 和 2.txt 的内容，保存为 3.txt 文件<br>如果不指定 3.txt ，则保存到 1.txt<br>copy test.txt +<br>复制文件到自己，实际上是修改了文件日期<br><br>12 title<br>设置cmd窗口的标题<br>title 新标题         <span class="hljs-comment">#可以看到cmd窗口的标题栏变了</span><br><br>13 ver<br>显示系统版本<br><br>14 label 和 vol<br>设置卷标<br>vol                  <span class="hljs-comment">#显示卷标</span><br>label                <span class="hljs-comment">#显示卷标，同时提示输入新卷标</span><br>label c<span class="hljs-function">:system</span>       <span class="hljs-comment">#设置C盘的卷标为 system</span><br><br>15 pause<br>暂停命令<br><br>16 rem 和 ::<br>注释命令<br>注释行不执行操作<br><br>17 date 和 time<br>日期和时间<br>date           <span class="hljs-comment">#显示当前日期，并提示输入新日期，按&quot;回车&quot;略过输入</span><br>date/t         <span class="hljs-comment">#只显示当前日期，不提示输入新日期</span><br>time           <span class="hljs-comment">#显示当前时间，并提示输入新时间，按&quot;回车&quot;略过输入</span><br>time/t         <span class="hljs-comment">#只显示当前时间，不提示输入新时间</span><br><br>18 goto 和 :<br>跳转命令<br><span class="hljs-function">:label</span>         <span class="hljs-comment">#行首为:表示该行是标签行，标签行不执行操作</span><br>goto label     <span class="hljs-comment">#跳转到指定的标签那一行</span><br><br>19 find <span class="hljs-params">(外部命令)</span><br>查找命令<br>find <span class="hljs-string">&quot;abc&quot;</span> c<span class="hljs-function">:test.txt</span><br>在 c<span class="hljs-function">:test.txt</span> 文件里查找含 abc 字符串的行<br>如果找不到，将设 errorlevel 返回码为1<br>find <span class="hljs-string">/i</span> “abc” c<span class="hljs-function">:test.txt</span><br>查找含 abc 的行，忽略大小写<br>find <span class="hljs-string">/c</span> <span class="hljs-string">&quot;abc&quot;</span> c<span class="hljs-function">:test.txt</span><br>显示含 abc 的行的行数<br><br>20 more <span class="hljs-params">(外部命令)</span><br>逐屏显示<br>more c<span class="hljs-function">:test.txt</span>     <span class="hljs-comment">#逐屏显示 c:test.txt 的文件内容</span><br><br>21 tree<br>显示目录结构<br>tree d:             <span class="hljs-comment">#显示D盘的文件目录结构</span><br><br>22 &amp;<br>顺序执行多条命令，而不管命令是否执行成功<br><br>23 &amp;&amp;<br>顺序执行多条命令，当碰到执行出错的命令后将不执行后面的命令<br>find <span class="hljs-string">&quot;ok&quot;</span> c<span class="hljs-function">:test.txt</span> &amp;&amp; <span class="hljs-keyword">echo</span> 成功<br>如果找到了<span class="hljs-string">&quot;ok&quot;</span>字样，就显示<span class="hljs-string">&quot;成功&quot;</span>，找不到就不显示<br><br>24 ||<br>顺序执行多条命令，当碰到执行正确的命令后将不执行后面的命令<br>find <span class="hljs-string">&quot;ok&quot;</span> c<span class="hljs-function">:test.txt</span> || <span class="hljs-keyword">echo</span> 不成功<br>如果找不到<span class="hljs-string">&quot;ok&quot;</span>字样，就显示<span class="hljs-string">&quot;不成功&quot;</span>，找到了就不显示<br><br>25 |<br>管道命令<br>dir *.* <span class="hljs-string">/s/a</span> | find <span class="hljs-string">/c</span> <span class="hljs-string">&quot;.exe&quot;</span><br>管道命令表示先执行 dir 命令，对其输出的结果执行后面的 find 命令<br>该命令行结果：输出当前文件夹及所有子文件夹里的<span class="hljs-string">.exe</span>文件的个数<br>type c<span class="hljs-function">:test.txt</span>|more<br>这个和 more c<span class="hljs-function">:test.txt</span> 的效果是一样的<br><br>26 &gt; 和 &gt;&gt;<br>输出重定向命令<br>&gt; 清除文件中原有的内容后再写入<br>&gt;&gt; 追加内容到文件末尾，而不会清除原有的内容<br>主要将本来显示在屏幕上的内容输出到指定文件中<br>指定文件如果不存在，则自动生成该文件<br>type c<span class="hljs-function">:test.txt</span> &gt;prn<br>屏幕上不显示文件内容，转向输出到打印机<br><span class="hljs-keyword">echo</span> hello world&gt;con<br>在屏幕上显示hello world，实际上所有输出都是默认 &gt;con 的<br>copy c<span class="hljs-function">:test.txt</span> f: &gt;nul<br>拷贝文件，并且不显示<span class="hljs-string">&quot;文件复制成功&quot;</span>的提示信息，但如果f盘不存在，还是会显示出错信息<br>copy c<span class="hljs-function">:test.txt</span> f: &gt;nul 2&gt;nul<br>不显示”文件复制成功”的提示信息，并且f盘不存在的话，也不显示错误提示信息<br><span class="hljs-keyword">echo</span> ^^W ^&gt; ^W&gt;c<span class="hljs-function">:test.txt</span><br>生成的文件内容为 ^W &gt; W<br>^ 和 &gt; 是控制命令，要把它们输出到文件，必须在前面加个 ^ 符号<br><br>27 &lt;<br>从文件中获得输入信息，而不是从屏幕上<br>一般用于 date time label 等需要等待输入的命令<br>@<span class="hljs-keyword">echo</span> off<br><span class="hljs-keyword">echo</span> 2005-05-01&gt;temp.txt<br>date &lt;temp.txt<br>del temp.txt<br>这样就可以不等待输入直接修改当前日期<br><br>28 %0 %1 %2 %3 %4 %5 %6 %7 %8 %9 %*<br>命令行传递给批处理的参数<br>%0 批处理文件本身<br>%1 第一个参数<br>%9 第九个参数<br>%* 从第一个参数开始的所有参数<br><br>批参数<span class="hljs-params">(%n)</span>的替代已被增强。您可以使用以下语法:<br><br>     %~1          - 删除引号<span class="hljs-params">(&quot;)</span>，扩充 %1<br>     %~f1         - 将 %1 扩充到一个完全合格的路径名<br>     %~d1         - 仅将 %1 扩充到一个驱动器号<br>     %~p1         - 仅将 %1 扩充到一个路径<br>     %~n1         - 仅将 %1 扩充到一个文件名<br>     %~x1         - 仅将 %1 扩充到一个文件扩展名<br>     %~s1         - 扩充的路径指含有短名<br>     %~a1         - 将 %1 扩充到文件属性<br>     %~t1         - 将 %1 扩充到文件的日期/时间<br>     %~z1         - 将 %1 扩充到文件的大小<br>     %~$PATH : 1 - 查找列在 PATH 环境变量的目录，并将 %1<br>                   扩充到找到的第一个完全合格的名称。如果环境<br>                   变量名未被定义，或者没有找到文件，此组合键会<br>                   扩充到空字符串<br><br>可以组合修定符来取得多重结果:<br><br>    %~dp1        - 只将 %1 扩展到驱动器号和路径<br>    %~nx1        - 只将 %1 扩展到文件名和扩展名<br>    %~dp$PATH<span class="hljs-function">:1</span> - 在列在 PATH 环境变量中的目录里查找 %1，<br>                   并扩展到找到的第一个文件的驱动器号和路径。<br>    %~ftza1      - 将 %1 扩展到类似 DIR 的输出行。<br>可以参照 call/? 或 for/? 看出每个参数的含意<br><span class="hljs-keyword">echo</span> load <span class="hljs-string">&quot;%%1&quot;</span> <span class="hljs-string">&quot;%%2&quot;</span>&gt;c<span class="hljs-function">:test.txt</span><br>生成的文件内容为 load <span class="hljs-string">&quot;%1&quot;</span> <span class="hljs-string">&quot;%2&quot;</span><br>批处理文件里，用这个格式把命令行参数输出到文件<br><br>29 <span class="hljs-keyword">if</span><br>判断命令<br><span class="hljs-keyword">if</span> <span class="hljs-string">&quot;%1&quot;</span>==<span class="hljs-string">&quot;/a&quot;</span> <span class="hljs-keyword">echo</span> 第一个参数是<span class="hljs-string">/a</span><br><span class="hljs-keyword">if</span> <span class="hljs-string">/i</span> <span class="hljs-string">&quot;%1&quot;</span> equ <span class="hljs-string">&quot;/a&quot;</span> <span class="hljs-keyword">echo</span> 第一个参数是<span class="hljs-string">/a</span><br><span class="hljs-string">/i</span> 表示不区分大小写，equ 和 == 是一样的，其它运算符参见 <span class="hljs-keyword">if</span>/?<br><span class="hljs-keyword">if</span> exist c<span class="hljs-function">:test.bat</span> <span class="hljs-keyword">echo</span> 存在c<span class="hljs-function">:test.bat</span>文件<br><span class="hljs-keyword">if</span> not exist c<span class="hljs-function">:windows</span> <span class="hljs-params">(</span><br><span class="hljs-params">     echo 不存在c:windows文件夹</span><br><span class="hljs-params">     )</span><br><span class="hljs-keyword">if</span> exist c<span class="hljs-function">:test.bat</span> <span class="hljs-params">(</span><br><span class="hljs-params">     echo 存在c:test.bat</span><br><span class="hljs-params">     )</span> else <span class="hljs-params">(</span><br><span class="hljs-params">     echo 不存在c:test.bat</span><br><span class="hljs-params">     )</span><br><br>30 setlocal 和 endlocal<br>设置”命令扩展名”和”延缓环境变量扩充”<br>SETLOCAL ENABLEEXTENSIONS             <span class="hljs-comment">#启用&quot;命令扩展名&quot;</span><br>SETLOCAL DISABLEEXTENSIONS            <span class="hljs-comment">#停用&quot;命令扩展名&quot;</span><br>SETLOCAL ENABLEDELAYEDEXPANSION       <span class="hljs-comment">#启用&quot;延缓环境变量扩充&quot;</span><br>SETLOCAL DISABLEDELAYEDEXPANSION      <span class="hljs-comment">#停用&quot;延缓环境变量扩充&quot;</span><br>ENDLOCAL                              <span class="hljs-comment">#恢复到使用SETLOCAL语句以前的状态</span><br>“命令扩展名”默认为启用<br>“延缓环境变量扩充”默认为停用<br>批处理结束系统会自动恢复默认值<br>可以修改注册表以禁用<span class="hljs-string">&quot;命令扩展名&quot;</span>，详见 cmd /? 。所以用到<span class="hljs-string">&quot;命令扩展名&quot;</span>的程<br>序，建议在开头和结尾加上 SETLOCAL ENABLEEXTENSIONS 和 ENDLOCAL 语句，以确<br>保程序能在其它系统上正确运行<br><span class="hljs-string">&quot;延缓环境变量扩充&quot;</span>主要用于 <span class="hljs-keyword">if</span> 和 for 的符合语句，在 <span class="hljs-keyword">set</span> 的说明里有其实用例程<br><br>31 <span class="hljs-keyword">set</span><br>设置变量<br>引用变量可在变量名前后加 % ，即 %变量名%<br><span class="hljs-keyword">set</span>                     <span class="hljs-comment">#显示目前所有可用的变量，包括系统变量和自定义的变量</span><br><span class="hljs-keyword">echo</span> %SystemDrive%      <span class="hljs-comment">#显示系统盘盘符。系统变量可以直接引用</span><br><span class="hljs-keyword">set</span> p                   <span class="hljs-comment">#显示所有以p开头的变量，要是一个也没有就设errorlevel=1</span><br><span class="hljs-keyword">set</span> p=aa1bb1aa2bb2      <span class="hljs-comment">#设置变量p，并赋值为 = 后面的字符串，即aa1bb1aa2bb2</span><br><span class="hljs-keyword">echo</span> %p%                <span class="hljs-comment">#显示变量p代表的字符串，即aa1bb1aa2bb2</span><br><span class="hljs-keyword">echo</span> %p:~6%             <span class="hljs-comment">#显示变量p中第6个字符以后的所有字符，即aa2bb2</span><br><span class="hljs-keyword">echo</span> %p:~6,3%           <span class="hljs-comment">#显示第6个字符以后的3个字符，即aa2</span><br><span class="hljs-keyword">echo</span> %p:~0,3%           <span class="hljs-comment">#显示前3个字符，即aa1</span><br><span class="hljs-keyword">echo</span> %p:~-2%            <span class="hljs-comment">#显示最后面的2个字符，即b2</span><br><span class="hljs-keyword">echo</span> %p:~0,-2%          <span class="hljs-comment">#显示除了最后2个字符以外的其它字符，即aa1bb1aa2b</span><br><span class="hljs-keyword">echo</span> %p<span class="hljs-function">:aa</span>=c%           <span class="hljs-comment">#用c替换变量p中所有的aa，即显示c1bb1c2bb2</span><br><span class="hljs-keyword">echo</span> %p<span class="hljs-function">:aa</span>=%            <span class="hljs-comment">#将变量p中的所有aa字符串置换为空，即显示1bb12bb2</span><br><span class="hljs-keyword">echo</span> %p:*bb=c%          <span class="hljs-comment">#第一个bb及其之前的所有字符被替换为c，即显示c1aa2bb2</span><br><span class="hljs-keyword">set</span> p=%p:*bb=c%         <span class="hljs-comment">#设置变量p，赋值为 %p:*bb=c% ，即c1aa2bb2</span><br><span class="hljs-keyword">set</span> <span class="hljs-string">/a</span> p=39             <span class="hljs-comment">#设置p为数值型变量，值为39</span><br><span class="hljs-keyword">set</span> <span class="hljs-string">/a</span> p=39/10          <span class="hljs-comment">#支持运算符，有小数时用去尾法，39/10=3.9，去尾得3，p=3</span><br><span class="hljs-keyword">set</span> <span class="hljs-string">/a</span> p=p/10           <span class="hljs-comment">#用 /a 参数时，在 = 后面的变量可以不加%直接引用</span><br><span class="hljs-keyword">set</span> <span class="hljs-string">/a</span> p=”1&amp;0″          <span class="hljs-comment">#”与”运算，要加引号。其它支持的运算符参见set/?</span><br><span class="hljs-keyword">set</span> p=                  <span class="hljs-comment">#取消p变量</span><br><span class="hljs-keyword">set</span> <span class="hljs-string">/p</span> p=请输入<br>屏幕上显示”请输入”，并会将输入的字符串赋值给变量p<br>注意这条可以用来取代 choice 命令<br>注意变量在 <span class="hljs-keyword">if</span> 和 for 的复合语句里是一次性全部替换的，如<br>@<span class="hljs-keyword">echo</span> off<br><span class="hljs-keyword">set</span> p=aaa<br><span class="hljs-keyword">if</span> %p%==aaa <span class="hljs-params">(</span><br><span class="hljs-params">     echo %p%</span><br><span class="hljs-params">     set <span class="hljs-attr">p</span>=bbb</span><br><span class="hljs-params">     echo %p%</span><br><span class="hljs-params">     )</span><br>结果将显示<br>aaa<br>aaa<br>因为在读取 <span class="hljs-keyword">if</span> 语句时已经将所有 %p% 替换为aaa<br>这里的<span class="hljs-string">&quot;替换&quot;</span>，在 /? 帮助里就是指<span class="hljs-string">&quot;扩充&quot;</span>、<span class="hljs-string">&quot;环境变量扩充&quot;</span><br>可以启用”延缓环境变量扩充”，用 ! 来引用变量，即 !变量名!<br>@<span class="hljs-keyword">echo</span> off<br>SETLOCAL ENABLEDELAYEDEXPANSION<br><span class="hljs-keyword">set</span> p=aaa<br><span class="hljs-keyword">if</span> %p%==aaa <span class="hljs-params">(</span><br><span class="hljs-params">     echo %p%</span><br><span class="hljs-params">     set <span class="hljs-attr">p</span>=bbb</span><br><span class="hljs-params">     echo !p!</span><br><span class="hljs-params">     )</span><br>ENDLOCAL<br>结果将显示<br>aaa<br>bbb<br>还有几个动态变量，运行 <span class="hljs-keyword">set</span> 看不到<br>%CD%                   <span class="hljs-comment">#代表当前目录的字符串</span><br>%DATE%                 <span class="hljs-comment">#当前日期</span><br>%TIME%                 <span class="hljs-comment">#当前时间</span><br>%RANDOM%               <span class="hljs-comment">#随机整数，介于0~32767</span><br>%ERRORLEVEL%           <span class="hljs-comment">#当前 ERRORLEVEL 值</span><br>%CMDEXTVERSION%        <span class="hljs-comment">#当前命令处理器扩展名版本号</span><br>%CMDCMDLINE%           <span class="hljs-comment">#调用命令处理器的原始命令行</span><br>可以用<span class="hljs-keyword">echo</span>命令查看每个变量值，如 <span class="hljs-keyword">echo</span> %time%<br>注意 %time% 精确到毫秒，在批处理需要延时处理时可以用到<br><br>32 start<br>批处理中调用外部程序的命令，否则等外部程序完成后才继续执行剩下的指令<br><br>33 call<br>批处理中调用另外一个批处理的命令，否则剩下的批处理指令将不会被执行<br>有时有的应用程序用start调用出错的，也可以call调用<br><br>34 choice <span class="hljs-params">(外部命令)</span><br>选择命令<br>让用户输入一个字符，从而选择运行不同的命令，返回码errorlevel为1234……<br>win98里是choice.com<br>win2000pro里没有，可以从win98里拷过来<br>win2003里是choice.exe<br>choice <span class="hljs-string">/N</span> <span class="hljs-string">/C</span> y <span class="hljs-string">/T</span> 5 <span class="hljs-string">/D</span> y&gt;nul<br>延时5秒<br><br>35 assoc 和 ftype<br>文件关联<br>assoc 设置&#x27;文件扩展名&#x27;关联，关联到&#x27;文件类型&#x27;<br>ftype 设置&#x27;文件类型&#x27;关联，关联到&#x27;执行程序和参数&#x27;<br>当你双击一个<span class="hljs-string">.txt</span>文件时，windows并不是根据<span class="hljs-string">.txt</span>直接判断用 notepad.exe 打开<br>而是先判断<span class="hljs-string">.txt</span>属于 txtfile &#x27;文件类型&#x27;<br>再调用 txtfile 关联的命令行 txtfile=%SystemRoot%system32NOTEPAD.EXE %1<br>可以在<span class="hljs-string">&quot;文件夹选项&quot;</span>→<span class="hljs-string">&quot;文件类型&quot;</span>里修改这2种关联<br>assoc            <span class="hljs-comment">#显示所有&#x27;文件扩展名&#x27;关联</span><br>assoc <span class="hljs-string">.txt</span>       <span class="hljs-comment">#显示.txt代表的&#x27;文件类型&#x27;，结果显示 .txt=txtfile</span><br>assoc <span class="hljs-string">.doc</span>       <span class="hljs-comment">#显示.doc代表的&#x27;文件类型&#x27;，结果显示 .doc=Word.Document.8</span><br>assoc <span class="hljs-string">.exe</span>       <span class="hljs-comment">#显示.exe代表的&#x27;文件类型&#x27;，结果显示 .exe=exefile</span><br>ftype            <span class="hljs-comment">#显示所有&#x27;文件类型&#x27;关联</span><br>ftype exefile    <span class="hljs-comment">#显示exefile类型关联的命令行，结果显示 exefile=&quot;%1&quot; %* </span><br>assoc <span class="hljs-string">.txt=Word.Document.8</span><br>设置<span class="hljs-string">.txt</span>为word类型的文档，可以看到<span class="hljs-string">.txt</span>文件的图标都变了<br>assoc <span class="hljs-string">.txt=txtfile</span><br>恢复<span class="hljs-string">.txt</span>的正确关联<br>ftype exefile=<span class="hljs-string">&quot;%1&quot;</span> %*<br>恢复 exefile 的正确关联<br>如果该关联已经被破坏，可以运行 <span class="hljs-keyword">command</span>.com ，再输入这条命令<br><br>36 pushd 和 popd<br>切换当前目录<br>@<span class="hljs-keyword">echo</span> off<br>c: &amp; <span class="hljs-keyword">cd</span> &amp; md mp3        <span class="hljs-comment">#在 C: 建立 mp3 文件夹</span><br>md d<span class="hljs-function">:mp4</span>                <span class="hljs-comment">#在 D: 建立 mp4 文件夹</span><br><span class="hljs-keyword">cd</span> <span class="hljs-string">/d</span> d<span class="hljs-function">:mp4</span>             <span class="hljs-comment">#更改当前目录为 d:mp4</span><br>pushd c<span class="hljs-function">:mp3</span>             <span class="hljs-comment">#保存当前目录，并切换当前目录为 c:mp3</span><br>popd                     <span class="hljs-comment">#恢复当前目录为刚才保存的 d:mp4</span><br><br>37 for<br>循环命令<br>这个比较复杂，请对照 for/? 来看<br>for %%i in <span class="hljs-params">(c: d: e: f:)</span> do <span class="hljs-keyword">echo</span> %%i<br>依次调用小括号里的每个字符串，执行 do 后面的命令<br>注意%%i，在批处理中 for 语句调用参数用2个%<br>默认的字符串分隔符是<span class="hljs-string">&quot;空格键&quot;</span>，<span class="hljs-string">&quot;Tab键&quot;</span>，<span class="hljs-string">&quot;回车键&quot;</span><br>for %%i in <span class="hljs-params">(*.txt)</span> do find <span class="hljs-string">&quot;abc&quot;</span> %%i<br>对当前目录里所有的txt文件执行 find 命令<br>for <span class="hljs-string">/r</span> . %%i in <span class="hljs-params">(*.txt)</span> do find <span class="hljs-string">&quot;abc&quot;</span> %%i<br>在当前目录和子目录里所有的<span class="hljs-string">.txt</span>文件中搜索包含 abc 字符串的行<br>for <span class="hljs-string">/r</span> . %%i in <span class="hljs-params">(.)</span> do <span class="hljs-keyword">echo</span> %%~pni<br>显示当前目录名和所有子目录名，包括路径，不包括盘符<br>for <span class="hljs-string">/r</span> d<span class="hljs-function">:mp3</span> %%i in <span class="hljs-params">(*.mp3)</span> do <span class="hljs-keyword">echo</span> %%i&gt;&gt;d<span class="hljs-function">:mp3.txt</span><br>把 d<span class="hljs-function">:mp3</span> 及其子目录里的mp3文件的文件名都存到 d<span class="hljs-function">:mp3.txt</span> 里去<br>for <span class="hljs-string">/l</span> %%i in <span class="hljs-params">(2,1,8)</span> do <span class="hljs-keyword">echo</span> %%i<br>生成2345678的一串数字，2是数字序列的开头，8是结尾，1表示每次加1<br>for <span class="hljs-string">/f</span> %%i in <span class="hljs-params">(&#x27;set&#x27;)</span> do <span class="hljs-keyword">echo</span> %%i<br>对 <span class="hljs-keyword">set</span> 命令的输出结果循环调用，每行一个<br>for <span class="hljs-string">/f</span> <span class="hljs-string">&quot;eol=P&quot;</span> %%i in <span class="hljs-params">(&#x27;set&#x27;)</span> do <span class="hljs-keyword">echo</span> %%i<br>取 <span class="hljs-keyword">set</span> 命令的输出结果，忽略以 P 开头的那几行<br>for <span class="hljs-string">/f</span> %%i in <span class="hljs-params">(d:mp3.txt)</span> do <span class="hljs-keyword">echo</span> %%i<br>显示 d<span class="hljs-function">:mp3.txt</span> 里的每个文件名，每行一个，不支持带空格的名称<br>for <span class="hljs-string">/f</span> <span class="hljs-string">&quot;delims=&quot;</span> %%i in <span class="hljs-params">(d:mp3.txt)</span> do <span class="hljs-keyword">echo</span> %%i<br>显示 d<span class="hljs-function">:mp3.txt</span> 里的每个文件名，每行一个，支持带空格的名称<br>for <span class="hljs-string">/f</span> <span class="hljs-string">&quot;skip=5 tokens=4&quot;</span> %%a in <span class="hljs-params">(&#x27;dir&#x27;)</span> do <span class="hljs-keyword">echo</span> %%a<br>对 dir 命令的结果，跳过前面5行，余下的每行取第4列<br>每列之间的分隔符为默认的<span class="hljs-string">&quot;空格&quot;</span><br>可以注意到 dir 命令输出的前5行是没有文件名的<br>for <span class="hljs-string">/f</span> <span class="hljs-string">&quot;tokens=1,2,3 delims=- &quot;</span> %%a in <span class="hljs-params">(&#x27;date /t&#x27;)</span> do <span class="hljs-params">(</span><br><span class="hljs-params">     echo %%a</span><br><span class="hljs-params">     echo %%b</span><br><span class="hljs-params">     echo %%c</span><br><span class="hljs-params">     )</span><br>如果一个循环你需要执行多条命令，可以在do后用<span class="hljs-params">()</span>括起来。对 date <span class="hljs-string">/t</span> 的输出结果，每行取1、2、3列<br>第一列对应指定的 %%a ，后面的 %%b 和 %%c 是派生出来的，对应其它列<br>分隔符指定为 - 和<span class="hljs-string">&quot;空格&quot;</span>，注意 delims=- 后面有个<span class="hljs-string">&quot;空格&quot;</span><br>其中 tokens=1,2,3 若用 tokens=1-3 替换，效果是一样的<br><br>for <span class="hljs-string">/f</span> <span class="hljs-string">&quot;tokens=2* delims=- &quot;</span> %%a in <span class="hljs-params">(&#x27;date /t&#x27;)</span> do <span class="hljs-keyword">echo</span> %%b<br>取第2列给 %%a ，其后的列都给 %%b<br><br>38 subst <span class="hljs-params">(外部命令)</span><br>映射磁盘<br>subst z: serverd      <span class="hljs-comment">#这样输入z:就可以访问serverd了</span><br>subst z: <span class="hljs-string">/d</span>              <span class="hljs-comment">#取消该映射</span><br>subst                    <span class="hljs-comment">#显示目前所有的映时</span><br><br>39   xcopy <span class="hljs-params">(外部命令)</span><br>文件拷贝<br><br>COPY和XCOPY都可以复制文件，这是它们的共处，区别如下：<br>1. COPY不能复制文件夹下的文件，而XCOPY可以。<br>如：有这样的文件结构：A盘下有2个文件夹，为A和B，在A下有1个文件和1个文件夹，为AA.TXT和AB文件夹，在AB文件夹下有个AAA的文件夹。现在要将A文件夹下所有的文件和文件夹都复制到B文件夹下，并保持原有文件结构。<br><br>解：最简单的方式就是用XCOPY命令<br>A:\&gt;XCOPY A:\A\*.* A:\B <span class="hljs-string">/S</span> <span class="hljs-string">/E</span><br>~~~~<span class="hljs-params">-------------------------</span><br><br>（~~~~表示机器反映出的内容，<span class="hljs-params">----</span>表示你输入的内容）<br><br>2. XCOPY不能连接文件，而COPY可以连接文件<br>如：将A盘中的A.TXT和B.TXT文件连接起来，连接后的文件名为C.TXT<br>解：用COPY命令即可完成此项操作。<br>A:\&gt;COPY A.TXT+B.TXT C.TXT<br><br><br>40 <span class="hljs-keyword">shutdown</span><br>关机<br><span class="hljs-keyword">shutdown</span> -s -f -t 300  <span class="hljs-comment">#300秒后强制关机</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>windows</category>
      
    </categories>
    
    
    <tags>
      
      <tag>windows</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>kubernetes之secret</title>
    <link href="/2018/11/14/kubernetes%E4%B9%8Bsecret/"/>
    <url>/2018/11/14/kubernetes%E4%B9%8Bsecret/</url>
    
    <content type="html"><![CDATA[<p>Secret解决了密码、token、密钥等敏感数据的配置问题，而不需要把这些敏感数据暴露到镜像或者Pod Spec中。Secret可以以Volume或者环境变量的方式使用。</p><h4 id="Secret类型："><a href="#Secret类型：" class="headerlink" title="Secret类型："></a>Secret类型：</h4><ol><li>Opaque：base64编码格式的Secret，用来存储密码、密钥等；但数据也通过base64 –decode解码得到原始数据，所有加密性很弱。</li><li>kubernetes.io/dockerconfigjson：用来存储私有docker registry的认证信息。</li><li>kubernetes.io/service-account-token： 用于被serviceaccount引用。serviceaccout创建时Kubernetes会默认创建对应的secret。Pod如果使用了serviceaccount，对应的secret会自动挂载到Pod目录/run/secrets/kubernetes.io/serviceaccount中。</li></ol><h5 id="1-Opaque-Secret"><a href="#1-Opaque-Secret" class="headerlink" title="1.Opaque Secret"></a>1.Opaque Secret</h5><p>Opaque类型的数据是一个map类型，要求value是base64编码格式： 比如来创建一个用户名为：admin，密码为： 1f2d1e2e67df的Secret 对象，首先把这用户名和密码做base64编码，</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> <span class="hljs-built_in">echo</span> -n <span class="hljs-string">&quot;admin&quot;</span> | base64</span><br>YWRtaW4=<br><span class="hljs-meta">$</span><span class="bash"> <span class="hljs-built_in">echo</span> -n <span class="hljs-string">&quot;1f2d1e2e67df&quot;</span> | base64</span><br>MWYyZDFlMmU2N2Rm<br></code></pre></td></tr></table></figure><p>然后就可以利用上面编码过后的数据来编写一个YAML文件：(secrets.yml)</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">apiVersion:</span> v1<br><span class="hljs-symbol">kind:</span> Secret<br><span class="hljs-symbol">metadata:</span><br><span class="hljs-symbol">  name:</span> mysecret<br><span class="hljs-symbol">type:</span> Opaque<br><span class="hljs-symbol">data:</span><br><span class="hljs-symbol">  password:</span> MWYyZDFlMmU2N2Rm<br><span class="hljs-symbol">  username:</span> YWRtaW4=<br></code></pre></td></tr></table></figure><p>同样的就可以使用kubectl命令来创建了： 创建secret：kubectl create -f secrets.yml。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># kubectl get secret</span><br><span class="hljs-attribute">NAME</span>                  TYPE                                  DATA      AGE<br><span class="hljs-attribute">default</span>-token-xxx   kubernetes.io/service-account-token   <span class="hljs-number">3</span>         <span class="hljs-number">45</span>d<br><span class="hljs-attribute">mysecret</span>              Opaque                                <span class="hljs-number">2</span>         <span class="hljs-number">7</span>s<br></code></pre></td></tr></table></figure><p>注意：其中default-token-xxx为创建集群时默认创建的secret，被serviceacount/default引用。 可以使用describe命令查看详情，如果想看到Data里面的详细信息，可以输出成YAML文件进行查看</p><p>如果是从文件创建secret，则可以用更简单的kubectl命令，比如创建tls的secret：</p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sas">$ kubectl <span class="hljs-meta">create</span> secret generic helloworld-tls \<br>  --<span class="hljs-meta">from</span>-<span class="hljs-meta">file</span>=<span class="hljs-meta">key</span>.pem \<br>  --<span class="hljs-meta">from</span>-<span class="hljs-meta">file</span>=cert.pem<br></code></pre></td></tr></table></figure><h5 id="2-Opaque-Secret的使用"><a href="#2-Opaque-Secret的使用" class="headerlink" title="2.Opaque Secret的使用"></a>2.Opaque Secret的使用</h5><p>创建好secret之后，有两种方式来使用它：</p><ul><li>以Volume方式</li><li>以环境变量方式</li><li>以Volume方式挂载制定的key</li></ul><h6 id="将Secret挂载到Volume中"><a href="#将Secret挂载到Volume中" class="headerlink" title="将Secret挂载到Volume中"></a>将Secret挂载到Volume中</h6><p>用一个Pod来验证下Volume挂载，创建一个Pod文件：(secret2-pod.yaml)</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">db</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">db</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">volumes:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">secrets</span><br>    <span class="hljs-attr">secret:</span><br>      <span class="hljs-attr">secretName:</span> <span class="hljs-string">mysecret</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">registry.martin.com:5000/my_project_id/pg:v1</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">db</span><br>    <span class="hljs-attr">volumeMounts:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">secrets</span><br>      <span class="hljs-attr">mountPath:</span> <span class="hljs-string">&quot;/etc/secrets&quot;</span><br>      <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cp</span><br>      <span class="hljs-attr">containerPort:</span> <span class="hljs-number">5432</span><br>      <span class="hljs-attr">hostPort:</span> <span class="hljs-number">5432</span><br></code></pre></td></tr></table></figure><p>查看Pod中对应的信息：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gradle"># ls <span class="hljs-regexp">/etc/</span>secrets<br>password  username<br># cat  <span class="hljs-regexp">/etc/</span>secrets/username<br>admin<br># cat  <span class="hljs-regexp">/etc/</span>secrets/password<br><span class="hljs-number">1</span>f2d1e2e67df<br></code></pre></td></tr></table></figure><p>查看输出日志：</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-variable">$ </span>kubectl logs secret2-pod<br>password<br>username<br></code></pre></td></tr></table></figure><p>可以看到secret把两个key挂载成了两个对应的文件。</p><span id="more"></span><h6 id="将Secret导出到环境变量中"><a href="#将Secret导出到环境变量中" class="headerlink" title="将Secret导出到环境变量中"></a>将Secret导出到环境变量中</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">extensions/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">wordpress-deployment</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span><br>  <span class="hljs-attr">strategy:</span><br>      <span class="hljs-attr">type:</span> <span class="hljs-string">RollingUpdate</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">wordpress</span><br>        <span class="hljs-attr">visualize:</span> <span class="hljs-string">&quot;true&quot;</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;wordpress&quot;</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">&quot;wordpress&quot;</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br>        <span class="hljs-attr">env:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">WORDPRESS_DB_USER</span><br>          <span class="hljs-attr">valueFrom:</span><br>            <span class="hljs-attr">secretKeyRef:</span><br>              <span class="hljs-attr">name:</span> <span class="hljs-string">mysecret</span><br>              <span class="hljs-attr">key:</span> <span class="hljs-string">username</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">WORDPRESS_DB_PASSWORD</span><br>          <span class="hljs-attr">valueFrom:</span><br>            <span class="hljs-attr">secretKeyRef:</span><br>              <span class="hljs-attr">name:</span> <span class="hljs-string">mysecret</span><br>              <span class="hljs-attr">key:</span> <span class="hljs-string">password</span><br></code></pre></td></tr></table></figure><p>主要上面环境变量中定义的secretKeyRef关键字，和configMapKeyRef比较类似，一个是从Secret对象中获取，一个是从ConfigMap对象中获取</p><p>创建上面的Pod：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-variable">$</span> kubectl create <span class="hljs-operator">-f</span> secret1<span class="hljs-literal">-pod</span>.yaml<br>pod <span class="hljs-string">&quot;secret1-pod&quot;</span> created<br></code></pre></td></tr></table></figure><p>然后查看Pod的日志输出：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">$ kubectl logs secret1-pod<br><span class="hljs-attribute">USERNAME</span>=admin<br><span class="hljs-attribute">PASSWORD</span>=admin321<br></code></pre></td></tr></table></figure><p>可以看到有 USERNAME 和 PASSWORD 两个环境变量输出出来。</p><h6 id="将Secret挂载指定的key"><a href="#将Secret挂载指定的key" class="headerlink" title="将Secret挂载指定的key"></a>将Secret挂载指定的key</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">db</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">db</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">volumes:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">secrets</span><br>    <span class="hljs-attr">secret:</span><br>      <span class="hljs-attr">secretName:</span> <span class="hljs-string">mysecret</span><br>      <span class="hljs-attr">items:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">password</span><br>        <span class="hljs-attr">mode:</span> <span class="hljs-number">511</span><br>        <span class="hljs-attr">path:</span> <span class="hljs-string">tst/psd</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">username</span><br>        <span class="hljs-attr">mode:</span> <span class="hljs-number">511</span><br>        <span class="hljs-attr">path:</span> <span class="hljs-string">tst/usr</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">db</span><br>    <span class="hljs-attr">volumeMounts:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">secrets</span><br>      <span class="hljs-attr">mountPath:</span> <span class="hljs-string">&quot;/etc/secrets&quot;</span><br>      <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cp</span><br>      <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br>      <span class="hljs-attr">hostPort:</span> <span class="hljs-number">5432</span><br></code></pre></td></tr></table></figure><p>可以直接用kubectl命令来创建用于docker registry认证的secret：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">$ kubectl create<span class="hljs-built_in"> secret </span>docker-registry myregistrykey <span class="hljs-attribute">--docker-server</span>=DOCKER_REGISTRY_SERVER <span class="hljs-attribute">--docker-username</span>=DOCKER_USER <span class="hljs-attribute">--docker-password</span>=DOCKER_PASSWORD <span class="hljs-attribute">--docker-email</span>=DOCKER_EMAIL<span class="hljs-built_in"></span><br><span class="hljs-built_in">secret </span><span class="hljs-string">&quot;myregistrykey&quot;</span> created.<br></code></pre></td></tr></table></figure><p>查看secret的内容：</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-meta"># kubectl get secret myregistrykey  -o yaml</span><br><span class="hljs-symbol">apiVersion:</span> v1<br><span class="hljs-symbol">data:</span><br>  .dockercfg: eyJjY3IuY2NzLnRlbmNlbnR5dW4uY29tL3RlbmNlbnR5dW4iOnsidXNlcm5hbWUiOiIzMzIxMzM3OTk0IiwicGFzc3dvcmQiOiIxMjM0NTYuY29tIiwiZW1haWwiOiIzMzIxMzM3OTk0QHFxLmNvbSIsImF1dGgiOiJNek15TVRNek56azVORG94TWpNME5UWXVZMjl0In19<br><span class="hljs-symbol">kind:</span> Secret<br><span class="hljs-symbol">metadata:</span><br><span class="hljs-symbol">  creationTimestamp:</span> <span class="hljs-number">2017</span><span class="hljs-number">-08</span><span class="hljs-number">-04</span>T02:<span class="hljs-number">06</span>:<span class="hljs-number">05</span>Z<br><span class="hljs-symbol">  name:</span> myregistrykey<br><span class="hljs-symbol">  namespace:</span> default<br><span class="hljs-symbol">  resourceVersion:</span> <span class="hljs-string">&quot;1374279324&quot;</span><br><span class="hljs-symbol">  selfLink:</span> <span class="hljs-meta-keyword">/api/</span>v1<span class="hljs-meta-keyword">/namespaces/</span>default<span class="hljs-meta-keyword">/secrets/</span>myregistrykey<br><span class="hljs-symbol">  uid:</span> <span class="hljs-number">78f</span>6a423<span class="hljs-number">-78</span>b9<span class="hljs-number">-11e7</span>-a70a<span class="hljs-number">-525400</span>bc11f0<br><span class="hljs-symbol">type:</span> kubernetes.io/dockercfg<br></code></pre></td></tr></table></figure><p>也可以直接读取~/.dockercfg的内容来创建：</p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sas">$ kubectl <span class="hljs-meta">create</span> secret docker-registry myregistrykey \<br>  --<span class="hljs-meta">from</span>-<span class="hljs-meta">file</span>=<span class="hljs-string">&quot;~/.docker/config.json&quot;</span><br></code></pre></td></tr></table></figure><p>在创建Pod的时候，通过imagePullSecrets来引用刚创建的myregistrykey:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">foo</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">foo</span><br>      <span class="hljs-attr">image:</span> <span class="hljs-string">janedoe/awesomeapp:v1</span><br>  <span class="hljs-attr">imagePullSecrets:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">myregistrykey</span><br></code></pre></td></tr></table></figure><p>kubernetes.io/service-account-token： 用于被serviceaccount引用。serviceaccout创建时Kubernetes会默认创建对应的secret。Pod如果使用了serviceaccount，对应的secret会自动挂载到Pod的/run/secrets/kubernetes.io/serviceaccount目录中。</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs arduino">$ kubectl run nginx --image nginx<br>deployment <span class="hljs-string">&quot;nginx&quot;</span> created<br>$ kubectl get pods<br>NAME                     READY     STATUS    RESTARTS   AGE<br>nginx<span class="hljs-number">-3137573019</span>-md1u2   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>       Running   <span class="hljs-number">0</span>          <span class="hljs-number">13</span>s<br>$ kubectl exec nginx<span class="hljs-number">-3137573019</span>-md1u2 ls /run/secrets/kubernetes.io/serviceaccount<br>ca.crt<br><span class="hljs-keyword">namespace</span><br>token<br></code></pre></td></tr></table></figure><h5 id="Secret与ConfigMap对比"><a href="#Secret与ConfigMap对比" class="headerlink" title="Secret与ConfigMap对比"></a>Secret与ConfigMap对比</h5><p>相同点：</p><ul><li>key/value的形式</li><li>属于某个特定的namespace</li><li>可以导出到环境变量</li><li>可以通过目录/文件形式挂载(支持挂载所有key和部分key)</li></ul><p>不同点：</p><ul><li>Secret可以被ServerAccount关联(使用)</li><li>Secret可以存储register的鉴权信息，用在ImagePullSecret参数中，用于拉取私有仓库的镜像</li><li>Secret支持Base64加密</li><li>Secret分为kubernetes.io/Service Account，kubernetes.io/dockerconfigjson，Opaque三种类型,Configmap不区分类型</li><li>Secret文件存储在tmpfs文件系统中，Pod删除后Secret文件也会对应的删除。</li></ul>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>生成k8s证书的三种方式</title>
    <link href="/2018/08/21/%E7%94%9F%E6%88%90k8s%E8%AF%81%E4%B9%A6%E7%9A%84%E4%B8%89%E7%A7%8D%E6%96%B9%E5%BC%8F/"/>
    <url>/2018/08/21/%E7%94%9F%E6%88%90k8s%E8%AF%81%E4%B9%A6%E7%9A%84%E4%B8%89%E7%A7%8D%E6%96%B9%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<p>根据官方文档，生成k8s秘钥证书及相关管理证书有三种方式，其本质都是通过openssl:</p><ul><li>cfssl</li><li>easyrsa</li><li>openssl</li></ul><p>官方文档：<a href="https://kubernetes.io/docs/concepts/cluster-administration/certificates/">https://kubernetes.io/docs/concepts/cluster-administration/certificates/</a></p><h5 id="cfssl方式"><a href="#cfssl方式" class="headerlink" title="cfssl方式"></a>cfssl方式</h5><h6 id="1-cfssl下载地址"><a href="#1-cfssl下载地址" class="headerlink" title="1.cfssl下载地址:"></a>1.cfssl下载地址:</h6><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">VERSION=R1.<span class="hljs-number">2</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> &#123;cfssl,cfssljson,cfssl-certinfo&#125;<br><span class="hljs-keyword">do</span><br>wget https:<span class="hljs-regexp">//</span>pkg.cfssl.org<span class="hljs-regexp">/$&#123;VERSION&#125;/</span><span class="hljs-variable">$&#123;i&#125;</span>_linux-amd64 -O <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span><span class="hljs-variable">$&#123;i&#125;</span><br>done<br></code></pre></td></tr></table></figure><h6 id="2-生成CA配置文件"><a href="#2-生成CA配置文件" class="headerlink" title="2.生成CA配置文件"></a>2.生成CA配置文件</h6><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs arduino">mkdir ssl &amp;&amp; cd ssl<br>cfssl print-defaults config &gt; config.json<br>cfssl print-defaults csr &gt; csr.json<br>cat &gt; ca-config.json &lt;&lt;EOF<br>&#123;<br>  <span class="hljs-string">&quot;signing&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;default&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;expiry&quot;</span>: <span class="hljs-string">&quot;87600h&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;profiles&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;kubernetes&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;usages&quot;</span>: [<br>            <span class="hljs-string">&quot;signing&quot;</span>,<br>            <span class="hljs-string">&quot;key encipherment&quot;</span>,<br>            <span class="hljs-string">&quot;server auth&quot;</span>,<br>            <span class="hljs-string">&quot;client auth&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;expiry&quot;</span>: <span class="hljs-string">&quot;87600h&quot;</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br>EOF<br></code></pre></td></tr></table></figure><h6 id="3-生成CA签名配置文件"><a href="#3-生成CA签名配置文件" class="headerlink" title="3.生成CA签名配置文件"></a>3.生成CA签名配置文件</h6><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">cat</span> &gt; <span class="hljs-keyword">ca</span>-csr.json &lt;&lt; EOF<br>&#123;<br>  <span class="hljs-string">&quot;CN&quot;</span>: <span class="hljs-string">&quot;kubernetes&quot;</span>,<br>  <span class="hljs-string">&quot;key&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;algo&quot;</span>: <span class="hljs-string">&quot;rsa&quot;</span>,<br>    <span class="hljs-string">&quot;size&quot;</span>: 2048<br>  &#125;,<br>  <span class="hljs-string">&quot;names&quot;</span>:[&#123;<br>    <span class="hljs-string">&quot;C&quot;</span>: <span class="hljs-string">&quot;CN&quot;</span>,<br>    <span class="hljs-string">&quot;ST&quot;</span>: <span class="hljs-string">&quot;Beijing&quot;</span>,<br>    <span class="hljs-string">&quot;L&quot;</span>: <span class="hljs-string">&quot;BeiJing&quot;</span>,<br>    <span class="hljs-string">&quot;O&quot;</span>: <span class="hljs-string">&quot;k8s&quot;</span>,<br>    <span class="hljs-string">&quot;OU&quot;</span>: <span class="hljs-string">&quot;System&quot;</span><br>  &#125;]<br>&#125;<br>EOF<br></code></pre></td></tr></table></figure><span id="more"></span><h6 id="4-生成私钥和证书"><a href="#4-生成私钥和证书" class="headerlink" title="4.生成私钥和证书"></a>4.生成私钥和证书</h6><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata">cfssl gencert -initca <span class="hljs-keyword">ca</span>-csr.json | cfssljson -bare <span class="hljs-keyword">ca</span><br></code></pre></td></tr></table></figure><h6 id="5-创建一个用于生成API-Server的密钥和证书的JSON配置文件"><a href="#5-创建一个用于生成API-Server的密钥和证书的JSON配置文件" class="headerlink" title="5.创建一个用于生成API Server的密钥和证书的JSON配置文件"></a>5.创建一个用于生成API Server的密钥和证书的JSON配置文件</h6><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">cat &gt; kubernetes-csr.<span class="hljs-keyword">json </span>&lt;&lt;EOF<br>&#123;<br>  <span class="hljs-string">&quot;CN&quot;</span>: <span class="hljs-string">&quot;kubernetes&quot;</span>,<br>  <span class="hljs-string">&quot;hosts&quot;</span>: [<br>    <span class="hljs-string">&quot;127.0.0.1&quot;</span>,<br>    <span class="hljs-string">&quot;&lt;MASTER_IP&gt;&quot;</span>,<br>    <span class="hljs-string">&quot;&lt;MASTER_CLUSTER_IP&gt;&quot;</span>,<br>    <span class="hljs-string">&quot;kubernetes&quot;</span>,<br>    <span class="hljs-string">&quot;kubernetes.default&quot;</span>,<br>    <span class="hljs-string">&quot;kubernetes.default.svc&quot;</span>,<br>    <span class="hljs-string">&quot;kubernetes.default.svc.cluster&quot;</span>,<br>    <span class="hljs-string">&quot;kubernetes.default.svc.cluster.local&quot;</span><br>  ],<br>  <span class="hljs-string">&quot;key&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;algo&quot;</span>: <span class="hljs-string">&quot;rsa&quot;</span>,<br>    <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">2048</span><br>  &#125;,<br>  <span class="hljs-string">&quot;names&quot;</span>: [&#123;<br>    <span class="hljs-string">&quot;C&quot;</span>: <span class="hljs-string">&quot;CN&quot;</span>,<br>    <span class="hljs-string">&quot;ST&quot;</span>: <span class="hljs-string">&quot;Beijing&quot;</span>,<br>    <span class="hljs-string">&quot;L&quot;</span>: <span class="hljs-string">&quot;BeiJing&quot;</span>,<br>    <span class="hljs-string">&quot;O&quot;</span>: <span class="hljs-string">&quot;k8s&quot;</span>,<br>    <span class="hljs-string">&quot;OU&quot;</span>: <span class="hljs-string">&quot;System&quot;</span><br>  &#125;]<br>&#125; <br>EOF<br><span class="hljs-comment">#该文件需要包含所有使用该证书的ip和域名列表，包括etcd集群、kubernetes master集群、以及apiserver 集群内部cluster ip。</span><br></code></pre></td></tr></table></figure><h6 id="6-生成-kubernetes-证书和私钥"><a href="#6-生成-kubernetes-证书和私钥" class="headerlink" title="6.生成 kubernetes 证书和私钥"></a>6.生成 kubernetes 证书和私钥</h6><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">cfssl gencert <span class="hljs-attribute">-ca</span>=ca.pem <span class="hljs-attribute">-ca-key</span>=ca-key.pem <span class="hljs-attribute">-config</span>=ca-config.json <span class="hljs-attribute">-profile</span>=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes<br></code></pre></td></tr></table></figure><h6 id="7-创建admin证书"><a href="#7-创建admin证书" class="headerlink" title="7.创建admin证书"></a>7.创建admin证书</h6><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">cat &gt; <span class="hljs-keyword">admin</span>-csr.json &lt;&lt;EOF<br>&#123;<br>  &quot;CN&quot;: &quot;admin&quot;,<br>  &quot;hosts&quot;: [],<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: <span class="hljs-number">2048</span><br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;ST&quot;: &quot;BeiJing&quot;,<br>      &quot;L&quot;: &quot;BeiJing&quot;,<br>      &quot;O&quot;: &quot;system:masters&quot;,<br>      &quot;OU&quot;: &quot;System&quot;<br>    &#125;<br>  ]<br>&#125;<br>EOF<br><br>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes <span class="hljs-keyword">admin</span>-csr.json | cfssljson -bare <span class="hljs-keyword">admin</span><br># 证书O配置为<span class="hljs-keyword">system</span>:masters 在集群内部<span class="hljs-keyword">cluster</span>-<span class="hljs-keyword">admin</span>的clusterrolebinding将<span class="hljs-keyword">system</span>:masters组和<span class="hljs-keyword">cluster</span>-<span class="hljs-keyword">admin</span> clusterrole绑定在一起<br></code></pre></td></tr></table></figure><h6 id="8-创建kube-proxy证书"><a href="#8-创建kube-proxy证书" class="headerlink" title="8.创建kube-proxy证书"></a>8.创建kube-proxy证书</h6><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">cat</span> &gt; kube-proxy-csr.json &lt;&lt; EOF<br>&#123;<br>  <span class="hljs-string">&quot;CN&quot;</span>: <span class="hljs-string">&quot;system:kube-proxy&quot;</span>,<br>  <span class="hljs-string">&quot;hosts&quot;</span>: [],<br>  <span class="hljs-string">&quot;key&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;algo&quot;</span>: <span class="hljs-string">&quot;rsa&quot;</span>,<br>    <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">2048</span><br>  &#125;,<br>  <span class="hljs-string">&quot;names&quot;</span>: [<br>    &#123;<br>      <span class="hljs-string">&quot;C&quot;</span>: <span class="hljs-string">&quot;CN&quot;</span>,<br>      <span class="hljs-string">&quot;ST&quot;</span>: <span class="hljs-string">&quot;BeiJing&quot;</span>,<br>      <span class="hljs-string">&quot;L&quot;</span>: <span class="hljs-string">&quot;BeiJing&quot;</span>,<br>      <span class="hljs-string">&quot;O&quot;</span>: <span class="hljs-string">&quot;k8s&quot;</span>,<br>      <span class="hljs-string">&quot;OU&quot;</span>: <span class="hljs-string">&quot;System&quot;</span><br>    &#125;<br>  ]<br>&#125;<br>EOF<br>cfssl gencert -<span class="hljs-keyword">ca</span>=<span class="hljs-keyword">ca</span>.pem -<span class="hljs-keyword">ca</span>-key=<span class="hljs-keyword">ca</span>-key.pem -config=<span class="hljs-keyword">ca</span>-config.json -<span class="hljs-keyword">profile</span>=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy<br># 该证书用户名为<span class="hljs-built_in">system</span>:kube-proxy，预定义的<span class="hljs-built_in">system</span>:node-proxier clusterrolebindings将 <span class="hljs-built_in">system</span>:kube-proxy用户和<span class="hljs-built_in">system</span>:node-proxier角色绑定在一起<br></code></pre></td></tr></table></figure><h6 id="9-校验证书信息"><a href="#9-校验证书信息" class="headerlink" title="9.校验证书信息"></a>9.校验证书信息</h6><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">cfssl</span>-certinfo -cert kubernetes.pem<br><span class="hljs-attribute">openssl</span> x<span class="hljs-number">509</span>  -noout -text -in  kubernetes.pem<br></code></pre></td></tr></table></figure><h6 id="10-拷贝证书"><a href="#10-拷贝证书" class="headerlink" title="10.拷贝证书"></a>10.拷贝证书</h6><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">mkdir -p <span class="hljs-regexp">/etc/</span>kubernetes<span class="hljs-regexp">/ssl/</span> &amp;&amp; cp *.pem <span class="hljs-regexp">/etc/</span>kubernetes<span class="hljs-regexp">/ssl/</span><br></code></pre></td></tr></table></figure><h5 id="easyrsa方式"><a href="#easyrsa方式" class="headerlink" title="easyrsa方式"></a>easyrsa方式</h5><h6 id="1-下载："><a href="#1-下载：" class="headerlink" title="1.下载："></a>1.下载：</h6><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">curl -L -O https:<span class="hljs-string">//storage.googleapis.com/kubernetes-release/easy-rsa/easy-rsa.tar.gz</span><br>tar xzf easy-rsa.tar.gz<br><span class="hljs-keyword">cd</span> easy-rsa-master/easyrsa3<br><span class="hljs-string">./easyrsa</span> init-pki<br><span class="hljs-string">./easyrsa</span> <span class="hljs-params">--batch</span> <span class="hljs-string">&quot;--req-cn=172.26.6.1@`date +%s`&quot;</span> build-ca nopass<br></code></pre></td></tr></table></figure><h6 id="2-生成-kubernetes-证书和私钥"><a href="#2-生成-kubernetes-证书和私钥" class="headerlink" title="2.生成 kubernetes 证书和私钥"></a>2.生成 kubernetes 证书和私钥</h6><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">./easyrsa --<span class="hljs-attr">subject-alt-name=</span><span class="hljs-string">&quot;IP:172.26.6.1,IP:10.254.0.1,DNS:kubernetes.default&quot;</span> build-server-full kubernetes-<span class="hljs-keyword">master</span> <span class="hljs-title">nopass</span><br></code></pre></td></tr></table></figure><h6 id="3-签发admin证书"><a href="#3-签发admin证书" class="headerlink" title="3.签发admin证书"></a>3.签发admin证书</h6><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-string">./easyrsa</span> <span class="hljs-params">--dn-mode=org</span> <span class="hljs-params">--req-cn=admin</span> <span class="hljs-params">--req-org=system</span><span class="hljs-function">:masters</span> <span class="hljs-params">--req-c=</span> <span class="hljs-params">--req-st=</span> <span class="hljs-params">--req-city=</span> <span class="hljs-params">--req-email=</span> <span class="hljs-params">--req-ou=</span> build-client-full admin nopass<br></code></pre></td></tr></table></figure><h5 id="openssl方式"><a href="#openssl方式" class="headerlink" title="openssl方式"></a>openssl方式</h5><h6 id="1-生成ca"><a href="#1-生成ca" class="headerlink" title="1.生成ca"></a>1.生成ca</h6><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sas">openssl genrsa -<span class="hljs-meta">out</span> ca.<span class="hljs-meta">key</span> 2048<br>openssl req -x509 -new -nodes -<span class="hljs-meta">key</span> ca.<span class="hljs-meta">key</span> -subj <span class="hljs-string">&quot;/CN=172.26.6.1&quot;</span> -days 10000 -<span class="hljs-meta">out</span> ca.crt<br></code></pre></td></tr></table></figure><h6 id="2-kubernetes证书和私钥"><a href="#2-kubernetes证书和私钥" class="headerlink" title="2.kubernetes证书和私钥"></a>2.kubernetes证书和私钥</h6><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs stylus">openssl genrsa -out server<span class="hljs-selector-class">.key</span> <span class="hljs-number">2048</span><br>cat &gt;csr<span class="hljs-selector-class">.conf</span> &lt;&lt;EOF<br><span class="hljs-selector-attr">[ req ]</span><br>default_bits = <span class="hljs-number">2048</span><br>prompt = no<br>default_md = sha256<br>req_extensions = req_ext<br>distinguished_name = dn<br>    <br><span class="hljs-selector-attr">[ dn ]</span><br>C = &lt;country&gt;<br>ST = &lt;state&gt;<br>L = &lt;city&gt;<br>O = &lt;organization&gt;<br>OU = &lt;organization unit&gt;<br>CN = <span class="hljs-number">172.26</span>.<span class="hljs-number">6.1</span><br>    <br><span class="hljs-selector-attr">[ req_ext ]</span><br>subjectAltName = @alt_names<br>    <br><span class="hljs-selector-attr">[ alt_names ]</span><br>DNS.<span class="hljs-number">1</span> = kubernetes<br>DNS.<span class="hljs-number">2</span> = kubernetes<span class="hljs-selector-class">.default</span><br>DNS.<span class="hljs-number">3</span> = kubernetes<span class="hljs-selector-class">.default</span><span class="hljs-selector-class">.svc</span><br>DNS.<span class="hljs-number">4</span> = kubernetes<span class="hljs-selector-class">.default</span><span class="hljs-selector-class">.svc</span><span class="hljs-selector-class">.cluster</span><br>DNS.<span class="hljs-number">5</span> = kubernetes<span class="hljs-selector-class">.default</span><span class="hljs-selector-class">.svc</span><span class="hljs-selector-class">.cluster</span><span class="hljs-selector-class">.local</span><br>IP.<span class="hljs-number">1</span> = <span class="hljs-number">172.26</span>.<span class="hljs-number">6.1</span><br>IP.<span class="hljs-number">2</span> = <span class="hljs-number">10.254</span>.<span class="hljs-number">0.1</span><br>    <br><span class="hljs-selector-attr">[ v3_ext ]</span><br>authorityKeyIdentifier=keyid,issuer:always<br>basicConstraints=CA:FALSE<br>keyUsage=keyEncipherment,dataEncipherment<br>extendedKeyUsage=serverAuth,clientAuth<br>subjectAltName=@alt_names<br>EOF<br><br>openssl req -new -key server<span class="hljs-selector-class">.key</span> -out server<span class="hljs-selector-class">.csr</span> -config csr<span class="hljs-selector-class">.conf</span><br>openssl x509 -req -<span class="hljs-keyword">in</span> server<span class="hljs-selector-class">.csr</span> -CA ca<span class="hljs-selector-class">.crt</span> -CAkey ca<span class="hljs-selector-class">.key</span> -CAcreateserial -out server<span class="hljs-selector-class">.crt</span> -days <span class="hljs-number">10000</span> -extensions v3_ext -extfile csr<span class="hljs-selector-class">.conf</span><br>openssl x509  -noout -text -<span class="hljs-keyword">in</span> ./server.crt<br></code></pre></td></tr></table></figure><h6 id="3-admin证书"><a href="#3-admin证书" class="headerlink" title="3.admin证书"></a>3.admin证书</h6><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">openssl genrsa -<span class="hljs-keyword">out</span> <span class="hljs-keyword">admin</span>.key <span class="hljs-number">2048</span><br>openssl req -<span class="hljs-built_in">new</span> -key <span class="hljs-keyword">admin</span>.key -<span class="hljs-keyword">out</span> <span class="hljs-keyword">admin</span>.csr -subj &quot;/O=system:masters/CN=dmin&quot;<br>openssl x509 -req -set_serial $(<span class="hljs-type">date</span> +%s%N) -<span class="hljs-keyword">in</span> <span class="hljs-keyword">admin</span>.csr -CA ca.crt -CAkey ca.key -<span class="hljs-keyword">out</span> <span class="hljs-keyword">admin</span>.crt -days <span class="hljs-number">365</span> -extensions v3_req -extfile req.conf<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>只在移动端网页内显示”Fork me on Github”</title>
    <link href="/2018/08/19/%E5%8F%AA%E5%9C%A8%E7%A7%BB%E5%8A%A8%E7%AB%AF%E7%BD%91%E9%A1%B5%E5%86%85%E6%98%BE%E7%A4%BA%E2%80%9DFork-me-on-Github%E2%80%9D/"/>
    <url>/2018/08/19/%E5%8F%AA%E5%9C%A8%E7%A7%BB%E5%8A%A8%E7%AB%AF%E7%BD%91%E9%A1%B5%E5%86%85%E6%98%BE%E7%A4%BA%E2%80%9DFork-me-on-Github%E2%80%9D/</url>
    
    <content type="html"><![CDATA[<h5 id="1-修改文件hexo博客根目录-themes-next-layout-layout-swig-找到如下代码块"><a href="#1-修改文件hexo博客根目录-themes-next-layout-layout-swig-找到如下代码块" class="headerlink" title="1.修改文件hexo博客根目录\themes\next\layout_layout.swig 找到如下代码块"></a>1.修改文件hexo博客根目录\themes\next\layout_layout.swig 找到如下代码块</h5><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs django"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;</span></span></span><span class="hljs-template-variable">&#123;&#123; html_class | lower &#125;&#125;</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">&quot;</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;</span></span></span><span class="hljs-template-variable">&#123;&#123; config.language &#125;&#125;</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">&quot;</span>&gt;</span></span><br><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></span><br><span class="xml">  </span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">include</span></span> &#x27;_partials/head.swig&#x27; %&#125;</span><span class="xml"></span><br><span class="xml">  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span></span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">block</span></span> title %&#125;</span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">endblock</span></span> %&#125;</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></span><br></code></pre></td></tr></table></figure><h5 id="2-添加代码，结果如下："><a href="#2-添加代码，结果如下：" class="headerlink" title="2.添加代码，结果如下："></a>2.添加代码，结果如下：</h5><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs django"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;</span></span></span><span class="hljs-template-variable">&#123;&#123; html_class | lower &#125;&#125;</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">&quot;</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;</span></span></span><span class="hljs-template-variable">&#123;&#123; config.language &#125;&#125;</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">&quot;</span>&gt;</span></span><br><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></span><br><span class="xml">  </span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">include</span></span> &#x27;_partials/head.swig&#x27; %&#125;</span><span class="xml"></span><br><span class="xml">  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span></span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">block</span></span> title %&#125;</span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">endblock</span></span> %&#125;</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></span><br><span class="xml">  </span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">include</span></span> &#x27;_third-party/analytics/index.swig&#x27; %&#125;</span><span class="xml"></span><br><span class="xml">  </span><br><span class="xml">  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css"></span></span><br><span class="css"><span class="xml">  <span class="hljs-selector-class">.forkMeOnGithub</span>&#123;</span></span><br><span class="css"><span class="xml">  <span class="hljs-attribute">display</span>: none;</span></span><br><span class="css"><span class="xml">  &#125;</span></span><br><span class="css"><span class="xml">  <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">768px</span>) &#123;</span></span><br><span class="css"><span class="xml">  <span class="hljs-selector-class">.forkMeOnGithub</span>&#123;</span></span><br><span class="css"><span class="xml">   <span class="hljs-attribute">display</span>: inline;</span></span><br><span class="css"><span class="xml">   &#125;</span></span><br><span class="css"><span class="xml">  &#125;</span></span><br><span class="css"><span class="xml">  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span><br><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></span><br></code></pre></td></tr></table></figure><h5 id="3-最后在之前引用代码块上套上div加上class就行了，代码如下"><a href="#3-最后在之前引用代码块上套上div加上class就行了，代码如下" class="headerlink" title="3.最后在之前引用代码块上套上div加上class就行了，代码如下"></a>3.最后在之前引用代码块上套上div加上class就行了，代码如下</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">&lt;div <span class="hljs-attribute">class</span>=<span class="hljs-string">&quot;forkMeOnGithub&quot;</span>&gt;<br>&lt;a <span class="hljs-attribute">href</span>=<span class="hljs-string">&quot;https://github.com/hannius&quot;</span>&gt;&lt;img <span class="hljs-attribute">style</span>=<span class="hljs-string">&quot;position........&lt;/a&gt;</span><br><span class="hljs-string">&lt;/div&gt;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>hexo</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MySQL5.6  5.7 SSL Config</title>
    <link href="/2018/07/19/MySQL5-6-5-7-SSL-Config/"/>
    <url>/2018/07/19/MySQL5-6-5-7-SSL-Config/</url>
    
    <content type="html"><![CDATA[<h3 id="5-7"><a href="#5-7" class="headerlink" title="5.7"></a>5.7</h3><h4 id="1-mysql5-7上开启并配置ssl"><a href="#1-mysql5-7上开启并配置ssl" class="headerlink" title="1.mysql5.7上开启并配置ssl"></a>1.mysql5.7上开启并配置ssl</h4><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">[root@mysqlmaster01 bin]# ./mysql_ssl_rsa_setup --datadir=/data/mysql_data1/ --user=mysql<br><br>Generating a 2048 bit RSA private key<br>............................................................................<span class="hljs-code">+++</span><br>............<span class="hljs-code">+++</span><br><span class="hljs-section">writing new private key to &#x27;ca-key.pem&#x27;</span><br><span class="hljs-section">-----</span><br>Generating a 2048 bit RSA private key<br>.......................<span class="hljs-code">+++</span><br>..........................<span class="hljs-code">+++</span><br><span class="hljs-section">writing new private key to &#x27;server-key.pem&#x27;</span><br><span class="hljs-section">-----</span><br>Generating a 2048 bit RSA private key<br>...........<span class="hljs-code">+++</span><br>..........<span class="hljs-code">+++</span><br><span class="hljs-section">writing new private key to &#x27;client-key.pem&#x27;</span><br><span class="hljs-section">-----</span><br></code></pre></td></tr></table></figure><p>查看：</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">mysql&gt; show variables like &#x27;%ssl%&#x27;;<br>+---------------+-----------------+<br>|<span class="hljs-string"> Variable_name </span>|<span class="hljs-string"> Value </span>|<br>+---------------+-----------------+<br>|<span class="hljs-string"> have_openssl </span>|<span class="hljs-string"> DISABLED </span>|<br>|<span class="hljs-string"> have_ssl </span>|<span class="hljs-string"> DISABLED </span>|<br>|<span class="hljs-string"> ssl_ca </span>|<span class="hljs-string"> ca.pem </span>|<br>|<span class="hljs-string"> ssl_capath </span>|<span class="hljs-string"> </span>|<br>|<span class="hljs-string"> ssl_cert </span>|<span class="hljs-string"> server-cert.pem </span>|<br>|<span class="hljs-string"> ssl_cipher </span>|<span class="hljs-string"> </span>|<br>|<span class="hljs-string"> ssl_crl </span>|<span class="hljs-string"> </span>|<br>|<span class="hljs-string"> ssl_crlpath </span>|<span class="hljs-string"> </span>|<br>|<span class="hljs-string"> ssl_key </span>|<span class="hljs-string"> server-key.pem </span>|<br>+---------------+-----------------+<br>9 rows in set (0.01 sec)<br></code></pre></td></tr></table></figure><p>(SSL还是没有启用)</p><p>解决办法：把数据目录下.pem的文件，属主和属组改成mysql</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@mysqlmaster01</span> mysql_data1]<span class="hljs-meta"># chown -R mysql.mysql *.pem</span><br></code></pre></td></tr></table></figure><p>然后重启服务</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">[root<span class="hljs-meta">@mysqlmaster01</span> mysql_data1]<span class="hljs-comment"># /etc/init.d/mysqld_multi stop 1</span><br><br>[root<span class="hljs-meta">@mysqlmaster01</span> mysql_data1]<span class="hljs-comment"># /etc/init.d/mysqld_multi start 1</span><br>[root<span class="hljs-meta">@mysqlmaster01</span> mysql_data1]<span class="hljs-comment"># /etc/init.d/mysqld_multi report</span><br>Reporting MySQL servers<br>MySQL server from group: mysqld1 is running<br><br>[root<span class="hljs-meta">@mysqlmaster01</span> mysql_data1]<span class="hljs-comment"># mysql --login-path=mysql1 -e &quot;show variables like &#x27;have%ssl%&#x27;;&quot;</span><br>+---------------+-------+<br>|<span class="hljs-string"> Variable_name </span>|<span class="hljs-string"> Value </span>|<br>+---------------+-------+<br>|<span class="hljs-string"> have_openssl </span>|<span class="hljs-string"> YES </span>|<br>|<span class="hljs-string"> have_ssl </span>|<span class="hljs-string"> YES </span>|<br>+---------------+-------+<br><br>(说明ssl已经启用）<br></code></pre></td></tr></table></figure><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@mysqlmaster01 mysql_data1]<span class="hljs-comment"># ll *.pem</span><br>-rw-------.<span class="hljs-number"> 1 </span>mysql mysql<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 24 </span>11:14 ca-key.pem<br>-rw-r--r--.<span class="hljs-number"> 1 </span>mysql mysql<span class="hljs-number"> 1107 </span>Nov<span class="hljs-number"> 24 </span>11:14 ca.pem<br>-rw-r--r--.<span class="hljs-number"> 1 </span>mysql mysql<span class="hljs-number"> 1107 </span>Nov<span class="hljs-number"> 24 </span>11:14 client-cert.pem<br>-rw-------.<span class="hljs-number"> 1 </span>mysql mysql<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 24 </span>11:14 client-key.pem<br>-rw-------.<span class="hljs-number"> 1 </span>mysql mysql<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 24 </span>11:14 private_key.pem<br>-rw-r--r--.<span class="hljs-number"> 1 </span>mysql mysql<span class="hljs-number"> 451 </span>Nov<span class="hljs-number"> 24 </span>11:14 public_key.pem<br>-rw-r--r--.<span class="hljs-number"> 1 </span>mysql mysql<span class="hljs-number"> 1107 </span>Nov<span class="hljs-number"> 24 </span>11:14 server-cert.pem<br>-rw-------.<span class="hljs-number"> 1 </span>mysql mysql<span class="hljs-number"> 1675 </span>Nov<span class="hljs-number"> 24 </span>11:14 server-key.pem<br></code></pre></td></tr></table></figure><h4 id="2-通过ssl进行连接："><a href="#2-通过ssl进行连接：" class="headerlink" title="2.通过ssl进行连接："></a>2.通过ssl进行连接：</h4><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs smali">[root@mysqlmaster01 mysql_data2]<span class="hljs-comment"># mysql -u ssl -p -h 10.2.11.226 --ssl-cert=/data/mysql_data2/client-cert.pem --ssl-key=/data/mysql_data2/client-key.pem -P 3307</span><br>Enter password: <br>Welcome to the MySQ<span class="hljs-class">L monitor. Commands end with ;</span><span class="hljs-built_in"> or </span>\g.<br>Your MySQL connection id is 15<br>Server version: 5.7.20-log MySQL Community Server (GPL)<br><br>Copyright (c) 2000, 2017, Oracle<span class="hljs-built_in"> and/or </span>its affiliates. All rights reserved.<br><br>Oracle is a registered trademark of Oracle Corporation<span class="hljs-built_in"> and/or </span>its<br>affiliates. Other names may be trademarks of their respective<br>owners.<br><br>Type &#x27;help;&#x27;<span class="hljs-built_in"> or </span>&#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.<br><br>mysql&gt; \q<br></code></pre></td></tr></table></figure><p>(默认如果授权没有做任何限制，用户既可以通过秘钥登录,也可以通过用户名和密码登录)</p><h4 id="3-用户授权规定只能通过ssl方式登录"><a href="#3-用户授权规定只能通过ssl方式登录" class="headerlink" title="3.用户授权规定只能通过ssl方式登录"></a>3.用户授权规定只能通过ssl方式登录</h4><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">mysql</span>&gt; create user &#x27;tom&#x27;@&#x27;<span class="hljs-number">10</span>.<span class="hljs-number">2</span>.<span class="hljs-number">11</span>.%&#x27; identified by &#x27;Aa<span class="hljs-number">123456</span>&#x27;;<br><span class="hljs-attribute">Query</span> OK, <span class="hljs-number">0</span> rows affected (<span class="hljs-number">0</span>.<span class="hljs-number">00</span> sec)<br><br><span class="hljs-attribute">mysql</span>&gt; grant <span class="hljs-literal">all</span> <span class="hljs-literal">on</span> *.* to &#x27;tom&#x27;@&#x27;<span class="hljs-number">10</span>.<span class="hljs-number">2</span>.<span class="hljs-number">11</span>.%&#x27; require ssl;<br><span class="hljs-attribute">Query</span> OK, <span class="hljs-number">0</span> rows affected, <span class="hljs-number">1</span> warning (<span class="hljs-number">0</span>.<span class="hljs-number">00</span> sec)<br></code></pre></td></tr></table></figure><h4 id="4-测试"><a href="#4-测试" class="headerlink" title="4.测试"></a>4.测试</h4><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">[root@mysqlmaster01 ~]# mysql -u tom -p -h 10.2.11.226 --ssl-mode <span class="hljs-emphasis">&#x27;REQUIRED&#x27;</span> -P 3306 <br>Enter password: <br>Welcome to the MySQL monitor. Commands end with ; or \g.<br><br><span class="hljs-section">mysql&gt; \s</span><br><span class="hljs-section">--------------</span><br>mysql Ver 14.14 Distrib 5.7.20, for linux-glibc2.12 (x86_64) using EditLine wrapper<br><br>Connection id:25<br>Current database:<br>Current user:tom@10.2.11.226<br>SSL:Cipher in use is DHE-RSA-AES256-SHA<br>Current pager:stdout<br>Using outfile:&#x27;&#x27;<br>Using delimiter:;<br>Server version:5.7.20-log MySQL Community Server (GPL)<br>Protocol version:10<br>Connection:10.2.11.226 via TCP/IP<br>Server characterset:latin1<br>Db characterset:latin1<br>Client characterset:utf8<br>Conn. characterset:utf8<br>TCP port:3306<br>Uptime:1 hour 34 min 11 sec<br><br><span class="hljs-section">Threads: 2 Questions: 56 Slow queries: 0 Opens: 124 Flush tables: 1 Open tables: 117 Queries per second avg: 0.009</span><br><span class="hljs-section">--------------</span><br></code></pre></td></tr></table></figure><h4 id="5-不仅需要ssl还需要秘钥"><a href="#5-不仅需要ssl还需要秘钥" class="headerlink" title="5.不仅需要ssl还需要秘钥"></a>5.不仅需要ssl还需要秘钥</h4><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">mysql</span>&gt; alter user &#x27;tom&#x27;@&#x27;<span class="hljs-number">10</span>.<span class="hljs-number">2</span>.<span class="hljs-number">11</span>.%&#x27; require x<span class="hljs-number">509</span>;<br><span class="hljs-attribute">Query</span> OK, <span class="hljs-number">0</span> rows affected (<span class="hljs-number">0</span>.<span class="hljs-number">01</span> sec)<br></code></pre></td></tr></table></figure><p>或者新建一个用户，要求ssl+秘钥登录</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">mysql</span>&gt; grant <span class="hljs-literal">all</span> <span class="hljs-literal">on</span> *.* to &#x27;test&#x27;@&#x27;<span class="hljs-number">10</span>.<span class="hljs-number">2</span>.<span class="hljs-number">11</span>.%&#x27; identified by &#x27;Aa<span class="hljs-number">123456</span>&#x27; require x<span class="hljs-number">509</span>;<br><span class="hljs-attribute">Query</span> OK, <span class="hljs-number">0</span> rows affected, <span class="hljs-number">1</span> warning (<span class="hljs-number">0</span>.<span class="hljs-number">01</span> sec)<br><br><span class="hljs-attribute">mysql</span>&gt; grant <span class="hljs-literal">all</span> <span class="hljs-literal">on</span> *.* to &#x27;test&#x27;@&#x27;<span class="hljs-number">10</span>.<span class="hljs-number">2</span>.<span class="hljs-number">18</span>.%&#x27; identified by &#x27;Aa<span class="hljs-number">123456</span>&#x27; require x<span class="hljs-number">509</span>;<br><span class="hljs-attribute">Query</span> OK, <span class="hljs-number">0</span> rows affected, <span class="hljs-number">1</span> warning (<span class="hljs-number">0</span>.<span class="hljs-number">01</span> sec)<br><br><span class="hljs-attribute">mysql</span>&gt; flush privileges;<br><span class="hljs-attribute">Query</span> OK, <span class="hljs-number">0</span> rows affected (<span class="hljs-number">0</span>.<span class="hljs-number">00</span> sec)<br></code></pre></td></tr></table></figure><p>测试登录：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql">[root<span class="hljs-variable">@mysqlmaster01</span> mysql_data1]# mysql <span class="hljs-operator">-</span>u test <span class="hljs-operator">-</span>p <span class="hljs-operator">-</span>h <span class="hljs-number">10.2</span><span class="hljs-number">.11</span><span class="hljs-number">.226</span> <span class="hljs-operator">-</span>P <span class="hljs-number">3306</span> <span class="hljs-comment">--ssl</span><br>WARNING: <span class="hljs-comment">--ssl is deprecated and will be removed in a future version. Use --ssl-mode instead.</span><br>Enter password: <br>ERROR <span class="hljs-number">1045</span> (<span class="hljs-number">28000</span>): Access denied <span class="hljs-keyword">for</span> <span class="hljs-keyword">user</span> <span class="hljs-string">&#x27;test&#x27;</span>@<span class="hljs-string">&#x27;10.2.11.226&#x27;</span> (<span class="hljs-keyword">using</span> password: YES)<br><br>[root<span class="hljs-variable">@mysqlmaster01</span> mysql_data1]# mysql <span class="hljs-operator">-</span>u test <span class="hljs-operator">-</span>p <span class="hljs-operator">-</span>h <span class="hljs-number">10.2</span><span class="hljs-number">.11</span><span class="hljs-number">.226</span> <span class="hljs-operator">-</span>P <span class="hljs-number">3306</span> <span class="hljs-comment">--ssl-cert=/data/dbdata/client-cert.pem --ssl-key=/data/dbdata/client-key.pem</span><br>mysql<span class="hljs-operator">&gt;</span><br></code></pre></td></tr></table></figure><h3 id="5-6"><a href="#5-6" class="headerlink" title="5.6"></a>5.6</h3><h4 id="1-加密连接服务端配置"><a href="#1-加密连接服务端配置" class="headerlink" title="1.加密连接服务端配置"></a>1.加密连接服务端配置</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[mysqld]</span><br><span class="hljs-attr">ssl-ca</span>=ca.pem<br><span class="hljs-attr">ssl-cert</span>=server-cert.pem<br><span class="hljs-attr">ssl-key</span>=server-key.pem<br></code></pre></td></tr></table></figure><p>说明：</p><ul><li>ss-ca：证书颁发机构(CA)证书文件的路径名</li><li>ssl-cert：服务器公钥证书文件的路径名。这可以发送到客户端，并通过CA证书进行身份验证。</li><li>ssl-key：服务器的私钥证书文件的路径名</li></ul><h4 id="2-客户端使用ssl"><a href="#2-客户端使用ssl" class="headerlink" title="2.客户端使用ssl"></a>2.客户端使用ssl</h4><p>案例：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">mysql  <span class="hljs-attribute">--ssl-ca</span>=ca.pem  <span class="hljs-attribute">--ssl-cert</span>=client-cert.pem  <span class="hljs-attribute">--ssl-key</span>=client-key.pem<br></code></pre></td></tr></table></figure><h4 id="3-通过openssl-制作生成-SSL-证书"><a href="#3-通过openssl-制作生成-SSL-证书" class="headerlink" title="3.通过openssl 制作生成 SSL 证书"></a>3.通过openssl 制作生成 SSL 证书</h4><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@mysqlmaster01</span> CA]<span class="hljs-meta"># touch index.txt</span><br>[root<span class="hljs-symbol">@mysqlmaster01</span> CA]<span class="hljs-meta"># echo 01&gt;serial</span><br></code></pre></td></tr></table></figure><h4 id="4-创建CA证书"><a href="#4-创建CA证书" class="headerlink" title="4.创建CA证书"></a>4.创建CA证书</h4><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs delphi">[root@server mysql56]# openssl genrsa <span class="hljs-number">2048</span> &gt; ca-key.pem<br>Generating RSA <span class="hljs-keyword">private</span> key, <span class="hljs-number">2048</span> bit long modulus<br>...............................................+++<br>......................................................................................................................+++<br>e <span class="hljs-keyword">is</span> <span class="hljs-number">65537</span> (<span class="hljs-number">0</span>x10001)<br>[root@server mysql56]# openssl req -new -x509 -nodes -days <span class="hljs-number">3600</span> -key ca-key.pem -<span class="hljs-keyword">out</span> ca.pem<br>You are about <span class="hljs-keyword">to</span> be asked <span class="hljs-keyword">to</span> enter information that will be incorporated<br>into your certificate request.<br>What you are about <span class="hljs-keyword">to</span> enter <span class="hljs-keyword">is</span> what <span class="hljs-keyword">is</span> called a Distinguished <span class="hljs-keyword">Name</span> <span class="hljs-keyword">or</span> a DN.<br>There are quite a few fields but you can leave some blank<br><span class="hljs-keyword">For</span> some fields there will be a <span class="hljs-keyword">default</span> value,<br><span class="hljs-keyword">If</span> you enter <span class="hljs-string">&#x27;.&#x27;</span>, the field will be left blank.<br>-----<br>Country <span class="hljs-keyword">Name</span> (<span class="hljs-number">2</span> letter code) [XX]:CN<br>State <span class="hljs-keyword">or</span> Province <span class="hljs-keyword">Name</span> (full <span class="hljs-keyword">name</span>) []:shanghai<br>Locality <span class="hljs-keyword">Name</span> (eg, city) [<span class="hljs-keyword">Default</span> City]:shanghai<br>Organization <span class="hljs-keyword">Name</span> (eg, company) [<span class="hljs-keyword">Default</span> Company Ltd]:als<br>Organizational <span class="hljs-keyword">Unit</span> <span class="hljs-keyword">Name</span> (eg, section) []:ops<br>Common <span class="hljs-keyword">Name</span> (eg, your <span class="hljs-keyword">name</span> <span class="hljs-keyword">or</span> your server<span class="hljs-string">&#x27;s hostname) []:ca.test.com</span><br><span class="hljs-string">Email Address []:</span><br><span class="hljs-string">[root@server mysql56]# ll *.pem</span><br><span class="hljs-string">-rw-r--r--. 1 root root 1679 Nov 24 15:15 ca-key.pem</span><br><span class="hljs-string">-rw-r--r--. 1 root root 1314 Nov 24 15:16 ca.pem</span><br></code></pre></td></tr></table></figure><h4 id="5-创建服务器证书"><a href="#5-创建服务器证书" class="headerlink" title="5.创建服务器证书"></a>5.创建服务器证书</h4><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs vbnet">[root@server mysql56]# openssl req -newkey rsa:<span class="hljs-number">2048</span> -days <span class="hljs-number">3600</span> -nodes -keyout server-<span class="hljs-keyword">key</span>.pem -out server-req.pem<br>Generating a <span class="hljs-number">2048</span> bit RSA <span class="hljs-keyword">private</span> <span class="hljs-keyword">key</span><br>......................................................+++<br>.........................+++<br>writing <span class="hljs-built_in">new</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">key</span> <span class="hljs-keyword">to</span> <span class="hljs-comment">&#x27;server-key.pem&#x27;</span><br>-----<br>You are about <span class="hljs-keyword">to</span> be asked <span class="hljs-keyword">to</span> enter information that will be incorporated<br><span class="hljs-keyword">into</span> your certificate request.<br>What you are about <span class="hljs-keyword">to</span> enter <span class="hljs-built_in">is</span> what <span class="hljs-built_in">is</span> called a Distinguished Name <span class="hljs-built_in">or</span> a DN.<br>There are quite a few fields but you can leave some blank<br><span class="hljs-keyword">For</span> some fields there will be a <span class="hljs-keyword">default</span> value,<br><span class="hljs-keyword">If</span> you enter <span class="hljs-comment">&#x27;.&#x27;, the field will be left blank.</span><br>-----<br>Country Name (<span class="hljs-number">2</span> letter code) [XX]:CN<br>State <span class="hljs-built_in">or</span> Province Name (full name) []:shanghai<br>Locality Name (eg, city) [<span class="hljs-keyword">Default</span> City]:shanghai<br>Organization Name (eg, company) [<span class="hljs-keyword">Default</span> Company Ltd]:als<br>Organizational Unit Name (eg, section) []:ops<br>Common Name (eg, your name <span class="hljs-built_in">or</span> your server<span class="hljs-comment">&#x27;s hostname) []:server.test.com</span><br>Email Address []:<br><br>Please enter the following <span class="hljs-comment">&#x27;extra&#x27; attributes</span><br><span class="hljs-keyword">to</span> be sent <span class="hljs-keyword">with</span> your certificate request<br>A challenge password []:<br>An <span class="hljs-keyword">optional</span> company name []:<br>[root@server mysql56]# openssl rsa -<span class="hljs-keyword">in</span> server-<span class="hljs-keyword">key</span>.pem -out server-<span class="hljs-keyword">key</span>.pem <br>writing RSA <span class="hljs-keyword">key</span><br><br>[root@server mysql56]# openssl x509 -req -<span class="hljs-keyword">in</span> server-req.pem -days <span class="hljs-number">3600</span> -CA ca.pem -CAkey ca-<span class="hljs-keyword">key</span>.pem -set_serial <span class="hljs-number">01</span> -out server-cert.pem<br>Signature ok<br>subject=/C=CN/ST=shanghai/L=shanghai/O=als/OU=ops/CN=server.test.com<br>Getting CA <span class="hljs-keyword">Private</span> <span class="hljs-keyword">Key</span><br></code></pre></td></tr></table></figure><h4 id="6-创建客户端证书"><a href="#6-创建客户端证书" class="headerlink" title="6.创建客户端证书"></a>6.创建客户端证书</h4><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs vbnet">[root@server mysql56]# openssl req -newkey rsa:<span class="hljs-number">2048</span> -days <span class="hljs-number">3600</span> -nodes -keyout client-<span class="hljs-keyword">key</span>.pem -out client-req.pem<br>Generating a <span class="hljs-number">2048</span> bit RSA <span class="hljs-keyword">private</span> <span class="hljs-keyword">key</span><br>.+++<br>...............................................+++<br>writing <span class="hljs-built_in">new</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">key</span> <span class="hljs-keyword">to</span> <span class="hljs-comment">&#x27;client-key.pem&#x27;</span><br>-----<br>You are about <span class="hljs-keyword">to</span> be asked <span class="hljs-keyword">to</span> enter information that will be incorporated<br><span class="hljs-keyword">into</span> your certificate request.<br>What you are about <span class="hljs-keyword">to</span> enter <span class="hljs-built_in">is</span> what <span class="hljs-built_in">is</span> called a Distinguished Name <span class="hljs-built_in">or</span> a DN.<br>There are quite a few fields but you can leave some blank<br><span class="hljs-keyword">For</span> some fields there will be a <span class="hljs-keyword">default</span> value,<br><span class="hljs-keyword">If</span> you enter <span class="hljs-comment">&#x27;.&#x27;, the field will be left blank.</span><br>-----<br>Country Name (<span class="hljs-number">2</span> letter code) [XX]:CN<br>State <span class="hljs-built_in">or</span> Province Name (full name) []:shanghai<br>Locality Name (eg, city) [<span class="hljs-keyword">Default</span> City]:shanghai<br>Organization Name (eg, company) [<span class="hljs-keyword">Default</span> Company Ltd]:als<br>Organizational Unit Name (eg, section) []:ops<br>Common Name (eg, your name <span class="hljs-built_in">or</span> your server<span class="hljs-comment">&#x27;s hostname) []:client.test.com </span><br>Email Address []:<br><br>Please enter the following <span class="hljs-comment">&#x27;extra&#x27; attributes</span><br><span class="hljs-keyword">to</span> be sent <span class="hljs-keyword">with</span> your certificate request<br>A challenge password []:<br>An <span class="hljs-keyword">optional</span> company name []:<br>[root@server mysql56]# openssl rsa -<span class="hljs-keyword">in</span> client-<span class="hljs-keyword">key</span>.pem -out client-<span class="hljs-keyword">key</span>.pem <br>writing RSA <span class="hljs-keyword">key</span><br>[root@server mysql56]# openssl x509 -req -<span class="hljs-keyword">in</span> client-req.pem -days <span class="hljs-number">3600</span> -CA ca.pem -CAkey ca-<span class="hljs-keyword">key</span>.pem -set_serial <span class="hljs-number">02</span> -out client-cert.pem<br>Signature ok<br>subject=/C=CN/ST=shanghai/L=shanghai/O=als/OU=ops/CN=client.test.com<br>Getting CA <span class="hljs-keyword">Private</span> <span class="hljs-keyword">Key</span><br></code></pre></td></tr></table></figure><h4 id="7-检测"><a href="#7-检测" class="headerlink" title="7.检测"></a>7.检测</h4><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs axapta">[root@mysqlmaster01 mysql56]<span class="hljs-meta"># openssl verify -CAfile ca.pem server-cert.pem client-cert.pem </span><br><span class="hljs-keyword">server</span>-cert.pem: OK<br><span class="hljs-keyword">client</span>-cert.pem: OK<br></code></pre></td></tr></table></figure><p>说明：</p><ul><li><p>ca.pem: Use this as the argument to –ssl-ca on the server and client sides. (The CA certificate, if used, must be the same on both sides.)</p></li><li><p>server-cert.pem, server-key.pem: Use these as the arguments to –ssl-cert and –ssl-key on the server side.</p></li><li><p>client-cert.pem, client-key.pem: Use these as the arguments to –ssl-cert and –ssl-key on the client side.</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@mysqlmaster01</span> mysql56]<span class="hljs-meta"># chown -R mysql.mysql *.pem （更改属主和属组</span><br></code></pre></td></tr></table></figure><p>编写my.cnf文件，在【mysqld】下填写</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs arcade">ssl-ca=<span class="hljs-regexp">/data/my</span>sql56/ca.pem <br>ssl-cert=<span class="hljs-regexp">/data/my</span>sql56/server-cert.pem <br>ssl-key=<span class="hljs-regexp">/data/my</span>sql56/server-key.pem<br></code></pre></td></tr></table></figure><p>测试：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs routeros">mysql&gt; grant all on *.* <span class="hljs-keyword">to</span> <span class="hljs-string">&#x27;test&#x27;</span>@<span class="hljs-string">&#x27;10.2.11.%&#x27;</span> identified by <span class="hljs-string">&#x27;Aa123456&#x27;</span> require x509; （授权test用户通过ssl+秘钥登录）<br>Query OK, 0 rows affected (0.00 sec)<br><br>mysql&gt; flush privileges;<br>Query OK, 0 rows affected (0.00 sec)<br><br>[root@mysqlmaster01 ~]# mysql -u test -h 10.2.11.226 -p -P 3308<br>Enter password: <br><span class="hljs-builtin-name">ERROR</span> 1045 (28000): Access denied <span class="hljs-keyword">for</span><span class="hljs-built_in"> user </span><span class="hljs-string">&#x27;test&#x27;</span>@<span class="hljs-string">&#x27;10.2.11.226&#x27;</span> (using password: <span class="hljs-literal">YES</span>)<br>(直接用密码登录错误)<br><br>[root@mysqlmaster01 ~]# mysql -u test -h 10.2.11.226 -p -P 3308 <span class="hljs-attribute">-ssl-cert</span>=client-cert.pem <span class="hljs-attribute">--ssl-key</span>=client-key.pem <span class="hljs-attribute">--ssl-ca</span>=ca.pem<br>mysql: [<span class="hljs-builtin-name">ERROR</span>] mysql: unknown option <span class="hljs-string">&#x27;-l&#x27;</span><br>[root@mysqlmaster01 ~]# mysql -u test -h 10.2.11.226 -p -P 3308 <span class="hljs-attribute">--ssl-cert</span>=client-cert.pem <span class="hljs-attribute">--ssl-key</span>=client-key.pem <span class="hljs-attribute">--ssl-ca</span>=ca.pem<br>Enter password: <br><span class="hljs-builtin-name">ERROR</span> 2026 (HY000): SSL<span class="hljs-built_in"> connection </span>error: SSL_CTX_set_default_verify_paths failed<br>[root@mysqlmaster01 ~]# mysql -u test -h 10.2.11.226 -p -P 3308 <span class="hljs-attribute">--ssl-cert</span>=/data/mysql56/client-cert.pem <span class="hljs-attribute">--ssl-key</span>=/data/mysql56/client-key.pem<br>Enter password: <br>Welcome <span class="hljs-keyword">to</span> the MySQL monitor. Commands end with ; <span class="hljs-keyword">or</span> \g.<br>Your MySQL<span class="hljs-built_in"> connection </span>id is 5<span class="hljs-built_in"></span><br><span class="hljs-built_in">Server </span>version: 5.6.38-log MySQL<span class="hljs-built_in"> Community Server </span>(GPL)<br><br>Copyright (c) 2000, 2017, Oracle <span class="hljs-keyword">and</span>/<span class="hljs-keyword">or</span> its affiliates. All rights reserved.<br><br>Oracle is a registered trademark of Oracle Corporation <span class="hljs-keyword">and</span>/<span class="hljs-keyword">or</span> its<br>affiliates. Other names may be trademarks of their respective<br>owners.<br><span class="hljs-built_in"></span><br><span class="hljs-built_in">Type </span><span class="hljs-string">&#x27;help;&#x27;</span> <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;\h&#x27;</span> <span class="hljs-keyword">for</span> help.<span class="hljs-built_in"> Type </span><span class="hljs-string">&#x27;\c&#x27;</span> <span class="hljs-keyword">to</span> clear the current input statement.<br><br>mysql&gt;<br></code></pre></td></tr></table></figure><p>(如果要在其他电脑上通过ssl登录该机器的数据库，必须要ca.pem,client-cert.pem,client-key.pem拷贝到其他电脑上，然后配置连接数据库的工具使用ssl)</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>mysql</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Jenkins CICD实用经验分享</title>
    <link href="/2018/07/10/Jenkins-CICD%E5%AE%9E%E7%94%A8%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB/"/>
    <url>/2018/07/10/Jenkins-CICD%E5%AE%9E%E7%94%A8%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB/</url>
    
    <content type="html"><![CDATA[<h3 id="1-修改-JVM-的内存配置"><a href="#1-修改-JVM-的内存配置" class="headerlink" title="1.修改 JVM 的内存配置"></a>1.修改 JVM 的内存配置</h3><p>Jenkins 启动方式有两种方式，一种是以 Jdk Jar 方式运行，一种是将 War 包放在 Tomcat 容器下运行。不管何种方式运行，都会存在一个问题就是，默认 JVM 内存分配太少，导致启动或者运行一段时间后内存溢出报错 java.lang.OutOfMemoryError: PermGen space。所以，需要在启动前修改 JVM 内存配置。以 Tomcat 容器方式启动 Jenkins 为例配置如下：</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs clean"># 进入到 Jenkins 运行所在 Tomcat bin目录<br>$ vim catalina.sh<br># 在 #JAVA_OPTS=<span class="hljs-string">&quot;$JAVA_OPTS -Dorg.apache.catalina.security.SecurityListener.UMASK=`umask`&quot;</span> 行下增加修改配置 JVM 内存配置大小，例如下边配置：<br>JAVA_OPTS=<span class="hljs-string">&quot;$JAVA_OPTS -server -Xms512m -Xmx1024m -XX:PermSize=256M -XX:MaxPermSize=512m&quot;</span><br></code></pre></td></tr></table></figure><p>注意：这里的几个JVM 参数含义如下：</p><ul><li>-Xms: 使用的最小堆内存大小</li><li>-Xmx: 使用的最大堆内存大小</li><li>-XX:PermSize: 内存的永久保存区域大小</li><li>-XX:MaxPermSize: 最大内存的永久保存区域大小</li></ul><h3 id="2-修改-Jenkins-主目录"><a href="#2-修改-Jenkins-主目录" class="headerlink" title="2.修改 Jenkins 主目录"></a>2.修改 Jenkins 主目录</h3><p>Linux下Jenkins默认安装目录为:/home/jenkins/.jenkins，这个目录磁盘空间有限，长时间使用会导致磁盘空间不够，建议修改为其他大磁盘空间目录。这里修改安装目录有两种方式，一种是配置为系统环境变量中，一种是配置到 Tomcat 容器环境变量中。</p><p>2.1. 配置JENKINS_HOME到系统环境变量里面</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs routeros">注意：如果一台机器只安装一个Jenkins时，可以配置如下。<br><span class="hljs-variable">$vim</span> /etc<span class="hljs-built_in">/profile</span><br><span class="hljs-built_in"></span><span class="hljs-built_in">..</span>.<br><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">JENKINS_HOME</span>=/data/app/jenkins<br><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">PATH</span>=<span class="hljs-variable">$PATH</span>:$JENKINS_HOME<br><span class="hljs-comment"># 使配置生效</span><br>$ source /etc/profile<br></code></pre></td></tr></table></figure><p>2.2 配置JENKINS_HOME到该Jenkins启动的Tomcat容器环境变量中</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs awk">注意：如果一台机器上边安装多个Jenkins 时，不能配置JENKINS_HOME 到系统环境变量里面，需要配置JENKINS_HOME到该Jenkins启动的Tomcat 容器配置里面，这样可以区分不同的Jenkins目录。<br>(<span class="hljs-number">1</span>)第一种方法是修改context.xml文件:<br>$ vim <span class="hljs-regexp">/data/</span>app<span class="hljs-regexp">/apache-tomcat-7.0.85/</span>conf/context.xml<br>&lt;Context&gt;<br>    ...<br>    <span class="hljs-comment"># 增加以下配置，优先获取该配置路径。</span><br>    &lt;Environment name=<span class="hljs-string">&quot;JENKINS_HOME&quot;</span> value=<span class="hljs-string">&quot;/data/app/jenkins/master/.jenkins&quot;</span> type=<span class="hljs-string">&quot;java.lang.String&quot;</span>/&gt;<br>&lt;/Context&gt;<br><br>(<span class="hljs-number">2</span>)第二种方法是修改bin下的catalina.sh<br>添加如下：<br>export JENKINS_HOME=<span class="hljs-string">&quot;/data/app/jenkins/master/.jenkins&quot;</span><br></code></pre></td></tr></table></figure><p>这里要说明一下，如果一台机器上只安装了一个Jenkins服务时，可以配置 JENKINS_HOME到系统环境变量里面，如果安装了多个Jenkins服务时，不能这么配置，因为Jenkins会读取系统环境变量中JENKINS_HOME作为主目录安装，那样会存在配置覆盖的问题。</p><p>此时应该采用第二种方式，各自配置JENKINS_HOME到自己启动的Tomcat容器环境变量中，Jenkins会优先读取该容器环境变量作为各自的主目录安装。</p><p>附Jenkins寻找JENKINS_HOME环境变量的顺序为：</p><ul><li>首先读取容器环境变量</li><li>如果没有，则读取系统环境变量</li><li>如果还没有，则使用默认路径安装。</li></ul><h3 id="3-配置优化减少磁盘空间占用"><a href="#3-配置优化减少磁盘空间占用" class="headerlink" title="3.配置优化减少磁盘空间占用"></a>3.配置优化减少磁盘空间占用</h3><p>Jenkins运行Job构建比较多时，如果没有配置好清理策略的话，会导致占用磁盘空间比较大，最终由于磁盘空间不够导致构建失败的问题。</p><h4 id="3-1-丢弃旧的构建配置"><a href="#3-1-丢弃旧的构建配置" class="headerlink" title="3.1.丢弃旧的构建配置"></a>3.1.丢弃旧的构建配置</h4><p>可以在Job中配置丢弃旧的构建，通过设置“保持构建的天数” 和“保持构建的最大个数” 两个参数，控制该Job最大保存构建数量。</p><p>配置了最大保持3天之内的构建，如果超过3天的构建，则会在Job执行前被清理掉。同时配置了最大保持构建数量为10个，意思就是如果3天内构建次数如果超过10次，则最多保留最近执行的10个构建。这样配置的好处，除了能够自动清理一些Build之外，还能够为我们代码执行远程停止Job Build时，缩短停止时间</p><h4 id="3-2-修改工作空间和构建记录根目录"><a href="#3-2-修改工作空间和构建记录根目录" class="headerlink" title="3.2.修改工作空间和构建记录根目录"></a>3.2.修改工作空间和构建记录根目录</h4><p>Jenkins 工作主要分为安装主目录，工作空间目录以及构建记录目录，默认配置路径：/home/jenkins/.jenkins<br>先停止tomcat,修改catalina.sh指定JENKINS_HOME,然后将/home/jenkins/.jenkins复制到JENKINS_HOME下，最后启动tomcat，则主目录会变成新的指定的JENKINS_HOME目录。</p><h3 id="4-设置全局属性"><a href="#4-设置全局属性" class="headerlink" title="4.设置全局属性"></a>4.设置全局属性</h3><p>适当设置全局属性，可以避免在Job中重复写一些固定值，例如输出日志地址、接口请求地址等等，而且当固定值需要修改时，只需要修改一次即可，不用去每个Job里面修改，方便维护。可以去“系统管理” —&gt; “系统配置” —&gt; “全局属性” 下增加Environment variables键值对:</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs elixir">键<span class="hljs-symbol">:DOCKER_JENKINS_URL</span><br><br>值<span class="hljs-symbol">:http</span><span class="hljs-symbol">://</span><span class="hljs-number">127.0</span>.0.<span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">8080</span>/jenkins<br><br>键<span class="hljs-symbol">:API_SERVICE_URL</span><br><br>值<span class="hljs-symbol">:http</span><span class="hljs-symbol">://</span><span class="hljs-number">127.0</span>.0.<span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">9090</span>/api/v1<br><br>键<span class="hljs-symbol">:LOG_PATH</span><br><br>值<span class="hljs-symbol">:/data/app/logs</span><br></code></pre></td></tr></table></figure><p>那么在job构建时执行”Execute Shell”，可以直接应用，例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#转发另一个Jenkins job执行</span><br>curl -X POST <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;DOCKER_JENKINS_URL&#125;</span>/job/maven_build/buildWithParameters?token=a4575431315316313665555asdasdee55&quot;</span><br><br><span class="hljs-comment">#进入到日志目录</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$&#123;LOG_PATH&#125;</span><br><br><span class="hljs-comment">#输出接口地址</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;API_SERVICE_URL&#125;</span><br></code></pre></td></tr></table></figure><h3 id="5-JDK-Maven-Gradle-等软件多版本安装"><a href="#5-JDK-Maven-Gradle-等软件多版本安装" class="headerlink" title="5.JDK/Maven/Gradle 等软件多版本安装"></a>5.JDK/Maven/Gradle 等软件多版本安装</h3><p>对于一些常用的软件，比如Jdk、Maven、Gradle等，可能每个项目对软件依赖版本不一样，有的项目依赖Jdk7，有的依赖Jdk8，所以为了更好的适配各个项目，可以指定安装多个版本软件，然后Job创建时选择其中一个版本使用。<br>这里以Jdk为例，去 “系统管理” —&gt; “Global Tool Configuration” —&gt; “JDK” 分别安装jdk6、Jdk7、Jdk8。 </p><p>然后，在创建Job时，选择项目需要的一个版本即可!</p><h3 id="6-设置构建超时时间"><a href="#6-设置构建超时时间" class="headerlink" title="6.设置构建超时时间"></a>6.设置构建超时时间</h3><p>有些Job在执行构建时，由于某些原因导致构建挂起，耗时比较长，而这些长时间挂起的Job会导致Jenkins内存占用比较大，性能下降，严重的会直接导致 Jenkins挂掉。所以，需要设置构建超时时间来预防这种事情发生，一旦超过一定的时间，要让Job自动停止掉。</p><p>jenkins的”build timeout plugin”插件可以帮我们完成该任务。</p><p>Build Timeout<br>Aborts a build if it’s taking too long</p><p>例如，这里设置构建超过30分钟则将本次Build置为失败:<br>Abort the build if it’s stuck:<br>time-out strategy: Absolute   Timeout minutes:30</p><h3 id="7-配置视图分类管理Job"><a href="#7-配置视图分类管理Job" class="headerlink" title="7.配置视图分类管理Job"></a>7.配置视图分类管理Job</h3><p>Jenkins默认视图为ALL,显示所有Job列表,如Job比较多的话,找某个Job会不太方便，虽然有Search搜索功能，毕竟还是不太方便。这时候，可以通过新建视图方式，对Job进行分门别类，这样管理和查找起来就方便多了！</p><h3 id="8-配置多节点管理"><a href="#8-配置多节点管理" class="headerlink" title="8.配置多节点管理"></a>8.配置多节点管理</h3><p>一般我们会使用Jenkins Slave集群管理来完成日常持续集成操作，使用 Jenkins Slave一主多从方式，可以将Job调度到对应的Slave机器上执行，能够大大提高系统并发执行效率。</p><p>可以从“系统管理”—&gt;“管理节点”—&gt;“新建节点”，设置节点类型为“Permanent Agent”名称“slave1”的一个从节点，当然有多个节点时，可以创建多个。创建完毕之后，此时插件还属于不可用状态，因为还没有执行关联，具体关联方式可以参照Jenkins上节点关联说明，关联完毕之后，就可以在新建Job中配置指定那个Slave节点运行了</p><ul><li>远程工作目录: /data/app/jenkins/slave</li><li>标签：slave1</li><li>用法：尽可能的使用这个节点</li><li>启动方式：Launch slave agents via SSH</li><li>主机：jenkins master所在主机ip</li><li>可用性：尽量保持代理在线</li></ul><p>有两种方式指定Job在哪个Slave节点运行：</p><ul><li>一种是对于自由风格类型的Job，我们可以通过在“Restrict where this project can be run” 选项下指定“Label Expression” 标签指定节点标签。</li><li>另一种是对于多配置项目类型的Job，可以通过在 “Configuration Matrix” 先配置“Slave”选择Node/Label勾选指定一个或多个Slave 执行。 </li></ul><h3 id="9-一些实用插件"><a href="#9-一些实用插件" class="headerlink" title="9.一些实用插件"></a>9.一些实用插件</h3><p>Jenkins的基础配置就能够满足我们日常的基本工作，但是为了提高构建效率和方便维护，Jenkins上提供了很多实用的插件，使用这些插件，可以更加轻松、更加简便、更加高效的执行持续集成和发布流程。下边，简单介绍几个插件。</p><h4 id="9-1-Managed-Script-插件管理脚本文件"><a href="#9-1-Managed-Script-插件管理脚本文件" class="headerlink" title="9.1 Managed Script 插件管理脚本文件"></a>9.1 Managed Script 插件管理脚本文件</h4><p>该插件是为了在管理文件时创建Script脚本文件，然后在Job中配置直接使用，方便脚本的统一管理和维护。首先我们需要去“系统管理” —&gt; “管理插件” —&gt; “可选插件” 中选择“Managed script” 插件，安装重启即可。 </p><p>安装完毕后，可以从“系统管理”—&gt;“Managed files”—&gt;“Add a new Config” 选择 “Managed script file” 类型，创建一个新的shell 脚本文件，然后输入我们要执行的脚本代码。这里我创建了两个脚本，分别为 before-build-step-shell 和 after-build-step-shell，意思很明确了，前者在构建前执行的一些操作，后者在构建后执行的一些操作。 </p><p>注意: 这里的脚本可以使用一些Jenkins系统的环境变量参数、参数化构建时传递的参数以及系统命令。</p><p>创建完毕后，在Job中构建处选择“Execute managed script” 就可以使用这些脚本了。 </p><h4 id="9-2-PostBuildScript-插件根据-Build-状态执行脚本"><a href="#9-2-PostBuildScript-插件根据-Build-状态执行脚本" class="headerlink" title="9.2 PostBuildScript 插件根据 Build 状态执行脚本"></a>9.2 PostBuildScript 插件根据 Build 状态执行脚本</h4><p>推荐安装 PostBuildScript插件，该插件可以在构建后操作中，根据构建结果状态，执行对应的脚本操作，很实用的一个插件。同上安装该插件，重启 Jenkins 完毕插件生效后，Job 中构建后操作处选择 “Execute Scripts” ，然后在 “Add build step” 中选择 “Execute shell” 等选项（当然也可以配合上一个插件，那么这里就选择 “Execute managed script”），下边选择一个build状态条件值，如果选择SUCCESS状态，那么该脚本只有在Build成功时才会执行，其他状态依次类推，状态可以多选，多选代表多种状态都能下触发。 </p><h4 id="9-3-Jenkins2-0-Pipeline-插件执行持续集成发布流程"><a href="#9-3-Jenkins2-0-Pipeline-插件执行持续集成发布流程" class="headerlink" title="9.3 Jenkins2.0 Pipeline 插件执行持续集成发布流程"></a>9.3 Jenkins2.0 Pipeline 插件执行持续集成发布流程</h4><p>详细文章参考<a href="https://blog.csdn.net/aixiaoyang168/article/details/72818804"> 初试Jenkins2.0 Pipeline持续集成</a></p><h4 id="9-4-Kubernetes-Plugin-插件动态创建-Jenkins-Slave"><a href="#9-4-Kubernetes-Plugin-插件动态创建-Jenkins-Slave" class="headerlink" title="9.4 Kubernetes Plugin 插件动态创建 Jenkins Slave"></a>9.4 Kubernetes Plugin 插件动态创建 Jenkins Slave</h4><p>传统的Jenkins Slave一主多从方式会存在一些痛点，比如Master单点故障，Slave配置环境差异，资源分配不均衡等导致可靠性和可维护性比较差，而使用 Kubernetes Plugin插件可以动态的创建和删除Jenkins Slave 节点，使用它可以很好的保证服务高可用，动态伸缩合理使用资源，以及良好的扩展性。</p><p>使用该插件后，它的工作流程大致为：当Jenkins Master接受到Build 请求时，会根据配置的Label动态创建一个运行在Docker Container中的 Jenkins Slave,并注册到Master上，当运行完Job后，这个Slave会被注销并且 Docker Container也会自动删除，恢复到最初状态。 </p><p>详细文章参考<a href="https://blog.csdn.net/aixiaoyang168/article/details/79767649">  初试 Jenkins 使用 Kubernetes Plugin 完成持续构建与发布</a></p><h3 id="10-JAVA-代码触发-Jenkins-Job-创建、删除、停止等操作。"><a href="#10-JAVA-代码触发-Jenkins-Job-创建、删除、停止等操作。" class="headerlink" title="10.JAVA 代码触发 Jenkins Job 创建、删除、停止等操作。"></a>10.JAVA 代码触发 Jenkins Job 创建、删除、停止等操作。</h3><p>Jenkins Job创建、删除、构建等操作，除了在页面手动操作外，还可以通过 Jenkins API接口执行对应操作，详细接口可参考 Jenkins<br>REST API 文档地址：http://<jenkins_url>/api。这里演示的是使用 Jenkins-client.jar包，使用JAVA代码操作如何创建、删除、停止、触发构建等，使用代码触发jenkins相关操作，好处就是自己可控，这样可以配合自己的业务需要，随时启动或者新建Job</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public <span class="hljs-keyword">class</span> JenkinsUtils &#123;<br><br>    <span class="hljs-keyword">private</span> static String jenkins_url = <span class="hljs-string">&quot;http://127.0.0.1/jenkins/&quot;</span>;<br>    <span class="hljs-keyword">private</span> static String jenkins_user = <span class="hljs-string">&quot;admin&quot;</span>;<br>    <span class="hljs-keyword">private</span> static String jenkins_token = <span class="hljs-string">&quot;1b356d175432ed0d34c440d68d00fe49&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 通过模板创建 Job</span><br><span class="hljs-comment">     * @param jobName</span><br><span class="hljs-comment">     * @param jobTemplate</span><br><span class="hljs-comment">     * @return</span><br><span class="hljs-comment">     */</span><br>    public static boolean create<span class="hljs-constructor">JobFromTemplate(String <span class="hljs-params">jobName</span>, String <span class="hljs-params">jobTemplate</span>)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            URI uri = <span class="hljs-keyword">new</span> <span class="hljs-constructor">URI(<span class="hljs-params">jenkins_url</span>)</span>;            <br>            JenkinsServer jenkins = <span class="hljs-keyword">new</span> <span class="hljs-constructor">JenkinsServer(<span class="hljs-params">uri</span>, <span class="hljs-params">jenkins_user</span>, <span class="hljs-params">jenkins_token</span>)</span>;<br>            String template = jenkins.get<span class="hljs-constructor">JobXml(<span class="hljs-params">jobTemplate</span>)</span>;<br>            Document doc = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">DocumentHelper</span>.</span></span>parse<span class="hljs-constructor">Text(<span class="hljs-params">template</span>)</span>;<br>            String newConfigXml = doc.<span class="hljs-keyword">as</span><span class="hljs-constructor">XML()</span>;<br>            jenkins.create<span class="hljs-constructor">Job(<span class="hljs-params">jobName</span>, <span class="hljs-params">newConfigXml</span>, <span class="hljs-params">false</span>)</span>;<br>        &#125;catch (Exception e)&#123;<br>            e.print<span class="hljs-constructor">StackTrace()</span>;<br>            return <span class="hljs-literal">false</span>;<br>        &#125;<br>        return <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 删除/禁用 Job</span><br><span class="hljs-comment">     * @param jobName</span><br><span class="hljs-comment">     * @return</span><br><span class="hljs-comment">     */</span><br>    public static boolean delete<span class="hljs-constructor">Job(String <span class="hljs-params">jobName</span>)</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            URI uri = <span class="hljs-keyword">new</span> <span class="hljs-constructor">URI(<span class="hljs-params">jenkins_url</span>)</span>;            <br>            JenkinsServer jenkins = <span class="hljs-keyword">new</span> <span class="hljs-constructor">JenkinsServer(<span class="hljs-params">uri</span>, <span class="hljs-params">jenkins_user</span>, <span class="hljs-params">jenkins_token</span>)</span>;<br>            jenkins.delete<span class="hljs-constructor">Job(<span class="hljs-params">jobName</span>, <span class="hljs-params">false</span>)</span>;<br>            jenkins.disable<span class="hljs-constructor">Job(<span class="hljs-params">jobName</span>, <span class="hljs-params">false</span>)</span>;<br>        &#125; catch (Exception e) &#123;<br>            e.print<span class="hljs-constructor">StackTrace()</span>;<br>            return <span class="hljs-literal">false</span>;<br>        &#125;<br>        return <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 启动 Job 构建</span><br><span class="hljs-comment">     * @param jobName</span><br><span class="hljs-comment">     * @param params</span><br><span class="hljs-comment">     * @return</span><br><span class="hljs-comment">     */</span><br>    public static boolean start<span class="hljs-constructor">Job(String <span class="hljs-params">jobName</span>, String <span class="hljs-params">params</span>)</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            String buildUrl = jenkins_url + jobName + <span class="hljs-string">&quot;/buildWithParameters?&quot;</span> + params;<br>            HttpUtils.<span class="hljs-constructor">HttpGet(<span class="hljs-params">buildUrl</span>)</span>;<br>        &#125; catch (Exception e) &#123;<br>            e.print<span class="hljs-constructor">StackTrace()</span>;<br>            return <span class="hljs-literal">false</span>;<br>        &#125;<br>        return <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 停止正在构建中的 Job，先清除等待队列中的 build，在停止运行中的 build</span><br><span class="hljs-comment">     * @param jobName</span><br><span class="hljs-comment">     * @return</span><br><span class="hljs-comment">     */</span><br>    public static boolean stop<span class="hljs-constructor">Job(String <span class="hljs-params">jobName</span>)</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            URI uri = <span class="hljs-keyword">new</span> <span class="hljs-constructor">URI(<span class="hljs-params">jenkins_url</span>)</span>;<br>            JenkinsServer jenkins = <span class="hljs-keyword">new</span> <span class="hljs-constructor">JenkinsServer(<span class="hljs-params">uri</span>, <span class="hljs-params">jenkins_user</span>, <span class="hljs-params">jenkins_token</span>)</span>;<br>            <span class="hljs-comment">// 先 kill 掉 queue 里面的 build</span><br>            QueueItem qi = jenkins.get<span class="hljs-constructor">Job(<span class="hljs-params">jobName</span>)</span>.get<span class="hljs-constructor">QueueItem()</span>;<br>            <span class="hljs-keyword">if</span>(qi != null)&#123;<br>                HttpUtils.<span class="hljs-constructor">HttpPost(<span class="hljs-params">jenkinsUrl</span> + <span class="hljs-string">&quot;queue/cancelItem?id=&quot;</span> + <span class="hljs-params">qi</span>.<span class="hljs-params">getId</span>()</span>);<br>            &#125;<br>            <span class="hljs-comment">// 在 kill 掉正在运行中的 build</span><br>            List&lt;Build&gt; bulidsList = jenkins.get<span class="hljs-constructor">Job(<span class="hljs-params">jobName</span>)</span>.get<span class="hljs-constructor">AllBuilds()</span>;<br>            <span class="hljs-keyword">for</span>(Build b:bulidsList)&#123;<br>                <span class="hljs-keyword">if</span>(b.details<span class="hljs-literal">()</span>.is<span class="hljs-constructor">Building()</span>)&#123;<br>                    <span class="hljs-keyword">try</span>&#123;<br>                        b.<span class="hljs-constructor">Stop()</span>;<br>                    &#125;catch(Exception ee)&#123;<br>                        ee.print<span class="hljs-constructor">StackTrace()</span>;<br>                        return <span class="hljs-literal">false</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125; catch(Exception e) &#123;<br>            e.print<span class="hljs-constructor">StackTrace()</span>;<br>            return <span class="hljs-literal">false</span>;<br>        &#125;<br>        return <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里有一个地方要注意，在停止构建中的Job 时，这里是遍历所有 Build，然后在Kill掉运行中的Build，如果Build历史比较多的时候，会耗时比较久，这将会导致立马重新执行该Job Build时，Build会被异常Abort掉。 也尝试过获取最后一次Build执行Stop操作，好像也不太好使。所以这里大家可以通过上边3.1、丢弃旧的构建配置中的操作，减少构建历史记录，这样就可以很快执行完毕，就不会出现上述问题了。</p>]]></content>
    
    
    <categories>
      
      <category>jenkins</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jenkins</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>pipeline jnlp</title>
    <link href="/2018/07/03/pipeline-jnlp/"/>
    <url>/2018/07/03/pipeline-jnlp/</url>
    
    <content type="html"><![CDATA[<h4 id="通过默认的jnlp"><a href="#通过默认的jnlp" class="headerlink" title="通过默认的jnlp"></a>通过默认的jnlp</h4><ol><li>jenkins-&gt;系统管理-&gt;系统设置-&gt;新增一个云(kubernetes)</li><li>kubernetes相应设置：</li></ol><ul><li>Name: kubernetes_jnlp</li><li>Kubernetes URL: <a href="http://127.0.0.1:8080/">http://127.0.0.1:8080</a>(通过http访问不用添加certificate key,不然要使用6443的https协议:API Server证书经过知名CA签名的)</li><li>Disable https certifiacate check: 勾选</li><li>Kubernetes Namespace: default</li><li>Credentials: none</li><li>Jenkins URL: <a href="http://192.168.0.14:9191/jenkins">http://192.168.0.14:9191/jenkins</a></li><li>如果在K8S集群内部可以直接访问Jenkins URL，则Jenkins tunnel不需要填写</li></ul><h4 id="pipeline-scripts"><a href="#pipeline-scripts" class="headerlink" title="pipeline scripts"></a>pipeline scripts</h4><p>指定kubernetes的相应pod(jnlp)来执行pipeline:</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><code class="hljs gams">pipeline &#123;<br>    agent &#123;<br>kubernetes &#123;<br>label <span class="hljs-string">&#x27;mypod&#x27;</span><br>cloud <span class="hljs-string">&#x27;kubernetes_jnlp&#x27;</span><br><span class="hljs-comment">//podTemplate &#123;</span><br><span class="hljs-comment">//inheritFrom &quot;mypod&quot;</span><br><span class="hljs-comment">//&#125;</span><br>&#125;<br>&#125;<br><br>    <span class="hljs-keyword">parameters</span> &#123;<br>    <span class="hljs-comment">//git代码路径【参数值对外隐藏】</span><br>    string(name:<span class="hljs-string">&#x27;repoUrl&#x27;</span>, defaultValue: <span class="hljs-string">&#x27;http://git.galaxymx.com/yunwei/oms.git&#x27;</span>, description: <span class="hljs-string">&#x27;git代码路径&#x27;</span>)<br>    string(name:<span class="hljs-string">&#x27;repoBranch&#x27;</span>, defaultValue: <span class="hljs-string">&#x27;master&#x27;</span>, description: <span class="hljs-string">&#x27;git分支名称&#x27;</span>)<br>    <span class="hljs-comment">//pom.xml的相对路径</span><br>    string(name:<span class="hljs-string">&#x27;pomPath&#x27;</span>, defaultValue: <span class="hljs-string">&#x27;pom.xml&#x27;</span>, description: <span class="hljs-string">&#x27;pom.xml的相对路径&#x27;</span>)<br>    <span class="hljs-comment">//war包的相对路径</span><br>    string(name:<span class="hljs-string">&#x27;warLocation&#x27;</span>, defaultValue: <span class="hljs-string">&#x27;/data/app/war/target/*.war&#x27;</span>, description: <span class="hljs-string">&#x27;war包的相对路径 &#x27;</span>)<br>    <span class="hljs-comment">//服务器参数采用了组合方式，避免多次选择，使用docker为更佳实践【参数值对外隐藏】</span><br>    choice(name: <span class="hljs-string">&#x27;server&#x27;</span>,choices:<span class="hljs-string">&#x27;192.168.1.107,9090,*****,*****\n192.168.1.60,9090,*****,*****&#x27;</span>, description: <span class="hljs-string">&#x27;测试服务器列表选择(IP,JettyPort,Name,Passwd)&#x27;</span>)<br>    <span class="hljs-comment">//测试服务器的dubbo服务端口</span><br>    string(name:<span class="hljs-string">&#x27;dubboPort&#x27;</span>, defaultValue: <span class="hljs-string">&#x27;31100&#x27;</span>, description: <span class="hljs-string">&#x27;测试服务器的dubbo服务端口&#x27;</span>)<br>    <span class="hljs-comment">//单元测试代码覆盖率要求，各项目视要求调整参数</span><br>    string(name:<span class="hljs-string">&#x27;lineCoverage&#x27;</span>, defaultValue: <span class="hljs-string">&#x27;20&#x27;</span>, description: <span class="hljs-string">&#x27;单元测试代码覆盖率要求(%)，小于此值pipeline将会失败！&#x27;</span>)<br>    <span class="hljs-comment">//若勾选在pipelie完成后会邮件通知测试人员进行验收</span><br>    booleanParam(name: <span class="hljs-string">&#x27;isCommitQA&#x27;</span>,description: <span class="hljs-string">&#x27;是否邮件通知测试人员进行人工验收&#x27;</span>,defaultValue: false <span class="hljs-comment">)</span><br>    &#125;<br>    <br>    <span class="hljs-comment">//常量参数，初始确定后一般不需更改</span><br>    environment <span class="hljs-comment">&#123;</span> <br>    <span class="hljs-comment">//def ITEMNAME = &quot;&quot;</span><br>    def <span class="hljs-comment">DESTPATH =</span> <span class="hljs-comment">&quot;/data/wwwroot/devops&quot;</span><br>    def <span class="hljs-comment">SRCPATH =</span> <span class="hljs-comment">&quot;~/.jenkins/workspace/oms&quot;</span><br>    def <span class="hljs-comment">CRED_ID =</span> <span class="hljs-comment">&#x27;d4a8ba52-0ea0-4f60-86f5-95a4fe0eaa84&#x27;</span><br>    <span class="hljs-comment">//测试人员邮箱地址</span><br>    def <span class="hljs-comment">QA_EMAIL =</span> <span class="hljs-comment">&#x27;hanniusshine@gmail.com&#x27;</span><br>    &#125;<br>    <br>    options <span class="hljs-comment">&#123;</span><br>        <span class="hljs-comment">//保持构建的最大个数</span><br>        buildDiscarder(logRotator(numToKeepStr: <span class="hljs-string">&#x27;10&#x27;</span>)) <br>    &#125;<br>    <span class="hljs-comment">//定期检查开发代码更新，工作日每晚4点做daily build</span><br>    triggers <span class="hljs-comment">&#123;</span><br>        pollSCM(<span class="hljs-string">&#x27;H 4 * * 1-5&#x27;</span>)<br>    &#125;<br>   <span class="hljs-comment">//pipeline运行结果通知给触发者</span><br>    post&#123;<br>        success&#123;<br>            script <span class="hljs-comment">&#123;</span> <br>                wrap([$class: <span class="hljs-string">&#x27;BuildUser&#x27;</span>]) &#123;<br>                mail <span class="hljs-comment">to:</span> <span class="hljs-comment">&quot;$&#123;BUILD_USER_EMAIL &#125;&quot;</span><span class="hljs-comment">,</span><br>                subject: <span class="hljs-string">&quot;PineLine &#x27;$&#123;JOB_NAME&#125;&#x27; ($&#123;BUILD_NUMBER&#125;) result&quot;</span>,<br>                body: <span class="hljs-string">&quot;$&#123;BUILD_USER&#125;&#x27;s pineline &#x27;$&#123;JOB_NAME&#125;&#x27; ($&#123;BUILD_NUMBER&#125;) run success\n请及时前往$&#123;env.BUILD_URL&#125;进行查看&quot;</span><br>                &#125;<br>            &#125;<br>        &#125;<br>        failure&#123;<br>            script <span class="hljs-comment">&#123;</span> <br>                wrap([$class: <span class="hljs-string">&#x27;BuildUser&#x27;</span>]) &#123;<br>                mail <span class="hljs-comment">to:</span> <span class="hljs-comment">&quot;$&#123;BUILD_USER_EMAIL &#125;&quot;</span><span class="hljs-comment">,</span><br>                subject: <span class="hljs-string">&quot;PineLine &#x27;$&#123;JOB_NAME&#125;&#x27; ($&#123;BUILD_NUMBER&#125;) result&quot;</span>,<br>                body: <span class="hljs-string">&quot;$&#123;BUILD_USER&#125;&#x27;s pineline  &#x27;$&#123;JOB_NAME&#125;&#x27; ($&#123;BUILD_NUMBER&#125;) run failure\n请及时前往$&#123;env.BUILD_URL&#125;进行查看&quot;</span><br>                &#125;<br>            &#125;<br><br>        &#125;<br>        unstable&#123;<br>            script <span class="hljs-comment">&#123;</span> <br>                wrap([$class: <span class="hljs-string">&#x27;BuildUser&#x27;</span>]) &#123;<br>                mail <span class="hljs-comment">to:</span> <span class="hljs-comment">&quot;$&#123;BUILD_USER_EMAIL &#125;&quot;</span><span class="hljs-comment">,</span><br>                subject: <span class="hljs-string">&quot;PineLine &#x27;$&#123;JOB_NAME&#125;&#x27; ($&#123;BUILD_NUMBER&#125;)结果&quot;</span>,<br>                body: <span class="hljs-string">&quot;$&#123;BUILD_USER&#125;&#x27;s pineline &#x27;$&#123;JOB_NAME&#125;&#x27; ($&#123;BUILD_NUMBER&#125;) run unstable\n请及时前往$&#123;env.BUILD_URL&#125;进行查看&quot;</span><br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">//pipeline的各个阶段场景</span><br>    stages <span class="hljs-comment">&#123;</span>    <br>        stage(<span class="hljs-string">&#x27;代码拉取&#x27;</span>)&#123;<br>            steps <span class="hljs-comment">&#123;</span><br>            echo <span class="hljs-comment">&quot;checkout from $&#123;params.repoUrl&#125;&quot;</span><br>            <span class="hljs-comment">//git url: &#x27;http://git.galaxymx.com/yunwei/oms.git&#x27;, branch: &#x27;master&#x27;</span><br>            git <span class="hljs-comment">credentialsId:CRED_ID, url:params.repoUrl, branch:params.repoBranch</span><br>                    &#125;<br>                    &#125;<br>        stage(<span class="hljs-string">&#x27;目录检查&#x27;</span>) &#123;<br>            steps <span class="hljs-comment">&#123;</span><br>                echo <span class="hljs-comment">&quot;检查$&#123;DESTPATH&#125;目录是否存在&quot;</span><br>                script&#123;<br>                    <span class="hljs-comment">//def resultUpdateshell = sh script: &#x27;ansible webapp -m shell -a &quot;ls -d $&#123;DESTPATH&#125;&quot;&#x27;</span><br>                    def <span class="hljs-comment">resultUpdateshell = sh script:</span> <span class="hljs-comment">&#x27;ls -d $&#123;DESTPATH&#125;&#x27;</span><br>                    if <span class="hljs-comment">(resultUpdateshell == 0) &#123;</span><br>                        skip <span class="hljs-comment">=</span> <span class="hljs-comment">&#x27;0&#x27;</span><br>                        return<br>                    &#125;   <br>                    &#125;<br>                    &#125;<br>                    &#125;       <br>        stage(<span class="hljs-string">&#x27;nginx服务检查&#x27;</span>) &#123;<br>            steps <span class="hljs-comment">&#123;</span><br>                echo <span class="hljs-comment">&quot;检查nginx进程是否存在&quot;</span><br>                script&#123;<br>                    def <span class="hljs-comment">resultUpdateshell = sh script:</span> <span class="hljs-comment">&#x27;ps aux|grep nginx|grep -v grep&#x27;</span><br>                    if <span class="hljs-comment">(resultUpdateshell == 0) &#123;</span><br>                        skip <span class="hljs-comment">=</span> <span class="hljs-comment">&#x27;0&#x27;</span><br>                        return<br>                    &#125;   <br>                    &#125;<br>                    &#125;<br>                    &#125;<br>        stage(<span class="hljs-string">&#x27;tomcat服务检查&#x27;</span>) &#123;<br>            steps <span class="hljs-comment">&#123;</span><br>                echo <span class="hljs-comment">&quot;检查tomcat进程是否存在&quot;</span><br>                script&#123;<br>                    def <span class="hljs-comment">resultUpdateshell = sh script:</span> <span class="hljs-comment">&#x27;ps aux|grep tomcat|grep -v grep&#x27;</span><br>                    if <span class="hljs-comment">(resultUpdateshell == 0) &#123;</span><br>                        skip <span class="hljs-comment">=</span> <span class="hljs-comment">&#x27;0&#x27;</span><br>                        return<br>                    &#125;   <br>                    &#125;<br>                    &#125;<br>                    &#125;<br>        stage(<span class="hljs-string">&#x27;发布确认&#x27;</span>) &#123;<br>            steps <span class="hljs-comment">&#123;</span><br>                input <span class="hljs-comment">&quot;检查完成，是否发布?&quot;</span><br>            &#125;<br>        &#125;                   <br>        stage(<span class="hljs-string">&#x27;代码推送&#x27;</span>) &#123;<br>            steps <span class="hljs-comment">&#123;</span><br>            echo <span class="hljs-comment">&quot;code sync&quot;</span><br>            <span class="hljs-comment">//sh &quot;ansible $&#123;ITEMNAME&#125; -m synchronize -a &#x27;src=$&#123;SRCPATH&#125;/ dest=$&#123;DESTPATH&#125;/ rsync_opts=-avz,--exclude=.git,--delete&#x27;&quot;</span><br>            sh <span class="hljs-comment">&quot;rsync -avz $&#123;SRCPATH&#125;/ $&#123;DESTPATH&#125;/ --exclude=.git --delete&quot;</span><br>        &#125;<br>        &#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>因为默认的jnlp容器是使用的官方的：jenkins/jnlp-slave:alpine<br>容器里面是没有：/data/wwwroot/devops目录，所以上面构建在”检查目录是否存在”步骤则返回0结束。</p><hr>]]></content>
    
    
    <categories>
      
      <category>jenkins</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jenkins</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>pipeline 语法详解</title>
    <link href="/2018/07/03/pipeline-%E8%AF%AD%E6%B3%95%E8%AF%A6%E8%A7%A3/"/>
    <url>/2018/07/03/pipeline-%E8%AF%AD%E6%B3%95%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<p>pipeline 脚本是有groovy语言实现的,无需专门学习 groovy</p><p>pipeline支持两种语法:</p><ul><li>Declarative 声明式</li><li>Scripted pipeline脚本式</li></ul><p>如何创建基本的pipeline</p><ul><li>直接在jenkins web ui网页界面输入脚本</li><li>通过常见一个jenkins可以检入项目的源代码管理库</li></ul><p>Declarative 声明式pipeline<br>声明式pipeline基本语法和表达式遵循groovy语法，但是有以下例外：</p><ul><li>声明式pipeline必须包含在固定格式的pipeline{}块内</li><li>每个声明语句必须独立一行，行尾无需使用分号</li><li>块(Blocks{})只能包含章节(Sections),指令（Directives）,步骤(Steps),或者赋值语句</li><li>属性引用语句被视为无参数方法调用,如input()</li></ul><ol><li>块(Blocks{}):由大括号括起来的语句： 如Pipeline{}, Sections{}, parameters{}, script{}</li><li>章节(Sections):通常包括一个或者多个指令或步骤,如agent，post，stages，steps</li><li>指令(Directives): environment, options, parameters, triggers, stage, tools, when</li><li>步骤(steps)：执行脚本式pipeline, 如script{}</li></ol><p>参考文章：<a href="https://www.cnblogs.com/fengjian2016/p/8227532.html">Jenkins pipeline：pipeline 语法详解</a></p>]]></content>
    
    
    <categories>
      
      <category>jenkins</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jenkins</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>kubernetes之Service Account</title>
    <link href="/2018/06/28/kubernetes%E4%B9%8BService-Account/"/>
    <url>/2018/06/28/kubernetes%E4%B9%8BService-Account/</url>
    
    <content type="html"><![CDATA[<p>Service Account概念的引入是基于这样的使用场景：运行在pod里的进程需要调用Kubernetes API以及非Kubernetes API的其它服务。Service Account它并不是给kubernetes集群的用户使用的，而是给pod里面的进程使用的，它为pod提供必要的身份认证。</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">➜  nexus kubectl <span class="hljs-keyword">get</span> sa<br><span class="hljs-type">NAME</span>      SECRETS   AGE<br><span class="hljs-keyword">default</span>   <span class="hljs-number">1</span>         <span class="hljs-number">18</span>d<br>➜  nexus <br>➜  nexus kubectl <span class="hljs-keyword">get</span> sa <span class="hljs-comment">--all-namespaces </span><br>NAMESPACE     <span class="hljs-type">NAME</span>                   SECRETS   AGE<br><span class="hljs-keyword">default</span>       <span class="hljs-keyword">default</span>                <span class="hljs-number">1</span>         <span class="hljs-number">18</span>d<br>kube-<span class="hljs-built_in">public</span>   <span class="hljs-keyword">default</span>                <span class="hljs-number">1</span>         <span class="hljs-number">18</span>d<br>kube-<span class="hljs-keyword">system</span>   <span class="hljs-keyword">admin</span>-<span class="hljs-keyword">user</span>             <span class="hljs-number">1</span>         <span class="hljs-number">9</span>d<br>kube-<span class="hljs-keyword">system</span>   coredns                <span class="hljs-number">1</span>         <span class="hljs-number">13</span>d<br>kube-<span class="hljs-keyword">system</span>   <span class="hljs-keyword">default</span>                <span class="hljs-number">1</span>         <span class="hljs-number">18</span>d<br>kube-<span class="hljs-keyword">system</span>   heapster               <span class="hljs-number">1</span>         <span class="hljs-number">9</span>d<br>kube-<span class="hljs-keyword">system</span>   kubernetes-dashboard   <span class="hljs-number">1</span>         <span class="hljs-number">9</span>d<br>➜  nexus <br></code></pre></td></tr></table></figure><p>如果kubernetes api开启了ServiceAccount（–admission_control=…,ServiceAccount,… ）</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs routeros">➜  nexus vim /usr/lib/systemd/system/kube-apiserver.service<br>[Unit]<br><span class="hljs-attribute">Description</span>=Kubernetes API<span class="hljs-built_in"> Server</span><br><span class="hljs-built_in"></span><span class="hljs-attribute">Documentation</span>=https://github.com/GoogleCloudPlatform/kubernetes<br><span class="hljs-attribute">After</span>=network.target<br><br>[Service]<br><span class="hljs-attribute">ExecStart</span>=/data/kubernetes/bin/kube-apiserver \<br>  <span class="hljs-attribute">--admission-control</span>=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota,NodeRestriction \<br>  <span class="hljs-attribute">--bind-address</span>=192.168.0.14 \<br>  <span class="hljs-attribute">--insecure-bind-address</span>=127.0.0.1 \<br>  <span class="hljs-built_in">..</span><span class="hljs-built_in">..</span><span class="hljs-built_in">..</span>.<br></code></pre></td></tr></table></figure><p>那么会在每个namespace下面都会创建一个默认的default的sa。<br>如下，其中最重要的就是secrets，每个sa下面都会拥有的一个加密的token。</p><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs vbnet">➜  nexus kubectl <span class="hljs-keyword">get</span> sa <span class="hljs-keyword">default</span> <br>NAME      SECRETS   AGE<br><span class="hljs-keyword">default</span>   <span class="hljs-number">1</span>         <span class="hljs-number">18</span>d<br>➜  nexus <br>➜  nexus kubectl <span class="hljs-keyword">get</span> sa <span class="hljs-keyword">default</span> -o yaml<br><span class="hljs-symbol">apiVersion:</span> v1<br><span class="hljs-symbol">kind:</span> ServiceAccount<br><span class="hljs-symbol">metadata:</span><br>  creationTimestamp: <span class="hljs-number">2018</span>-<span class="hljs-number">06</span>-<span class="hljs-number">07</span>T07:<span class="hljs-number">52</span>:<span class="hljs-number">58</span>Z<br>  name: <span class="hljs-keyword">default</span><br>  <span class="hljs-keyword">namespace</span>: <span class="hljs-keyword">default</span><br>  resourceVersion: <span class="hljs-string">&quot;149&quot;</span><br>  selfLink: /api/v1/namespaces/<span class="hljs-keyword">default</span>/serviceaccounts/<span class="hljs-keyword">default</span><br>  uid: cb4da2fd-<span class="hljs-number">6</span>a27-<span class="hljs-number">11e8</span>-<span class="hljs-number">8209</span>-<span class="hljs-number">5254004</span>f2222<br><span class="hljs-symbol">secrets:</span><br>- name: <span class="hljs-keyword">default</span>-token-fck44<br>➜  nexus <br></code></pre></td></tr></table></figure><p>当用户在该namespace下创建pod的时候都会默认使用这个sa，下面是get pod -o yaml截取的部分，可以看到kubernetes会把默认的sa挂载到容器内。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">volumes:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nexus-data</span><br>    <span class="hljs-attr">persistentVolumeClaim:</span><br>      <span class="hljs-attr">claimName:</span> <span class="hljs-string">nexus3-data-pvc</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">default-token-fck44</span><br>    <span class="hljs-attr">secret:</span><br>      <span class="hljs-attr">defaultMode:</span> <span class="hljs-number">420</span><br>      <span class="hljs-attr">secretName:</span> <span class="hljs-string">default-token-fck44</span><br></code></pre></td></tr></table></figure><p>具体看一下secret</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs dts">➜  nexus kubectl get secret                     <br>NAME                  TYPE                                  DATA      AGE<br>default-token-fck44   kubernetes.io/service-account-token   <span class="hljs-number">3</span>         <span class="hljs-number">18</span>d<br>registrykey<span class="hljs-number">-2.6</span><span class="hljs-number">.2</span>     kubernetes.io/dockerconfigjson        <span class="hljs-number">1</span>         <span class="hljs-number">3</span>d<br>registrykey-m262<span class="hljs-number">-3</span>    kubernetes.io/dockerconfigjson        <span class="hljs-number">1</span>         <span class="hljs-number">2</span>d<br>registrykey-m262<span class="hljs-number">-5</span>    kubernetes.io/dockerconfigjson        <span class="hljs-number">1</span>         <span class="hljs-number">2</span>h<br>➜  nexus <br>➜  nexus kubectl get secret default-token-fck44 -o yaml<br><span class="hljs-symbol">apiVersion:</span> v1<br><span class="hljs-symbol">data:</span><br>  ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUR2akNDQXFhZ0F3SUJBZ0lVVVZFU2V4MnJsdddcUN3NzF5V1RTCjJicjZXbHRHanZsaVJSK1VoWWlGOGJ3ODk2ZGxzVjYvSUtHVDRwUE1zUUV1bmE2RmZEd0Y5V3cxbVFPRE1BWlUKalRUSzA0aXFHdmVSL2RqMitzSTc0SGJnSDA0N2hCb1pXUHhkOVorUHFPeDhYOVZBeUtvMW10aktVTDltOXdsbQovOWc9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K<br><span class="hljs-symbol">  namespace:</span> ZGVmYXVsdA==<br><span class="hljs-symbol">  token:</span> ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNklpSjkuZXlKcGMzTWlPaUpyZFdKbGNtNWxkR1ZdsdsdN3dHZG9URDNrU1RjNEhiWmxzNUZuWmtrbGJ5SmFkT3JnYUlQVWROTE56eUt4OGdINkFkXzYtNjQ3QnhObUdiZGQ0ZXBVSG9Ga0tDZlAxaktid3daYVI4OXRxb1Z3YUhXVnBuVTdkU3hVZkNtZV8waE1Bc1RQRFFfX2xPWWJuX1ZMNjFKSXAydDdBSXRGQjl4c3hnX1pLZEdEWTcwZGI3TEo1Mm01TmRhREgxdEhHX0VGckdiVVI2QmYyLTVsa3JhYl9BTTE0a1NfM19MRWRLSXM3SWc=<br><span class="hljs-symbol">kind:</span> Secret<br><span class="hljs-symbol">metadata:</span><br><span class="hljs-symbol">  annotations:</span><br>    kubernetes.io/service-account.name: default<br>    kubernetes.io/service-account.uid: cb4da2fd<span class="hljs-number">-6</span>a27<span class="hljs-number">-11e8</span><span class="hljs-number">-8209</span><span class="hljs-number">-5254004</span>f2222<br><span class="hljs-symbol">  creationTimestamp:</span> <span class="hljs-number">2018</span><span class="hljs-number">-06</span><span class="hljs-number">-07</span>T07:<span class="hljs-number">52</span>:<span class="hljs-number">58</span>Z<br><span class="hljs-symbol">  name:</span> default-token-fck44<br><span class="hljs-symbol">  namespace:</span> default<br><span class="hljs-symbol">  resourceVersion:</span> <span class="hljs-string">&quot;146&quot;</span><br><span class="hljs-symbol">  selfLink:</span> <span class="hljs-meta-keyword">/api/</span>v1<span class="hljs-meta-keyword">/namespaces/</span>default<span class="hljs-meta-keyword">/secrets/</span>default-token-fck44<br><span class="hljs-symbol">  uid:</span> cb51b5b6<span class="hljs-number">-6</span>a27<span class="hljs-number">-11e8</span><span class="hljs-number">-8209</span><span class="hljs-number">-5254004</span>f2222<br><span class="hljs-symbol">type:</span> kubernetes.io/service-account-token<br>➜  nexus <br></code></pre></td></tr></table></figure><p>上面的内容是经过base64加密过后的，直接进入容器内：</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs tap">➜  nexus kubectl get pod              <br>NAME                              READY     STATUS    RESTARTS   AGE<br>nexus3-68f55d9746-vfnf8           1/1       Running  <span class="hljs-number"> 0 </span>         3d<br>rbd-rest-api-registrykey-m262-1   1/1       Running  <span class="hljs-number"> 0 </span>         3d<br>➜  nexus <br>➜  nexus kubectl exec nexus3-68f55d9746-vfnf8 -it /bin/bash<br>[root@nexus3-68f55d9746-vfnf8 /]<span class="hljs-comment"># ls -lth /var/run/secrets/kubernetes.io/serviceaccount</span><br>total 0<br>lrwxrwxrwx.<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 13 </span>Jun<span class="hljs-number"> 21 </span>21:29 ca.crt -&gt; ..data/ca.crt<br>lrwxrwxrwx.<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 16 </span>Jun<span class="hljs-number"> 21 </span>21:29 namespace -&gt; ..data/namespace<br>lrwxrwxrwx.<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 12 </span>Jun<span class="hljs-number"> 21 </span>21:29 token -&gt; ..data/token<br></code></pre></td></tr></table></figure><p>可以看到已将ca.crt 、namespace和token放到容器内了，那么这个容器就可以通过https的请求访问apiserver了。</p>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Kubernetes RBAC  Detailed</title>
    <link href="/2018/06/27/bernetes-RBAC-Detailed/"/>
    <url>/2018/06/27/bernetes-RBAC-Detailed/</url>
    
    <content type="html"><![CDATA[<p>RBAC - 基于角色的访问控制<br>RBAC使用：rbac.authorization.k8s.io API Group 来实现授权决策，允许管理员通过 Kubernetes API 动态配置策略，要启用RBAC，需要在 apiserver 中添加参数–authorization-mode=RBAC，如果使用的kubeadm安装的集群，1.6 版本以上的都默认开启了RBAC，可以通过查看 Master 节点上 apiserver 的静态Pod定义文件：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">$ cat <span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/systemd/</span>system/kube-apiserver.service<br>或者是：<br>$ cat <span class="hljs-regexp">/etc/</span>kubernetes<span class="hljs-regexp">/manifests/</span>kube-apiserver.yaml<br>...<br>    - --authorization-mode=Node,RBAC<br>...<br></code></pre></td></tr></table></figure><p>如果是二进制的方式搭建的集群，添加这个参数过后，记得要重启 apiserver 服务。</p><hr><h3 id="RBAC-API-对象"><a href="#RBAC-API-对象" class="headerlink" title="RBAC API 对象"></a>RBAC API 对象</h3><p>Kubernetes有一个很基本的特性就是它的所有资源对象都是模型化的 API 对象，允许执行 CRUD(Create、Read、Update、Delete)操作(也就是我们常说的增、删、改、查操作)，比如下面的这下资源：</p><ul><li>Pods</li><li>ConfigMaps</li><li>Deployments</li><li>Nodes</li><li>Secrets</li><li>Namespaces</li></ul><p>上面这些资源对象的可能存在的操作有：</p><ul><li>create</li><li>get</li><li>delete</li><li>list</li><li>update</li><li>edit</li><li>watch</li><li>exec</li></ul><p>在更上层，这些资源和API Group 进行关联，比如Pods属于Core API Group，而Deployements属于 apps API Group，要在Kubernetes中进行RBAC的管理，除了上面的这些资源和操作以外，我们还需要另外的一些对象：</p><ol><li>Rule：规则，规则是一组属于不同API Group 资源上的一组操作的集合</li><li>Role 和 ClusterRole：角色和集群角色，这两个对象都包含上面的Rules 元素，二者的区别在于，在Role 中，定义的规则只适用于单个命名空间，也就是和namespace 关联的，而ClusterRole 是集群范围内的，因此定义的规则不受命名空间的约束。另外Role和 ClusterRole在Kubernetes中都被定义为集群内部的API 资源，和Pod、ConfigMap 这些类似，都是集群的资源对象，所以同样的可以使用kubectl相关的命令来进行操作</li><li>Subject：主题，对应在集群中尝试操作的对象，集群中定义了3种类型的主题资源：</li></ol><ul><li>User Account：用户，这是有外部独立服务进行管理的，管理员进行私钥的分配，用户可以使用KeyStone或者Goolge 帐号，甚至一个用户名和密码的文件列表也可以。对于用户的管理集群内部没有一个关联的资源对象，所以用户不能通过集群内部的API 来进行管理</li><li>Group：组，这是用来关联多个账户的，集群中有一些默认创建的组，比如cluster-admin</li><li>Service Account：服务帐号，通过Kubernetes API 来管理的一些用户帐号，和namespace 进行关联的，适用于集群内部运行的应用程序，需要通过API 来完成权限认证，所以在集群内部进行权限操作，都需要使用到 ServiceAccount</li></ul><ol start="4"><li>RoleBinding和 ClusterRoleBinding：角色绑定和集群角色绑定，简单来说就是把声明的Subject和Role 进行绑定的过程(给某个用户绑定上操作的权限)，二者的区别也是作用范围的区别：RoleBinding只会影响到当前namespace 下面的资源操作权限，而ClusterRoleBinding会影响到所有的 namespace。</li></ol><span id="more"></span><hr><h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p>通过如下示例来演示RBAC的配置方法：</p><h4 id="创建一个只能访问某个-namespace-的用户"><a href="#创建一个只能访问某个-namespace-的用户" class="headerlink" title="创建一个只能访问某个 namespace 的用户"></a>创建一个只能访问某个 namespace 的用户</h4><p>创建一个 User Account，只能访问 kube-system这个命名空间：</p><ul><li>username: martin</li><li>group: op</li></ul><h5 id="第一步：创建用户凭证"><a href="#第一步：创建用户凭证" class="headerlink" title="第一步：创建用户凭证"></a>第一步：创建用户凭证</h5><p>Kubernetes没有User Account的API 对象，不过要创建一个用户帐号的话也是挺简单的，利用管理员分配的一个私钥就可以创建了。<br>创建方法有两种:</p><h6 id="1-使用OpenSSL证书来创建User；"><a href="#1-使用OpenSSL证书来创建User；" class="headerlink" title="1. 使用OpenSSL证书来创建User；"></a>1. 使用OpenSSL证书来创建User；</h6><ul><li>给用户martin创建一个私钥，命名成：martin.key：</li></ul><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sas">$ openssl genrsa -<span class="hljs-meta">out</span> martin.<span class="hljs-meta">key</span> 2048<br></code></pre></td></tr></table></figure><ul><li>使用刚刚创建的私钥创建一个证书签名请求文件：martin.csr，要注意需要确保在-subj参数中指定用户名和组(CN表示用户名，O表示组)：</li></ul><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">$ openssl req -<span class="hljs-built_in">new</span> -<span class="hljs-built_in">key</span> martin.<span class="hljs-built_in">key</span> -out martin.csr -subj <span class="hljs-string">&quot;/CN=martin/O=op&quot;</span><br></code></pre></td></tr></table></figure><ul><li><p>然后找到Kubernetes集群的CA，我们使用的是kubeadm安装的集群，CA相关证书位于/etc/kubernetes/pki/目录下面，如果是二进制方式搭建的，应该在最开始搭建集群的时候就已经指定好了CA的目录(/data/kubernetes/ssl)，然后利用该目录下面的ca.crt和ca.key两个文件来批准上面的证书请求</p></li><li><p>生成最终的证书文件，这里设置证书的有效期为500天</p></li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">$ openssl x509 -req -<span class="hljs-keyword">in</span> martin.csr -CA <span class="hljs-regexp">/data/</span>kubernetes<span class="hljs-regexp">/ssl/</span>ca.crt -CAkey <span class="hljs-regexp">/data/</span>kubernetes<span class="hljs-regexp">/ssl/</span>ca.key -CAcreateserial -out martin.crt -days <span class="hljs-number">500</span><br>现在查看当前文件夹下面是否生成了一个证书文件：<br>$ ls<br>martin.csr martin.key martin.crt<br></code></pre></td></tr></table></figure><ul><li>现在可以使用刚刚创建的证书文件和私钥文件在集群中创建新的凭证和上下文(Context):</li></ul><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dsconfig">$ <span class="hljs-string">kubectl</span> <span class="hljs-string">config</span> <span class="hljs-built_in">set-credentials</span> <span class="hljs-string">martin</span> <span class="hljs-built_in">--client-certificate=martin.crt</span>  <span class="hljs-built_in">--client-key=martin.key</span><br></code></pre></td></tr></table></figure><ul><li>可以看到一个用户martin创建了，然后为这个用户设置新的 Context:</li></ul><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dsconfig">$ <span class="hljs-string">kubectl</span> <span class="hljs-string">config</span> <span class="hljs-built_in">set-context</span> <span class="hljs-string">martin-context</span> <span class="hljs-built_in">--cluster=kubernetes</span> <span class="hljs-built_in">--namespace=kube-system</span> <span class="hljs-built_in">--user=martin</span><br></code></pre></td></tr></table></figure><p>到这里，用户martin就已经创建成功了，现在使用当前的这个配置文件来操作kubectl命令的时候，应该会出现错误，因为还没有为该用户定义任何操作的权限：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">$ kubectl <span class="hljs-builtin-name">get</span> pods <span class="hljs-attribute">--context</span>=martin-context<br><span class="hljs-builtin-name">Error</span> <span class="hljs-keyword">from</span><span class="hljs-built_in"> server </span>(Forbidden): pods is forbidden:<span class="hljs-built_in"> User </span><span class="hljs-string">&quot;martin&quot;</span> cannot list pods <span class="hljs-keyword">in</span> the namespace <span class="hljs-string">&quot;default&quot;</span><br></code></pre></td></tr></table></figure><h6 id="2-使用cfssl工具来创建，也是参考官方文档中的方法。"><a href="#2-使用cfssl工具来创建，也是参考官方文档中的方法。" class="headerlink" title="2. 使用cfssl工具来创建，也是参考官方文档中的方法。"></a>2. 使用cfssl工具来创建，也是参考官方文档中的方法。</h6><ul><li><p>CFSSL是CloudFlare开源的一款PKI/TLS工具。 CFSSL 包含一个命令行工具和一个用于签名，验证并且捆绑TLS证书的HTTP API服务。使用Go语言编写。</p></li><li><p>CFSSL包括：</p><ul><li>一组用于生成自定义TLS PKI的工具</li><li>cfssl程序，是CFSSL的命令行工具</li><li>multirootca程序是可以使用多个签名密钥的证书颁发机构服务器</li><li>mkbundle程序用于构建证书池</li><li>cfssljson程序，从cfssl和multirootca程序获取JSON输出，并将证书，密钥，CSR和bundle写入磁盘</li></ul></li><li><p>PKI借助数字证书和公钥加密技术提供可信任的网络身份。通常，证书就是一个包含如下身份信息的文件：</p><ul><li>证书所有组织的信息</li><li>公钥</li><li>证书颁发组织的信息</li><li>证书颁发组织授予的权限，如证书有效期、适用的主机名、用途等</li><li>使用证书颁发组织私钥创建的数字签名</li></ul></li><li><p>cfssl工具，子命令介绍：</p><ul><li>bundle: 创建包含客户端证书的证书包</li><li>genkey: 生成一个key(私钥)和CSR(证书签名请求)</li><li>scan: 扫描主机问题</li><li>revoke: 吊销证书</li><li>certinfo: 输出给定证书的证书信息，跟cfssl-certinfo 工具作用一样</li><li>gencrl: 生成新的证书吊销列表</li><li>selfsign: 生成一个新的自签名密钥和签名证书</li><li>print-defaults: 打印默认配置，这个默认配置可以用作模板</li><li>serve: 启动一个HTTP API服务</li><li>gencert: 生成新的key(密钥)和签名证书</li><li>-ca：指明ca的证书</li><li>-ca-key：指明ca的私钥文件</li><li>-config：指明请求证书的json文件</li><li>-profile：与-config中的profile对应，是指根据config中的prof  ile段来生成证书的相关信息</li><li>ocspdump</li><li>ocspsign</li><li>info: 获取有关远程签名者的信息</li><li>sign: 签名一个客户端证书，通过给定的CA和CA密钥，和主机名</li><li>ocsprefresh</li><li>ocspserve</li></ul></li><li><p>创建认证中心(CA)，也就是Kubernetes集群的CA，上面用openssl时已经将其省略了，现cfssl操作说明下详细方法：</p><ol><li><p>CFSSL可以创建一个获取和操作证书的内部认证中心。运行认证中心需要一个CA证书和相应的CA私钥。任何知道私钥的人都可以充当CA颁发证书。因此，私钥的保护至关重要。</p></li><li><p>创建用来生成CA文件的JSON配置文件,配置证书生成策略，让CA软件知道颁发什么样的证书。</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs axapta">[root@linux-node1 ssl]<span class="hljs-meta"># vim ca-config.json</span><br>&#123;<br>  <span class="hljs-string">&quot;signing&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;default&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;expiry&quot;</span>: <span class="hljs-string">&quot;8760h&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;profiles&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;kubernetes&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;usages&quot;</span>: [<br>            <span class="hljs-string">&quot;signing&quot;</span>,<br>            <span class="hljs-string">&quot;key encipherment&quot;</span>,<br>            <span class="hljs-string">&quot;server auth&quot;</span>,<br>            <span class="hljs-string">&quot;client auth&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;expiry&quot;</span>: <span class="hljs-string">&quot;8760h&quot;</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br>这个策略，有一个默认的配置，和一个profile，可以设置多个profile，这里的profile   是kubernetes。<br>默认策略，指定了证书的有效期是一年(<span class="hljs-number">8760</span>h)<br>kubernetes策略，指定了证书的用途<br>signing, 表示该证书可用于签名其它证书；生成的ca.pem 证书中   CA=TRUE<br><span class="hljs-keyword">server</span> auth：表示<span class="hljs-keyword">client</span>可以用该CA对<span class="hljs-keyword">server</span>提供的证书进行验证<br><span class="hljs-keyword">client</span> auth：表示<span class="hljs-keyword">server</span>可以用该CA对<span class="hljs-keyword">client</span>提供的证书进行验证<br></code></pre></td></tr></table></figure></li><li><p>创建用来生成CA证书签名请求（CSR）的JSON配置文件</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs makefile">[root@linux-node1 ssl]<span class="hljs-comment"># vim ca-csr.json</span><br>&#123;<br>  <span class="hljs-string">&quot;CN&quot;</span>: <span class="hljs-string">&quot;kubernetes&quot;</span>,<br>  <span class="hljs-string">&quot;key&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;algo&quot;</span>: <span class="hljs-string">&quot;rsa&quot;</span>,<br>    <span class="hljs-string">&quot;size&quot;</span>: 2048<br>  &#125;,<br>  <span class="hljs-string">&quot;names&quot;</span>: [<br>    &#123;<br>      <span class="hljs-string">&quot;C&quot;</span>: <span class="hljs-string">&quot;CN&quot;</span>,<br>      <span class="hljs-string">&quot;ST&quot;</span>: <span class="hljs-string">&quot;BeiJing&quot;</span>,<br>      <span class="hljs-string">&quot;L&quot;</span>: <span class="hljs-string">&quot;BeiJing&quot;</span>,<br>      <span class="hljs-string">&quot;O&quot;</span>: <span class="hljs-string">&quot;k8s&quot;</span>,<br>      <span class="hljs-string">&quot;OU&quot;</span>: <span class="hljs-string">&quot;System&quot;</span><br>    &#125;<br>  ]<br>&#125;<br><span class="hljs-section">术语介绍:</span><br><span class="hljs-section">CN: Common Name，浏览器使用该字段验证网站是否合法，一般写的是域名。非常重要。浏览器使用该字段验证网站是否合法</span><br><span class="hljs-section">C: Country， 国家</span><br><span class="hljs-section">L: Locality，地区，城市</span><br><span class="hljs-section">O: Organization Name，组织名称，公司名称</span><br><span class="hljs-section">OU: Organization Unit Name，组织单位名称，公司部门</span><br><span class="hljs-section">ST: State，州，省</span><br></code></pre></td></tr></table></figure></li><li><p>生成CA证书（ca.pem）和私钥（ca-key.pem）  </p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@ linux-node1 ssl]<span class="hljs-comment"># cfssl gencert -initca ca-csr.json |   cfssljson -bare ca  </span><br><span class="hljs-comment">#初始化ca</span><br>[root@ linux-node1 ssl]<span class="hljs-comment"># ls -l ca*</span><br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 290 </span>Mar <span class="hljs-number"> 4 </span>13:45 ca-config.json<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1001 </span>Mar <span class="hljs-number"> 4 </span>14:09 ca.csr<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 208 </span>Mar <span class="hljs-number"> 4 </span>13:51 ca-csr.json<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Mar <span class="hljs-number"> 4 </span>14:09 ca-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1359 </span>Mar <span class="hljs-number"> 4 </span>14:09 ca.pem<br>该命令会生成运行CA所必需的文件ca-key.pem（私钥）和ca.pem（证书），还会生成ca.csr（证书签名请求），用于交叉签名或重新签名。<br></code></pre></td></tr></table></figure><p>小提示：</p></li></ol><ul><li>使用现有的CA私钥，重新生成：</li></ul> <figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata">cfssl gencert -initca -<span class="hljs-keyword">ca</span>-key key.pem <span class="hljs-keyword">ca</span>-csr.json |     cfssljson -bare <span class="hljs-keyword">ca</span><br></code></pre></td></tr></table></figure><ul><li>使用现有的CA私钥和CA证书，重新生成：</li></ul> <figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lsl">cfssl gencert -renewca -ca cert.pem -ca-<span class="hljs-type">key</span> <span class="hljs-type">key</span>.pem<br></code></pre></td></tr></table></figure><ul><li>查看cert(证书信息)：cfssl certinfo -cert ca.pem</li><li>查看CSR(证书签名请求)信息：cfssl certinfo -csr ca.csr</li></ul></li><li><p>创建martin证书签名请求(Kubernetes集群的CA创建好了，再根据该CA证书来创建一个只能访问某个namespace的用户)</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">➜  martin cat martin-csr.json <br>&#123;<br>  &quot;CN&quot;: &quot;martin&quot;,<br>  &quot;hosts&quot;: [],<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: <span class="hljs-number">2048</span><br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;ST&quot;: &quot;BeiJing&quot;,<br>      &quot;L&quot;: &quot;BeiJing&quot;,<br>      &quot;O&quot;: &quot;op&quot;, #<span class="hljs-keyword">system</span>:masters<br>      &quot;OU&quot;: &quot;System&quot;<br>    &#125;<br>  ]<br>&#125;<br>➜  martin <br>后续kube-apiserver使用RBAC对客户端(如kubelet、kube-proxy、Pod)请求进行授权；<br>kube-apiserver预定义了一些RBAC使用的RoleBindings，如<span class="hljs-keyword">cluster</span>-<span class="hljs-keyword">admin</span>将<span class="hljs-keyword">Group</span> op(<span class="hljs-keyword">system</span>:masters)与 <span class="hljs-keyword">Role</span> <span class="hljs-keyword">cluster</span>-<span class="hljs-keyword">admin</span> 绑定，该<span class="hljs-keyword">Role</span>授予了调用kube-apiserver的所有API的权限；<br>OU指定该证书的<span class="hljs-keyword">Group</span>为op(<span class="hljs-keyword">system</span>:masters)，kubelet使用该证书访问 kube-apiserver时,由于证书被CA签名，所以认证通过，同时由于证书用户组为经过预授权的op(<span class="hljs-keyword">system</span>:masters)，所以被授予访问所有 API 的权限；<br></code></pre></td></tr></table></figure></li><li><p>生成martin证书和私钥</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">➜  martin ls -lth<br>total <span class="hljs-number">4.0</span>K<br>-rw-r<span class="hljs-comment">--r-- 1 root root 218 Jun 26 11:59 martin-csr.json</span><br>➜  martin cfssl gencert -ca=/data/kubernetes/ssl/ca.pem -ca-key=/data/kubernetes/ssl/ca-key.pem -config=/data/kubernetes/ssl/ca-config.json -profile=kubernetes martin-csr.json|cfssljson -bare martin<br><span class="hljs-number">2018</span>/<span class="hljs-number">06</span>/<span class="hljs-number">26</span> <span class="hljs-number">16</span>:<span class="hljs-number">20</span>:<span class="hljs-number">37</span> [<span class="hljs-keyword">INFO</span>] generate received request<br><span class="hljs-number">2018</span>/<span class="hljs-number">06</span>/<span class="hljs-number">26</span> <span class="hljs-number">16</span>:<span class="hljs-number">20</span>:<span class="hljs-number">37</span> [<span class="hljs-keyword">INFO</span>] received CSR<br><span class="hljs-number">2018</span>/<span class="hljs-number">06</span>/<span class="hljs-number">26</span> <span class="hljs-number">16</span>:<span class="hljs-number">20</span>:<span class="hljs-number">37</span> [<span class="hljs-keyword">INFO</span>] generating key: rsa<span class="hljs-number">-2048</span><br><span class="hljs-number">2018</span>/<span class="hljs-number">06</span>/<span class="hljs-number">26</span> <span class="hljs-number">16</span>:<span class="hljs-number">20</span>:<span class="hljs-number">38</span> [<span class="hljs-keyword">INFO</span>] encoded CSR<br><span class="hljs-number">2018</span>/<span class="hljs-number">06</span>/<span class="hljs-number">26</span> <span class="hljs-number">16</span>:<span class="hljs-number">20</span>:<span class="hljs-number">38</span> [<span class="hljs-keyword">INFO</span>] signed certificate <span class="hljs-keyword">with</span> <span class="hljs-type">serial</span> number <span class="hljs-number">451530418945753741698899402739082416074910829402</span><br><span class="hljs-number">2018</span>/<span class="hljs-number">06</span>/<span class="hljs-number">26</span> <span class="hljs-number">16</span>:<span class="hljs-number">20</span>:<span class="hljs-number">38</span> [<span class="hljs-built_in">WARNING</span>] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable <span class="hljs-keyword">for</span><br>websites. <span class="hljs-keyword">For</span> more information see the Baseline Requirements <span class="hljs-keyword">for</span> the Issuance <span class="hljs-keyword">and</span> Management<br><span class="hljs-keyword">of</span> Publicly-<span class="hljs-keyword">Trusted</span> Certificates, v<span class="hljs-number">.1</span><span class="hljs-number">.1</span><span class="hljs-number">.6</span>, <span class="hljs-keyword">from</span> the CA/Browser Forum (https://cabforum.org);<br>specifically, section <span class="hljs-number">10.2</span><span class="hljs-number">.3</span> (&quot;Information Requirements&quot;).<br>➜  martin ls -lth<br>total <span class="hljs-number">16</span>K<br>-rw-r<span class="hljs-comment">--r-- 1 root root  993 Jun 26 16:20 martin.csr</span><br>-rw<span class="hljs-comment">------- 1 root root 1.7K Jun 26 16:20 martin-key.pem</span><br>-rw-r<span class="hljs-comment">--r-- 1 root root 1.4K Jun 26 16:20 martin.pem</span><br>-rw-r<span class="hljs-comment">--r-- 1 root root  218 Jun 26 11:59 martin-csr.json</span><br>➜  martin <br></code></pre></td></tr></table></figure></li><li><p>设置集群参数</p></li></ul><p>本段主要设置了需要访问的集群的信息。使用set-cluster设置了需要访问的集群，如下为kubernetes，这只是个名称，实际为–server指向的apiserver；–certificate-authority设置了该集群的公钥；–embed-certs为true表示将–certificate-authority证书写入到kubeconfig中；–server则表示该集群的kube-apiserver地址</p><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs dsconfig">➜  <span class="hljs-string">martin</span> <span class="hljs-string">kubectl</span> <span class="hljs-string">config</span> <span class="hljs-built_in">set-cluster</span> <span class="hljs-string">kubernetes</span> <span class="hljs-built_in">--certificate-authority=/data/kubernetes/ssl/ca.pem</span> <span class="hljs-built_in">--embed-certs=true</span> <span class="hljs-built_in">--server=https://192.168.0.14:6443</span> <span class="hljs-built_in">--kubeconfig=martin.kubeconfig</span><br><span class="hljs-string">Cluster</span> <span class="hljs-string">&quot;kubernetes&quot;</span> <span class="hljs-string">set</span>.<br>➜  <span class="hljs-string">martin</span> <span class="hljs-string">ls</span> -<span class="hljs-string">lth</span><br><span class="hljs-string">total</span> <span class="hljs-string">20K</span><br>-<span class="hljs-string">rw</span>------- <span class="hljs-string">1</span> <span class="hljs-string">root</span> <span class="hljs-string">root</span> <span class="hljs-string">2</span>.<span class="hljs-string">0K</span> <span class="hljs-string">Jun</span> <span class="hljs-string">26</span> <span class="hljs-string">16:29 </span><span class="hljs-string">martin</span>.<span class="hljs-string">kubeconfig</span><br>-<span class="hljs-string">rw-r</span><span class="hljs-built_in">--r--</span> <span class="hljs-string">1</span> <span class="hljs-string">root</span> <span class="hljs-string">root</span>  <span class="hljs-string">993</span> <span class="hljs-string">Jun</span> <span class="hljs-string">26</span> <span class="hljs-string">16:20 </span><span class="hljs-string">martin</span>.<span class="hljs-string">csr</span><br>-<span class="hljs-string">rw</span>------- <span class="hljs-string">1</span> <span class="hljs-string">root</span> <span class="hljs-string">root</span> <span class="hljs-string">1</span>.<span class="hljs-string">7K</span> <span class="hljs-string">Jun</span> <span class="hljs-string">26</span> <span class="hljs-string">16:20 </span><span class="hljs-string">martin-key</span>.<span class="hljs-string">pem</span><br>-<span class="hljs-string">rw-r</span><span class="hljs-built_in">--r--</span> <span class="hljs-string">1</span> <span class="hljs-string">root</span> <span class="hljs-string">root</span> <span class="hljs-string">1</span>.<span class="hljs-string">4K</span> <span class="hljs-string">Jun</span> <span class="hljs-string">26</span> <span class="hljs-string">16:20 </span><span class="hljs-string">martin</span>.<span class="hljs-string">pem</span><br>-<span class="hljs-string">rw-r</span><span class="hljs-built_in">--r--</span> <span class="hljs-string">1</span> <span class="hljs-string">root</span> <span class="hljs-string">root</span>  <span class="hljs-string">218</span> <span class="hljs-string">Jun</span> <span class="hljs-string">26</span> <span class="hljs-string">11:59 </span><span class="hljs-string">martin-csr</span>.<span class="hljs-string">json</span><br>生成了新的文件：<span class="hljs-string">martin</span>.<span class="hljs-string">kubeconfig</span><br>➜  <span class="hljs-string">martin</span> <span class="hljs-string">cat</span> <span class="hljs-string">martin</span>.<span class="hljs-string">kubeconfig</span> <br><span class="hljs-string">apiVersion</span>: <span class="hljs-string">v1</span><br><span class="hljs-string">clusters</span>:<br>- <span class="hljs-string">cluster</span>:<br>    <span class="hljs-string">certificate-authority-data</span>: <span class="hljs-string">xxx</span><br>    <span class="hljs-string">server</span>: <span class="hljs-string">https</span>://<span class="hljs-string">192</span>.<span class="hljs-string">168</span>.<span class="hljs-string">0</span>.<span class="hljs-string">14:6443</span><br><span class="hljs-string"></span>  <span class="hljs-string">name</span>: <span class="hljs-string">kubernetes</span><br><span class="hljs-string">contexts</span>: []<br><span class="hljs-string">current-context</span>: <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-string">kind</span>: <span class="hljs-string">Config</span><br><span class="hljs-string">preferences</span>: &#123;&#125;<br><span class="hljs-string">users</span>: []<br>➜  <span class="hljs-string">martin</span> <br><br></code></pre></td></tr></table></figure><p>注意：–kubeconfig=martin.kubeconfig是将生成的相关信息全部写入martin.kubeconfig文件,如果不指定的话，默认是写入到“~/.kube/config ”</p><ul><li>设置客户端认证参数</li></ul><p>本段主要设置用户的相关信息，主要是用户证书。如下用户名为martin，证书为：/martin.pem，私钥为：./martin-key.pem。客户端的证书首先要经过集群CA的签署，否则不会被集群认可。此处使用的是ca认证方式，也可以使用token认证，如kubelet的TLS Boostrap机制下的bootstrapping使用的就是token认证方式。如下kubectl使用的是ca认证，不需要token字段</p><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs dsconfig">➜  <span class="hljs-string">martin</span> <span class="hljs-string">kubectl</span> <span class="hljs-string">config</span> <span class="hljs-built_in">set-credentials</span> <span class="hljs-string">martin</span> <span class="hljs-built_in">--client-certificate=./martin.pem</span> <span class="hljs-built_in">--client-key=./martin-key.pem</span> <span class="hljs-built_in">--embed-certs=true</span> <span class="hljs-built_in">--kubeconfig=martin.kubeconfig</span>                                      <br><span class="hljs-string">User</span> <span class="hljs-string">&quot;martin&quot;</span> <span class="hljs-string">set</span>.<br>➜  <span class="hljs-string">martin</span> <br>可以看到<span class="hljs-string">martin</span>.<span class="hljs-string">kubeconfig</span>新增了如下内容：<br><span class="hljs-string">users</span>:<br>- <span class="hljs-string">name</span>: <span class="hljs-string">martin</span><br>  <span class="hljs-string">user</span>:<br>    <span class="hljs-string">xxx</span><br></code></pre></td></tr></table></figure><ul><li>设置上下文参数,指定命名空间为：kube-system</li></ul><p>集群参数和用户参数可以同时设置多对，在上下文参数中将集群参数和用户参数关联起来。下面的上下文名称为martin-context，集群为kubenetes，用户为martin，表示使用martin的用户凭证来访问kubenetes集群的kube-system命名空间(增加–namspace来指定访问的命名空间)。</p><p>执行之前先看下:martin.kubeconfig文件内容：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">➜</span>  <span class="hljs-string">martin</span> <span class="hljs-string">cat</span> <span class="hljs-string">martin.kubeconfig</span> <br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">clusters:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">cluster:</span><br>    <span class="hljs-attr">certificate-authority-data:</span> <span class="hljs-string">xxx</span><br>    <span class="hljs-attr">server:</span> <span class="hljs-string">https://192.168.0.14:6443</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes</span><br><span class="hljs-attr">contexts:</span> []<br><span class="hljs-attr">current-context:</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Config</span><br><span class="hljs-attr">preferences:</span> &#123;&#125;<br><span class="hljs-attr">users:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">martin</span><br>  <span class="hljs-attr">user:</span><br>    <span class="hljs-attr">client-certificate-data:</span> <span class="hljs-string">xxx</span><br>    <span class="hljs-attr">client-key-data:</span> <span class="hljs-string">xxx</span><br><span class="hljs-string">➜</span>  <span class="hljs-string">martin</span> <br></code></pre></td></tr></table></figure><p>执行：</p><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dsconfig">➜  <span class="hljs-string">martin</span> <span class="hljs-string">kubectl</span> <span class="hljs-string">config</span> <span class="hljs-built_in">set-context</span> <span class="hljs-string">martin-context</span> <span class="hljs-built_in">--cluster=kubernetes</span> <span class="hljs-built_in">--namespace=kube-system</span> <span class="hljs-built_in">--user=martin</span> <span class="hljs-built_in">--kubeconfig=martin.kubeconfig</span>   <br><span class="hljs-string">Context</span> <span class="hljs-string">&quot;martin-context&quot;</span> <span class="hljs-string">created</span>.<br>➜  <span class="hljs-string">martin</span> <br></code></pre></td></tr></table></figure><p>再次查看martin.kubeconfig文件,发现内容做了如下改变：<br>之前：</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">contexts:</span> [] <br></code></pre></td></tr></table></figure><p>现在：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">contexts:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">context:</span><br>    <span class="hljs-attr">cluster:</span> <span class="hljs-string">kubernetes</span><br>    <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>    <span class="hljs-attr">user:</span> <span class="hljs-string">martin</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">martin-context</span><br></code></pre></td></tr></table></figure><p>增加了上下文的相关信息。</p><ul><li>设置默认上下文</li></ul><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vhdl">➜  martin kubectl config <span class="hljs-keyword">use</span>-<span class="hljs-keyword">context</span> martin-<span class="hljs-keyword">context</span> <span class="hljs-comment">--kubeconfig=martin.kubeconfig</span><br>Switched <span class="hljs-keyword">to</span> <span class="hljs-keyword">context</span> <span class="hljs-string">&quot;martin-context&quot;</span>.<br></code></pre></td></tr></table></figure><p>如果配置了多个环境项，可以通过切换不同的环境项名字或指定kubeconfig文件来访问到不同的集群环境。</p><ul><li>现在martin用户通过cfssl创建成功,可以看到所有关于martin用户的信息都写入了配置文件：martin.kubeconfig,不指定”-kubeconfig=”的话，默认是写入到”~/.kube/config”，如果之前有admin的相关信息，会追加到后面。martin.kubeconfig配置文件描述了集群、用户和上下文</li></ul><p>kubectl只是个go编写的可执行程序，只要为kubectl配置合适的kubeconfig，就可以在集群中的任意节点使用。kubectl默认会从$HOME/.kube目录下查找文件名为config的文件，也可以通过设置环境变量KUBECONFIG或者通过设置–kubeconfig去指定其它kubeconfig文件,总之kubeconfig就是为访问集群所作的配置。</p><p>如果之前”~/.kube/config”下配置的是admin账号信息，要用martin账号，则指定kubeconfig文件即可：</p><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs dsconfig">➜  <span class="hljs-string">martin</span> <span class="hljs-string">kubectl</span> <span class="hljs-string">config</span> <span class="hljs-built_in">get-contexts</span>                               <br><span class="hljs-string">CURRENT</span>   <span class="hljs-string">NAME</span>         <span class="hljs-string">CLUSTER</span>      <span class="hljs-string">AUTHINFO</span>   <span class="hljs-string">NAMESPACE</span><br>*         <span class="hljs-string">kubernetes</span>   <span class="hljs-string">kubernetes</span>   <span class="hljs-string">admin</span>      <br>➜  <span class="hljs-string">martin</span> <br>➜  <span class="hljs-string">martin</span> <span class="hljs-string">kubectl</span> <span class="hljs-string">config</span> <span class="hljs-built_in">get-contexts</span> <span class="hljs-built_in">--kubeconfig</span> <span class="hljs-string">martin</span>.<span class="hljs-string">kubeconfig</span><br><span class="hljs-string">CURRENT</span>   <span class="hljs-string">NAME</span>             <span class="hljs-string">CLUSTER</span>      <span class="hljs-string">AUTHINFO</span>   <span class="hljs-string">NAMESPACE</span><br>*         <span class="hljs-string">martin-context</span>   <span class="hljs-string">kubernetes</span>   <span class="hljs-string">martin</span>     <span class="hljs-string">kube-system</span><br>➜  <span class="hljs-string">martin</span> <br></code></pre></td></tr></table></figure><p>现在使用当前的这个配置文件来操作kubectl命令的时候，应该会出现错误，因为还没有为该用户定义任何操作的权限呢：</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs subunit">➜  martin kubectl get pods --kubeconfig martin.kubeconfig<br><span class="hljs-keyword">Error </span>from server (Forbidden): pods is forbidden: User &quot;martin&quot; cannot list pods in the namespace &quot;default&quot;<br>➜  martin <br></code></pre></td></tr></table></figure><p>如果提示：“kubectl error: You must be logged in to the server (Unauthorized)”<br>则是没有指定martin.kubeconfig文件或者默认的”~/.kube/config”里面没有martin用户的相关证书信息，因为前面设置客户端认证的时候没有指定password，而是用了证书。</p><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dsconfig"><span class="hljs-string">kubectl</span> <span class="hljs-string">config</span> <span class="hljs-built_in">set-credentials</span> <span class="hljs-string">kubeuser</span>/<span class="hljs-string">foo</span>.<span class="hljs-string">kubernetes</span>.<span class="hljs-string">com</span> <span class="hljs-built_in">--username=kubeuser</span> <span class="hljs-built_in">--password=kubepassword</span> (用户名密码认证方式)<br><br><span class="hljs-string">kubectl</span> <span class="hljs-string">config</span> <span class="hljs-built_in">set-credentials</span> <span class="hljs-string">martin</span> <span class="hljs-built_in">--client-certificate=./martin.pem</span> <span class="hljs-built_in">--client-key=./martin-key.pem</span> <span class="hljs-built_in">--embed-certs=true</span> <span class="hljs-built_in">--kubeconfig=martin.kubeconfig</span><br>(证书认证方式)<br></code></pre></td></tr></table></figure><p>另外可以通过：”Cfssl-Certinfo“命令来查看martin证书信息</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs prolog">➜  martin cfssl-certinfo -cert martin.pem<br>&#123;<br>  <span class="hljs-string">&quot;subject&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;common_name&quot;</span>: <span class="hljs-string">&quot;martin&quot;</span>,<br>    <span class="hljs-string">&quot;country&quot;</span>: <span class="hljs-string">&quot;CN&quot;</span>,<br>    <span class="hljs-string">&quot;organization&quot;</span>: <span class="hljs-string">&quot;op&quot;</span>,<br>    <span class="hljs-string">&quot;organizational_unit&quot;</span>: <span class="hljs-string">&quot;System&quot;</span>,<br>    <span class="hljs-string">&quot;locality&quot;</span>: <span class="hljs-string">&quot;BeiJing&quot;</span>,<br>    <span class="hljs-string">&quot;province&quot;</span>: <span class="hljs-string">&quot;BeiJing&quot;</span>,<br>    <span class="hljs-string">&quot;names&quot;</span>: [<br>      <span class="hljs-string">&quot;CN&quot;</span>,<br>      <span class="hljs-string">&quot;BeiJing&quot;</span>,<br>      <span class="hljs-string">&quot;BeiJing&quot;</span>,<br>      <span class="hljs-string">&quot;op&quot;</span>,<br>      <span class="hljs-string">&quot;System&quot;</span>,<br>      <span class="hljs-string">&quot;martin&quot;</span><br>    ]<br>  &#125;,<br>  <span class="hljs-string">&quot;issuer&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;common_name&quot;</span>: <span class="hljs-string">&quot;kubernetes&quot;</span>,<br>    <span class="hljs-string">&quot;country&quot;</span>: <span class="hljs-string">&quot;CN&quot;</span>,<br>    <span class="hljs-string">&quot;organization&quot;</span>: <span class="hljs-string">&quot;k8s&quot;</span>,<br>    <span class="hljs-string">&quot;organizational_unit&quot;</span>: <span class="hljs-string">&quot;System&quot;</span>,<br>    <span class="hljs-string">&quot;locality&quot;</span>: <span class="hljs-string">&quot;BeiJing&quot;</span>,<br>    <span class="hljs-string">&quot;province&quot;</span>: <span class="hljs-string">&quot;BeiJing&quot;</span>,<br>    <span class="hljs-string">&quot;names&quot;</span>: [<br>      <span class="hljs-string">&quot;CN&quot;</span>,<br>      <span class="hljs-string">&quot;BeiJing&quot;</span>,<br>      <span class="hljs-string">&quot;BeiJing&quot;</span>,<br>      <span class="hljs-string">&quot;k8s&quot;</span>,<br>      <span class="hljs-string">&quot;System&quot;</span>,<br>      <span class="hljs-string">&quot;kubernetes&quot;</span><br>    ]<br>  &#125;,<br></code></pre></td></tr></table></figure><h5 id="第二步：创建角色"><a href="#第二步：创建角色" class="headerlink" title="第二步：创建角色"></a>第二步：创建角色</h5><p>用户创建完成后，接下来就需要给该用户添加操作权限，定义一个YAML文件，创建一个允许用户操作Deployment、Pod、ReplicaSets 的角色，如下定义：(martin-role.yaml)</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs dts">➜  martin cat martin-role.yaml <br><span class="hljs-symbol">apiVersion:</span> rbac.authorization.k8s.io/v1<br><span class="hljs-symbol">kind:</span> Role<br><span class="hljs-symbol">metadata:</span><br><span class="hljs-symbol">  name:</span> martin-role<br><span class="hljs-symbol">  namespace:</span> kube-system<br><span class="hljs-symbol">rules:</span><br>- apiGroups: [<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;extensions&quot;</span>, <span class="hljs-string">&quot;apps&quot;</span>]<br><span class="hljs-symbol">  resources:</span> [<span class="hljs-string">&quot;deployments&quot;</span>, <span class="hljs-string">&quot;replicasets&quot;</span>, <span class="hljs-string">&quot;pods&quot;</span>]<br><span class="hljs-symbol">  verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>, <span class="hljs-string">&quot;create&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>, <span class="hljs-string">&quot;patch&quot;</span>, <span class="hljs-string">&quot;delete&quot;</span>] <span class="hljs-meta"># 也可以使用[<span class="hljs-string">&#x27;*&#x27;</span>]</span><br>➜  martin <br></code></pre></td></tr></table></figure><p>其中Pod属于core这个API Group，在YAML中用空字符就可以，而Deployment属于apps 这个API Group，ReplicaSets属于extensions这个API Group(<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.10/">点这里查文档</a>)，所以 rules下面的apiGroups 就综合了这几个资源的 API Group：[“”, “extensions”, “apps”]，其中verbs就是上面提到的可以对这些资源对象执行的操作，这里需要所有的操作方法，所以也可以使用[‘*’]来代替。</p><p>然后创建这个Role:</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">➜  martin kubectl create -f martin-role<span class="hljs-selector-class">.yaml</span> <br>role<span class="hljs-selector-class">.rbac</span><span class="hljs-selector-class">.authorization</span><span class="hljs-selector-class">.k8s</span><span class="hljs-selector-class">.io</span> <span class="hljs-string">&quot;martin-role&quot;</span> created<br>➜  martin <br></code></pre></td></tr></table></figure><p>注意这里没有使用上面的martin-context这个上下文，因为木有权限</p><h5 id="第三步：创建角色权限绑定"><a href="#第三步：创建角色权限绑定" class="headerlink" title="第三步：创建角色权限绑定"></a>第三步：创建角色权限绑定</h5><p>Role创建完成了，但是很明显现在这个Role和我们的用户martin 还没有任何关系，这里就需要创建一个RoleBinding对象，在 kube-system这个命名空间下面将上面的martin-role角色和用户 martin进行绑定:(martin-rolebinding.yaml)</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs dts">➜  martin cat martin-rolebinding.yaml <br><span class="hljs-symbol">apiVersion:</span> rbac.authorization.k8s.io/v1<br><span class="hljs-symbol">kind:</span> RoleBinding<br><span class="hljs-symbol">metadata:</span><br><span class="hljs-symbol">  name:</span> martin-rolebinding<br><span class="hljs-symbol">  namespace:</span> kube-system<br><span class="hljs-symbol">roleRef:</span><br>  <span class="hljs-meta">#apiGroup: rbac.authorization.k8s.io</span><br>  <span class="hljs-meta">#kind: ClusterRole</span><br><span class="hljs-symbol">  kind:</span> Role<br><span class="hljs-symbol">  name:</span> martin-role<br><span class="hljs-symbol">  apiGroup:</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-symbol">subjects:</span><br>- apiGroup: <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-symbol">  kind:</span> User<br><span class="hljs-symbol">  name:</span> martin<br>  <span class="hljs-meta">#apiGroup: <span class="hljs-string">&quot;&quot;</span>  #会提示语法错误</span><br>➜  martin <br></code></pre></td></tr></table></figure><p>上面的YAML文件中看到了subjects关键字，这里就是上面提到的用来尝试操作集群的对象，这里对应上面的 User帐号martin，使用kubectl创建上面的资源对象：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">➜  martin kubectl create -f martin-rolebinding<span class="hljs-selector-class">.yaml</span><br>rolebinding<span class="hljs-selector-class">.rbac</span><span class="hljs-selector-class">.authorization</span><span class="hljs-selector-class">.k8s</span><span class="hljs-selector-class">.io</span> <span class="hljs-string">&quot;martin-rolebinding&quot;</span> created<br></code></pre></td></tr></table></figure><p>使用admin账号(martin账号无权限查看)查看role和rolebinding相关信息：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">➜  martin kubectl <span class="hljs-keyword">get</span> rolebinding <span class="hljs-comment">--all-namespaces</span><br>NAMESPACE     <span class="hljs-type">NAME</span>                                             AGE<br>kube-<span class="hljs-built_in">public</span>   <span class="hljs-keyword">system</span>:controller:bootstrap-signer               <span class="hljs-number">19</span>d<br>kube-<span class="hljs-keyword">system</span>   kubernetes-dashboard-minimal                     <span class="hljs-number">11</span>d<br>kube-<span class="hljs-keyword">system</span>   martin-rolebinding                               <span class="hljs-number">18</span>h<br>kube-<span class="hljs-keyword">system</span>   <span class="hljs-keyword">system</span>::leader-locking-kube-controller-manager   <span class="hljs-number">19</span>d<br>kube-<span class="hljs-keyword">system</span>   <span class="hljs-keyword">system</span>::leader-locking-kube-scheduler            <span class="hljs-number">19</span>d<br>kube-<span class="hljs-keyword">system</span>   <span class="hljs-keyword">system</span>:controller:bootstrap-signer               <span class="hljs-number">19</span>d<br>kube-<span class="hljs-keyword">system</span>   <span class="hljs-keyword">system</span>:controller:cloud-provider                 <span class="hljs-number">19</span>d<br>kube-<span class="hljs-keyword">system</span>   <span class="hljs-keyword">system</span>:controller:token-cleaner                  <span class="hljs-number">19</span>d<br>kube-<span class="hljs-keyword">system</span>   ui-<span class="hljs-keyword">admin</span>-binding                                 <span class="hljs-number">11</span>d<br>kube-<span class="hljs-keyword">system</span>   ui-<span class="hljs-keyword">read</span>-binding                                  <span class="hljs-number">11</span>d<br>➜  martin <br>➜  martin kubectl <span class="hljs-keyword">get</span> <span class="hljs-keyword">role</span> <span class="hljs-comment">--all-namespaces            </span><br>NAMESPACE     <span class="hljs-type">NAME</span>                                             AGE<br>kube-<span class="hljs-built_in">public</span>   <span class="hljs-keyword">system</span>:controller:bootstrap-signer               <span class="hljs-number">19</span>d<br>kube-<span class="hljs-keyword">system</span>   <span class="hljs-keyword">extension</span>-apiserver-authentication-reader        <span class="hljs-number">19</span>d<br>kube-<span class="hljs-keyword">system</span>   kubernetes-dashboard-minimal                     <span class="hljs-number">11</span>d<br>kube-<span class="hljs-keyword">system</span>   martin-<span class="hljs-keyword">role</span>                                      <span class="hljs-number">18</span>h<br>kube-<span class="hljs-keyword">system</span>   <span class="hljs-keyword">system</span>::leader-locking-kube-controller-manager   <span class="hljs-number">19</span>d<br>kube-<span class="hljs-keyword">system</span>   <span class="hljs-keyword">system</span>::leader-locking-kube-scheduler            <span class="hljs-number">19</span>d<br>kube-<span class="hljs-keyword">system</span>   <span class="hljs-keyword">system</span>:controller:bootstrap-signer               <span class="hljs-number">19</span>d<br>kube-<span class="hljs-keyword">system</span>   <span class="hljs-keyword">system</span>:controller:cloud-provider                 <span class="hljs-number">19</span>d<br>kube-<span class="hljs-keyword">system</span>   <span class="hljs-keyword">system</span>:controller:token-cleaner                  <span class="hljs-number">19</span>d<br>➜  martin<br></code></pre></td></tr></table></figure><h5 id="第四步：测试"><a href="#第四步：测试" class="headerlink" title="第四步：测试"></a>第四步：测试</h5><p>现在应该可以用上面的martin-context上下文来操作集群了：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sql">➜  martin kubectl <span class="hljs-keyword">get</span> pods                                          <br>NAME                              READY     STATUS    RESTARTS   AGE<br>nexus3<span class="hljs-number">-68</span>f55d9746<span class="hljs-operator">-</span>vfnf8           <span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-number">1</span>       <span class="hljs-keyword">Running</span>   <span class="hljs-number">0</span>          <span class="hljs-number">5</span>d<br>rbd<span class="hljs-operator">-</span>rest<span class="hljs-operator">-</span>api<span class="hljs-operator">-</span>registrykey<span class="hljs-operator">-</span>m262<span class="hljs-number">-1</span>   <span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-number">1</span>       <span class="hljs-keyword">Running</span>   <span class="hljs-number">0</span>          <span class="hljs-number">4</span>d<br>➜  martin <br>➜  martin kubectl <span class="hljs-keyword">get</span> pods <span class="hljs-operator">-</span>n <span class="hljs-keyword">default</span><br>NAME                              READY     STATUS    RESTARTS   AGE<br>nexus3<span class="hljs-number">-68</span>f55d9746<span class="hljs-operator">-</span>vfnf8           <span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-number">1</span>       <span class="hljs-keyword">Running</span>   <span class="hljs-number">0</span>          <span class="hljs-number">5</span>d<br>rbd<span class="hljs-operator">-</span>rest<span class="hljs-operator">-</span>api<span class="hljs-operator">-</span>registrykey<span class="hljs-operator">-</span>m262<span class="hljs-number">-1</span>   <span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-number">1</span>       <span class="hljs-keyword">Running</span>   <span class="hljs-number">0</span>          <span class="hljs-number">4</span>d<br>➜  martin <br>➜  martin kubectl <span class="hljs-keyword">get</span> pods <span class="hljs-comment">--kubeconfig martin.kubeconfig</span><br>NAME                                    READY     STATUS    RESTARTS   AGE<br>coredns<span class="hljs-number">-77</span>c989547b<span class="hljs-operator">-</span>lcbfw                <span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-number">1</span>       <span class="hljs-keyword">Running</span>   <span class="hljs-number">1</span>          <span class="hljs-number">15</span>d<br>coredns<span class="hljs-number">-77</span>c989547b<span class="hljs-operator">-</span>xq4dr                <span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-number">1</span>       <span class="hljs-keyword">Running</span>   <span class="hljs-number">1</span>          <span class="hljs-number">15</span>d<br>heapster<span class="hljs-number">-77</span>b9c5bd7b<span class="hljs-operator">-</span>l5ms6               <span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-number">1</span>       <span class="hljs-keyword">Running</span>   <span class="hljs-number">0</span>          <span class="hljs-number">11</span>d<br>kubernetes<span class="hljs-operator">-</span>dashboard<span class="hljs-number">-66</span>c9d98865<span class="hljs-operator">-</span>g8l6l   <span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-number">1</span>       <span class="hljs-keyword">Running</span>   <span class="hljs-number">0</span>          <span class="hljs-number">11</span>d<br>monitoring<span class="hljs-operator">-</span>grafana<span class="hljs-number">-7</span>c674cb7f6<span class="hljs-operator">-</span>nqvlw     <span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-number">1</span>       <span class="hljs-keyword">Running</span>   <span class="hljs-number">0</span>          <span class="hljs-number">11</span>d<br>monitoring<span class="hljs-operator">-</span>influxdb<span class="hljs-number">-644</span>db5c5b6<span class="hljs-operator">-</span>llnp9    <span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-number">1</span>       <span class="hljs-keyword">Running</span>   <span class="hljs-number">0</span>          <span class="hljs-number">11</span>d<br></code></pre></td></tr></table></figure><p>使用kubectl时并没有指定namespace，这是因为之前已经为该用户分配了权限，并且指定了kube-system命名空间写入到martin.kubeconfig文件中，如果使用default命名空间，在后面加上一个-n default，则会提示forbidden,如下：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">➜  martin kubectl <span class="hljs-builtin-name">get</span> pods -n<span class="hljs-built_in"> default </span>--kubeconfig martin.kubeconfig <br><span class="hljs-builtin-name">Error</span> <span class="hljs-keyword">from</span><span class="hljs-built_in"> server </span>(Forbidden): pods is forbidden:<span class="hljs-built_in"> User </span><span class="hljs-string">&quot;martin&quot;</span> cannot list pods <span class="hljs-keyword">in</span> the namespace <span class="hljs-string">&quot;default&quot;</span><br>➜  martin <br></code></pre></td></tr></table></figure><p>这是因为该用户并没有default这个命名空间的操作权限。</p><hr><h4 id="创建一个只能访问某个namespace的ServiceAccount"><a href="#创建一个只能访问某个namespace的ServiceAccount" class="headerlink" title="创建一个只能访问某个namespace的ServiceAccount"></a>创建一个只能访问某个namespace的ServiceAccount</h4><p>上面创建了一个只能访问某个命名空间下面的普通用户，前面也提到过subjects,下面还有一种类型的主题资源：ServiceAccount。</p><h5 id="第一步：创建一个集群内部的用户只能操作kube-system这个命名空间下面的pods和deployments"><a href="#第一步：创建一个集群内部的用户只能操作kube-system这个命名空间下面的pods和deployments" class="headerlink" title="第一步：创建一个集群内部的用户只能操作kube-system这个命名空间下面的pods和deployments"></a>第一步：创建一个集群内部的用户只能操作kube-system这个命名空间下面的pods和deployments</h5><p>首先来创建一个ServiceAccount对象：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">➜  serviceaccount kubectl <span class="hljs-keyword">create</span> sa martin-sa -n kube-<span class="hljs-keyword">system</span><br>serviceaccount &quot;martin-sa&quot; created<br>➜  serviceaccount <br>➜  serviceaccount kubectl <span class="hljs-keyword">get</span> sa <br><span class="hljs-type">NAME</span>      SECRETS   AGE<br><span class="hljs-keyword">default</span>   <span class="hljs-number">1</span>         <span class="hljs-number">20</span>d<br>➜  serviceaccount kubectl <span class="hljs-keyword">get</span> sa -n kube-<span class="hljs-keyword">system</span><br><span class="hljs-type">NAME</span>                   SECRETS   AGE<br><span class="hljs-keyword">admin</span>-<span class="hljs-keyword">user</span>             <span class="hljs-number">1</span>         <span class="hljs-number">11</span>d<br>coredns                <span class="hljs-number">1</span>         <span class="hljs-number">15</span>d<br><span class="hljs-keyword">default</span>                <span class="hljs-number">1</span>         <span class="hljs-number">20</span>d<br>heapster               <span class="hljs-number">1</span>         <span class="hljs-number">11</span>d<br>kubernetes-dashboard   <span class="hljs-number">1</span>         <span class="hljs-number">11</span>d<br>martin-sa              <span class="hljs-number">1</span>         <span class="hljs-number">13</span>s<br>➜  serviceaccount <br></code></pre></td></tr></table></figure><p>当然也可以定义成YAML文件的形式来创建:</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">apiVersion:</span> v1<br><span class="hljs-symbol">kind:</span> ServiceAccount<br><span class="hljs-symbol">metadata:</span><br><span class="hljs-symbol">  name:</span> martin-sa<br><span class="hljs-symbol">  namespace:</span> kube-system<br><br></code></pre></td></tr></table></figure><h5 id="第二步：创建一个Role对象：-martin-sa-role-yaml"><a href="#第二步：创建一个Role对象：-martin-sa-role-yaml" class="headerlink" title="第二步：创建一个Role对象：(martin-sa-role.yaml)"></a>第二步：创建一个Role对象：(martin-sa-role.yaml)</h5><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs vim">➜  serviceaccount <span class="hljs-keyword">cat</span> martin-<span class="hljs-keyword">sa</span>-role.yaml <br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: Role<br>metadat<span class="hljs-variable">a:</span><br>  name: martin-<span class="hljs-keyword">sa</span>-role<br>  namespace: kube-<span class="hljs-built_in">system</span><br>rule<span class="hljs-variable">s:</span><br>- apiGroup<span class="hljs-variable">s:</span> [<span class="hljs-string">&quot;&quot;</span>]<br>  resource<span class="hljs-variable">s:</span> [<span class="hljs-string">&quot;pods&quot;</span>]<br>  <span class="hljs-keyword">verb</span><span class="hljs-variable">s:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>] # 也可以使用[<span class="hljs-string">&#x27;*&#x27;</span>]<br>- apiGroup<span class="hljs-variable">s:</span> [<span class="hljs-string">&quot;apps&quot;</span>]<br>  resource<span class="hljs-variable">s:</span> [<span class="hljs-string">&quot;deployments&quot;</span>]<br>  <span class="hljs-keyword">verb</span><span class="hljs-variable">s:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>, <span class="hljs-string">&quot;create&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>, <span class="hljs-string">&quot;patch&quot;</span>, <span class="hljs-string">&quot;delete&quot;</span>]<br>➜  serviceaccount<br></code></pre></td></tr></table></figure><p>可以看到这里定义的角色没有创建、删除、更新Pod的权限，等会可以重点测试一下。</p><p>创建该Role对象：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">➜  serviceaccount kubectl create -f martin-sa-role<span class="hljs-selector-class">.yaml</span> <br>role<span class="hljs-selector-class">.rbac</span><span class="hljs-selector-class">.authorization</span><span class="hljs-selector-class">.k8s</span><span class="hljs-selector-class">.io</span> <span class="hljs-string">&quot;martin-sa-role&quot;</span> created<br></code></pre></td></tr></table></figure><h5 id="第三步，创建一个RoleBinding对象，将上面的martin-sa和角色martin-sa-role进行绑定：-martin-sa-rolebinding-yaml"><a href="#第三步，创建一个RoleBinding对象，将上面的martin-sa和角色martin-sa-role进行绑定：-martin-sa-rolebinding-yaml" class="headerlink" title="第三步，创建一个RoleBinding对象，将上面的martin-sa和角色martin-sa-role进行绑定：(martin-sa-rolebinding.yaml)"></a>第三步，创建一个RoleBinding对象，将上面的martin-sa和角色martin-sa-role进行绑定：(martin-sa-rolebinding.yaml)</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">➜</span>  <span class="hljs-string">serviceaccount</span> <span class="hljs-string">cat</span> <span class="hljs-string">martin-sa-rolebinding.yaml</span> <br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">RoleBinding</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">martin-sa-rolebinding</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br><span class="hljs-attr">subjects:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">martin-sa</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">Role</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">martin-sa-role</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br></code></pre></td></tr></table></figure><p>创建这个资源对象：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">➜  serviceaccount kubectl <span class="hljs-keyword">get</span> rolebinding -n kube-<span class="hljs-keyword">system</span><br><span class="hljs-type">NAME</span>                                             AGE<br>kubernetes-dashboard-minimal                     <span class="hljs-number">11</span>d<br>martin-rolebinding                               <span class="hljs-number">22</span>h<br>➜  serviceaccount <br><br>➜  serviceaccount kubectl <span class="hljs-keyword">create</span> -f martin-sa-rolebinding.yaml <br>rolebinding.rbac.<span class="hljs-keyword">authorization</span>.k8s.io &quot;martin-sa-rolebinding&quot; created<br>➜  serviceaccount <br>➜  serviceaccount kubectl <span class="hljs-keyword">get</span> rolebinding               <br><span class="hljs-keyword">No</span> resources <span class="hljs-built_in">found</span>.<br>➜  serviceaccount kubectl <span class="hljs-keyword">get</span> rolebinding -n kube-<span class="hljs-keyword">system</span><br><span class="hljs-type">NAME</span>                                             AGE<br>kubernetes-dashboard-minimal                     <span class="hljs-number">11</span>d<br>martin-rolebinding                               <span class="hljs-number">23</span>h<br>martin-sa-rolebinding                            <span class="hljs-number">26</span>s<br>可以看到martin-sa-rolebinding已经添加<br><br></code></pre></td></tr></table></figure><h5 id="第四步，验证这个ServiceAccount"><a href="#第四步，验证这个ServiceAccount" class="headerlink" title="第四步，验证这个ServiceAccount"></a>第四步，验证这个ServiceAccount</h5><p>一个ServiceAccount会生成一个Secret对象和它进行映射，这个Secret里面包含一个token：</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs stata">➜  serviceaccount kubectl get secret -<span class="hljs-keyword">n</span> kube-system<br>NAME                               <span class="hljs-keyword">TYPE</span>                                  DATA      AGE<br>admin-user-<span class="hljs-keyword">token</span>-xszp7             kubernetes.io/service-account-<span class="hljs-keyword">token</span>   3         11d<br>coredns-<span class="hljs-keyword">token</span>-9ppnq                kubernetes.io/service-account-<span class="hljs-keyword">token</span>   3         15d<br>default-<span class="hljs-keyword">token</span>-fs7zj                kubernetes.io/service-account-<span class="hljs-keyword">token</span>   3         20d<br>heapster-<span class="hljs-keyword">token</span>-gn8g5               kubernetes.io/service-account-<span class="hljs-keyword">token</span>   3         11d<br>kubernetes-dashboard-certs         Opaque                                0         11d<br>kubernetes-dashboard-key-holder    Opaque                                2         15d<br>kubernetes-dashboard-<span class="hljs-keyword">token</span>-tg782   kubernetes.io/service-account-<span class="hljs-keyword">token</span>   3         11d<br>martin-<span class="hljs-keyword">sa</span>-<span class="hljs-keyword">token</span>-78s5j              kubernetes.io/service-account-<span class="hljs-keyword">token</span>   3         41m  #新增<br>➜  serviceaccount <br>➜  serviceaccount kubectl <span class="hljs-keyword">describe</span> secret martin-<span class="hljs-keyword">sa</span>-<span class="hljs-keyword">token</span>-78s5j -<span class="hljs-keyword">n</span> kube-system<br>Name:         martin-<span class="hljs-keyword">sa</span>-<span class="hljs-keyword">token</span>-78s5j<br>Namespace:    kube-system<br>Labels:       &lt;none&gt;<br>Annotations:  kubernetes.io/service-account.name=martin-<span class="hljs-keyword">sa</span><br>              kubernetes.io/service-account.uid=576ef41d-79e2-11e8-bede-5254004f2222<br><br><span class="hljs-keyword">Type</span>:  kubernetes.io/service-account-<span class="hljs-keyword">token</span><br><br>Data<br>====<br><span class="hljs-keyword">ca</span>.crt:     1359 bytes<br>namespace:  11 bytes<br><span class="hljs-keyword">token</span>:      xxx<br>➜  serviceaccount <br></code></pre></td></tr></table></figure><p>==注意：查看时需要-n指定kube-system命名空间！==</p><p>然后可以利用这个token去登录Dashboard，就可以在Dashboard中来验证功能是否符合预期：</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs maxima">➜  serviceaccount kubectl <span class="hljs-built_in">get</span> secret martin-sa-token-78s5j -o jsonpath=&#123;.data.token&#125; -n kube-<span class="hljs-built_in">system</span> |<span class="hljs-built_in">base64</span> -d #会生成一串很长的<span class="hljs-built_in">base64</span>后的字符串<br>xxxxxxxxxxxxxxxx<br>➜  serviceaccount <br></code></pre></td></tr></table></figure><p>使用这里的xxx token去Dashboard页面进行登录：<br>会出现如下提示信息：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">configmaps <span class="hljs-keyword">is</span> forbidden: <span class="hljs-keyword">User</span> &quot;system:serviceaccount:kube-system:martin-sa&quot; cannot list configmaps <span class="hljs-keyword">in</span> the namespace &quot;default&quot;<br><span class="hljs-keyword">close</span><br><span class="hljs-built_in">warning</span><br>persistentvolumeclaims <span class="hljs-keyword">is</span> forbidden: <span class="hljs-keyword">User</span> &quot;system:serviceaccount:kube-system:martin-sa&quot; cannot list persistentvolumeclaims <span class="hljs-keyword">in</span> the namespace &quot;default&quot; <br></code></pre></td></tr></table></figure><p>这是因为登录进来后默认跳转到default命名空间，但是却没有改空间的权限，因此需要切换到kube-system命名空间下面:</p><p>原来url:<br><a href="https://xxx/#!/deployment?namespace=default">https://xxx/#!/deployment?namespace=default</a></p><p>修改为新url:<br><a href="https://xxx/#!/deployment?namespace=kube-system">https://xxx/#!/deployment?namespace=kube-system</a></p><p>可以看到能访问pod列表了，但是也会有一些其他额外的提示：events is forbidden: User “system:serviceaccount:kube-system:martin-sa” cannot list events in the namespace “kube-system”，这是因为当前登录用只被授权了访问pod和deployment的权限，同样的，访问下deployment看看可以了吗？</p><p>同样的，可以根据自己的需求来对访问用户的权限进行限制，可以自己通过Role定义更加细粒度的权限，也可以使用系统内置的一些权限……</p><hr><h4 id="创建一个可以访问所有-namespace-的ServiceAccount"><a href="#创建一个可以访问所有-namespace-的ServiceAccount" class="headerlink" title="创建一个可以访问所有 namespace 的ServiceAccount"></a>创建一个可以访问所有 namespace 的ServiceAccount</h4><p>刚刚创建的martin-sa这个ServiceAccount和一个Role角色进行绑定的，如果现在创建一个新的ServiceAccount，需要他操作的权限作用于所有的namespace，这个时候就需要使用到ClusterRole 和 ClusterRoleBinding 这两种资源对象了。</p><h5 id="第一步，同样，首先新建一个ServiceAcount对象：-martin-sa2-yaml"><a href="#第一步，同样，首先新建一个ServiceAcount对象：-martin-sa2-yaml" class="headerlink" title="第一步，同样，首先新建一个ServiceAcount对象：(martin-sa2.yaml)"></a>第一步，同样，首先新建一个ServiceAcount对象：(martin-sa2.yaml)</h5><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs vim">➜  serviceaccount <span class="hljs-keyword">cat</span> martin-sa2.yaml <br>apiVersion: v1<br>kind: ServiceAccount<br>metadat<span class="hljs-variable">a:</span><br>  name: martin-sa2<br>  namespace: kube-<span class="hljs-built_in">system</span><br>➜  serviceaccount <br>➜  serviceaccount kubectl create -<span class="hljs-keyword">f</span> martin-sa2.yaml <br>serviceaccount <span class="hljs-string">&quot;martin-sa2&quot;</span> created<br>➜  serviceaccount kubectl <span class="hljs-built_in">get</span> <span class="hljs-keyword">sa</span>   <br>NAME      SECRETS   AGE<br>default   <span class="hljs-number">1</span>         <span class="hljs-number">20</span>d<br>➜  serviceaccount kubectl <span class="hljs-built_in">get</span> <span class="hljs-keyword">sa</span> -n kube-<span class="hljs-built_in">system</span><br>NAME                   SECRETS   AGE<br>admin-user             <span class="hljs-number">1</span>         <span class="hljs-number">12</span>d<br>coredns                <span class="hljs-number">1</span>         <span class="hljs-number">15</span>d<br>default                <span class="hljs-number">1</span>         <span class="hljs-number">20</span>d<br>heapster               <span class="hljs-number">1</span>         <span class="hljs-number">12</span>d<br>kubernetes-dashboard   <span class="hljs-number">1</span>         <span class="hljs-number">12</span>d<br>martin-<span class="hljs-keyword">sa</span>              <span class="hljs-number">1</span>         <span class="hljs-number">1</span>h<br>martin-sa2             <span class="hljs-number">1</span>         <span class="hljs-number">12</span>s<br>➜  serviceaccount<br></code></pre></td></tr></table></figure><h5 id="第二步，创建一个ClusterRoleBinding-对象-martin-clusterolebinding-yaml"><a href="#第二步，创建一个ClusterRoleBinding-对象-martin-clusterolebinding-yaml" class="headerlink" title="第二步，创建一个ClusterRoleBinding 对象(martin-clusterolebinding.yaml):"></a>第二步，创建一个ClusterRoleBinding 对象(martin-clusterolebinding.yaml):</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">➜</span>  <span class="hljs-string">serviceaccount</span> <span class="hljs-string">cat</span> <span class="hljs-string">martin-clusterolebinding.yaml</span>   <br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">martin-sa2-clusterrolebinding</span><br><span class="hljs-attr">subjects:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">martin-sa2</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">cluster-admin</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br><span class="hljs-string">➜</span>  <span class="hljs-string">serviceaccount</span> <br></code></pre></td></tr></table></figure><p>对比下之前的”martin-sa-rolebinding.yaml”</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">➜</span>  <span class="hljs-string">serviceaccount</span> <span class="hljs-string">cat</span> <span class="hljs-string">martin-sa-rolebinding.yaml</span> <br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">RoleBinding</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">martin-sa-rolebinding</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br><span class="hljs-attr">subjects:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">martin-sa</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">Role</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">martin-sa-role</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br><span class="hljs-string">➜</span>  <span class="hljs-string">serviceaccount</span> <br></code></pre></td></tr></table></figure><p>从上面可以看到没有为这个资源对象声明namespace，因为这是一个ClusterRoleBinding 资源对象，是作用于整个集群的，也没有单独新建一个ClusterRole对象，而是使用的 cluster-admin这个对象，这是Kubernetes集群内置的ClusterRole对象，可以使用kubectl get clusterrole 和kubectl get clusterrolebinding查看系统内置的一些集群角色和集群角色绑定，这里使用的 cluster-admin这个集群角色是拥有最高权限的集群角色，所以一般需要谨慎使用该集群角色。</p><p>创建上面集群角色绑定资源对象：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">➜  serviceaccount kubectl create -f martin-clusterolebinding<span class="hljs-selector-class">.yaml</span> <br>clusterrolebinding<span class="hljs-selector-class">.rbac</span><span class="hljs-selector-class">.authorization</span><span class="hljs-selector-class">.k8s</span><span class="hljs-selector-class">.io</span> <span class="hljs-string">&quot;martin-sa2-clusterrolebinding&quot;</span> created<br>➜  serviceaccount <br></code></pre></td></tr></table></figure><p>通过ubectl get clusterrolebinding可以看到”martin-sa2-clusterrolebinding”已经加入其中：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">➜  serviceaccount kubectl <span class="hljs-keyword">get</span> clusterrolebinding <br><span class="hljs-type">NAME</span>                                                   AGE<br><span class="hljs-keyword">admin</span>-<span class="hljs-keyword">user</span>                                             <span class="hljs-number">12</span>d<br><span class="hljs-keyword">cluster</span>-<span class="hljs-keyword">admin</span>                                          <span class="hljs-number">20</span>d<br>heapster                                               <span class="hljs-number">12</span>d<br>kubelet-bootstrap                                      <span class="hljs-number">19</span>d<br>martin-sa2-clusterrolebinding                          <span class="hljs-number">22</span>s<br></code></pre></td></tr></table></figure><h5 id="第三步，使用-ServiceAccount对应的token去登录Dashboard验证："><a href="#第三步，使用-ServiceAccount对应的token去登录Dashboard验证：" class="headerlink" title="第三步，使用 ServiceAccount对应的token去登录Dashboard验证："></a>第三步，使用 ServiceAccount对应的token去登录Dashboard验证：</h5><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs gauss">➜  serviceaccount kubectl get secret -n kube-<span class="hljs-keyword">system</span>|grep martin-sa2-<span class="hljs-built_in">token</span>-q7bhr<br>martin-sa2-<span class="hljs-built_in">token</span>-q7bhr             kubernetes.io/service-account-<span class="hljs-built_in">token</span>   <span class="hljs-number">3</span>         <span class="hljs-number">34</span>m<br>➜  serviceaccount <br>➜  serviceaccount kubectl get secret martin-sa2-<span class="hljs-built_in">token</span>-q7bhr -o jsonpath=&#123;.data.token&#125; -n kube-<span class="hljs-keyword">system</span> |base64 -d<br>xxxxxxx<br><span class="hljs-meta">#会生成一串很长的base64后的字符串</span><br>➜  serviceaccount <br></code></pre></td></tr></table></figure><p>在最开始接触到RBAC认证的时候，可能不太熟悉，特别是不知道应该怎么去编写rules规则，可以去分析系统自带的clusterrole、clusterrolebinding这些资源对象的编写方法，利用 kubectl的get、describe、-o yaml这些操作，所以kubectl最基本的操作一定要掌握好。</p><p>RBAC只是Kubernetes中安全认证的一种方式，当然也是现在最重要的一种方式。</p><hr>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Kubernetes从Private Registry中拉取容器镜像的方法</title>
    <link href="/2018/06/25/Kubernetes%E4%BB%8EPrivate-Registry%E4%B8%AD%E6%8B%89%E5%8F%96%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E7%9A%84%E6%96%B9%E6%B3%95/"/>
    <url>/2018/06/25/Kubernetes%E4%BB%8EPrivate-Registry%E4%B8%AD%E6%8B%89%E5%8F%96%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E7%9A%84%E6%96%B9%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h3 id="方法1：利用Node上的配置访问Private-Registry"><a href="#方法1：利用Node上的配置访问Private-Registry" class="headerlink" title="方法1：利用Node上的配置访问Private Registry"></a>方法1：利用Node上的配置访问Private Registry</h3><p>在玩Docker时，很多朋友都 搭建过自己的Private Registry。Docker访问那些以basic auth方式进行鉴权的Private Registry，只需在本地执行docker login，输入用户名、密码后，就可以自由向Registry Push镜像或pull 镜像到本地了：</p><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ldif">[root@node3 docker]<span class="hljs-comment"># docker login registry.martin.com:5000</span><br><span class="hljs-attribute">Username (martin)</span>: martin<br><span class="hljs-attribute">Password</span>: <br><span class="hljs-attribute">Login Succeeded</span><br></code></pre></td></tr></table></figure><p>在这一过程结束后，Docker实际上会在~/.docker目录下创建一个config.json文件，保存后续与Registry交互过程中所要使用的鉴权串（这个鉴权串只是一个base64编码结果，安全性欠佳)</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs awk">➜  nexus cat ~<span class="hljs-regexp">/.docker/</span>config.json <br>&#123;<br>        <span class="hljs-string">&quot;auths&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;daocloud.io&quot;</span>: &#123;<br>                        <span class="hljs-string">&quot;auth&quot;</span>: <span class="hljs-string">&quot;xxxxQ==&quot;</span><br>                &#125;,<br>                <span class="hljs-string">&quot;https://index.docker.io/v1/&quot;</span>: &#123;<br>                        <span class="hljs-string">&quot;auth&quot;</span>: <span class="hljs-string">&quot;axxw==&quot;</span><br>                &#125;,<br>                <span class="hljs-string">&quot;registry.martin.com:5000&quot;</span>: &#123;<br>                        <span class="hljs-string">&quot;auth&quot;</span>: <span class="hljs-string">&quot;sdxxxxxxB&quot;</span><br>                &#125;<br>        &#125;,<br>        <span class="hljs-string">&quot;HttpHeaders&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;User-Agent&quot;</span>: <span class="hljs-string">&quot;Docker-Client/17.09.0-ce (linux)&quot;</span><br>        &#125;<br>&#125;<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure><p>一但Node上有了这个配置，那么K8s就可以通过docker直接访问Private Registry了，这是<a href="https://kubernetes.io/docs/concepts/containers/images/#using-a-private-registry">K8s文档中与私有镜像仓库交互的第一个方法</a> 。考虑到Pod可以被调度到集群中的任意一个Node上，需要在每个Node上执行上述login操作，或者可以简单地将<del>/.docker/config.json scp到各个node上的</del>/.docker目录下。</p><p>但实际效果却不尽人意.</p><h4 id="创建一个Pod-yaml-测试一下是否能run起来"><a href="#创建一个Pod-yaml-测试一下是否能run起来" class="headerlink" title="创建一个Pod.yaml,测试一下是否能run起来:"></a>创建一个Pod.yaml,测试一下是否能run起来:</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">➜</span>  <span class="hljs-string">nexus</span> <span class="hljs-string">cat</span> <span class="hljs-string">test.yaml</span> <br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">rbd-rest-api-using-node-config</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">rbd-rest-api-using-node-config</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">registry.martin.com:5000/registry</span><br>    <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">Always</span><br>  <span class="hljs-attr">nodeSelector:</span> <span class="hljs-comment">#指定节点启用pod</span><br>    <span class="hljs-attr">kubernetes.io/hostname:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.16</span><br><span class="hljs-string">➜</span>  <span class="hljs-string">nexus</span> <br></code></pre></td></tr></table></figure><h4 id="创建这个Pod并查看Pod的创建状态："><a href="#创建这个Pod并查看Pod的创建状态：" class="headerlink" title="创建这个Pod并查看Pod的创建状态："></a>创建这个Pod并查看Pod的创建状态：</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">➜  nexus kubectl <span class="hljs-keyword">create</span> -f test.yaml <br>pod &quot;rbd-rest-api-using-node-config&quot; created<br>➜  nexus kubectl <span class="hljs-keyword">get</span> pods<br><span class="hljs-type">NAME</span>                             READY     STATUS             RESTARTS   AGE<br>nexus3<span class="hljs-number">-68</span>f55d9746-vfnf8          <span class="hljs-number">1</span>/<span class="hljs-number">1</span>       Running            <span class="hljs-number">0</span>          <span class="hljs-number">17</span>h<br>rbd-rest-api-<span class="hljs-keyword">using</span>-node-config   <span class="hljs-number">0</span>/<span class="hljs-number">1</span>       ImagePullBackOff   <span class="hljs-number">0</span>          <span class="hljs-number">5</span>s<br></code></pre></td></tr></table></figure><h4 id="通过log查看Pod"><a href="#通过log查看Pod" class="headerlink" title="通过log查看Pod:"></a>通过log查看Pod:</h4><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs subunit">➜  nexus kubectl logs pod/rbd-rest-api-using-node-config<br><span class="hljs-keyword">Error </span>from server (BadRequest): container &quot;rbd-rest-api-using-node-config&quot; in pod &quot;rbd-rest-api-using-node-config&quot; is waiting to start: trying and failing to pull image<br>➜  nexus <br></code></pre></td></tr></table></figure><h4 id="通过describe查看pod失败的更加详细的信息："><a href="#通过describe查看pod失败的更加详细的信息：" class="headerlink" title="通过describe查看pod失败的更加详细的信息："></a>通过describe查看pod失败的更加详细的信息：</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sql">➜  nexus kubectl <span class="hljs-keyword">describe</span> pod<span class="hljs-operator">/</span>rbd<span class="hljs-operator">-</span>rest<span class="hljs-operator">-</span>api<span class="hljs-operator">-</span><span class="hljs-keyword">using</span><span class="hljs-operator">-</span>node<span class="hljs-operator">-</span>config<br>....<br>前面部分省略<br>....<br>QoS Class:       BestEffort<br>Node<span class="hljs-operator">-</span>Selectors:  kubernetes.io<span class="hljs-operator">/</span>hostname<span class="hljs-operator">=</span><span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.16</span><br>Tolerations:     <span class="hljs-operator">&lt;</span><span class="hljs-keyword">none</span><span class="hljs-operator">&gt;</span><br>Events:<br>  Type     Reason                 Age                <span class="hljs-keyword">From</span>                   Message<br>  <span class="hljs-comment">----     ------                 ----               ----                   -------</span><br>  Normal   Scheduled              <span class="hljs-number">13</span>m                <span class="hljs-keyword">default</span><span class="hljs-operator">-</span>scheduler      Successfully assigned rbd<span class="hljs-operator">-</span>rest<span class="hljs-operator">-</span>api<span class="hljs-operator">-</span><span class="hljs-keyword">using</span><span class="hljs-operator">-</span>node<span class="hljs-operator">-</span>config <span class="hljs-keyword">to</span> <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.16</span><br>  Normal   SuccessfulMountVolume  <span class="hljs-number">13</span>m                kubelet, <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.16</span>  MountVolume.SetUp succeeded <span class="hljs-keyword">for</span> volume &quot;default-token-fck44&quot;<br>  Normal   SandboxChanged         <span class="hljs-number">13</span>m                kubelet, <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.16</span>  Pod sandbox changed, it will be killed <span class="hljs-keyword">and</span> re<span class="hljs-operator">-</span>created.<br>  Warning  Failed                 <span class="hljs-number">12</span>m (x3 <span class="hljs-keyword">over</span> <span class="hljs-number">13</span>m)  kubelet, <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.16</span>  Failed <span class="hljs-keyword">to</span> pull image &quot;registry.martin.com:5000/registry&quot;: rpc error: code <span class="hljs-operator">=</span> <span class="hljs-literal">Unknown</span> <span class="hljs-keyword">desc</span> <span class="hljs-operator">=</span> Error response <span class="hljs-keyword">from</span> daemon: <span class="hljs-keyword">Get</span> https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>registry.martin.com:<span class="hljs-number">5000</span><span class="hljs-operator">/</span>v2<span class="hljs-operator">/</span>registry<span class="hljs-operator">/</span>manifests<span class="hljs-operator">/</span>latest: <span class="hljs-keyword">no</span> basic auth credentials<br>  Normal   Pulling                <span class="hljs-number">11</span>m (x4 <span class="hljs-keyword">over</span> <span class="hljs-number">13</span>m)  kubelet, <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.16</span>  pulling image &quot;registry.martin.com:5000/registry&quot;<br>  Warning  Failed                 <span class="hljs-number">11</span>m (x4 <span class="hljs-keyword">over</span> <span class="hljs-number">13</span>m)  kubelet, <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.16</span>  Error: ErrImagePull<br>  Normal   BackOff                <span class="hljs-number">8</span>m (x21 <span class="hljs-keyword">over</span> <span class="hljs-number">13</span>m)  kubelet, <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.16</span>  Back<span class="hljs-operator">-</span>off pulling image &quot;registry.martin.com:5000/registry&quot;<br>  Warning  Failed                 <span class="hljs-number">3</span>m (x42 <span class="hljs-keyword">over</span> <span class="hljs-number">13</span>m)  kubelet, <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.16</span>  Error: ImagePullBackOff<br>➜  nexus <br></code></pre></td></tr></table></figure><p>貌似不能生效,一直提示”no basic auth credentials”，结果是K8s无法从Private Registry获取我们想要的镜像文件.</p><h4 id="删除该Pod-尝试手动pull-registry仓库镜像"><a href="#删除该Pod-尝试手动pull-registry仓库镜像" class="headerlink" title="删除该Pod,尝试手动pull registry仓库镜像"></a>删除该Pod,尝试手动pull registry仓库镜像</h4><ul><li>删除Pod</li></ul><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs arduino">➜  nexus kubectl <span class="hljs-keyword">delete</span> pod rbd-rest-api-<span class="hljs-keyword">using</span>-node-config<br>pod <span class="hljs-string">&quot;rbd-rest-api-using-node-config&quot;</span> deleted<br>➜  nexus kubectl get pods<br>NAME                      READY     STATUS    RESTARTS   AGE<br>已经没有该pod了<br></code></pre></td></tr></table></figure><ul><li>手动pull registry image</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs vim">[root@node3 docker]# docker pull registry.martin.<span class="hljs-keyword">com</span>:<span class="hljs-number">5000</span>/registry  <br>Using default <span class="hljs-keyword">ta</span><span class="hljs-variable">g:</span> latest<br>lates<span class="hljs-variable">t:</span> Pulling from registry<br><span class="hljs-number">81033</span>e7c1d6<span class="hljs-variable">a:</span> Pull <span class="hljs-built_in">complete</span> <br>b235084c2315: Pull <span class="hljs-built_in">complete</span> <br>c692f3a6894<span class="hljs-variable">b:</span> Pull <span class="hljs-built_in">complete</span> <br>ba2177f3a70e: Pull <span class="hljs-built_in">complete</span> <br>a8d793620947: Pull <span class="hljs-built_in">complete</span> <br>Diges<span class="hljs-variable">t:</span> <span class="hljs-built_in">sha256</span>:feb40d14cd33e646b9985e2d6754ed66616fedb840226c4d917ef53d616dcd6c<br>Statu<span class="hljs-variable">s:</span> Downloaded newer image <span class="hljs-keyword">for</span> registry.martin.<span class="hljs-keyword">com</span>:<span class="hljs-number">5000</span>/registry:latest<br>==node3为指定运行pod的节点==<br></code></pre></td></tr></table></figure><h4 id="再次创建rbd-rest-api-using-node-config-pod"><a href="#再次创建rbd-rest-api-using-node-config-pod" class="headerlink" title="再次创建rbd-rest-api-using-node-config pod"></a>再次创建rbd-rest-api-using-node-config pod</h4><p>如果需要借助该image运行某些环境的话，是可以使用了，因为image已经手动拉取了。不然如果自动拉取的话会一直提示没有basic认证</p><hr><h3 id="方法2：通过kubectl创建docker-registry的secret"><a href="#方法2：通过kubectl创建docker-registry的secret" class="headerlink" title="方法2：通过kubectl创建docker-registry的secret"></a>方法2：通过kubectl创建docker-registry的secret</h3><p>K8s提供的第二种方法是通过kubectl创建一个docker-registry的secret，并在Pod描述文件中引用该secret以达到从Private Registry Pull Image的目的。</p><h4 id="操作之前，先删除掉各个Node上的-docker-config-json。"><a href="#操作之前，先删除掉各个Node上的-docker-config-json。" class="headerlink" title="操作之前，先删除掉各个Node上的~/.docker/config.json。"></a>操作之前，先删除掉各个Node上的~/.docker/config.json。</h4><p>执行kubectl create secret docker-registry时需要提供private registry的访问UserName和Password：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs routeros">➜  nexus kubectl <span class="hljs-builtin-name">get</span><span class="hljs-built_in"> secret</span><br><span class="hljs-built_in"></span>NAME                 <span class="hljs-built_in"> TYPE </span>                                 DATA      AGE<br>default-token-fck44   kubernetes.io/service-account-token   3         15d<br>可以看到之前已经有个default-token的secret<br>➜  nexus <br>➜  nexus kubectl create<span class="hljs-built_in"> secret </span>docker-registry registrykey-2.6.2 <span class="hljs-attribute">--docker-server</span>=registry.martin.com:5000 <span class="hljs-attribute">--docker-username</span>=martin <span class="hljs-attribute">--docker-password</span>=xxx1 <span class="hljs-attribute">--docker-email</span>=hanniusshine@gmail.com<span class="hljs-built_in"></span><br><span class="hljs-built_in">secret </span><span class="hljs-string">&quot;registrykey-2.6.2&quot;</span> created<br><br>➜  nexus kubectl <span class="hljs-builtin-name">get</span><span class="hljs-built_in"> secret </span>                                               <br>NAME                 <span class="hljs-built_in"> TYPE </span>                                 DATA      AGE<br>default-token-fck44   kubernetes.io/service-account-token   3         15d<br>registrykey-2.6.2     kubernetes.io/dockerconfigjson        1         3s<br>➜  nexus <br></code></pre></td></tr></table></figure><h4 id="secret-registrykey-2-6-2创建成功。测试一下引用这个secret对象的Pod是否能Pull-Image成功并Run起来-引用时Pod的YAML文件中必须指定imagePullSecrets为创建的secrety-Pod-yaml文件如下："><a href="#secret-registrykey-2-6-2创建成功。测试一下引用这个secret对象的Pod是否能Pull-Image成功并Run起来-引用时Pod的YAML文件中必须指定imagePullSecrets为创建的secrety-Pod-yaml文件如下：" class="headerlink" title="secret: registrykey-2.6.2创建成功。测试一下引用这个secret对象的Pod是否能Pull Image成功并Run起来,引用时Pod的YAML文件中必须指定imagePullSecrets为创建的secrety,Pod yaml文件如下："></a>secret: registrykey-2.6.2创建成功。测试一下引用这个secret对象的Pod是否能Pull Image成功并Run起来,引用时Pod的YAML文件中必须指定imagePullSecrets为创建的secrety,Pod yaml文件如下：</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">➜</span>  <span class="hljs-string">nexus</span> <span class="hljs-string">cat</span> <span class="hljs-string">test.yaml</span> <br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">rbd-rest-api-registrykey-2.6.2</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">rbd-rest-api-registrykey-2.6.2</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">registry.martin.com:5000/registry</span><br>    <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">Always</span><br>  <span class="hljs-attr">imagePullSecrets:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">registrykey-2.6.2</span>  <br>  <span class="hljs-attr">nodeSelector:</span><br>    <span class="hljs-attr">kubernetes.io/hostname:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.16</span><br><span class="hljs-string">➜</span>  <span class="hljs-string">nexus</span> <br></code></pre></td></tr></table></figure><h4 id="创建Pod-查看Pod状态："><a href="#创建Pod-查看Pod状态：" class="headerlink" title="创建Pod,查看Pod状态："></a>创建Pod,查看Pod状态：</h4><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">➜  nexus kubectl <span class="hljs-keyword">create</span> -f test.yaml<br>The Pod <span class="hljs-string">&quot;rbd-rest-api-registrykey-m2.6.2-1&quot;</span> <span class="hljs-keyword">is</span> invalid: spec.containers[<span class="hljs-number">0</span>].name: Invalid <span class="hljs-keyword">value</span>: <span class="hljs-string">&quot;rbd-rest-api-registrykey-m2.6.2-1&quot;</span>: a DNS<span class="hljs-number">-1123</span> label must consist of <span class="hljs-built_in">lower</span> <span class="hljs-keyword">case</span> alphanumeric characters <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;-&#x27;</span>, <span class="hljs-keyword">and</span> must <span class="hljs-keyword">start</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">with</span> an alphanumeric character (<span class="hljs-built_in">e</span>.g. <span class="hljs-string">&#x27;my-name&#x27;</span>,  <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;123-abc&#x27;</span>, regex used <span class="hljs-keyword">for</span> validation <span class="hljs-keyword">is</span> <span class="hljs-string">&#x27;[a-z0-9]([-a-z0-9]*[a-z0-9])?&#x27;</span>)<br>原来container的name命名只能用小写字母和-，不能用.号，所以修改name为：<span class="hljs-string">&quot;rbd-rest-api-registrykey-m262-1&quot;</span><br><br>再次创建ok:<br>➜  nexus kubectl <span class="hljs-keyword">create</span> -f test.yaml<br>pod <span class="hljs-string">&quot;rbd-rest-api-registrykey-m262-1&quot;</span> created<br>➜  nexus <br>➜  nexus kubectl get pods           <br>NAME                              READY     STATUS    RESTARTS   AGE<br>nexus3<span class="hljs-number">-68</span>f55d9746-vfnf8           <span class="hljs-number">1</span>/<span class="hljs-number">1</span>       Running   <span class="hljs-number">0</span>          <span class="hljs-number">18</span>h<br>rbd-rest-api-registrykey-m262<span class="hljs-number">-1</span>   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>       Running   <span class="hljs-number">0</span>          <span class="hljs-number">6</span>s<br>➜  nexus <br></code></pre></td></tr></table></figure><h4 id="通过describe-pod，查看创建的event序列："><a href="#通过describe-pod，查看创建的event序列：" class="headerlink" title="通过describe pod，查看创建的event序列："></a>通过describe pod，查看创建的event序列：</h4><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">➜  nexus kubectl describe pod/rbd-rest-api-registrykey-m262-1<br><span class="hljs-string">...</span><br>部分省略<br><span class="hljs-string">...</span><br>Events:<br>  Type    Reason                 Age   From                   Message<br>  <span class="hljs-params">----</span>    <span class="hljs-params">------</span>                 <span class="hljs-params">----</span>  <span class="hljs-params">----</span>                   <span class="hljs-params">-------</span><br>  Normal  Scheduled              1m    default-scheduler      Successfully assigned rbd-rest-api-registrykey-m262-1 to 192.168.1.16<br>  Normal  SuccessfulMountVolume  1m    kubelet, 192.168.1.16  MountVolume.SetUp succeeded for volume <span class="hljs-string">&quot;default-token-fck44&quot;</span><br>  Normal  Pulling                1m    kubelet, 192.168.1.16  pulling image <span class="hljs-string">&quot;registry.martin.com:5000/registry&quot;</span><br>  Normal  Pulled                 1m    kubelet, 192.168.1.16  Successfully pulled image <span class="hljs-string">&quot;registry.martin.com:5000/registry&quot;</span><br>  Normal  Created                1m    kubelet, 192.168.1.16  Created container<br>  Normal  Started                1m    kubelet, 192.168.1.16  Started container<br>➜  nexus <br></code></pre></td></tr></table></figure><p>正如期望的那样，引用了secret: registrykey-2.6.2的Pod成功Run起来了。</p><p>查看指定运行pod的节点是否run了对应的image:</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs subunit">[root@node3 docker]# docker ps<br>CONTAINER ID        IMAGE                                            COMMAND                  CREATED             STATUS              PORTS               NAMES<br>457e48f68bd7        registry.martin.com:5000/registry                &quot;/entrypoint.sh /e...&quot;   6 minutes ago       Up 5 minutes                            k8s_rbd-rest-api-registrykey-m262<span class="hljs-string">-1</span>_rbd-rest-api-registrykey-m262<span class="hljs-string">-1</span>_default_1265c1f5<span class="hljs-string">-75</span>f3<span class="hljs-string">-11</span>e8<span class="hljs-string">-8760</span><span class="hljs-string">-5254004</span>f2222_0<br></code></pre></td></tr></table></figure><hr><h3 id="如果一个pod中有来自不同私有仓库的不同镜像，需要怎么做呢？"><a href="#如果一个pod中有来自不同私有仓库的不同镜像，需要怎么做呢？" class="headerlink" title="如果一个pod中有来自不同私有仓库的不同镜像，需要怎么做呢？"></a>如果一个pod中有来自不同私有仓库的不同镜像，需要怎么做呢？</h3><p>通过kubectl create secret docker-registry一次只能建立一个registrykey，如果要访问两个镜像仓库，就需要分别为每个仓库创建一个registrykey。再来创建一个registrykey，对应的仓库为：registry.martin.com:6000</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs routeros">➜  nexus <br>➜  nexus kubectl create<span class="hljs-built_in"> secret </span>docker-registry registrykey-2.6.3 <span class="hljs-attribute">--docker-server</span>=registry.martin.com:6000 <span class="hljs-attribute">--docker-username</span>=martin <span class="hljs-attribute">--docker-password</span>=xxx2 <span class="hljs-attribute">--docker-email</span>=hanniusshine@gmail.com<span class="hljs-built_in"></span><br><span class="hljs-built_in">secret </span><span class="hljs-string">&quot;registrykey-2.6.3&quot;</span> created<br><br>➜  nexus kubectl <span class="hljs-builtin-name">get</span><span class="hljs-built_in"> secret </span>                                               <br>NAME                 <span class="hljs-built_in"> TYPE </span>                                 DATA      AGE<br>default-token-fck44   kubernetes.io/service-account-token   3         15d<br>registrykey-2.6.2     kubernetes.io/dockerconfigjson        1         3s<br>registrykey-2.6.3     kubernetes.io/dockerconfigjson        1         3s<br>➜  nexus <br></code></pre></td></tr></table></figure><h4 id="创建一个包含多个container的Pod："><a href="#创建一个包含多个container的Pod：" class="headerlink" title="创建一个包含多个container的Pod："></a>创建一个包含多个container的Pod：</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">➜</span>  <span class="hljs-string">nexus</span> <span class="hljs-string">cat</span> <span class="hljs-string">test2.yaml</span> <br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">rbd-rest-api-multi-registrykeys-m262-2</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">rbd-rest-api-multi-registrykeys-m262-2</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">registry.martin.com:5000/registry</span><br>    <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">Always</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">test-multi-registrykeys-m262-2</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">registry.martin.com:6000/registry</span><br>    <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">Always</span><br>    <span class="hljs-attr">command:</span><br>       <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;tail&quot;</span><br>       <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;-f&quot;</span><br>       <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;/var/log/bootstrap.log&quot;</span><br>  <span class="hljs-attr">imagePullSecrets:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">registrykey-2.6.2</span> <br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">registrykey-2.6.3</span><br>  <span class="hljs-attr">nodeSelector:</span><br>    <span class="hljs-attr">kubernetes.io/hostname:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.16</span><br><span class="hljs-string">➜</span>  <span class="hljs-string">nexus</span> <br></code></pre></td></tr></table></figure><h4 id="在secret引用中，将两个key都引用了进来。创建该pod"><a href="#在secret引用中，将两个key都引用了进来。创建该pod" class="headerlink" title="在secret引用中，将两个key都引用了进来。创建该pod"></a>在secret引用中，将两个key都引用了进来。创建该pod</h4><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># kubectl create -f test2.yaml</span><br><span class="hljs-attribute">pod</span> <span class="hljs-string">&quot;rbd-rest-api-multi-registrykeys-m262-2&quot;</span> created<br><br><span class="hljs-comment"># kubectl get pod</span><br><span class="hljs-attribute">NAME</span>                                   READY     STATUS             RESTARTS   AGE<br><span class="hljs-attribute">rbd</span>-rest-api-multi-registrykeys-m<span class="hljs-number">262</span>-<span class="hljs-number">2</span>   <span class="hljs-number">2</span>/<span class="hljs-number">2</span>       Running            <span class="hljs-number">0</span>          <span class="hljs-number">5</span>s<br></code></pre></td></tr></table></figure><h4 id="通过pod的event，看下启动的操作顺序："><a href="#通过pod的event，看下启动的操作顺序：" class="headerlink" title="通过pod的event，看下启动的操作顺序："></a>通过pod的event，看下启动的操作顺序：</h4><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-symbol">Events:</span><br>  Type    Reason                 Age   From                   Message<br>  ----    ------                 ----  ----                   -------<br>  <span class="hljs-keyword">Normal </span> <span class="hljs-keyword">Scheduled </span>             <span class="hljs-number">1</span>m    default-<span class="hljs-keyword">scheduler </span>     Successfully assigned rbd-rest-api-registrykey-m262<span class="hljs-number">-1</span> to <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">16</span><br>  <span class="hljs-keyword">Normal </span> SuccessfulMountVolume  <span class="hljs-number">1</span>m    kubelet, <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">16</span>  MountVolume.SetUp succeeded for volume <span class="hljs-string">&quot;default-token-fck44&quot;</span><br>  <span class="hljs-keyword">Normal </span> Pulling                <span class="hljs-number">1</span>m    kubelet, <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">16</span>  pulling image <span class="hljs-string">&quot;registry.martin.com:5000/registry&quot;</span><br>  <span class="hljs-keyword">Normal </span> Pulled                 <span class="hljs-number">1</span>m    kubelet, <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">16</span>  Successfully pulled image <span class="hljs-string">&quot;registry.martin.com:5000/registry&quot;</span><br>  <span class="hljs-keyword">Normal </span> Created                <span class="hljs-number">1</span>m    kubelet, <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">16</span>  Created container<br>  <span class="hljs-keyword">Normal </span> Started                <span class="hljs-number">1</span>m    kubelet, <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">16</span>  Started container<br>  <span class="hljs-keyword">Normal </span> Pulling                <span class="hljs-number">1</span>m    kubelet, <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">16</span>  pulling image <span class="hljs-string">&quot;registry.martin.com:6000/registry&quot;</span><br>  <span class="hljs-keyword">Normal </span> Pulled                 <span class="hljs-number">1</span>m    kubelet, <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">16</span>  Successfully pulled image <span class="hljs-string">&quot;registry.martin.com:6000/registry&quot;</span><br>  <span class="hljs-keyword">Normal </span> Created                <span class="hljs-number">1</span>m    kubelet, <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">16</span>  Created container<br>  <span class="hljs-keyword">Normal </span> Started                <span class="hljs-number">1</span>m    kubelet, <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">16</span>  Started container<br>➜  nexus <br></code></pre></td></tr></table></figure><hr><h3 id="方法3：通过secret-yaml文件创建pull-image所用的secret"><a href="#方法3：通过secret-yaml文件创建pull-image所用的secret" class="headerlink" title="方法3：通过secret yaml文件创建pull image所用的secret"></a>方法3：通过secret yaml文件创建pull image所用的secret</h3><p>除了上面通过kubectl可以快捷的创建pull image所用的secret外，还可以使用常规的手段-yaml描述文件来创建需要的secret资源。</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs dts">➜  nexus cat registrykey-m262<span class="hljs-number">-3.</span>yaml <br><span class="hljs-symbol">apiVersion:</span> v1<br><span class="hljs-symbol">kind:</span> Secret<br><span class="hljs-symbol">metadata:</span><br><span class="hljs-symbol">  name:</span> registrykey-m262<span class="hljs-number">-3</span><br><span class="hljs-symbol">  namespace:</span> default<br><span class="hljs-symbol">data:</span><br>    <span class="hljs-meta">#.dockerconfigjson: &#123;base64 -w 0 ~/.docker/config.json&#125;</span><br>    .dockerconfigjson: xxxxx<br><span class="hljs-symbol">type:</span> kubernetes.io/dockerconfigjson<br>➜  nexus <br></code></pre></td></tr></table></figure><p>前面说过docker login会在~/.docker下面创建一个config.json文件保存鉴权串，这里secret yaml的.dockerconfigjson后面的数据就是那个json文件的base64编码输出（-w 0让base64输出在单行上，避免折行）。</p><h4 id="创建registrykey-m262-3-secret"><a href="#创建registrykey-m262-3-secret" class="headerlink" title="创建registrykey-m262-3 secret:"></a>创建registrykey-m262-3 secret:</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">➜  nexus cat ~/.docker/config.json                <br>&#123;<br>        &quot;auths&quot;: &#123;<br>                &quot;daocloud.io&quot;: &#123;<br>                        &quot;auth&quot;: &quot;aGFubml1czppYnhnMVE1QQ==&quot;<br>                &#125;,<br>                &quot;https://index.docker.io/v1/&quot;: &#123;<br>                        &quot;auth&quot;: &quot;aGFubml1czppYnhnMVE1QTg4Ng==&quot;<br>                &#125;,<br>                &quot;registry.martin.com:5000&quot;: &#123;<br>                        &quot;auth&quot;: &quot;bWFydGluOmlieGcxUTVB&quot;<br>                &#125;<br>        &#125;,<br>        &quot;HttpHeaders&quot;: &#123;<br>                &quot;User-Agent&quot;: &quot;Docker-Client/17.09.0-ce (linux)&quot;<br>        &#125;<br>&#125;#<br>➜  nexus<br>因为此处&quot;#&quot;的问题，导致通过base64 -w <span class="hljs-number">0</span> ~/.docker/config.json生成的base转码有问题，一直创建pod失败，原因是zsh模拟器引起的&quot;#&quot;,切换到正常shell下ok<br><br>➜  nexus kubectl <span class="hljs-keyword">create</span> -f registrykey-m262<span class="hljs-number">-3.</span>yaml<br>secret &quot;registrykey-m262-3&quot; created<br>➜  nexus <br><br>➜  nexus kubectl <span class="hljs-keyword">get</span> secret <br><span class="hljs-type">NAME</span>                  <span class="hljs-keyword">TYPE</span>                                  DATA      AGE<br><span class="hljs-keyword">default</span>-token-fck44   kubernetes.io/service-account-token   <span class="hljs-number">3</span>         <span class="hljs-number">15</span>d<br>registrykey<span class="hljs-number">-2.6</span><span class="hljs-number">.2</span>     kubernetes.io/dockerconfigjson        <span class="hljs-number">1</span>         <span class="hljs-number">2</span>h<br>registrykey-m262<span class="hljs-number">-3</span>    kubernetes.io/dockerconfigjson        <span class="hljs-number">1</span>         <span class="hljs-number">4</span>m<br><br></code></pre></td></tr></table></figure><p>如果是以前老版本可能出现：<br>两个registrykey secret的类型略有不同，前者是:kubernetes.io/dockercfg，后者是:kubernetes.io/dockerconfigjson</p><h4 id="同样的可以使用describe命令来查看详细信息："><a href="#同样的可以使用describe命令来查看详细信息：" class="headerlink" title="同样的可以使用describe命令来查看详细信息："></a>同样的可以使用describe命令来查看详细信息：</h4><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">➜  nexus kubectl describe secret registrykey-m262-3<br>Name:         registrykey-m262-3<br>Namespace:    default<br>Labels:       &lt;none&gt;<br>Annotations:  &lt;none&gt;<br><br>Type:  kubernetes.io/dockerconfigjson<br><br><span class="hljs-section">Data</span><br><span class="hljs-section">====</span><br><span class="hljs-title">.dockerconfigjson:  305 bytes</span><br></code></pre></td></tr></table></figure><h4 id="可以看到Data区域没有直接展示出来，如果想查看的话可以使用-o-yaml来输出展示出来："><a href="#可以看到Data区域没有直接展示出来，如果想查看的话可以使用-o-yaml来输出展示出来：" class="headerlink" title="可以看到Data区域没有直接展示出来，如果想查看的话可以使用-o yaml来输出展示出来："></a>可以看到Data区域没有直接展示出来，如果想查看的话可以使用-o yaml来输出展示出来：</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs dts">➜  nexus kubectl get secret registrykey-m262<span class="hljs-number">-3</span> -o yaml<br><span class="hljs-symbol">apiVersion:</span> v1<br><span class="hljs-symbol">data:</span><br>  .dockerconfigjson: ewoJImF1dGhzIjogewoJCSJkYW9jbG91ZC5pbyI6IHsKCQkJImF1dGgiOiAiYUdGdWJtbDFjenBwWW5obk1WRTsdsdcmc9PSIKCQl9LAoJCSJyZWdpc3RyeS5tYXJ0aW4uY29tOjUwMDAiOiB7CgkJCSJhdXRoIjogImJXRnlkR2x1T21saWVHY3hVVFZCIgoJCX0KCX0sCgkiSHR0cEhlYWRlcnMiOiB7CgkJIlVzZXItQWdlbnQiOiAiRG9ja2VyLUNsaWVudC8xNy4wOS4wLWNlIChsaW51eCkiCgl9Cn0=<br><span class="hljs-symbol">kind:</span> Secret<br><span class="hljs-symbol">metadata:</span><br><span class="hljs-symbol">  creationTimestamp:</span> <span class="hljs-number">2018</span><span class="hljs-number">-06</span><span class="hljs-number">-22</span>T10:<span class="hljs-number">06</span>:<span class="hljs-number">27</span>Z<br><span class="hljs-symbol">  name:</span> registrykey-m262<span class="hljs-number">-3</span><br><span class="hljs-symbol">  namespace:</span> default<br><span class="hljs-symbol">  resourceVersion:</span> <span class="hljs-string">&quot;1519892&quot;</span><br><span class="hljs-symbol">  selfLink:</span> <span class="hljs-meta-keyword">/api/</span>v1<span class="hljs-meta-keyword">/namespaces/</span>default<span class="hljs-meta-keyword">/secrets/</span>registrykey-m262<span class="hljs-number">-3</span><br><span class="hljs-symbol">  uid:</span> ed2f027e<span class="hljs-number">-7603</span><span class="hljs-number">-11e8</span><span class="hljs-number">-8760</span><span class="hljs-number">-5254004</span>f2222<br><span class="hljs-symbol">type:</span> kubernetes.io/dockerconfigjson<br>➜  nexus <br></code></pre></td></tr></table></figure><h4 id="可以把上面的data-dockerconfigjson下面的数据做一个base64解码，看看里面的数据是怎样的"><a href="#可以把上面的data-dockerconfigjson下面的数据做一个base64解码，看看里面的数据是怎样的" class="headerlink" title="可以把上面的data.dockerconfigjson下面的数据做一个base64解码，看看里面的数据是怎样的:"></a>可以把上面的data.dockerconfigjson下面的数据做一个base64解码，看看里面的数据是怎样的:</h4><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs 1c">nexus echo ewoJImF1dGhzIjogewoJCSJkYW9jbG91ZC5pbyI6IHsKCQkJImF1dGgiOiAiYUdGdWJtbDFjenBwWW5obk1WRTFRUT09IgoJCX0sCgkJImh0dHBzOi8vaW5kZXguZG9ja2VyLmlvL3YxLyI6IHsKCQkJImF1dGgiOiAiYUdGdWJtbDFjenBwWW5obk1WRTFRVGc0Tmc9PSIKCQl9LAoJCSJyZWdpc3RyeS5tYXJ0aW4uY29tOjUwMDAiOiB7CgkJCSJdsddImJXRnlkR2x1T21saWVHY3hVVFZCIgoJCX0KCX0sCgkiSHR0cEhlYWRlcnMiOiB7CgkJIlVzZXItQWdlbnQiOiAiRG9ja2VyLUNsaWVudC8xNy4wOS4wLWNlIChsaW51eCkiCgl9Cn0= <span class="hljs-string">|base64 -d</span><br>&#123;<br>        <span class="hljs-string">&quot;auths&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;daocloud.io&quot;</span>: &#123;<br>                        <span class="hljs-string">&quot;auth&quot;</span>: <span class="hljs-string">&quot;aGFubmldffnhnMVE1QQ==&quot;</span><br>                &#125;,<br>                <span class="hljs-string">&quot;https://index.docker.io/v1/&quot;</span>: &#123;<br>                        <span class="hljs-string">&quot;auth&quot;</span>: <span class="hljs-string">&quot;aGFubml1czffnhnMVE1QTg4Ng==&quot;</span><br>                &#125;,<br>                <span class="hljs-string">&quot;registry.martin.com:5000&quot;</span>: &#123;<br>                        <span class="hljs-string">&quot;auth&quot;</span>: <span class="hljs-string">&quot;bWFydGff4dieGcxUTVB&quot;</span><br>                &#125;<br>        &#125;,<br>        <span class="hljs-string">&quot;HttpHeaders&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;User-Agent&quot;</span>: <span class="hljs-string">&quot;Docker-Client/17.09.0-ce (linux)&quot;</span><br>        &#125;<br>&#125;<span class="hljs-meta">#                                                                             ➜  nexus</span><br></code></pre></td></tr></table></figure><h4 id="编写引用registrykey-m262-3的pod"><a href="#编写引用registrykey-m262-3的pod" class="headerlink" title="编写引用registrykey-m262-3的pod:"></a>编写引用registrykey-m262-3的pod:</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">➜</span>  <span class="hljs-string">nexus</span> <span class="hljs-string">cat</span> <span class="hljs-string">test3.yaml</span> <br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">rbd-rest-api-registrykey-m262-3</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">rbd-rest-api-registrykey-m262-3</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">registry.martin.com:5000/os/alpine</span><br>    <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">Always</span><br>  <span class="hljs-attr">imagePullSecrets:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">registrykey-m262-3</span>  <br>  <span class="hljs-attr">nodeSelector:</span><br>    <span class="hljs-attr">kubernetes.io/hostname:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.16</span><br><span class="hljs-string">➜</span>  <span class="hljs-string">nexus</span> <br></code></pre></td></tr></table></figure><h4 id="创建运行pod"><a href="#创建运行pod" class="headerlink" title="创建运行pod:"></a>创建运行pod:</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs sql">➜  nexus kubectl <span class="hljs-keyword">create</span> <span class="hljs-operator">-</span>f test3.yaml <br>pod &quot;rbd-rest-api-registrykey-m262-3&quot; created<br>➜  nexus kubectl <span class="hljs-keyword">get</span> pod<br>NAME                              READY     STATUS             RESTARTS   AGE<br>nexus3<span class="hljs-number">-68</span>f55d9746<span class="hljs-operator">-</span>vfnf8           <span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-number">1</span>       <span class="hljs-keyword">Running</span>            <span class="hljs-number">0</span>          <span class="hljs-number">3</span>d<br>rbd<span class="hljs-operator">-</span>rest<span class="hljs-operator">-</span>api<span class="hljs-operator">-</span>registrykey<span class="hljs-operator">-</span>m262<span class="hljs-number">-1</span>   <span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-number">1</span>       <span class="hljs-keyword">Running</span>            <span class="hljs-number">0</span>          <span class="hljs-number">2</span>d<br>rbd<span class="hljs-operator">-</span>rest<span class="hljs-operator">-</span>api<span class="hljs-operator">-</span>registrykey<span class="hljs-operator">-</span>m262<span class="hljs-number">-3</span>   <span class="hljs-number">0</span><span class="hljs-operator">/</span><span class="hljs-number">1</span>       CrashLoopBackOff   <span class="hljs-number">1</span>          <span class="hljs-number">7</span>s<br>➜  nexus <br>➜  nexus kubectl <span class="hljs-keyword">describe</span> pod rbd<span class="hljs-operator">-</span>rest<span class="hljs-operator">-</span>api<span class="hljs-operator">-</span>registrykey<span class="hljs-operator">-</span>m262<span class="hljs-number">-3</span><br>Events:<br>  Type     Reason                 Age                <span class="hljs-keyword">From</span>                   Message<br>  <span class="hljs-comment">----     ------                 ----               ----                   -------</span><br>  Normal   Scheduled              <span class="hljs-number">39</span>s                <span class="hljs-keyword">default</span><span class="hljs-operator">-</span>scheduler      Successfully assigned rbd<span class="hljs-operator">-</span>rest<span class="hljs-operator">-</span>api<span class="hljs-operator">-</span>registrykey<span class="hljs-operator">-</span>m262<span class="hljs-number">-3</span> <span class="hljs-keyword">to</span> <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.16</span><br>  Normal   SuccessfulMountVolume  <span class="hljs-number">39</span>s                kubelet, <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.16</span>  MountVolume.SetUp succeeded <span class="hljs-keyword">for</span> volume &quot;default-token-fck44&quot;<br>  Normal   Pulling                <span class="hljs-number">22</span>s (x3 <span class="hljs-keyword">over</span> <span class="hljs-number">38</span>s)  kubelet, <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.16</span>  pulling image &quot;registry.martin.com:5000/os/alpine&quot;<br>  Normal   Pulled                 <span class="hljs-number">22</span>s (x3 <span class="hljs-keyword">over</span> <span class="hljs-number">38</span>s)  kubelet, <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.16</span>  Successfully pulled image &quot;registry.martin.com:5000/os/alpine&quot;<br>  Normal   Created                <span class="hljs-number">22</span>s (x3 <span class="hljs-keyword">over</span> <span class="hljs-number">38</span>s)  kubelet, <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.16</span>  Created container<br>  Normal   Started                <span class="hljs-number">22</span>s (x3 <span class="hljs-keyword">over</span> <span class="hljs-number">37</span>s)  kubelet, <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.16</span>  Started container<br>  Warning  BackOff                <span class="hljs-number">7</span>s (x4 <span class="hljs-keyword">over</span> <span class="hljs-number">36</span>s)   kubelet, <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.16</span>  Back<span class="hljs-operator">-</span>off restarting failed container<br><br>➜  nexus kubectl <span class="hljs-keyword">get</span> pod                                     <br>NAME                              READY     STATUS      RESTARTS   AGE<br>nexus3<span class="hljs-number">-68</span>f55d9746<span class="hljs-operator">-</span>vfnf8           <span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-number">1</span>       <span class="hljs-keyword">Running</span>     <span class="hljs-number">0</span>          <span class="hljs-number">3</span>d<br>rbd<span class="hljs-operator">-</span>rest<span class="hljs-operator">-</span>api<span class="hljs-operator">-</span>registrykey<span class="hljs-operator">-</span>m262<span class="hljs-number">-1</span>   <span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-number">1</span>       <span class="hljs-keyword">Running</span>     <span class="hljs-number">0</span>          <span class="hljs-number">2</span>d<br>rbd<span class="hljs-operator">-</span>rest<span class="hljs-operator">-</span>api<span class="hljs-operator">-</span>registrykey<span class="hljs-operator">-</span>m262<span class="hljs-number">-3</span>   <span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-number">1</span>       <span class="hljs-keyword">Running</span>   <span class="hljs-number">3</span>          <span class="hljs-number">50</span>s<br><br></code></pre></td></tr></table></figure><p>创建成功。</p><h4 id="那么这种方法如何应对含有来自多个镜像仓库container的Pod的呢？"><a href="#那么这种方法如何应对含有来自多个镜像仓库container的Pod的呢？" class="headerlink" title="那么这种方法如何应对含有来自多个镜像仓库container的Pod的呢？"></a>那么这种方法如何应对含有来自多个镜像仓库container的Pod的呢？</h4><p>这里的思路与方法2略有不同。不需要创建并引用两个或多个secret，而是==创建一个可以访问多个私有镜像仓库的secret==，需要将多个镜像仓库的访问鉴权串都放到~/.docker/config.json中：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>    <span class="hljs-attr">&quot;auths&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;registry.martin.com:5000&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;auth&quot;</span>: <span class="hljs-string">&quot;....省略....&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>再docker login registry.martin.com:6000,得到config.json如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>    <span class="hljs-attr">&quot;auths&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;registry.martin.com:5000&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;auth&quot;</span>: <span class="hljs-string">&quot;....省略....&quot;</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;registry.martin.com:6000&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;auth&quot;</span>: <span class="hljs-string">&quot;....省略....&quot;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>看到Docker自动将新login的private registry的鉴权串merge到了同一个config.json中了，与云镜像加速器daocloud.io类似</p><h4 id="现在基于该包含了两个库鉴权串的config-json创建一个新secret：registrykey-m262-4："><a href="#现在基于该包含了两个库鉴权串的config-json创建一个新secret：registrykey-m262-4：" class="headerlink" title="现在基于该包含了两个库鉴权串的config.json创建一个新secret：registrykey-m262-4："></a>现在基于该包含了两个库鉴权串的config.json创建一个新secret：registrykey-m262-4：</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs dts">➜  nexus cat registrykey-m262<span class="hljs-number">-4.</span>yaml <br><span class="hljs-symbol">apiVersion:</span> v1<br><span class="hljs-symbol">kind:</span> Secret<br><span class="hljs-symbol">metadata:</span><br><span class="hljs-symbol">  name:</span> registrykey-m262<span class="hljs-number">-4</span><br><span class="hljs-symbol">  namespace:</span> default<br><span class="hljs-symbol">data:</span><br>  <span class="hljs-meta">#.dockerconfigjson: &#123;base64 -w 0 ~/.docker/config.json&#125; #基于该命令创建下面base64 encode码</span><br>  .dockerconfigjson: ewoJImF1dGhzIjogewoJCSJkYW9jbG91ZC5pbyI6IHsKCQkJImF1dGgiOiAiYUdGdWJtbDFjenBwWW5obk1WRTFRUT09IgoJCX0sCgkJImh0dHBzOi8vaW5kZXguZG9ja2VyLmlvL3YxLyI6IHsKCQkJImF1dGgiOiAiYUdGdWJtbDFjenBwWW5obk1WRTFRVGc0Tmc9PSIKCQl9LAoJCSJyZWdpc3RyeS5tYXJ0aW4uY29tOjUwMDAiOiB7CgkJCSJhdXRoIjogImJXRnlkR2x1T21saWVHY3hVVFZCIgoJCX0KCX0sCgkiSHR0cEhlYWRlcnMiOiB7CgkJIlVzZXItQWdlbnQiOiAiRG9ja2VyLUNsaWVudC8xNy4wOS4wLWNlIChsaW51eCkiCgl9Cn0=<br><span class="hljs-symbol">type:</span> kubernetes.io/dockerconfigjson<br></code></pre></td></tr></table></figure><h4 id="创建secret-registrykey-m262-4"><a href="#创建secret-registrykey-m262-4" class="headerlink" title="创建secret:registrykey-m262-4"></a>创建secret:registrykey-m262-4</h4><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vala"><span class="hljs-meta"># kubectl create -f registrykey-m262-4.yaml </span><br></code></pre></td></tr></table></figure><h4 id="编辑一个包含两个容器，引用secret-“registrykey-m262-4″-的Pod-yaml："><a href="#编辑一个包含两个容器，引用secret-“registrykey-m262-4″-的Pod-yaml：" class="headerlink" title="编辑一个包含两个容器，引用secret “registrykey-m262-4″ 的Pod yaml："></a>编辑一个包含两个容器，引用secret “registrykey-m262-4″ 的Pod yaml：</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs dts">cat test4.yaml<br><span class="hljs-symbol">apiVersion:</span> v1<br><span class="hljs-symbol">kind:</span> Pod<br><span class="hljs-symbol">metadata:</span><br><span class="hljs-symbol">  name:</span> rbd-rest-api-multi-registrykeys-m262<span class="hljs-number">-2</span><br><span class="hljs-symbol">spec:</span><br><span class="hljs-symbol">  containers:</span><br>  - name: rbd-rest-api-multi-registrykeys-m262<span class="hljs-number">-2</span><br><span class="hljs-symbol">    image:</span> registry.martin.com:<span class="hljs-number">5000</span><span class="hljs-meta-keyword">/xxxx/</span>rbd-rest-api:latest<br><span class="hljs-symbol">    imagePullPolicy:</span> Always<br>  - name: test-multi-registrykeys-m262<span class="hljs-number">-2</span><br><span class="hljs-symbol">    image:</span> registry.martin.com:<span class="hljs-number">6000</span><span class="hljs-meta-keyword">/xxxx/</span>test:latest<br><span class="hljs-symbol">    imagePullPolicy:</span> Always<br><span class="hljs-symbol">    command:</span><br>       - <span class="hljs-string">&quot;tail&quot;</span><br>       - <span class="hljs-string">&quot;-f&quot;</span><br>       - <span class="hljs-string">&quot;/var/log/bootstrap.log&quot;</span><br><span class="hljs-symbol">  imagePullSecrets:</span><br>  - name: registrykey-m262<span class="hljs-number">-4</span><br></code></pre></td></tr></table></figure><h4 id="创建改pod"><a href="#创建改pod" class="headerlink" title="创建改pod:"></a>创建改pod:</h4><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># kubectl create -f test4.yaml</span><br><span class="hljs-attribute">pod</span> <span class="hljs-string">&quot;rbd-rest-api-multi-registrykeys-m262-2&quot;</span> created<br><br><span class="hljs-comment"># kubectl get pod</span><br><span class="hljs-attribute">NAME</span>                                   READY     STATUS             RESTARTS   AGE<br><span class="hljs-attribute">rbd</span>-rest-api-multi-registrykeys-m<span class="hljs-number">262</span>-<span class="hljs-number">2</span>   <span class="hljs-number">2</span>/<span class="hljs-number">2</span>       Running            <span class="hljs-number">0</span>          <span class="hljs-number">4</span>s<br><br></code></pre></td></tr></table></figure><p>Pod创建成功</p><h3 id="调用API创建registrykey-secret"><a href="#调用API创建registrykey-secret" class="headerlink" title="调用API创建registrykey secret"></a>调用API创建registrykey secret</h3><p>对比了方法2和方法3，方法2更简洁，方法3更强大。但在任何一个产品中，secret都不应该是手动创建的，在这种情况下， API创建 registrykey secret便是必经之路。一旦选择通过API创建，我们显然将依仗着方法2中的原理，将config.json中的内容通过API请求的Body Post给K8s api server。</p><h4 id="如何在远端构建出config-json的内容继而构建出secret-yaml中-dockerconfigjson的值数据呢？"><a href="#如何在远端构建出config-json的内容继而构建出secret-yaml中-dockerconfigjson的值数据呢？" class="headerlink" title="如何在远端构建出config.json的内容继而构建出secret yaml中.dockerconfigjson的值数据呢？"></a>如何在远端构建出config.json的内容继而构建出secret yaml中.dockerconfigjson的值数据呢？</h4><p>我们发现config.json套路中，唯一不确定的就是每个private repository下的auth串，那么这个串是啥？你大可base64 -d一下：</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-meta"># echo -n <span class="hljs-string">&quot;sddfhbfUGFzcgg3dgf=&quot;</span>|base64 -d</span><br><span class="hljs-symbol">UserName:</span>Password<br></code></pre></td></tr></table></figure><p>可以看到实质上这个auth串就是UserName:Password的base64编码值。因此，首先要用某个仓库的UserName和Password按照’UserName:Password’格式进行base64编码，利用编码的结果值构造json内容，比如：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>    <span class="hljs-attr">&quot;auths&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;registry.martin.com:5000/xxxx/rbd-rest-api&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;auth&quot;</span>: <span class="hljs-string">&quot;Vsddff3dfFzc3dfgQ=&quot;</span><br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后对这段json数据再做base64编码，所得到的值就是secret yaml中的.dockerconfigjson的值数据。</p><h4 id="通过API创建一个secret："><a href="#通过API创建一个secret：" class="headerlink" title="通过API创建一个secret："></a>通过API创建一个secret：</h4><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs llvm">➜  nexus cat secret_api.sh <br>#!/bin/bash<br>#<span class="hljs-string">&quot;.dockerconfigjson&quot;</span>: <span class="hljs-string">&quot;&#123;cat ~/.docker/config.json |base64 -w 0&#125;&quot;</span><br>curl -v -H <span class="hljs-string">&quot;Content-type: application/json&quot;</span>  -X POST -d &#x27; &#123;<br>  <span class="hljs-string">&quot;apiVersion&quot;</span>: <span class="hljs-string">&quot;v1&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-string">&quot;kind&quot;</span>: <span class="hljs-string">&quot;Secret&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-string">&quot;metadata&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;registrykey-m262-5&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;namespace&quot;</span>: <span class="hljs-string">&quot;default&quot;</span><br>  &#125;<span class="hljs-punctuation">,</span><br>  <span class="hljs-string">&quot;data&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;.dockerconfigjson&quot;</span>: <span class="hljs-string">&quot;ewoJImF1dGhzIjogewoJCSJkYW9jbG91ZC5pbyI6IHsKCQkJImF1dGgiOiAiYUdGdWJtbDFjenBwWW5obk1WRTFRUT09IgoJCX0sCgkJImh0dHBzOi8vaW5kZXguZG9ja2VyLmlvL3YxLyI6IHsKCQkJImF1dGgiOiAiYUdGdWJtbDFjenBwWW5obk1WRTFRVGc0Tmc9PSIKCQl9LAoJCSJyZWdpc3RyeS5tYXJ0aW4uY29tOjUwMDAiOiB7CgkJCSJhdXRoIjogImJXRnlkR2x1T21saWVHY3hVVFZCIgoJCX0KCX0sCgkiSHR0cEhlYWRlcnMiOiB7CgkJIlVzZXItQWdlbnQiOiAiRG9ja2VyLUNsaWVudC8xNy4wOS4wLWNlIChsaW51eCkiCgl9Cn0=&quot;</span><br>  &#125;<span class="hljs-punctuation">,</span><br>  <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;kubernetes.io/dockerconfigjson&quot;</span><br>&#125;&#x27; http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8080</span>/api/v<span class="hljs-number">1</span>/namespaces/<span class="hljs-keyword">default</span>/secrets<br>➜  nexus<br>➜  nexus ./secret_api.sh  <br>* About <span class="hljs-keyword">to</span> connect() <span class="hljs-keyword">to</span> <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span> port <span class="hljs-number">8080</span> (<span class="hljs-variable">#0</span>)<br>*   Trying <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>...<br>* Connected <span class="hljs-keyword">to</span> <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span> (<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>) port <span class="hljs-number">8080</span> (<span class="hljs-variable">#0</span>)<br>&gt; POST /api/v<span class="hljs-number">1</span>/namespaces/<span class="hljs-keyword">default</span>/secrets HTTP/<span class="hljs-number">1.1</span><br>&gt; User-Agent: curl/<span class="hljs-number">7.29</span>.<span class="hljs-number">0</span><br>&gt; Host: <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8080</span><br>&gt; Accept: */*<br>&gt; Content-<span class="hljs-keyword">type</span>: application/json<br>&gt; Content-Length: <span class="hljs-number">624</span><br>&gt; <br>* upload completely sent off: <span class="hljs-number">624</span> out of <span class="hljs-number">624</span> bytes<br>&lt; HTTP/<span class="hljs-number">1.1</span> <span class="hljs-number">201</span> Created<br>&lt; Content-Type: application/json<br>&lt; Date: Mon<span class="hljs-punctuation">,</span> <span class="hljs-number">25</span> Jun <span class="hljs-number">2018</span> <span class="hljs-number">07</span>:<span class="hljs-number">01</span>:<span class="hljs-number">04</span> GMT<br>&lt; Content-Length: <span class="hljs-number">830</span><br>&lt; <br>&#123;<br>  <span class="hljs-string">&quot;kind&quot;</span>: <span class="hljs-string">&quot;Secret&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-string">&quot;apiVersion&quot;</span>: <span class="hljs-string">&quot;v1&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-string">&quot;metadata&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;registrykey-m262-5&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;namespace&quot;</span>: <span class="hljs-string">&quot;default&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;selfLink&quot;</span>: <span class="hljs-string">&quot;/api/v1/namespaces/default/secrets/registrykey-m262-5&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;uid&quot;</span>: <span class="hljs-string">&quot;86ccae15-7845-11e8-8760-5254004f2222&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;resourceVersion&quot;</span>: <span class="hljs-string">&quot;1815470&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;creationTimestamp&quot;</span>: <span class="hljs-string">&quot;2018-06-25T07:01:04Z&quot;</span><br>  &#125;<span class="hljs-punctuation">,</span><br>  <span class="hljs-string">&quot;data&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;.dockerconfigjson&quot;</span>: <span class="hljs-string">&quot;ewoJImF1dGhzIjogewoJCSJkYW9jbG91ZC5pbyI6IHsKCQkJImF1dGgiOiAiYUdGdWJtbDFjenBwWW5obk1WRTFRUT09IgoJCX0sCgkJImh0dHBzOi8vaW5kZXguZG9ja2VyLmlvL3YxLyI6IHsKCQkJImF1dGgiOiAiYUdGdWJtbDFjenBwWW5obk1WRTFRVGc0Tmc9PSIKCQl9LAoJCSJyZWdpc3RyeS5tYXJ0aW4uY29tOjUwMDAiOiB7CgkJCSJhdXRoIjogImJXRnlkR2x1T21saWVHY3hVVFZCIgoJCX0KCX0sCgkiSHR0cEhlYWRlcnMiOiB7CgkJIlVzZXItQWdlbnQiOiAiRG9ja2VyLUNsaWVudC8xNy4wOS4wLWNlIChsaW51eCkiCgl9Cn0=&quot;</span><br>  &#125;<span class="hljs-punctuation">,</span><br>  <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;kubernetes.io/dockerconfigjson&quot;</span><br>* Connection <span class="hljs-variable">#0</span> <span class="hljs-keyword">to</span> host <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span> left intact<br>&#125;<br>➜  nexus kubectl get secret<br>NAME                  TYPE                                  DATA      AGE<br><span class="hljs-keyword">default</span>-token-fck<span class="hljs-number">44</span>   kubernetes.io/service-account-token   <span class="hljs-number">3</span>         <span class="hljs-number">17</span>d<br>registrykey<span class="hljs-number">-2.6</span>.<span class="hljs-number">2</span>     kubernetes.io/dockerconfigjson        <span class="hljs-number">1</span>         <span class="hljs-number">2</span>d<br>registrykey-m<span class="hljs-number">262</span><span class="hljs-number">-3</span>    kubernetes.io/dockerconfigjson        <span class="hljs-number">1</span>         <span class="hljs-number">2</span>d<br>registrykey-m<span class="hljs-number">262</span><span class="hljs-number">-5</span>    kubernetes.io/dockerconfigjson        <span class="hljs-number">1</span>         <span class="hljs-number">2</span>m<br>➜  nexus <br></code></pre></td></tr></table></figure><h4 id="基于registrykey-m262-5，启动一个Pod："><a href="#基于registrykey-m262-5，启动一个Pod：" class="headerlink" title="基于registrykey-m262-5，启动一个Pod："></a>基于registrykey-m262-5，启动一个Pod：</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">apiVersion:</span> v1<br><span class="hljs-symbol">kind:</span> Pod<br><span class="hljs-symbol">metadata:</span><br><span class="hljs-symbol">  name:</span> rbd-rest-api-registrykey-m262<span class="hljs-number">-5</span><br><span class="hljs-symbol">spec:</span><br><span class="hljs-symbol">  containers:</span><br>  - name: rbd-rest-api-registrykey-m262<span class="hljs-number">-5</span><br><span class="hljs-symbol">    image:</span> registry.martin.com:<span class="hljs-number">5000</span><span class="hljs-meta-keyword">/xxxx/</span>api:latest<br><span class="hljs-symbol">    imagePullPolicy:</span> Always<br><span class="hljs-symbol">  imagePullSecrets:</span><br>  - name: registrykey-m262<span class="hljs-number">-5</span><br><br><span class="hljs-meta"># kubectl create -f test5.yaml</span><br>pod <span class="hljs-string">&quot;rbd-rest-api-registrykey-m262-5&quot;</span> created<br><br><span class="hljs-meta"># kubectl get pod</span><br>NAME                            READY     STATUS             RESTARTS   AGE<br>rbd-rest-api-registrykey-m262<span class="hljs-number">-5</span>   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>       Running            <span class="hljs-number">0</span>          <span class="hljs-number">5</span>s<br></code></pre></td></tr></table></figure><p>Pod创建成功！</p>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>基于k8s 动态配置及扩容maven nexus私服</title>
    <link href="/2018/06/22/%E5%9F%BA%E4%BA%8Ek8s%20%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E5%8F%8A%E6%89%A9%E5%AE%B9maven%20nexus%E7%A7%81%E6%9C%8D/"/>
    <url>/2018/06/22/%E5%9F%BA%E4%BA%8Ek8s%20%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E5%8F%8A%E6%89%A9%E5%AE%B9maven%20nexus%E7%A7%81%E6%9C%8D/</url>
    
    <content type="html"><![CDATA[<h3 id="配置nexus"><a href="#配置nexus" class="headerlink" title="配置nexus"></a>配置nexus</h3><p>从官网下载了nexus之后还需要进行一些配置。<br>编辑bin/nexus.vmoptions 调整后的如下：</p><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs haml">-<span class="ruby">Xms600M</span><br><span class="ruby"></span>-<span class="ruby">Xmx600M</span><br><span class="ruby"></span>-<span class="ruby"><span class="hljs-symbol">XX:</span>MaxDirectMemorySize=1G</span><br><span class="ruby"></span>-<span class="ruby"><span class="hljs-symbol">XX:</span>+UnlockDiagnosticVMOptions</span><br><span class="ruby"></span>-<span class="ruby"><span class="hljs-symbol">XX:</span>+UnsyncloadClass</span><br><span class="ruby"></span>-<span class="ruby"><span class="hljs-symbol">XX:</span>+LogVMOutput</span><br><span class="ruby"></span>-<span class="ruby"><span class="hljs-symbol">XX:</span>LogFile=<span class="hljs-regexp">/data/docker</span><span class="hljs-regexp">/soft/nexus</span><span class="hljs-regexp">/log/jvm</span>.log</span><br><span class="ruby"></span>-<span class="ruby"><span class="hljs-symbol">XX:</span>-OmitStackTraceInFastThrow</span><br><span class="ruby"></span>-<span class="ruby">Djava.net.preferIPv4Stack=<span class="hljs-literal">true</span></span><br><span class="ruby"></span>-<span class="ruby">Dkaraf.home=.</span><br><span class="ruby"></span>-<span class="ruby">Dkaraf.base=.</span><br><span class="ruby"></span>-<span class="ruby">Dkaraf.etc=etc/karaf</span><br><span class="ruby"></span>-<span class="ruby">Djava.util.logging.config.file=etc/karaf/java.util.logging.properties</span><br><span class="ruby"></span>-<span class="ruby">Dkaraf.data=<span class="hljs-regexp">/data/docker</span><span class="hljs-regexp">/soft/nexus</span><span class="hljs-regexp">/data</span></span><br><span class="hljs-regexp"><span class="ruby"></span></span>-<span class="ruby"><span class="hljs-regexp">Djava.io.tmpdir=/data</span><span class="hljs-regexp">/docker/soft</span><span class="hljs-regexp">/nexus/tmp</span></span><br><span class="ruby"></span>-<span class="ruby">Dkaraf.startLocalConsole=<span class="hljs-literal">false</span></span><br></code></pre></td></tr></table></figure><p>其中除了1，2行的jvm内存配置之外，最关键的就是，以下几个属性配置：</p><ul><li>-XX:LogFile=/data/docker/soft/nexus/log/jvm.log       # 日志文件生成位置</li><li>-Dkaraf.data=/data/docker/soft/nexus/data             # 仓库数据存放位置(上传的jar包)</li><li>-Djava.io.tmpdir=/data/docker/soft/nexus/tmp          # 临时文件存放位置</li></ul><h3 id="制作Docker镜像"><a href="#制作Docker镜像" class="headerlink" title="制作Docker镜像"></a>制作Docker镜像</h3><p>配置好nexus之后，需要再制作自己的docker镜像，因为k8s就是调度镜像容器的。 </p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@master nexus]<span class="hljs-comment"># pwd</span><br>/data/docker/dockerfile/nexus<br>[root@master nexus]<span class="hljs-comment"># ls -lth </span><br>total 223M<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 146 </span>Jun<span class="hljs-number"> 21 </span>16:06 Dockerfile<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root 108M Jun<span class="hljs-number"> 21 </span>16:02 nexus3.tar.gz<br>drwxr-xr-x<span class="hljs-number"> 3 </span>root root 4.0K Jun<span class="hljs-number"> 21 </span>15:53 sonatype-work<br>drwxr-xr-x<span class="hljs-number"> 9 </span>root root 4.0K Jun<span class="hljs-number"> 21 </span>15:53 nexus-3.12.1-01<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root 115M Jun<span class="hljs-number"> 21 </span>15:36 nexus-3.12.1-01-unix.tar.gz.org<br></code></pre></td></tr></table></figure><p>docker镜像的制作很简单，新建一个Dockerfile文件：</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">[root@<span class="hljs-keyword">master</span> <span class="hljs-title">nexus</span>]<span class="hljs-comment"># cat Dockerfile </span><br>FROM registry.cn-hangzhou.aliyuncs.com/luhaoyuan/oracle-jdk8:latest<br><br>ADD nexus3.tar.gz /opt<br><br>ENTRYPOINT [<span class="hljs-string">&quot;/opt/nexus-3.12.1-01/bin/nexus&quot;</span>, <span class="hljs-string">&quot;run&quot;</span>]<br></code></pre></td></tr></table></figure><ul><li>第一行：nexus的运行是依赖JDK环境的，所以我们这里就使用jdk作为基础镜像；(镜像是基于centos7，比较大，后续可以考虑修改为alpine_3.6)</li><li>第二行：将我们配置过后的nexus(nexus-3.12.1-01)再重新打包一下，添加到容器中； </li><li>第三行：启动容器时，执行的命令，nexus的启动命令有start和run，由于start默认是启动在后台进程的，这样容器一启动就退出了。所以这里必须要使用run命令启动了。</li></ul><p>最后构建Docker镜像：<br>docker build -t registry.martin.com:5000/tools/nexus:3.12.1 .<br>registry.martin.com:5000为我registry地址,构建之后将改image push到私库,当然也可以用harbor<br>如果有做ca校验，需要将证书拷贝到指定的:/etc/docker/certs.d/xxx/ca.crt,然后docker login校验<br>再docker push registry.martin.com:5000/tools/nexus:3.12.1，不然会提示x509认证失败</p><span id="more"></span><h3 id="配置k8s-PV-PVC"><a href="#配置k8s-PV-PVC" class="headerlink" title="配置k8s PV-PVC"></a>配置k8s PV-PVC</h3><p>为了避免容器重启数据丢失，需要挂载主机的卷空间。<br>在k8s中，pod挂载主机的存储卷，就需要使用到了PV（PersistentVolume）和PVC（PersistentVolumeClaim）。<br>新建nexus3-pv-pvc.yaml文件：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@master</span> <span class="hljs-string">nexus</span>]<span class="hljs-comment"># pwd</span><br><span class="hljs-string">/data/k8s/nexus</span><br>[<span class="hljs-string">root@master</span>  <span class="hljs-string">nexus</span>]<span class="hljs-comment"># ls -lth</span><br><span class="hljs-string">total</span> <span class="hljs-string">12K</span><br><span class="hljs-string">-rw-r--r--</span> <span class="hljs-number">1</span> <span class="hljs-string">root</span> <span class="hljs-string">root</span> <span class="hljs-number">777</span> <span class="hljs-string">Jun</span> <span class="hljs-number">21</span> <span class="hljs-number">18</span><span class="hljs-string">:49</span> <span class="hljs-string">nexus3-deployment.yaml</span><br><span class="hljs-string">-rw-r--r--</span> <span class="hljs-number">1</span> <span class="hljs-string">root</span> <span class="hljs-string">root</span> <span class="hljs-number">370</span> <span class="hljs-string">Jun</span> <span class="hljs-number">21</span> <span class="hljs-number">17</span><span class="hljs-string">:12</span> <span class="hljs-string">nexus3-service.yaml</span><br><span class="hljs-string">-rw-r--r--</span> <span class="hljs-number">1</span> <span class="hljs-string">root</span> <span class="hljs-string">root</span> <span class="hljs-number">525</span> <span class="hljs-string">Jun</span> <span class="hljs-number">21</span> <span class="hljs-number">16</span><span class="hljs-string">:49</span> <span class="hljs-string">nexus3-pv-pvc.yaml</span><br>[<span class="hljs-string">root@master</span>  <span class="hljs-string">nexus</span>]<span class="hljs-comment"># cat nexus3-pv-pvc.yaml </span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolume</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nexus3-data-pv</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nexus3-data-pv</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">capacity:</span><br>    <span class="hljs-attr">storage:</span> <span class="hljs-string">500Gi</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteOnce</span><br>  <span class="hljs-attr">persistentVolumeReclaimPolicy:</span> <span class="hljs-string">Recycle</span><br>  <span class="hljs-attr">hostPath:</span><br>    <span class="hljs-attr">path:</span> <span class="hljs-string">/data/docker/soft/nexus</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nexus3-data-pvc</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nexus3-data-pvc</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteOnce</span><br>  <span class="hljs-attr">resources:</span><br>    <span class="hljs-attr">requests:</span><br>      <span class="hljs-attr">storage:</span> <span class="hljs-string">500Gi</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">nexus3-data-pv</span><br>[<span class="hljs-string">root@master</span>  <span class="hljs-string">nexus</span>]<span class="hljs-comment"># </span><br></code></pre></td></tr></table></figure><p>==注意：PV中的hostPath，指定了宿主主机上的挂载路径(node节点最好全部先创建好)==</p><h3 id="配置k8s-Deployment"><a href="#配置k8s-Deployment" class="headerlink" title="配置k8s Deployment"></a>配置k8s Deployment</h3><p>在k8s早期更多的是使用ReplicationController (RC)来控制保障pod，不过后来又出现了Deployment。<br>Deployment不仅包含了RC的所有功能，还具有：版本记录、回滚、暂停和启动等多种额外的强大功能。<br>所以可以尽量都使用Deployment,新建nexus3-deployment.yaml文件：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@master</span> <span class="hljs-string">nexus</span>]<span class="hljs-comment"># cat nexus3-deployment.yaml </span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">extensions/v1beta1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nexus3</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nexus3</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">nexus3</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">nexus3</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nexus3</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">registry.martin.com:5000/tools/nexus:3.12.1</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>          <span class="hljs-attr">ports:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9193</span><br>            <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">volumeMounts:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nexus-data</span><br>            <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/data/docker/soft/nexus</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nexus-data</span><br>          <span class="hljs-attr">persistentVolumeClaim:</span><br>            <span class="hljs-attr">claimName:</span> <span class="hljs-string">nexus3-data-pvc</span><br>      <span class="hljs-attr">nodeSelector:</span><br>        <span class="hljs-attr">kubernetes.io/hostname:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.15</span><br></code></pre></td></tr></table></figure><p>需要在volumes结点上引用之前创建的PVC：</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs haskell"><span class="hljs-title">volumes</span>:<br>  - name: nexus-<span class="hljs-class"><span class="hljs-keyword">data</span></span><br>    persistentVolumeClaim:<br>      claimName: nexus3-<span class="hljs-class"><span class="hljs-keyword">data</span>-pvc</span><br></code></pre></td></tr></table></figure><p>在volumeMounts结点上，配置了挂载到容器中的路径：/data/docker/soft/nexus(node节点最好全部先创建好)</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">volumeMounts:<br>  - name: nexus-data<br>    mountPath: <span class="hljs-regexp">/data/</span>docker<span class="hljs-regexp">/soft/</span>nexus<br></code></pre></td></tr></table></figure><p>最后的nodeSelector表示pod只在某个主机上运行,可以通过在k8s的master上使用:kubectl get nodes查看</p><h3 id="配置k8s-Service"><a href="#配置k8s-Service" class="headerlink" title="配置k8s Service"></a>配置k8s Service</h3><p>k8s中的pod的访问是不可靠的，随时可能发生pod停止-漂移-创建的过程。<br>所以要想能够稳定的访问，就必须要创建Service进行服务发现了，在Service中是根据selector来寻找pod的。<br>最后k8s上的Service只能在集群节点上访问，如果我们想要在集群外部进行访问的话，只有三种方式：</p><ul><li>NodePort、</li><li>LoadBalancer、</li><li>Ingress。 </li></ul><p>这里使用NodePort，绑定宿主机的端口来进行暴露服务。跟docker run -p 看上去效果相似。<br>新建nexus3-service.yaml文件：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@master</span> <span class="hljs-string">nexus</span>]<span class="hljs-comment"># cat nexus3-service.yaml </span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nexus3</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nexus3</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8081</span><br>    <span class="hljs-attr">nodePort:</span> <span class="hljs-number">30031</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">web-ui</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nexus3</span><br>[<span class="hljs-string">root@master</span> <span class="hljs-string">nexus</span>]<span class="hljs-comment"># </span><br></code></pre></td></tr></table></figure><p>其中关键的地方就是spec.type节点配置NodePort类型了。<br>说明下的ports 端口的配置：</p><ul><li>port 属性定义了Service的虚端口；</li><li>targetPort 属性指定了后面pod上提供的端口，如果没有指定则默认与port相同(这里我们显视的指定了)；</li><li>nodePort 属性指定了绑定在宿主机(物理机)上的端口号，我们可以通过宿主机IP + 端口的形式访问到后方pod中的服。</li><li>name 如果有多个port配置的话，必须要为每个port指定一个名称。</li></ul><h3 id="k8s部署访问"><a href="#k8s部署访问" class="headerlink" title="k8s部署访问"></a>k8s部署访问</h3><h4 id="创建-PV-PVC"><a href="#创建-PV-PVC" class="headerlink" title="创建 PV-PVC"></a>创建 PV-PVC</h4><p>根据配置文件，创建PV-PVC：</p><p>kubectl create -f nexus3-pv-pvc.yaml</p><p>创建完成后，查看一下状态，是否正常： </p><p>kubectl get pv</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-keyword">NAME</span>             CAPACITY   <span class="hljs-keyword">ACCESS</span> MODES   RECLAIM POLICY   <span class="hljs-keyword">STATUS</span>    CLAIM                     STORAGECLASS   REASON    AGE<br>nexus3-<span class="hljs-keyword">data</span>-pv   <span class="hljs-number">500</span>Gi      RWO            Recycle          Bound     <span class="hljs-keyword">default</span>/nexus3-<span class="hljs-keyword">data</span>-pvc                            <span class="hljs-number">17</span>h<br></code></pre></td></tr></table></figure><h4 id="创建Deployment"><a href="#创建Deployment" class="headerlink" title="创建Deployment"></a>创建Deployment</h4><p>继续创建Deployment，创建完后会自动创建pod的，并维护pod数量始终为1。 </p><p>kubectl create -f nexus3-deployment.yaml </p><p>稍等几秒钟，查看pod状态： </p><p>kubectl get pod -o wide</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">NAME</span>                      READY     STATUS    RESTARTS   AGE       IP           NODE<br><span class="hljs-attribute">nexus3</span>-<span class="hljs-number">68</span>f<span class="hljs-number">55</span>d<span class="hljs-number">9746</span>-vfnf<span class="hljs-number">8</span>   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>       Running   <span class="hljs-number">0</span>          <span class="hljs-number">12</span>h       <span class="hljs-number">10.20.7.12</span>   <span class="hljs-number">192.168.0.15</span><br></code></pre></td></tr></table></figure><p>==注意：默认不用-n指定namespace的都是用的default，-o wide可以看到详细的IP及node信息==</p><h4 id="创建Service"><a href="#创建Service" class="headerlink" title="创建Service"></a>创建Service</h4><p>创建Service，暴露服务：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">kubectl</span> create -f nexus<span class="hljs-number">3</span>-service.yaml<br></code></pre></td></tr></table></figure><p>查看状态：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"> <span class="hljs-attribute">kubectl</span> get svc<br><span class="hljs-attribute">NAME</span>            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                                        AGE<br><span class="hljs-attribute">kubernetes</span>      ClusterIP   <span class="hljs-number">10.10.0.1</span>       &lt;none&gt;        <span class="hljs-number">443</span>/TCP                                        <span class="hljs-number">13</span>d<br><span class="hljs-attribute">nexus3</span>          NodePort    <span class="hljs-number">10.10.165.3</span>     &lt;none&gt;        <span class="hljs-number">8081</span>:<span class="hljs-number">30031</span>/TCP,<span class="hljs-number">5000</span>:<span class="hljs-number">30032</span>/TCP,<span class="hljs-number">8889</span>:<span class="hljs-number">30033</span>/TCP   <span class="hljs-number">12</span>h<br><span class="hljs-attribute">nginx</span>-service   ClusterIP   <span class="hljs-number">10.10.147.216</span>   &lt;none&gt;        <span class="hljs-number">80</span>/TCP                                         <span class="hljs-number">10</span>d<br></code></pre></td></tr></table></figure><p>==注意这里的访问，是访问宿主机的IP+端口，至于CLUSTER-IP这些都是虚拟的IP，无法在外部进行访问的==。</p><h3 id="访问Nexus"><a href="#访问Nexus" class="headerlink" title="访问Nexus"></a>访问Nexus</h3><p><a href="http://192.168.1.2:30031/">http://192.168.1.2:30031</a> (pod内container端口为：8081)</p><h3 id="升级"><a href="#升级" class="headerlink" title="升级"></a>升级</h3><p>借用k8s Deployment的升级方式:</p><ol><li>从官网下载最新的nexus安装包；</li><li>修改nexus配置文件，将上面旧版本的配置覆盖过来就行了；</li><li>修改Dockerfile文件，构建新的Docker镜像，将新打包的nexus放入镜像中。<br>如：docker build -t registry.martin.com:5000/tools/nexus:3.12.2 .<br>Ps: 不要忘记启动命令路径也要调整!</li><li>使用k8s命令升级Deployment：<br>如：kubectl set image deployment/nexus3 nexus3=registry.martin.com:5000/tools/nexus:3.12.2</li><li>回滚升级，如果发现升级了的不好用，或者出现问题，也可以回滚：<br>如：kubectl rollout undo deployment/nexus3</li></ol><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>其实这个过程中里复杂了一部分，也简化了一部分。<br>复杂了pv-pvc过程，pv-pvc不用创建直接在Deployment中挂载hostPath也是可以的。<br>简化了Deployment，其实应该还需要加上cpu、内存等资源限制的。<br>这里只是在nexus配置文件中做了限制，如果出现内存泄漏问题，还是没办法解决!</p>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>kubernetes-jenkins-ci-cd</title>
    <link href="/2018/06/14/kubernetes-jenkins-ci-cd/"/>
    <url>/2018/06/14/kubernetes-jenkins-ci-cd/</url>
    
    <content type="html"><![CDATA[<h3 id="流程图："><a href="#流程图：" class="headerlink" title="流程图："></a>流程图：</h3><p>基于Jenkins的CI/CD流程如下所示:<br><img src="https://cos.leiyawu.com/docker/k8s/kubernetes-jenkins-ci-cd.png" alt="kubernetes-jenkins-ci-cd"></p><h3 id="流程说明："><a href="#流程说明：" class="headerlink" title="流程说明："></a>流程说明：</h3><ol><li>用户向Gitlab提交代码，代码中必须包含Dockerfile</li><li>将代码提交到远程仓库</li><li>用户在发布应用时需要填写git仓库地址和分支、服务类型、服务名称、资源数量、实例个数，确定后触发Jenkins自动构建</li><li>Jenkins的CI流水线自动编译代码并打包成docker镜像推送到Harbor镜像仓库</li><li>Jenkins的CI流水线中包括了自定义脚本，根据我们已准备好的kubernetes的YAML模板，将其中的变量替换成用户输入的选项</li><li>生成应用的kubernetes YAML配置文件</li><li>更新Ingress的配置，根据新部署的应用的名称，在ingress的配置文件中增加一条路由信息</li><li>更新PowerDNS，向其中插入一条DNS记录，IP地址是边缘节点的IP地址。关于边缘节点，请查看<a href="https://jimmysong.io/kubernetes-handbook/practice/edge-node-configuration.html">边缘节点配置</a></li><li>Jenkins调用kubernetes的API，部署应用</li></ol>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Pause容器</title>
    <link href="/2018/06/13/Pause%E5%AE%B9%E5%99%A8/"/>
    <url>/2018/06/13/Pause%E5%AE%B9%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="Pause容器定义"><a href="#Pause容器定义" class="headerlink" title="Pause容器定义"></a>Pause容器定义</h2><p>Pause容器，又叫Infra容器，本文将探究该容器的作用与原理。</p><p>在kubelet的配置中有这样一个参数：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">KUBELET_POD_INFRA_CONTAINER=--pod-infra-container-image=registry.access.redhat.com<span class="hljs-regexp">/rhel7/</span>pod-infrastructure:latest<br><br></code></pre></td></tr></table></figure><p>上面是openshift中的配置参数，kubernetes中默认的配置参数是：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">KUBELET_POD_INFRA_CONTAINER</span>=--pod-infra-container-image=gcr.io/google_containers/pause-amd<span class="hljs-number">64</span>:<span class="hljs-number">3</span>.<span class="hljs-number">0</span><br><br></code></pre></td></tr></table></figure><p>Pause容器，是可以自己来定义，官方使用的gcr.io/google_containers/pause-amd64:3.0容器的代码见Github，使用C语言编写。</p><h2 id="Pause容器的作用"><a href="#Pause容器的作用" class="headerlink" title="Pause容器的作用"></a>Pause容器的作用</h2><p>检查nod节点的时候会发现每个node上都运行了很多的pause容器，例如如下:</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs subunit">[root@elk<span class="hljs-string">-02</span> bin]# docker ps<br>CONTAINER ID        IMAGE                                               COMMAND                  CREATED             STATUS              PORTS               NAMES<br>576c56bd6065        mirrorgooglecontainers/kubernetes-dashboard-amd64   &quot;/dashboard --inse...&quot;   2 hours ago         Up 2 hours                              k8s_kubernetes-dashboard_kubernetes-dashboard<span class="hljs-string">-66</span>c9d98865-jdbg8_kube-system_d2406f4f<span class="hljs-string">-6</span>de3<span class="hljs-string">-11</span>e8<span class="hljs-string">-8760</span><span class="hljs-string">-5254004</span>f2222_0<br>c4985381c2b7        d4b7466213fe                                        &quot;/coredns -conf /e...&quot;   2 hours ago         Up 2 hours                              k8s_coredns_coredns<span class="hljs-string">-77</span>c989547b-xq4dr_kube-system_d23ef2c4<span class="hljs-string">-6</span>de3<span class="hljs-string">-11</span>e8<span class="hljs-string">-8760</span><span class="hljs-string">-5254004</span>f2222_1<br>ba2fef1cbf00        mirrorgooglecontainers/pause-amd64:3.0              &quot;/pause&quot;                 2 hours ago         Up 2 hours                              k8s_POD_coredns<span class="hljs-string">-77</span>c989547b-xq4dr_kube-system_d23ef2c4<span class="hljs-string">-6</span>de3<span class="hljs-string">-11</span>e8<span class="hljs-string">-8760</span><span class="hljs-string">-5254004</span>f2222_1<br>ea6c2994b397        d4b7466213fe                                        &quot;/coredns -conf /e...&quot;   2 hours ago         Up 2 hours                              k8s_coredns_coredns<span class="hljs-string">-77</span>c989547b-lcbfw_kube-system_0696926b<span class="hljs-string">-6</span>d79<span class="hljs-string">-11</span>e8<span class="hljs-string">-8760</span><span class="hljs-string">-5254004</span>f2222_1<br>f61476c51230        mirrorgooglecontainers/pause-amd64:3.0              &quot;/pause&quot;                 2 hours ago         Up 2 hours                              k8s_POD_kubernetes-dashboard<span class="hljs-string">-66</span>c9d98865-jdbg8_kube-system_d2406f4f<span class="hljs-string">-6</span>de3<span class="hljs-string">-11</span>e8<span class="hljs-string">-8760</span><span class="hljs-string">-5254004</span>f2222_0<br>b6f61200d5ea        mirrorgooglecontainers/pause-amd64:3.0              &quot;/pause&quot;                 2 hours ago         Up 2 hours                              k8s_POD_coredns<span class="hljs-string">-77</span>c989547b-lcbfw_kube-system_0696926b<span class="hljs-string">-6</span>d79<span class="hljs-string">-11</span>e8<span class="hljs-string">-8760</span><span class="hljs-string">-5254004</span>f2222_1<br></code></pre></td></tr></table></figure><p>kubernetes中的pause容器主要为每个业务容器提供以下功能：</p><ul><li>在pod中担任Linux命名空间共享的基础；</li><li>启用pid命名空间，开启init进程。</li></ul><p>pause容器的作用可以从这个例子中看出，首先见下图：<br><img src="https://cos.leiyawu.com/docker/k8s/pause-container.png" alt="map"></p><h2 id="Pause容器测试"><a href="#Pause容器测试" class="headerlink" title="Pause容器测试"></a>Pause容器测试</h2><p>首先在节点上运行一个pause容器。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> run -d --name pause -p <span class="hljs-number">8880</span>:<span class="hljs-number">80</span> martin/pause-amd<span class="hljs-number">64</span>:<span class="hljs-number">3</span>.<span class="hljs-number">0</span><br><br></code></pre></td></tr></table></figure><p>然后再运行一个nginx容器，nginx将为localhost:2398创建一个代理。</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">$ cat <span class="hljs-symbol">&lt;&lt;EOF &gt;&gt;</span> nginx.conff<br>error_log stderr;<br>events &#123; worker_connections  <span class="hljs-number">1024</span>; &#125;<br>http &#123;<br>    access_log /dev/stdout combined;<br>    <span class="hljs-keyword">server</span> &#123;<br>        <span class="hljs-keyword">listen</span> <span class="hljs-number">80</span> default_server;<br>        server_name example.com www.example.com;<br>        <span class="hljs-keyword">location</span> / &#123;<br>            proxy_pass http://<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">2398</span>;<br>        &#125;<br>    &#125;<br>&#125;<br>EOF<br>$ docker run -d <span class="hljs-comment">--name nginx -v `pwd`/nginx.conf:/etc/nginx/nginx.conf --net=container:pause --ipc=container:pause --pid=container:pause nginx</span><br></code></pre></td></tr></table></figure><p>然后再为ghost创建一个应用容器，这是一款博客软件。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">$ docker <span class="hljs-builtin-name">run</span> -d --name ghost <span class="hljs-attribute">--net</span>=container:pause <span class="hljs-attribute">--ipc</span>=container:pause <span class="hljs-attribute">--pid</span>=container:pause ghost<br><br></code></pre></td></tr></table></figure><p>现在访问<a href="http://localhost:8880/%E5%B0%B1%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0ghost%E5%8D%9A%E5%AE%A2%E7%9A%84%E7%95%8C%E9%9D%A2%E4%BA%86%E3%80%82">http://localhost:8880/就可以看到ghost博客的界面了。</a></p><h2 id="Pause容器解析"><a href="#Pause容器解析" class="headerlink" title="Pause容器解析"></a>Pause容器解析</h2><p>pause容器将内部的80端口映射到宿主机的8880端口，pause容器在宿主机上设置好了网络namespace后，nginx容器加入到该网络namespace中，我们看到nginx容器启动的时候指定了–net=container:pause，ghost容器同样加入到了该网络namespace中，这样三个容器就共享了网络，互相之间就可以使用localhost直接通信，–ipc=contianer:pause –pid=container:pause就是三个容器处于同一个namespace中，init进程为pause，这时我们进入到ghost容器中查看进程情况。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># ps aux</span><br><span class="hljs-attribute">USER</span>       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND<br><span class="hljs-attribute">root</span>         <span class="hljs-number">1</span>  <span class="hljs-number">0</span>.<span class="hljs-number">0</span>  <span class="hljs-number">0</span>.<span class="hljs-number">0</span>   <span class="hljs-number">1024</span>     <span class="hljs-number">4</span> ?        Ss   <span class="hljs-number">13</span>:<span class="hljs-number">49</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> /pause<br><span class="hljs-attribute">root</span>         <span class="hljs-number">5</span>  <span class="hljs-number">0</span>.<span class="hljs-number">0</span>  <span class="hljs-number">0</span>.<span class="hljs-number">1</span>  <span class="hljs-number">32432</span>  <span class="hljs-number">5736</span> ?        Ss   <span class="hljs-number">13</span>:<span class="hljs-number">51</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> nginx: master p<br><span class="hljs-attribute">systemd</span>+     <span class="hljs-number">9</span>  <span class="hljs-number">0</span>.<span class="hljs-number">0</span>  <span class="hljs-number">0</span>.<span class="hljs-number">0</span>  <span class="hljs-number">32980</span>  <span class="hljs-number">3304</span> ?        S    <span class="hljs-number">13</span>:<span class="hljs-number">51</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> nginx: worker p<br><span class="hljs-attribute">node</span>        <span class="hljs-number">10</span>  <span class="hljs-number">0</span>.<span class="hljs-number">3</span>  <span class="hljs-number">2</span>.<span class="hljs-number">0</span> <span class="hljs-number">1254200</span> <span class="hljs-number">83788</span> ?       Ssl  <span class="hljs-number">13</span>:<span class="hljs-number">53</span>   <span class="hljs-number">0</span>:<span class="hljs-number">03</span> node current/in<br><span class="hljs-attribute">root</span>        <span class="hljs-number">79</span>  <span class="hljs-number">0</span>.<span class="hljs-number">1</span>  <span class="hljs-number">0</span>.<span class="hljs-number">0</span>   <span class="hljs-number">4336</span>   <span class="hljs-number">812</span> pts/<span class="hljs-number">0</span>    Ss   <span class="hljs-number">14</span>:<span class="hljs-number">09</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> sh<br><span class="hljs-attribute">root</span>        <span class="hljs-number">87</span>  <span class="hljs-number">0</span>.<span class="hljs-number">0</span>  <span class="hljs-number">0</span>.<span class="hljs-number">0</span>  <span class="hljs-number">17500</span>  <span class="hljs-number">2080</span> pts/<span class="hljs-number">0</span>    R+   <span class="hljs-number">14</span>:<span class="hljs-number">10</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> ps aux<br></code></pre></td></tr></table></figure><p>在ghost容器中同时可以看到pause和nginx容器的进程，并且pause容器的PID是1。而在kubernetes中容器的PID=1的进程即为容器本身的业务进程。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://o-my-chenjian.com/2017/10/17/The-Pause-Container-Of-Kubernetes/">Kubernetes只Pause容器</a></p><p><a href="https://jimmysong.io/posts/what-is-a-pause-container/">kubernetes中的infra容器——Pause容器探究</a></p>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>crontab、anacron、logrotate relationship</title>
    <link href="/2018/05/24/crontab%E5%92%8Canacron%E5%92%8Clogrotate-relation/"/>
    <url>/2018/05/24/crontab%E5%92%8Canacron%E5%92%8Clogrotate-relation/</url>
    
    <content type="html"><![CDATA[<p>服务器上的nginx使用logrotate来分割日志，设置为每天分割。但是logrotate似乎没有工作，日志并没有分割。服务器是CentOS 6。</p><p>为了找到原因，分析可能出错的地方。<br>如果是logrotate未执行，可能是crond没有启动，因为logrotate被/etc/cron.daily/logrotate脚本所启动，可以查看其中代码：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@test ~]<span class="hljs-comment"># cat /etc/cron.daily/logrotate</span><br><span class="hljs-comment">#!/bin/sh</span><br><br><span class="hljs-regexp">/usr/</span>sbin<span class="hljs-regexp">/logrotate /</span>etc/logrotate.conf<br>EXITVALUE=$?<br><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$EXITVALUE</span> != <span class="hljs-number">0</span> ]; then<br>    <span class="hljs-regexp">/usr/</span>bin/logger -t logrotate <span class="hljs-string">&quot;ALERT exited abnormally with [$EXITVALUE]&quot;</span><br>fi<br><span class="hljs-keyword">exit</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>可以看到logrotate运行时加载配置文件logrotate.conf，而这个配置文件除了设定一些分割日志相关的选项，还包含分割日志的配置文件目录/etc/logrotate.d。</p><p>nginx的日志分割配置文件就保存在logrotate.d目录：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@test ~]<span class="hljs-comment"># cat !$</span><br>cat <span class="hljs-regexp">/etc/</span>logrotate.d/nginx<br><span class="hljs-regexp">/root/</span>*.log &#123;<br>    Daily<br>    Missingok<br>    rotate <span class="hljs-number">52</span><br>    compress<br>    delaycompress<br>    notifempty<br>    dateext<br>    create <span class="hljs-number">644</span> nobody nobody<br>    sharedscripts<br>    postrotate<br>    [ -f <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/nginx/</span>logs<span class="hljs-regexp">/nginx.pid ] &amp;&amp; kill -USR1 `cat /u</span>sr<span class="hljs-regexp">/local/</span>nginx<span class="hljs-regexp">/logs/</span>nginx.pid`<br>    endscript<br>&#125;<br></code></pre></td></tr></table></figure><p>/root/*.log就是需要被分割的日志的目录，通配符*表示目录内的所有log文件都被分割，分割的规则就是{…}中的内容。这里把/root/*.log当做nginx日志只是为了测试。<br>在启动crond服务后，发现日志还是没有分割，于是想到会不会是/etc/logrotate.d/nginx配置文件的语法有问题，使用以下命令调试这个文件：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">logrotate -vfd <span class="hljs-regexp">/etc/</span>logrotate.d/nginx  <span class="hljs-comment"># -vfd 三个选项分别表示显示详情，强制分割日志，只是调试配置文件而不是真的分割日志</span><br></code></pre></td></tr></table></figure><p>输出结果表明有语法错误，Daily，Missingok 都应该是小写。改成daily，missingok。再次调试配置文件，可以正确分割日志：</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs subunit">[root@test ~]# ls <span class="hljs-string">-1</span> /root/<br>install<span class="hljs-string">-2017</span><span class="hljs-string">-5</span><span class="hljs-string">-14</span>.log<br>install<span class="hljs-string">-2017</span><span class="hljs-string">-5</span><span class="hljs-string">-14</span>.log<span class="hljs-string">-20170521</span>  #logrotate归档的日志<br></code></pre></td></tr></table></figure><p>上面猜测是crond执行/etc/cron.daily/内的脚本，实现定时执行计划任务，包括执行logrotate日志分割。<br>为了验证是否正确，网上搜索一番后找到了答案。如果没有crontab命令，先安装：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs csharp">yum install crontabs  <span class="hljs-meta">#安装crond，crond实际上来自cronie包，这个包作为crontabs包的依赖被安装</span><br>chkconfig --<span class="hljs-keyword">add</span> crond <span class="hljs-meta">#添加到开机启动列表</span><br>chkconfig crond <span class="hljs-keyword">on</span>    <span class="hljs-meta">#开机启动crond服务</span><br>/etc/<span class="hljs-keyword">init</span>.d/crond     <span class="hljs-meta">#立即启动crond</span><br><br></code></pre></td></tr></table></figure><span id="more"></span><p>以下文件或目录的作用：<br>cron计划任务有两种类型：</p><ul><li>1）系统cron任务：由crond服务执行，/etc/crontab配置系统级别的任务</li><li>2）用户cron任务：由crond服务执行，用crontab命令编辑用户级别的任务</li></ul><p><font color=#DC143C size=3>属于系统cron任务的文件或目录：</font></p><ul><li>/etc/cron.d             #系统的任务脚本。执行 rpm -ql cronie 可以看到该目录被cronie包安装</li><li>/etc/cron.hourly     #每小时执行其内脚本。其中的0anacron文件调用anacron来执行任务，它被包cronie-anacron安装</li><li>/etc/cron.daily        #每天执行其内脚本。也被anacron执行其内脚本，logrotate调用脚本就在该目录内</li><li>/etc/cron.weekly     #每周执行其内脚本。</li><li>/etc/cron.monthly   #每月执行其内脚本。</li></ul><p><font color=#DC143C size=3>控制用户cron任务的执行：</font></p><ul><li>/etc/cron.allow   #默认不存在，如果这个文件存在，只有用户在这个文件中才能使用crontab命令</li><li>/etc/cron.deny    #将不可以使用crontab命令的用户写入其中</li></ul><p>注意：cron.allow和cron.deny就是用户名的列表，每行一个用户名。比如 cron.deny中有一行jason，效果是如果当前登录用户是jason，执行 crontab -e会提示不允许使用crontab命令。</p><p>以下三个目录的作用：</p><p>/var/spool/cron/USER_NAME<br>#这个文件才是跟crontab -e/-l 关联的，这个文件保存了crontab -e编辑的任务内容<br>#比如执行 crontab -u root -e，编辑保存后，就会有/var/spool/cron/root 这个文件</p><p>/var/spool/anacron/{cron.daily,cron.monthly,cron.weekly}<br>#这三个文件记录了anacron上一次执行的时间（上一天，上一周或上一月）<br>#anacron任务执行时，对照这里的时间，决定是否执行anacron任务</p><p>/var/lib/logrotate.status<br>#这个文件记录logrotate执行情况，logrotate参考这个文件来决定是否需要rotate日志</p><p>crontab和anacron和logrotate的关系：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@test ~]# cat <span class="hljs-regexp">/etc/</span>cron.d<span class="hljs-regexp">/0hourly     #这个文件指定每小时的01分执行/</span>etc/cron.hourly内的所有脚本<br>SHELL=<span class="hljs-regexp">/bin/</span>bash<br>PATH=<span class="hljs-regexp">/sbin:/</span>bin:<span class="hljs-regexp">/usr/</span>sbin:<span class="hljs-regexp">/usr/</span>bin<br>MAILTO=root<br>HOME=/<br><span class="hljs-number">01</span> * * * * root run-parts <span class="hljs-regexp">/etc/</span>cron.hourly  #这里的root指定执行任务的用户，run-parts其实是一个可执行脚本，在<span class="hljs-regexp">/usr/</span>bin/run-parts，用来执行cron.hourly目录内的所有脚本<br><br></code></pre></td></tr></table></figure><p>说明：用crontab -e命令每次编辑完某个用户的cron设置后，cron自动在/var/spool/cron下生成一个与此用户同名的文件，此用户的cron信息都记录在这个文件中。cron启动后每过一份钟读一次这个文件，检查是否要执行里面的命令。因此此文件修改后不需要重新启动cron服务。cron服务每分钟不仅要读一次/var/spool/cron内的所有文件，还需要读一次/etc/crontab，因此我们配置这个文件也能运用cron服务做一些事情。用crontab命令配置是针对某个用户的，而编辑/etc/crontab是针对系统的任务。此文件的文件格式是：</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs elixir">SHELL=<span class="hljs-regexp">/bin/bash</span><br>PATH=<span class="hljs-regexp">/sbin:/bin</span><span class="hljs-symbol">:/usr/sbin</span><span class="hljs-symbol">:/usr/bin</span>     <span class="hljs-comment">#可执行文件查找路径</span><br>MAILTO=root      <span class="hljs-comment">#如果出现错误，或者有数据输出，数据作为邮件发给这个帐号</span><br>HOME=<span class="hljs-regexp">/           #使用者运行的路径，这里是根目录</span><br></code></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@test ~]<span class="hljs-comment"># cat /etc/cron.hourly/0anacron   #cron.hourly目录下的脚本，根据条件执行anacron命令</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment"># Skip excecution unless the date has changed from the previous run</span><br><span class="hljs-keyword">if</span> test -r <span class="hljs-regexp">/var/</span>spool<span class="hljs-regexp">/anacron/</span>cron.daily; then<br>    day=`cat <span class="hljs-regexp">/var/</span>spool<span class="hljs-regexp">/anacron/</span>cron.daily`<br>fi<br><span class="hljs-keyword">if</span> [ `date +%Y%m%d` = <span class="hljs-string">&quot;$day&quot;</span> ]; then<br>    <span class="hljs-keyword">exit</span> <span class="hljs-number">0</span>;<br>fi<br><br><span class="hljs-comment"># Skip excecution unless AC powered</span><br><span class="hljs-keyword">if</span> test -x <span class="hljs-regexp">/usr/</span>bin/on_ac_power; then<br>    <span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/on_ac_power &amp;&gt; /</span>dev/null<br>    <span class="hljs-keyword">if</span> test $? -eq <span class="hljs-number">1</span>; then<br>    <span class="hljs-keyword">exit</span> <span class="hljs-number">0</span><br>    fi<br>fi<br><span class="hljs-regexp">/usr/</span>sbin/anacron -s<br></code></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@test ~]<span class="hljs-comment"># cat /etc/anacrontab   #如果执行anacron命令，那么接着查看anacron的配置文件</span><br><span class="hljs-comment"># /etc/anacrontab: configuration file for anacron</span><br><br><span class="hljs-comment"># See anacron(8) and anacrontab(5) for details.</span><br><br>SHELL=<span class="hljs-regexp">/bin/</span>sh<br>PATH=<span class="hljs-regexp">/sbin:/</span>bin:<span class="hljs-regexp">/usr/</span>sbin:<span class="hljs-regexp">/usr/</span>bin<br>MAILTO=root<br><span class="hljs-comment"># the maximal random delay added to the base delay of the jobs</span><br>RANDOM_DELAY=<span class="hljs-number">45</span>     <span class="hljs-comment">#最大延迟时间</span><br><span class="hljs-comment"># the jobs will be started during the following hours only</span><br>START_HOURS_RANGE=<span class="hljs-number">3</span>-<span class="hljs-number">22</span>     <span class="hljs-comment">#只有在3-22点之间执行任务</span><br><br><span class="hljs-comment">#period in days   delay in minutes   job-identifier   command</span><br><span class="hljs-number">1</span>    <span class="hljs-number">5</span>    cron.daily        nice run-parts <span class="hljs-regexp">/etc/</span>cron.daily<br><span class="hljs-number">7</span>    <span class="hljs-number">25</span>    cron.weekly        nice run-parts <span class="hljs-regexp">/etc/</span>cron.weekly<br>@monthly <span class="hljs-number">45</span>    cron.monthly        nice run-parts <span class="hljs-regexp">/etc/</span>cron.monthly<br></code></pre></td></tr></table></figure><p>以上anacrontab配置文件最重要的是最后一部分，以这行为例：</p><p>1    5    cron.daily        nice run-parts /etc/cron.daily</p><p>表示每天都执行/etc/cront.daily/目录下的脚本文件，真实的延迟是RANDOM_DELAY+delay。这里的延迟是5分钟，加上上面的RANDOM_DELAY，所以实际的延迟时间是5-50之间，开始时间为03-22点，如果机器没关，那么一般就是在03:05-03:50之间执行。<font color=#DC143C size=3>nice命令将该进程设置为nice=10，默认为0，即低优先级进程。</font>如果RANDOM_DELAY=0，那么表示准确延迟5min，即03:05执行cron.daily内的脚本。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@test ~]<span class="hljs-comment"># cat /etc/cron.daily/logrotate  #最后在cron.daily内有logrotate的调用脚本</span><br><span class="hljs-comment">#!/bin/sh</span><br><br><span class="hljs-regexp">/usr/</span>sbin<span class="hljs-regexp">/logrotate /</span>etc<span class="hljs-regexp">/logrotate.conf       #logrotate将会读取配置文件，最终会读取到/</span>etc<span class="hljs-regexp">/logrotate.d/</span>nginx<br>EXITVALUE=$?<br><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$EXITVALUE</span> != <span class="hljs-number">0</span> ]; then<br>    <span class="hljs-regexp">/usr/</span>bin/logger -t logrotate <span class="hljs-string">&quot;ALERT exited abnormally with [$EXITVALUE]&quot;</span><br>fi<br><span class="hljs-keyword">exit</span> <span class="hljs-number">0</span><br><br></code></pre></td></tr></table></figure><p>当logrotate命令加载了/etc/logrotate.d/nginx配置文件时，还要比较nginx日志的归档日期：</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs subunit">[root@test ~]# cat /var/lib/logrotate.status | grep /root<br>&quot;/root/install<span class="hljs-string">-2017</span><span class="hljs-string">-5</span><span class="hljs-string">-14</span>.log&quot; 2017<span class="hljs-string">-5</span><span class="hljs-string">-21</span>   #如果今天是2017<span class="hljs-string">-5</span><span class="hljs-string">-21</span>，这个文件里也是2017<span class="hljs-string">-5</span><span class="hljs-string">-21</span>，说明今天已经归档过了，否则就会归档（分割）nginx日志<br></code></pre></td></tr></table></figure><p>综上，整个逻辑流程为：</p><p>crond服务加载/etc/cron.d/0hourly —&gt;在每小时的01分执行/etc/cront.hourly/0anacron —&gt;执行anacron —&gt;根据/etc/anacrontab的配置执行/etc/cron.daily，/etc/cron.weekly，/etc/cron.monthly —&gt;执行/etc/cron.daily/下的logrotate脚本 —&gt;执行logrotate —&gt;根据/etc/logrotate.conf配置执行脚本/etc/logrotate.d/nginx —&gt;分割nginx日志成功</p>]]></content>
    
    
    <categories>
      
      <category>logrotate</category>
      
    </categories>
    
    
    <tags>
      
      <tag>logrotate</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ELK Sentinl</title>
    <link href="/2018/05/21/ELK-Sentinl/"/>
    <url>/2018/05/21/ELK-Sentinl/</url>
    
    <content type="html"><![CDATA[<h3 id="Sentinl简介"><a href="#Sentinl简介" class="headerlink" title="Sentinl简介"></a>Sentinl简介</h3><p>Sentinl 5扩展自Kibi / Kibana 5，具有警报和报告功能，可使用标准查询，可编程验证器和各种可配置操作来监控，通知和报告数据系列更改 - 将其视为一个独立的“观察者” “报告”功能（PNG / PDFs快照）。</p><p>SENTINEL还旨在通过直接在Kibana UI中整合来简化在Kibi / Kibana中创建和管理警报和报告的过程。</p><h3 id="功能模块"><a href="#功能模块" class="headerlink" title="功能模块"></a>功能模块</h3><p>Watchers<br>Alarms<br>Reports<br>Watchers是Sentinl核心，主要由 input,Condition,Transform,Actions几大块组成，可以和X-Pack一一对应，部分文档可参考X-Pack，但需要注意的是它和X-Pack还有一些区别，主要体现在input只实现了search，其他并未实现，Actions也并未都实现</p><h3 id="安装与配置"><a href="#安装与配置" class="headerlink" title="安装与配置"></a>安装与配置</h3><ul><li>安装</li></ul><p>/usr/share/kibana/bin/kibana-plugin install <a href="https://github.com/sirensolutions/sentinl/releases/download/tag-5.5/sentinl-v5.6.5.zip">https://github.com/sirensolutions/sentinl/releases/download/tag-5.5/sentinl-v5.6.5.zip</a></p><ul><li>config</li></ul><p>kibana.yml config:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">sentinl:</span><br>  <span class="hljs-attr">es:</span><br>    <span class="hljs-attr">timefield:</span> <span class="hljs-string">&#x27;@timestamp&#x27;</span><br>    <span class="hljs-attr">default_index:</span> <span class="hljs-string">watcher</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">watch</span><br>    <span class="hljs-attr">alarm_index:</span> <span class="hljs-string">watcher_alarms</span><br>  <span class="hljs-attr">sentinl:</span><br>    <span class="hljs-attr">history:</span> <span class="hljs-number">20</span><br>    <span class="hljs-attr">results:</span> <span class="hljs-number">50</span><br>  <span class="hljs-attr">settings:</span><br>    <span class="hljs-attr">email:</span><br>      <span class="hljs-attr">active:</span> <span class="hljs-literal">false</span><br>      <span class="hljs-attr">user:</span> <span class="hljs-string">username</span><br>      <span class="hljs-attr">password:</span> <span class="hljs-string">password</span><br>      <span class="hljs-attr">host:</span> <span class="hljs-string">smtp.server.com</span><br>      <span class="hljs-attr">ssl:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">timeout:</span> <span class="hljs-number">10000</span>  <span class="hljs-comment"># mail server connection timeout</span><br>    <span class="hljs-attr">slack:</span><br>      <span class="hljs-attr">active:</span> <span class="hljs-literal">false</span><br>      <span class="hljs-attr">username:</span> <span class="hljs-string">username</span><br>      <span class="hljs-attr">hook:</span> <span class="hljs-string">&#x27;https://hooks.slack.com/services/&lt;token&gt;&#x27;</span><br>      <span class="hljs-attr">channel:</span> <span class="hljs-string">&#x27;#channel&#x27;</span><br>    <span class="hljs-attr">report:</span><br>      <span class="hljs-attr">active:</span> <span class="hljs-literal">false</span><br>      <span class="hljs-attr">tmp_path:</span> <span class="hljs-string">/tmp/</span><br>    <span class="hljs-attr">pushapps:</span><br>      <span class="hljs-attr">active:</span> <span class="hljs-literal">false</span><br>      <span class="hljs-attr">api_key:</span> <span class="hljs-string">&#x27;&lt;pushapps API Key&gt;&#x27;</span><br></code></pre></td></tr></table></figure><ul><li>raw</li></ul><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-string">&quot;input&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;search&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;request&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;index&quot;</span>: [<br>            <span class="hljs-string">&quot;&lt;xxx-&#123;now/d&#125;&gt;&quot;</span><br>          ],<br>          <span class="hljs-string">&quot;body&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;bool&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;should&quot;</span>: [<br>                  &#123;<br>                    <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>                      <span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;502&quot;</span><br>                    &#125;<br>                  &#125;,<br>                  &#123;<br>                    <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>                      <span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;404&quot;</span><br>                    &#125;<br>                  &#125;<br>                ],<br>                <span class="hljs-string">&quot;minimum_should_match&quot;</span>: <span class="hljs-number">1</span>,  <span class="hljs-comment">#must setup</span><br>                <span class="hljs-string">&quot;filter&quot;</span>: &#123;<br>                  <span class="hljs-string">&quot;range&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;@timestamp&quot;</span>: &#123;<br>                      <span class="hljs-string">&quot;gte&quot;</span>: <span class="hljs-string">&quot;now-60s&quot;</span>,<br>                      <span class="hljs-string">&quot;lte&quot;</span>: <span class="hljs-string">&quot;now&quot;</span><br>                    &#125;<br>                  &#125;<br>                &#125;<br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;,<br>    <span class="hljs-string">&quot;condition&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;script&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;script&quot;</span>: <span class="hljs-string">&quot;payload.hits.total &gt; 30&quot;</span><br>      &#125;<br>    &#125;,<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ELK</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ELK</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ES内置账号密码修改、自定义角色自定义账号、ldap及AD认证</title>
    <link href="/2018/05/07/es/"/>
    <url>/2018/05/07/es/</url>
    
    <content type="html"><![CDATA[<h2 id="自定义内置账号"><a href="#自定义内置账号" class="headerlink" title="自定义内置账号"></a>自定义内置账号</h2><ul><li>账户elastic为elasticsearch超级管理员，拥有所有权限</li><li>账户kibana用于kibana组件获取相关信息用于web展示</li><li>账户logstash_system用于logstash服务获取elasticsearch的监控数据</li><li>注意：此步骤需先启动elasticsearch服务</li></ul><p><img src="https://cos.leiyawu.com/img/elk/es_user.png" alt="es_user"></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">[elasticsearch@elasticsearch elasticsearch<span class="hljs-number">-6.0</span><span class="hljs-number">.0</span>]$ ./bin/x-pack/setup-passwords interactive<br>Initiating the setup <span class="hljs-keyword">of</span> reserved <span class="hljs-keyword">user</span> elastic,kibana,logstash_system passwords.<br>You will be prompted <span class="hljs-keyword">to</span> enter passwords <span class="hljs-keyword">as</span> the process progresses.<br>Please confirm that you would <span class="hljs-keyword">like</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">continue</span> [y/N]y<br><br><br>Enter <span class="hljs-keyword">password</span> <span class="hljs-keyword">for</span> [elastic]: <br>Reenter <span class="hljs-keyword">password</span> <span class="hljs-keyword">for</span> [elastic]: <br>Enter <span class="hljs-keyword">password</span> <span class="hljs-keyword">for</span> [kibana]: <br>Reenter <span class="hljs-keyword">password</span> <span class="hljs-keyword">for</span> [kibana]: <br>Enter <span class="hljs-keyword">password</span> <span class="hljs-keyword">for</span> [logstash_system]: <br>Reenter <span class="hljs-keyword">password</span> <span class="hljs-keyword">for</span> [logstash_system]: <br>Changed <span class="hljs-keyword">password</span> <span class="hljs-keyword">for</span> <span class="hljs-keyword">user</span> [kibana]<br>Changed <span class="hljs-keyword">password</span> <span class="hljs-keyword">for</span> <span class="hljs-keyword">user</span> [logstash_system]<br>Changed <span class="hljs-keyword">password</span> <span class="hljs-keyword">for</span> <span class="hljs-keyword">user</span> [elastic]<br>[elasticsearch@elasticsearch elasticsearch<span class="hljs-number">-6.0</span><span class="hljs-number">.0</span>]$ <br></code></pre></td></tr></table></figure><h2 id="验证内置账户访问"><a href="#验证内置账户访问" class="headerlink" title="验证内置账户访问"></a>验证内置账户访问</h2><ul><li>若不提供用户名密码则返回401</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs swift">[elasticsearch<span class="hljs-meta">@elasticsearch</span> elasticsearch<span class="hljs-operator">-</span><span class="hljs-number">6.0</span>.<span class="hljs-number">0</span>]$ curl &#x27;http:<span class="hljs-comment">//10.59.30.96:9200/_cat/indices?pretty&#x27;</span><br>&#123;<br>  <span class="hljs-string">&quot;error&quot;</span> : &#123;<br>    <span class="hljs-string">&quot;root_cause&quot;</span> : [<br>      &#123;<br>        <span class="hljs-string">&quot;type&quot;</span> : <span class="hljs-string">&quot;security_exception&quot;</span>,<br>        <span class="hljs-string">&quot;reason&quot;</span> : <span class="hljs-string">&quot;missing authentication token for REST request [/_cat/indices?pretty]&quot;</span>,<br>        <span class="hljs-string">&quot;header&quot;</span> : &#123;<br>          <span class="hljs-string">&quot;WWW-Authenticate&quot;</span> : <span class="hljs-string">&quot;Basic realm=<span class="hljs-subst">\&quot;</span>security<span class="hljs-subst">\&quot;</span> charset=<span class="hljs-subst">\&quot;</span>UTF-8<span class="hljs-subst">\&quot;</span>&quot;</span><br>        &#125;<br>      &#125;<br>    ],<br>    <span class="hljs-string">&quot;type&quot;</span> : <span class="hljs-string">&quot;security_exception&quot;</span>,<br>    <span class="hljs-string">&quot;reason&quot;</span> : <span class="hljs-string">&quot;missing authentication token for REST request [/_cat/indices?pretty]&quot;</span>,<br>    <span class="hljs-string">&quot;header&quot;</span> : &#123;<br>      <span class="hljs-string">&quot;WWW-Authenticate&quot;</span> : <span class="hljs-string">&quot;Basic realm=<span class="hljs-subst">\&quot;</span>security<span class="hljs-subst">\&quot;</span> charset=<span class="hljs-subst">\&quot;</span>UTF-8<span class="hljs-subst">\&quot;</span>&quot;</span><br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;status&quot;</span> : <span class="hljs-number">401</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p>提供相应用户信息后可访问，若用户权限不足则返回403</p><p>使用logstash_system用户访问</p></li></ul><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs ada">[elasticsearch@elasticsearch elasticsearch-<span class="hljs-number">6.0</span>.<span class="hljs-number">0</span>]$ curl <span class="hljs-symbol">&#x27;http</span>://<span class="hljs-number">10.59</span>.<span class="hljs-number">30.96</span>:<span class="hljs-number">9200</span>/_cat/indices?pretty&#x27; -u logstash_system:logstash_system<br>&#123;<br>  <span class="hljs-string">&quot;error&quot;</span> : &#123;<br>    <span class="hljs-string">&quot;root_cause&quot;</span> : [<br>      &#123;<br>        <span class="hljs-string">&quot;type&quot;</span> : &quot;<span class="hljs-type">security_exception</span><span class="hljs-string">&quot;,</span><br><span class="hljs-string">        &quot;</span>reason<span class="hljs-string">&quot; : &quot;</span>action [indices:monitor/stats] <span class="hljs-keyword">is</span> unauthorized <span class="hljs-keyword">for</span> user [logstash_system]<span class="hljs-string">&quot;</span><br><span class="hljs-string">      &#125;</span><br><span class="hljs-string">    ],</span><br><span class="hljs-string">    &quot;</span><span class="hljs-keyword">type</span><span class="hljs-string">&quot; : &quot;</span>security_exception<span class="hljs-string">&quot;,</span><br><span class="hljs-string">    &quot;</span>reason<span class="hljs-string">&quot; : &quot;</span>action [indices:monitor/stats] <span class="hljs-keyword">is</span> unauthorized <span class="hljs-keyword">for</span> user [logstash_system]<span class="hljs-string">&quot;</span><br><span class="hljs-string">  &#125;,</span><br><span class="hljs-string">  &quot;</span>status<span class="hljs-string">&quot; : 403</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">[elasticsearch@elasticsearch elasticsearch-6.0.0]$</span><br></code></pre></td></tr></table></figure><ul><li>使用kibana用户访问</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs swift">[elasticsearch<span class="hljs-meta">@elasticsearch</span> elasticsearch<span class="hljs-operator">-</span><span class="hljs-number">6.0</span>.<span class="hljs-number">0</span>]$ curl &#x27;http:<span class="hljs-comment">//10.59.30.96:9200/_cat/indices?pretty&#x27; -u kibana:kibana</span><br>yellow <span class="hljs-keyword">open</span> .monitoring<span class="hljs-operator">-</span>es<span class="hljs-operator">-</span><span class="hljs-number">6</span><span class="hljs-operator">-</span><span class="hljs-number">2018.01</span>.<span class="hljs-number">10</span>   nND6<span class="hljs-operator">-</span>i_rR5iLEYVccBGj8w <span class="hljs-number">1</span> <span class="hljs-number">1</span>    <br>yellow <span class="hljs-keyword">open</span> .triggered_watches            <span class="hljs-type">BtygGZisSDqiL3Y2TaQGqQ</span> <span class="hljs-number">1</span> <span class="hljs-number">1</span>    <br>green  <span class="hljs-keyword">open</span> .security<span class="hljs-operator">-</span><span class="hljs-number">6</span>                   <span class="hljs-type">QVRL1mcFSAilryHGEhen7Q</span> <span class="hljs-number">1</span> <span class="hljs-number">0</span>    <br>yellow <span class="hljs-keyword">open</span> .watcher<span class="hljs-operator">-</span>history<span class="hljs-operator">-</span><span class="hljs-number">6</span><span class="hljs-operator">-</span><span class="hljs-number">2018.01</span>.<span class="hljs-number">10</span> <span class="hljs-type">SBGiHDAnTPiXFoHU65VY_g</span> <span class="hljs-number">1</span> <span class="hljs-number">1</span>    <br>yellow <span class="hljs-keyword">open</span> .watches                      kMzN4j5cQySZQQSDVPww8w <span class="hljs-number">1</span> <span class="hljs-number">1</span>    <br>yellow <span class="hljs-keyword">open</span> .monitoring<span class="hljs-operator">-</span>alerts<span class="hljs-operator">-</span><span class="hljs-number">6</span>          <span class="hljs-type">VygY6VN9R3S0PR_jrGy50Q</span> <span class="hljs-number">1</span> <span class="hljs-number">1</span>    <br>[elasticsearch<span class="hljs-meta">@elasticsearch</span> elasticsearch<span class="hljs-operator">-</span><span class="hljs-number">6.0</span>.<span class="hljs-number">0</span>]$ <br></code></pre></td></tr></table></figure><span id="more"></span><h2 id="添加自定义角色"><a href="#添加自定义角色" class="headerlink" title="添加自定义角色"></a>添加自定义角色</h2><ul><li><p>添加角色接口为 POST /_xpack/security/role/<rolename></p><p>下述示例为添加超级管理员角色的方法</p></li></ul><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs ada">[elasticsearch@elasticsearch elasticsearch-<span class="hljs-number">6.0</span>.<span class="hljs-number">0</span>]$ curl -XPOST -H <span class="hljs-symbol">&#x27;Content</span>-<span class="hljs-keyword">type</span>: application/json&#x27; -u elastic:elastic <span class="hljs-symbol">&#x27;http</span>://<span class="hljs-number">10.59</span>.<span class="hljs-number">30.96</span>:<span class="hljs-number">9200</span>/_xpack/security/role/admin?pretty&#x27; -d &#x27;&#123;<br>&gt;   <span class="hljs-string">&quot;run_as&quot;</span>: [ <span class="hljs-string">&quot;elastic&quot;</span> ],<br>&gt;   <span class="hljs-string">&quot;cluster&quot;</span>: [ <span class="hljs-string">&quot;all&quot;</span> ],<br>&gt;   <span class="hljs-string">&quot;indices&quot;</span>: [<br>&gt;     &#123;<br>&gt;       <span class="hljs-string">&quot;names&quot;</span>: [ <span class="hljs-string">&quot;*&quot;</span> ],<br>&gt;       <span class="hljs-string">&quot;privileges&quot;</span>: [ <span class="hljs-string">&quot;all&quot;</span> ]<br>&gt;     &#125;<br>&gt;   ]<br>&gt; &#125;&#x27;<br>&#123;<br>  <span class="hljs-string">&quot;role&quot;</span> : &#123;<br>    <span class="hljs-string">&quot;created&quot;</span> : <span class="hljs-type">true</span><br>  &#125;<br>&#125;<br>[elasticsearch@elasticsearch elasticsearch-<span class="hljs-number">6.0</span>.<span class="hljs-number">0</span>]$ curl -XGET -H <span class="hljs-symbol">&#x27;Content</span>-<span class="hljs-keyword">type</span>: application/json&#x27; -u elastic:elastic <span class="hljs-symbol">&#x27;http</span>://<span class="hljs-number">10.59</span>.<span class="hljs-number">30.96</span>:<span class="hljs-number">9200</span>/_xpack/security/role/admin?pretty&#x27;<br>&#123;<br>  <span class="hljs-string">&quot;admin&quot;</span> : &#123;<br>    <span class="hljs-string">&quot;cluster&quot;</span> : [<br>      <span class="hljs-string">&quot;all&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;indices&quot;</span> : [<br>      &#123;<br>        <span class="hljs-string">&quot;names&quot;</span> : [<br>          <span class="hljs-string">&quot;*&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;privileges&quot;</span> : [<br>          <span class="hljs-string">&quot;all&quot;</span><br>        ]<br>      &#125;<br>    ],<br>    <span class="hljs-string">&quot;run_as&quot;</span> : [<br>      <span class="hljs-string">&quot;elastic&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;metadata&quot;</span> : &#123; &#125;,<br>    <span class="hljs-string">&quot;transient_metadata&quot;</span> : &#123;<br>      <span class="hljs-string">&quot;enabled&quot;</span> : <span class="hljs-type">true</span><br>    &#125;<br>  &#125;<br>&#125;<br>[elasticsearch@elasticsearch elasticsearch-<span class="hljs-number">6.0</span>.<span class="hljs-number">0</span>]$<br></code></pre></td></tr></table></figure><h2 id="添加自定义账户"><a href="#添加自定义账户" class="headerlink" title="添加自定义账户"></a>添加自定义账户</h2><ul><li><p>添加用户接口为 POST /_xpack/security/user/<username></p><p>下述为添加martin账户并添加至admin角色操作方法</p></li></ul><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs scala">[elasticsearch<span class="hljs-meta">@elasticsearch</span> elasticsearch<span class="hljs-number">-6.0</span><span class="hljs-number">.0</span>]$ curl -<span class="hljs-type">XPOST</span> -<span class="hljs-type">H</span> <span class="hljs-symbol">&#x27;Content</span>-<span class="hljs-class"><span class="hljs-keyword">type</span></span>: application/json&#x27; -u elastic:elastic <span class="hljs-symbol">&#x27;http</span>:<span class="hljs-comment">//10.59.30.96:9200/_xpack/security/user/martin?pretty&#x27; -d &#x27;&#123;</span><br>&gt;   <span class="hljs-string">&quot;password&quot;</span> : <span class="hljs-string">&quot;123456&quot;</span>,<br>&gt;   <span class="hljs-string">&quot;full_name&quot;</span> : <span class="hljs-string">&quot;Martin Lei&quot;</span>,<br>&gt;   <span class="hljs-string">&quot;roles&quot;</span> : [<span class="hljs-string">&quot;admin&quot;</span>],<br>&gt;   <span class="hljs-string">&quot;email&quot;</span> : <span class="hljs-string">&quot;martin@martin.com&quot;</span><br>&gt; &#125;&#x27;<br>&#123;<br>  <span class="hljs-string">&quot;user&quot;</span> : &#123;<br>    <span class="hljs-string">&quot;created&quot;</span> : <span class="hljs-literal">true</span><br>  &#125;<br>&#125;<br>[elasticsearch<span class="hljs-meta">@elasticsearch</span> elasticsearch<span class="hljs-number">-6.0</span><span class="hljs-number">.0</span>]$ curl -<span class="hljs-type">XGET</span> -<span class="hljs-type">H</span> <span class="hljs-symbol">&#x27;Content</span>-<span class="hljs-class"><span class="hljs-keyword">type</span></span>: application/json&#x27; -u elastic:elastic <span class="hljs-symbol">&#x27;http</span>:<span class="hljs-comment">//10.59.30.96:9200/_xpack/security/user/martin?pretty&#x27;</span><br>&#123;<br>  <span class="hljs-string">&quot;rocshen&quot;</span> : &#123;<br>    <span class="hljs-string">&quot;username&quot;</span> : <span class="hljs-string">&quot;martin&quot;</span>,<br>    <span class="hljs-string">&quot;roles&quot;</span> : [<br>      <span class="hljs-string">&quot;admin&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;full_name&quot;</span> : <span class="hljs-string">&quot;Martin Lei&quot;</span>,<br>    <span class="hljs-string">&quot;email&quot;</span> : <span class="hljs-string">&quot;martin@martin.com&quot;</span>,<br>    <span class="hljs-string">&quot;metadata&quot;</span> : &#123; &#125;,<br>    <span class="hljs-string">&quot;enabled&quot;</span> : <span class="hljs-literal">true</span><br>  &#125;<br>&#125;<br>[elasticsearch<span class="hljs-meta">@elasticsearch</span> elasticsearch<span class="hljs-number">-6.0</span><span class="hljs-number">.0</span>]$ curl -<span class="hljs-type">XGET</span> -<span class="hljs-type">H</span> <span class="hljs-symbol">&#x27;Content</span>-<span class="hljs-class"><span class="hljs-keyword">type</span></span>: application/json&#x27; -u martin:<span class="hljs-number">123456</span> <span class="hljs-symbol">&#x27;http</span>:<span class="hljs-comment">//10.59.30.96:9200/_cat/indices?pretty&#x27;</span><br>yellow open .monitoring-es<span class="hljs-number">-6</span><span class="hljs-number">-2018.01</span><span class="hljs-number">.10</span>   nND6-i_rR5iLEYVccBGj8w <span class="hljs-number">1</span> <span class="hljs-number">1</span> <span class="hljs-number">4883</span> <span class="hljs-number">88</span>   <span class="hljs-number">2.5</span>mb   <span class="hljs-number">2.5</span>mb<br>yellow open .triggered_watches            <span class="hljs-type">BtygGZisSDqiL3Y2TaQGqQ</span> <span class="hljs-number">1</span> <span class="hljs-number">1</span>    <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">24.2</span>kb  <span class="hljs-number">24.2</span>kb<br>green  open .security<span class="hljs-number">-6</span>                   <span class="hljs-type">QVRL1mcFSAilryHGEhen7Q</span> <span class="hljs-number">1</span> <span class="hljs-number">0</span>                        <br>yellow open .watcher-history<span class="hljs-number">-6</span><span class="hljs-number">-2018.01</span><span class="hljs-number">.10</span> <span class="hljs-type">SBGiHDAnTPiXFoHU65VY_g</span> <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">630</span>  <span class="hljs-number">0</span> <span class="hljs-number">703.3</span>kb <span class="hljs-number">703.3</span>kb<br>yellow open .watches                      kMzN4j5cQySZQQSDVPww8w <span class="hljs-number">1</span> <span class="hljs-number">1</span>    <span class="hljs-number">5</span>  <span class="hljs-number">0</span>  <span class="hljs-number">33.3</span>kb  <span class="hljs-number">33.3</span>kb<br>yellow open .monitoring-alerts<span class="hljs-number">-6</span>          <span class="hljs-type">VygY6VN9R3S0PR_jrGy50Q</span> <span class="hljs-number">1</span> <span class="hljs-number">1</span>    <span class="hljs-number">1</span>  <span class="hljs-number">0</span>   <span class="hljs-number">6.5</span>kb   <span class="hljs-number">6.5</span>kb<br>[elasticsearch<span class="hljs-meta">@elasticsearch</span> elasticsearch<span class="hljs-number">-6.0</span><span class="hljs-number">.0</span>]$<br><br></code></pre></td></tr></table></figure><h2 id="修改账户密码"><a href="#修改账户密码" class="headerlink" title="修改账户密码"></a>修改账户密码</h2><ol><li>修改密码需使用超级管理员权限即elastic账户，接口为POST _xpack/security/user/<username>/_password</li></ol><p>curl参数含义如下</p><ul><li>-XPOST 使用post方法传递参数</li><li>-H 指定http协议的header信息</li><li>-u 指定用于认证的用户信息用户名与密码使用冒号分隔</li><li>-d 指定具体要传递的参数信息</li></ul><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs scala">[elasticsearch<span class="hljs-meta">@elasticsearch</span> elasticsearch<span class="hljs-number">-6.0</span><span class="hljs-number">.0</span>]$ curl -<span class="hljs-type">XPOST</span> -<span class="hljs-type">H</span> <span class="hljs-symbol">&#x27;Content</span>-<span class="hljs-class"><span class="hljs-keyword">type</span></span>: application/json&#x27; -u elastic:elastic <span class="hljs-symbol">&#x27;http</span>:<span class="hljs-comment">//10.59.30.96:9200/_xpack/security/user/kibana/_password?pretty&#x27; -d &#x27;&#123;&quot;password&quot;: &quot;123456&quot;&#125;&#x27;</span><br>&#123; &#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>密码修改后使用老密码访问则返回401，使用更新后的密码则正常</li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs swift">[elasticsearch<span class="hljs-meta">@elasticsearch</span> elasticsearch<span class="hljs-operator">-</span><span class="hljs-number">6.0</span>.<span class="hljs-number">0</span>]$ curl &#x27;http:<span class="hljs-comment">//10.59.30.96:9200/_cat/indices?pretty&#x27; -u kibana:kibana</span><br>&#123;<br>  <span class="hljs-string">&quot;error&quot;</span> : &#123;<br>    <span class="hljs-string">&quot;root_cause&quot;</span> : [<br>      &#123;<br>        <span class="hljs-string">&quot;type&quot;</span> : <span class="hljs-string">&quot;security_exception&quot;</span>,<br>        <span class="hljs-string">&quot;reason&quot;</span> : <span class="hljs-string">&quot;failed to authenticate user [kibana]&quot;</span>,<br>        <span class="hljs-string">&quot;header&quot;</span> : &#123;<br>          <span class="hljs-string">&quot;WWW-Authenticate&quot;</span> : <span class="hljs-string">&quot;Basic realm=<span class="hljs-subst">\&quot;</span>security<span class="hljs-subst">\&quot;</span> charset=<span class="hljs-subst">\&quot;</span>UTF-8<span class="hljs-subst">\&quot;</span>&quot;</span><br>        &#125;<br>      &#125;<br>    ],<br>    <span class="hljs-string">&quot;type&quot;</span> : <span class="hljs-string">&quot;security_exception&quot;</span>,<br>    <span class="hljs-string">&quot;reason&quot;</span> : <span class="hljs-string">&quot;failed to authenticate user [kibana]&quot;</span>,<br>    <span class="hljs-string">&quot;header&quot;</span> : &#123;<br>      <span class="hljs-string">&quot;WWW-Authenticate&quot;</span> : <span class="hljs-string">&quot;Basic realm=<span class="hljs-subst">\&quot;</span>security<span class="hljs-subst">\&quot;</span> charset=<span class="hljs-subst">\&quot;</span>UTF-8<span class="hljs-subst">\&quot;</span>&quot;</span><br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;status&quot;</span> : <span class="hljs-number">401</span><br>&#125;<br>[elasticsearch<span class="hljs-meta">@elasticsearch</span> elasticsearch<span class="hljs-operator">-</span><span class="hljs-number">6.0</span>.<span class="hljs-number">0</span>]$ curl &#x27;http:<span class="hljs-comment">//10.59.30.96:9200/_cat/indices?pretty&#x27; -u kibana:123456</span><br>yellow <span class="hljs-keyword">open</span> .monitoring<span class="hljs-operator">-</span>es<span class="hljs-operator">-</span><span class="hljs-number">6</span><span class="hljs-operator">-</span><span class="hljs-number">2018.01</span>.<span class="hljs-number">10</span>   nND6<span class="hljs-operator">-</span>i_rR5iLEYVccBGj8w <span class="hljs-number">1</span> <span class="hljs-number">1</span>    <br>yellow <span class="hljs-keyword">open</span> .triggered_watches            <span class="hljs-type">BtygGZisSDqiL3Y2TaQGqQ</span> <span class="hljs-number">1</span> <span class="hljs-number">1</span>    <br>green  <span class="hljs-keyword">open</span> .security<span class="hljs-operator">-</span><span class="hljs-number">6</span>                   <span class="hljs-type">QVRL1mcFSAilryHGEhen7Q</span> <span class="hljs-number">1</span> <span class="hljs-number">0</span>    <br>yellow <span class="hljs-keyword">open</span> .watcher<span class="hljs-operator">-</span>history<span class="hljs-operator">-</span><span class="hljs-number">6</span><span class="hljs-operator">-</span><span class="hljs-number">2018.01</span>.<span class="hljs-number">10</span> <span class="hljs-type">SBGiHDAnTPiXFoHU65VY_g</span> <span class="hljs-number">1</span> <span class="hljs-number">1</span>    <br>yellow <span class="hljs-keyword">open</span> .watches                      kMzN4j5cQySZQQSDVPww8w <span class="hljs-number">1</span> <span class="hljs-number">1</span>    <br>yellow <span class="hljs-keyword">open</span> .monitoring<span class="hljs-operator">-</span>alerts<span class="hljs-operator">-</span><span class="hljs-number">6</span>          <span class="hljs-type">VygY6VN9R3S0PR_jrGy50Q</span> <span class="hljs-number">1</span> <span class="hljs-number">1</span>    <br>[elasticsearch<span class="hljs-meta">@elasticsearch</span> elasticsearch<span class="hljs-operator">-</span><span class="hljs-number">6.0</span>.<span class="hljs-number">0</span>]$ <br></code></pre></td></tr></table></figure><h2 id="配置ldap帐号认证"><a href="#配置ldap帐号认证" class="headerlink" title="配置ldap帐号认证"></a>配置ldap帐号认证</h2><p>ldap服务安装可参考：<a href="https://segmentfault.com/a/11">https://segmentfault.com/a/11</a>…</p><p>添加下述ldap相关述配置 bind_dn为ldap的管理DN</p><ul><li>bind_password为管理dn的密码</li><li>user_search.base_dn为linux系统账户信息导入ldap的信息</li><li>user_search.attribute为账户在ldap中的标识信息</li><li>group_search.base_dn为linux系统组信息导入ldap的信息</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">elasticsearch@elasticsearch</span> <span class="hljs-string">elasticsearch-6.0.0</span>]<span class="hljs-string">$</span> <span class="hljs-string">vim</span> <span class="hljs-string">config/elasticsearch.yml</span> <br><br><span class="hljs-string">......</span><br><br><span class="hljs-attr">network.host:</span> <span class="hljs-number">10.59</span><span class="hljs-number">.30</span><span class="hljs-number">.96</span><br><span class="hljs-attr">bootstrap.system_call_filter:</span> <span class="hljs-literal">false</span><br><br><span class="hljs-attr">xpack.ssl.key:</span> <span class="hljs-string">elasticsearch/elasticsearch.key</span><br><span class="hljs-attr">xpack.ssl.certificate:</span> <span class="hljs-string">elasticsearch/elasticsearch.crt</span><br><span class="hljs-attr">xpack.ssl.certificate_authorities:</span> <span class="hljs-string">ca/ca.crt</span><br><span class="hljs-attr">xpack.security.transport.ssl.enabled:</span> <span class="hljs-literal">true</span><br><br><span class="hljs-attr">xpack:</span><br>  <span class="hljs-attr">security:</span><br>    <span class="hljs-attr">authc:</span><br>      <span class="hljs-attr">realms:</span><br>        <span class="hljs-attr">ldap1:</span><br>          <span class="hljs-attr">type:</span> <span class="hljs-string">ldap</span><br>          <span class="hljs-attr">order:</span> <span class="hljs-number">0</span><br>          <span class="hljs-attr">url:</span> <span class="hljs-string">&quot;ldap://10.59.30.95&quot;</span><br>          <span class="hljs-attr">bind_dn:</span> <span class="hljs-string">&quot;cn=Manager, dc=martin, dc=com&quot;</span><br>          <span class="hljs-attr">bind_password:</span> <span class="hljs-number">123456</span><br>          <span class="hljs-attr">user_search:</span><br>            <span class="hljs-attr">base_dn:</span> <span class="hljs-string">&quot;ou=People,dc=martin,dc=com&quot;</span><br>            <span class="hljs-attr">attribute:</span> <span class="hljs-string">uid</span><br>          <span class="hljs-attr">group_search:</span><br>            <span class="hljs-attr">base_dn:</span> <span class="hljs-string">&quot;ou=Group,dc=martin,dc=com&quot;</span><br>          <span class="hljs-attr">unmapped_groups_as_roles:</span> <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure><h2 id="配置AD域帐号认证"><a href="#配置AD域帐号认证" class="headerlink" title="配置AD域帐号认证"></a>配置AD域帐号认证</h2><p>添加下ldap相关述配置至elasticsearch.yml，此处为接着上述LDAP配置添加，如果只需配置AD认证请将ldap相关配置删除即可；</p><ul><li>domain_name为AD域的域名</li><li>url为AD域的地址</li><li>bind_dnw为随意的域账户名称（格式为user@domain）</li><li>bind_password为上述账户的密码</li></ul><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs less">xpack:<br>  security:<br>    authc:<br>      realms:<br>        ldap1:<br>          type: ldap<br>          <span class="hljs-attribute">order</span>: <span class="hljs-number">0</span><br>          <span class="hljs-attribute">url</span>: <span class="hljs-string">&quot;ldap://10.59.30.94&quot;</span><br>          <span class="hljs-attribute">bind_dn</span>: <span class="hljs-string">&quot;cn=Manager, dc=martin, dc=com&quot;</span><br>          <span class="hljs-attribute">bind_password</span>: <span class="hljs-number">123456</span><br>          <span class="hljs-attribute">user_search</span>:<br>            <span class="hljs-attribute">base_dn</span>: <span class="hljs-string">&quot;ou=People,dc=martin,dc=com&quot;</span><br>            <span class="hljs-attribute">attribute</span>: uid<br>          <span class="hljs-attribute">group_search</span>:<br>            <span class="hljs-attribute">base_dn</span>: <span class="hljs-string">&quot;ou=Group,dc=martin,dc=com&quot;</span><br>          <span class="hljs-attribute">unmapped_groups_as_roles</span>: false<br>        <span class="hljs-attribute">active_directory</span>:<br>          <span class="hljs-attribute">type</span>: active_directory<br>          <span class="hljs-attribute">order</span>: <span class="hljs-number">1</span><br>          <span class="hljs-attribute">domain_name</span>: martin.com<br>          <span class="hljs-attribute">url</span>: <span class="hljs-attribute">ldap</span>:<span class="hljs-comment">//ad.martin.com</span><br>          <span class="hljs-attribute">bind_dn</span>: martin<span class="hljs-variable">@martin</span>.com<br>          <span class="hljs-attribute">bind_password</span>: AD.<span class="hljs-number">123456</span><br></code></pre></td></tr></table></figure><p>重启elasticsearch服务并使用ldap域账户user01登录</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[elasticsearch@elasticsearch elasticsearch-<span class="hljs-number">6.0</span>.<span class="hljs-number">0</span>]$ killall java<br>[elasticsearch@elasticsearch elasticsearch-<span class="hljs-number">6.0</span>.<span class="hljs-number">0</span>]$ .<span class="hljs-regexp">/bin/</span>elasticsearch -d<br>[elasticsearch@elasticsearch elasticsearch-<span class="hljs-number">6.0</span>.<span class="hljs-number">0</span>]$ curl -XGET -u user01:user01 <span class="hljs-string">&#x27;http://10.59.30.96:9200/_cat?pretty&#x27;</span><br>=^.^=<br><span class="hljs-regexp">/_cat/</span>allocation<br><span class="hljs-regexp">/_cat/</span>shards<br><span class="hljs-regexp">/_cat/</span>shards/&#123;index&#125;<br><span class="hljs-regexp">/_cat/m</span>aster<br><span class="hljs-regexp">/_cat/</span>nodes<br><span class="hljs-regexp">/_cat/</span>tasks<br><span class="hljs-regexp">/_cat/i</span>ndices<br><span class="hljs-regexp">/_cat/i</span>ndices/&#123;index&#125;<br><span class="hljs-regexp">/_cat/</span>segments<br><span class="hljs-regexp">/_cat/</span>segments/&#123;index&#125;<br><span class="hljs-regexp">/_cat/</span><span class="hljs-keyword">count</span><br><span class="hljs-regexp">/_cat/</span><span class="hljs-keyword">count</span>/&#123;index&#125;<br><span class="hljs-regexp">/_cat/</span>recovery<br><span class="hljs-regexp">/_cat/</span>recovery/&#123;index&#125;<br><span class="hljs-regexp">/_cat/</span>health<br><span class="hljs-regexp">/_cat/</span>pending_tasks<br><span class="hljs-regexp">/_cat/</span>aliases<br><span class="hljs-regexp">/_cat/</span>aliases/&#123;alias&#125;<br><span class="hljs-regexp">/_cat/</span>thread_pool<br><span class="hljs-regexp">/_cat/</span>thread_pool/&#123;thread_pools&#125;<br><span class="hljs-regexp">/_cat/</span>plugins<br><span class="hljs-regexp">/_cat/</span>fielddata<br><span class="hljs-regexp">/_cat/</span>fielddata/&#123;fields&#125;<br><span class="hljs-regexp">/_cat/</span>nodeattrs<br><span class="hljs-regexp">/_cat/</span><span class="hljs-keyword">repositories</span><br><span class="hljs-regexp">/_cat/</span>snapshots/&#123;repository&#125;<br><span class="hljs-regexp">/_cat/</span>templates<br>[elasticsearch@elasticsearch elasticsearch-<span class="hljs-number">6.0</span>.<span class="hljs-number">0</span>]$<br><br></code></pre></td></tr></table></figure><p>使用AD域账户martin登录</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[elasticsearch@elasticsearch elasticsearch-<span class="hljs-number">6.0</span>.<span class="hljs-number">0</span>]$ curl http:<span class="hljs-comment">//10.59.30.96:9200/_cat?pretty -u martin:AD.123456</span><br>=^.^=<br><span class="hljs-regexp">/_cat/</span>allocation<br><span class="hljs-regexp">/_cat/</span>shards<br><span class="hljs-regexp">/_cat/</span>shards/&#123;index&#125;<br><span class="hljs-regexp">/_cat/m</span>aster<br><span class="hljs-regexp">/_cat/</span>nodes<br><span class="hljs-regexp">/_cat/</span>tasks<br><span class="hljs-regexp">/_cat/i</span>ndices<br><span class="hljs-regexp">/_cat/i</span>ndices/&#123;index&#125;<br><span class="hljs-regexp">/_cat/</span>segments<br><span class="hljs-regexp">/_cat/</span>segments/&#123;index&#125;<br><span class="hljs-regexp">/_cat/</span><span class="hljs-keyword">count</span><br><span class="hljs-regexp">/_cat/</span><span class="hljs-keyword">count</span>/&#123;index&#125;<br><span class="hljs-regexp">/_cat/</span>recovery<br><span class="hljs-regexp">/_cat/</span>recovery/&#123;index&#125;<br><span class="hljs-regexp">/_cat/</span>health<br><span class="hljs-regexp">/_cat/</span>pending_tasks<br><span class="hljs-regexp">/_cat/</span>aliases<br><span class="hljs-regexp">/_cat/</span>aliases/&#123;alias&#125;<br><span class="hljs-regexp">/_cat/</span>thread_pool<br><span class="hljs-regexp">/_cat/</span>thread_pool/&#123;thread_pools&#125;<br><span class="hljs-regexp">/_cat/</span>plugins<br><span class="hljs-regexp">/_cat/</span>fielddata<br><span class="hljs-regexp">/_cat/</span>fielddata/&#123;fields&#125;<br><span class="hljs-regexp">/_cat/</span>nodeattrs<br><span class="hljs-regexp">/_cat/</span><span class="hljs-keyword">repositories</span><br><span class="hljs-regexp">/_cat/</span>snapshots/&#123;repository&#125;<br><span class="hljs-regexp">/_cat/</span>templates<br>[elasticsearch@elasticsearch elasticsearch-<span class="hljs-number">6.0</span>.<span class="hljs-number">0</span>]$<br></code></pre></td></tr></table></figure><h2 id="为域账户信息映射角色"><a href="#为域账户信息映射角色" class="headerlink" title="为域账户信息映射角色"></a>为域账户信息映射角色</h2><p>接口为：POST /_xpack/security/role_mapping/<name></p><p>下述为映射user1*账户为管理员角色的操作步骤</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs scala">[elasticsearch<span class="hljs-meta">@elasticsearch</span> elasticsearch<span class="hljs-number">-6.0</span><span class="hljs-number">.0</span>]$ curl -<span class="hljs-type">XPOST</span> -<span class="hljs-type">H</span> <span class="hljs-symbol">&#x27;Content</span>-<span class="hljs-class"><span class="hljs-keyword">type</span></span>: application/json&#x27; -u elastic:elastic <span class="hljs-symbol">&#x27;http</span>:<span class="hljs-comment">//10.59.30.96:9200/_xpack/security/role_mapping/ldap_user_admin?pretty&#x27; -d &#x27;&#123;</span><br>&gt;   <span class="hljs-string">&quot;roles&quot;</span>: [ <span class="hljs-string">&quot;admin&quot;</span> ],<br>&gt;   <span class="hljs-string">&quot;enabled&quot;</span>: <span class="hljs-literal">true</span>,<br>&gt;   <span class="hljs-string">&quot;rules&quot;</span>: &#123;<br>&gt;     <span class="hljs-string">&quot;any&quot;</span>: [<br>&gt;       &#123;<br>&gt;         <span class="hljs-string">&quot;field&quot;</span>: &#123;<br>&gt;           <span class="hljs-string">&quot;username&quot;</span>: <span class="hljs-string">&quot;/user1*/&quot;</span><br>&gt;         &#125;<br>&gt;       &#125;<br>&gt;     ]<br>&gt;   &#125;<br>&gt; &#125;&#x27;<br>&#123;<br>  <span class="hljs-string">&quot;role_mapping&quot;</span> : &#123;<br>    <span class="hljs-string">&quot;created&quot;</span> : <span class="hljs-literal">true</span><br>  &#125;<br>&#125;<br>[elasticsearch<span class="hljs-meta">@elasticsearch</span> elasticsearch<span class="hljs-number">-6.0</span><span class="hljs-number">.0</span>]$ curl -<span class="hljs-type">XGET</span> -<span class="hljs-type">H</span> <span class="hljs-symbol">&#x27;Content</span>-<span class="hljs-class"><span class="hljs-keyword">type</span></span>: application/json&#x27; -u elastic:elastic <span class="hljs-symbol">&#x27;http</span>:<span class="hljs-comment">//10.59.30.96:9200/_xpack/security/role_mapping/ldap_user_admin?pretty&#x27;</span><br>&#123;<br>  <span class="hljs-string">&quot;ldap_user_admin&quot;</span> : &#123;<br>    <span class="hljs-string">&quot;enabled&quot;</span> : <span class="hljs-literal">true</span>,<br>    <span class="hljs-string">&quot;roles&quot;</span> : [<br>      <span class="hljs-string">&quot;admin&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;rules&quot;</span> : &#123;<br>      <span class="hljs-string">&quot;any&quot;</span> : [<br>        &#123;<br>          <span class="hljs-string">&quot;field&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;username&quot;</span> : <span class="hljs-string">&quot;/user1*/&quot;</span><br>          &#125;<br>        &#125;<br>      ]<br>    &#125;,<br>    <span class="hljs-string">&quot;metadata&quot;</span> : &#123; &#125;<br>  &#125;<br>&#125;<br>[elasticsearch<span class="hljs-meta">@elasticsearch</span> elasticsearch<span class="hljs-number">-6.0</span><span class="hljs-number">.0</span>]$ <br></code></pre></td></tr></table></figure><p>验证域账户权限，使用user01无权访问indices接口，使用user11可以访问；</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs swift">[elasticsearch<span class="hljs-meta">@elasticsearch</span> elasticsearch<span class="hljs-operator">-</span><span class="hljs-number">6.0</span>.<span class="hljs-number">0</span>]$ curl <span class="hljs-operator">-</span><span class="hljs-type">XGET</span> <span class="hljs-operator">-</span>u user01:user01 &#x27;http:<span class="hljs-comment">//10.59.30.96:9200/_cat/indices?pretty&#x27;</span><br>&#123;<br>  <span class="hljs-string">&quot;error&quot;</span> : &#123;<br>    <span class="hljs-string">&quot;root_cause&quot;</span> : [<br>      &#123;<br>        <span class="hljs-string">&quot;type&quot;</span> : <span class="hljs-string">&quot;security_exception&quot;</span>,<br>        <span class="hljs-string">&quot;reason&quot;</span> : <span class="hljs-string">&quot;action [cluster:monitor/state] is unauthorized for user [user01]&quot;</span><br>      &#125;<br>    ],<br>    <span class="hljs-string">&quot;type&quot;</span> : <span class="hljs-string">&quot;security_exception&quot;</span>,<br>    <span class="hljs-string">&quot;reason&quot;</span> : <span class="hljs-string">&quot;action [cluster:monitor/state] is unauthorized for user [user01]&quot;</span><br>  &#125;,<br>  <span class="hljs-string">&quot;status&quot;</span> : <span class="hljs-number">403</span><br>&#125;<br>[elasticsearch<span class="hljs-meta">@elasticsearch</span> elasticsearch<span class="hljs-operator">-</span><span class="hljs-number">6.0</span>.<span class="hljs-number">0</span>]$ curl <span class="hljs-operator">-</span><span class="hljs-type">XGET</span> <span class="hljs-operator">-</span>u user11:user11 &#x27;http:<span class="hljs-comment">//10.59.30.96:9200/_cat/indices?pretty&#x27;</span><br>yellow <span class="hljs-keyword">open</span> .monitoring<span class="hljs-operator">-</span>es<span class="hljs-operator">-</span><span class="hljs-number">6</span><span class="hljs-operator">-</span><span class="hljs-number">2018.01</span>.<span class="hljs-number">10</span>   nND6<span class="hljs-operator">-</span>i_rR5iLEYVccBGj8w <span class="hljs-number">1</span> <span class="hljs-number">1</span> <span class="hljs-number">6178</span> <span class="hljs-number">44</span>  <span class="hljs-number">5</span>.9mb  <span class="hljs-number">5</span>.9mb<br>yellow <span class="hljs-keyword">open</span> .triggered_watches            <span class="hljs-type">BtygGZisSDqiL3Y2TaQGqQ</span> <span class="hljs-number">1</span> <span class="hljs-number">1</span>    <span class="hljs-number">0</span>  <span class="hljs-number">0</span> <span class="hljs-number">11</span>.7kb <span class="hljs-number">11</span>.7kb<br>green  <span class="hljs-keyword">open</span> .security<span class="hljs-operator">-</span><span class="hljs-number">6</span>                   <span class="hljs-type">QVRL1mcFSAilryHGEhen7Q</span> <span class="hljs-number">1</span> <span class="hljs-number">0</span>                      <br>yellow <span class="hljs-keyword">open</span> .watcher<span class="hljs-operator">-</span>history<span class="hljs-operator">-</span><span class="hljs-number">6</span><span class="hljs-operator">-</span><span class="hljs-number">2018.01</span>.<span class="hljs-number">10</span> <span class="hljs-type">SBGiHDAnTPiXFoHU65VY_g</span> <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">777</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>.1mb  <span class="hljs-number">1</span>.1mb<br>yellow <span class="hljs-keyword">open</span> .watches                      kMzN4j5cQySZQQSDVPww8w <span class="hljs-number">1</span> <span class="hljs-number">1</span>    <span class="hljs-number">5</span>  <span class="hljs-number">0</span> <span class="hljs-number">40</span>.2kb <span class="hljs-number">40</span>.2kb<br>yellow <span class="hljs-keyword">open</span> .monitoring<span class="hljs-operator">-</span>alerts<span class="hljs-operator">-</span><span class="hljs-number">6</span>          <span class="hljs-type">VygY6VN9R3S0PR_jrGy50Q</span> <span class="hljs-number">1</span> <span class="hljs-number">1</span>    <span class="hljs-number">1</span>  <span class="hljs-number">0</span> <span class="hljs-number">12</span>.8kb <span class="hljs-number">12</span>.8kb<br>[elasticsearch<span class="hljs-meta">@elasticsearch</span> elasticsearch<span class="hljs-operator">-</span><span class="hljs-number">6.0</span>.<span class="hljs-number">0</span>]$ <br></code></pre></td></tr></table></figure><h2 id="常见报错"><a href="#常见报错" class="headerlink" title="常见报错"></a>常见报错</h2><p>No subject alternative names matching IP address</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-attr">[2018-01-10T19:19:35,483]</span><span class="hljs-selector-attr">[WARN ]</span><span class="hljs-selector-attr">[o.e.x.s.t.n.SecurityNetty4Transport]</span> <span class="hljs-selector-attr">[fzP4t-4]</span> exception caught on transport layer <span class="hljs-selector-attr">[[id: 0x5d97fe48, L:/0:0:0:0:0:0:0:1:49121 ! R:/0:0:0:0:0:0:0:1:9300]</span>], closing connection<br>    io<span class="hljs-selector-class">.netty</span><span class="hljs-selector-class">.handler</span><span class="hljs-selector-class">.codec</span><span class="hljs-selector-class">.DecoderException</span>: javax<span class="hljs-selector-class">.net</span><span class="hljs-selector-class">.ssl</span><span class="hljs-selector-class">.SSLHandshakeException</span>: General SSLEngine problem<br>......<br>Caused by: java<span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.cert</span><span class="hljs-selector-class">.CertificateException</span>: No subject alternative names matching IP <span class="hljs-selector-tag">address</span> <span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">1</span> found<br></code></pre></td></tr></table></figure><p>解决方案为一种是关闭IPv6地址，另一种是修改ES_HOME/config/elasticsearch.yml中的network.host值为本机eth0的IP</p><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li>官方安装步骤：<a href="https://www.elastic.co/guide/">https://www.elastic.co/guide/</a>…</li><li>配置内置账户密码：<br><a href="https://www.elastic.co/guide/">https://www.elastic.co/guide/</a>…</li><li>修改账户密码：<br><a href="https://www.elastic.co/guide/">https://www.elastic.co/guide/</a>…</li><li>用户相关操作：<br><a href="https://www.elastic.co/guide/">https://www.elastic.co/guide/</a>…</li><li>使用LDAP认证： <a href="https://www.elastic.co/guide/">https://www.elastic.co/guide/</a>…</li><li>用户角色映射： <a href="https://www.elastic.co/guide/">https://www.elastic.co/guide/</a>…</li></ul>]]></content>
    
    
    <categories>
      
      <category>ELK</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ELK</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Elasticsearch分片及集群说明</title>
    <link href="/2018/05/07/Elasticsearch%E5%88%86%E7%89%87%E5%8F%8A%E9%9B%86%E7%BE%A4%E8%AF%B4%E6%98%8E/"/>
    <url>/2018/05/07/Elasticsearch%E5%88%86%E7%89%87%E5%8F%8A%E9%9B%86%E7%BE%A4%E8%AF%B4%E6%98%8E/</url>
    
    <content type="html"><![CDATA[<h2 id="replica的作用主要包括："><a href="#replica的作用主要包括：" class="headerlink" title="replica的作用主要包括："></a>replica的作用主要包括：</h2><ul><li><p>a.容灾:primary分片丢失，replica分片就会被顶上去成为新的主分片，同时根据这个新的主分片创建新的replica,集群数据安然无恙；</p></li><li><p>b.提高查询性能：replica和primary分片的数据是相同的，所以对于一个query既可以查主分片也可以查备分片，在合适的范围内多个replica性能会更优(但要考虑资源占用也会提升[cpu/disk/heap])，另外index request只能发生在主分片上，replica不能执行index request;</p></li></ul><h2 id="分片数目调整："><a href="#分片数目调整：" class="headerlink" title="分片数目调整："></a>分片数目调整：</h2><p>对于一个索引，除非重建索引否则不能调整分片的数目(主分片数，number_of_shards),但可以随时调整replica数(number_of_replicas)</p><h2 id="ES集群状态有三种："><a href="#ES集群状态有三种：" class="headerlink" title="ES集群状态有三种："></a>ES集群状态有三种：</h2><ul><li><p>Green: 所有主分片和备份分片都准备就绪(分配成功)，即使有一台机器挂了(假设一台机器一个实例)，数据都不会丢失，但会变成YELLOW状态；</p></li><li><p>Yellow: 所有主分片准备就绪，但存在至少一个主分片(假设是A)对应的备份分片没有就绪，此时集群属于告警状态，意味着集群高可用和容灾能力下降，如果刚好A所在的机器挂了，并且你只设置了一个备份(已处于未就绪状态),那么A的数据就会丢失(查询结果不完整)，此时集群进入Red状态；</p></li><li><p>Red: 至少有一个主分片没有就绪(直接原因是找不到对应的备份分片成为新的主分片),此时查询的结果会出现数据丢失(不完整)</p></li></ul><h2 id="Elasticsearch与关系数据的类比对应关系如下："><a href="#Elasticsearch与关系数据的类比对应关系如下：" class="headerlink" title="Elasticsearch与关系数据的类比对应关系如下："></a>Elasticsearch与关系数据的类比对应关系如下：</h2><p>Relational DB  ⇒ Databases ⇒ Tables ⇒ Rows  ⇒ Columns<br>Elasticsearch  ⇒ Indices  ⇒ Types ⇒ Documents ⇒ Fields</p><p>这里的document的可以理解为一个JSON序列对象。每个document可包含多个field。再来说说Shard，每个Index（对应Database）包含多个Shard，默认是5个，分散在不同的Node上，但不会存在两个相同的Shard存在一个Node上，这样就没有备份的意义了。Shard是一个最小的Lucene索引单元。当来一个document的时候，Elasticsearch通过对docid进行hash来确定其放在哪个shard上面，然后在shard上面进行索引存储。replicas就是备份，Elasticsearch采用的是Push Replication模式，当你往 master主分片上面索引一个文档，该分片会复制该文档(document)到剩下的所有 replica副本分片中，这些分片也会索引这个文档。</p><p>当进行查询时，如果提供了查询的DocID，Elasticsearch通过hash就知道Doc存在哪个shard上面，再通过routing table查询就知道再哪个node上面，让后去node上面去取就好了。如果不提供DocID,那么Elasticsearch会在该Index（indics）shards所在的所有node上执行搜索预警，然后返回搜索结果，由coordinating node gather之后返回给用户。</p><p>集群信息说明图如下：</p><p><img src="https://cos.leiyawu.com/img/elk/es_cluster_map.jpg" alt="map"></p>]]></content>
    
    
    <categories>
      
      <category>ELK</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ELK</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>hexo添加admin,修改默认端口</title>
    <link href="/2018/04/20/hexo%E4%BF%AE%E6%94%B9%E9%BB%98%E8%AE%A4%E7%AB%AF%E5%8F%A3/"/>
    <url>/2018/04/20/hexo%E4%BF%AE%E6%94%B9%E9%BB%98%E8%AE%A4%E7%AB%AF%E5%8F%A3/</url>
    
    <content type="html"><![CDATA[<h3 id="默认使用4000端口，用hexo-s-p-80-，可以暂时修改启动端口。"><a href="#默认使用4000端口，用hexo-s-p-80-，可以暂时修改启动端口。" class="headerlink" title="默认使用4000端口，用hexo s -p 80 ，可以暂时修改启动端口。"></a>默认使用4000端口，用hexo s -p 80 ，可以暂时修改启动端口。</h3><p>但是每次启动都要写”-p 80”才行，过于繁琐。</p><p>修改方法：</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs axapta">找到node_modules\hexo-<span class="hljs-keyword">server</span>\<span class="hljs-keyword">index</span>.js文件，可以修改默认的port值！<br></code></pre></td></tr></table></figure><h3 id="另外需要在-config-yml添加如下信息："><a href="#另外需要在-config-yml添加如下信息：" class="headerlink" title="另外需要在_config.yml添加如下信息："></a>另外需要在_config.yml添加如下信息：</h3><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nsis"><span class="hljs-comment">#for hexo-admin</span><br><span class="hljs-literal">admin</span>:<br>  username: martin <span class="hljs-comment">#自己设置用户名</span><br>  password_hash: <span class="hljs-variable">$2a</span><span class="hljs-variable">$10</span><span class="hljs-variable">$3iexljP9AqDzeNGboJmHaetHM</span>/IaA.<span class="hljs-number">8</span>dSNuZOj.S0B0wINIhBKBym <span class="hljs-comment">#密码,明文经过bcrypt hash加密后生成的</span><br>  secret: martin  <span class="hljs-comment">#用于cookie安全</span><br>  deployCommand: <span class="hljs-string">&#x27;/data/scripts/hexo-generate.sh&#x27;</span>  <span class="hljs-comment">#调用该脚本</span><br></code></pre></td></tr></table></figure><h3 id="hexo-generate-sh脚本如下："><a href="#hexo-generate-sh脚本如下：" class="headerlink" title="hexo-generate.sh脚本如下："></a>hexo-generate.sh脚本如下：</h3><figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs d">➜  init cat /data/scripts/hexo-generate.sh<br><span class="hljs-meta">#!/bin/bash</span><br>hexo g<br></code></pre></td></tr></table></figure><h3 id="启动服务："><a href="#启动服务：" class="headerlink" title="启动服务："></a>启动服务：</h3><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">nohup hexo server -d <span class="hljs-meta">&amp;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>hexo</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>docker cicd持续集成部署</title>
    <link href="/2018/04/20/docker-cicd%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E9%83%A8%E7%BD%B2/"/>
    <url>/2018/04/20/docker-cicd%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h2 id="持续集成的概念"><a href="#持续集成的概念" class="headerlink" title="持续集成的概念"></a>持续集成的概念</h2><p>持续集成，Continuous integration ，简称CI。</p><p>首先，解释下集成：所有的项目代码都是托管在SVN或者GIT服务器上（以下简称代码服务器）。每个项目都有若干个单元测试和集成测试。集成测试是单元测试的逻辑扩展：在单元测试的基础上，将所有模块按照设计要求组装成为子系统或系统进行集成测试。实践表明，一些模块虽然能够单独地工作，但并不能保证连接起来也能正常的工作。一些局部反映不出来的问题，在全局上很可能暴露出来（关于单元测试及集成测试的详述，读者可以查阅相关文档）。</p><p>简单来说，集成测试就是把所有的单元测试跑一遍，以及其它一些能自动完成的测试。只有通过了集成测试的代码才能上传到代码服务器上，确保上传的代码没有问题。集成一般指集成测试。</p><p>持续，显而易见就是长期对代码进行的集成测试。既然是长期进行，那么最好是自动执行，否则人工执行既没保证，而且耗人力。</p><p>基于此种目的，我们需要有一台服务器，它将定期从代码服务器中拉取代码，并进行编译，然后自动运行集成测试；并且每次集成测试的结果都会记录在案。</p><h2 id="持续集成的特点"><a href="#持续集成的特点" class="headerlink" title="持续集成的特点"></a>持续集成的特点</h2><ul><li>它是一个自动化的周期性的集成测试过程，从拉取代码、编译构建、运行测试、结果记录、测试统计等都是自动完成的，无需人工干预；</li><li>需要有专门的集成服务器来执行集成构建；</li><li>需要有代码托管工具支持；</li></ul><h2 id="持续集成的作用"><a href="#持续集成的作用" class="headerlink" title="持续集成的作用"></a>持续集成的作用</h2><ul><li>保证团队开发人员提交代码的质量，减轻了软件发布时的压力；</li><li>持续集成中的任何一个环节都是自动完成的，无需太多的人工干预，有利于减少重复过程以节省时间、费用和工作量；</li></ul><p>首先，Docker可以让你非常容易和方便地以“容器化”的方式去部署应用。 它就像集装箱一样，打包了所有依赖，再在其他服务器上部署很容易，不至于换服务器后发现各种配置文件散落一地，这样就解决了编译时依赖和运行时依赖的问题；</p><p>其次，Docker的隔离性使得应用在运行是就像处于沙箱中一样，每个应用都认为自己是在系统中唯一运行的程序，就像刚才例子中，A依赖于Python 2.7，同时A还依赖于B，但B却依赖于Python3， 这样我们可以在系统中部署一个基于python2.7的容器和一个基于python3的容器，这样就可以很方便的在系统中部署多种不同的环境来解决依赖复杂度的问题。这里有些朋友可能会说，虚拟机也可以解决这样的问题！诚然，虚拟化确实可以做到这一点，但是这样需要硬件支持虚拟化及开启BIOS中虚拟化相关的功能，同时还需要在系统中安装2套操作系统，虚拟机的出现是解决了操作系统和物理机的强耦合问题。但是Docker就轻量化很多，只需内核支持，无需硬件和BIOS的强制要求，可以很轻松迅速的在系统上部署多套不同的容器环境，容器的出现解决了应用和操作系统的强耦合问题。</p><p>正以为Docker是以应用为中心，镜像中打包了应用及应用所需的环境，一次构建，处处运行。这种特性完美的解决了传统模式下应用迁移后面临的环境不一致问题。</p><p>同时，Docker 压根不管内部应用怎么启动，你自己爱咋来咋来，我们用 docker start 或 run 作为统一标准。这样我们应用启动就标准化了， 不需要再根据不同应用而记忆一大串不同的启动命令。</p><h2 id="基于Docker的特征，现在常见的利用-Docker-进行持续集成的流程如下："><a href="#基于Docker的特征，现在常见的利用-Docker-进行持续集成的流程如下：" class="headerlink" title="基于Docker的特征，现在常见的利用 Docker 进行持续集成的流程如下："></a>基于Docker的特征，现在常见的利用 Docker 进行持续集成的流程如下：</h2><ol><li>开发者提交代码</li><li>触发镜像构建</li><li>构建镜像上传至私有仓库</li><li>镜像下载至执行机器</li><li>镜像运行</li></ol><p>其基本拓扑结构如下所示：<br><img src="https://cos.leiyawu.com/docker/img/docker1.png" alt="图1"></p><p>熟悉Docker的都知道，Docker以的启动是非常快的，可以说是秒启。在上述的五步中，1 和 5 的耗时是比较短的，整个持续集成主要耗时集中在中间的3个步骤，也就是 Docker build，Docker push ，Docekr pull 的时间消耗.</p><p>Docker Registry升级到 v2 后加入了很多安全相关检查，在v2中的镜像的存储格式变成了gzip ，镜像在压缩过程中占用的时间也是比较多的。</p><p>Docker pull 镜像的速度对服务的启动速度至关重要，好在 Registry v2 后可以并行 pull 了，速度有了很大的改善。但是依然有一些小的问题影响了启动的速度：</p><ul><li>下载镜像和解压镜像是串行的；</li><li>串行解压，由于 v2 都是 gzip,要解压，尽管并行下载了还是串行解压，内网的话解压时间比网络传输都要长；</li><li>和 Registry 通信， Registry 在 pull的过程中并不提供下载内容只是提供下载URL和鉴权，这一部分加长网络传输而且一些 Metadata还是要去后端存储获取，延时还是有一些的。</li></ul><p>整个持续集成平台架构演进到如下图所示：<br><img src="https://cos.leiyawu.com/docker/img/docker2.png" alt="图2"></p>]]></content>
    
    
    <categories>
      
      <category>docker</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>logstash吞吐率优化</title>
    <link href="/2018/04/13/logstash%E4%BC%98%E5%8C%96/"/>
    <url>/2018/04/13/logstash%E4%BC%98%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h2 id="问题一"><a href="#问题一" class="headerlink" title="问题一##"></a>问题一##</h2><p>最近发现kibana的日志传的很慢，常常查不到日志，由于所有的日志收集都只传输到了一个logstash进行收集和过滤，于是怀疑是否是由于logstash的吞吐量存在瓶颈。一看，还真是到了瓶颈。</p><h3 id="优化过程"><a href="#优化过程" class="headerlink" title="优化过程"></a>优化过程</h3><p>经过查询logstash完整配置文件，有几个参数需要调整</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># pipeline线程数，官方建议是等于CPU内核数</span><br><span class="hljs-attr">pipeline.workers:</span> <span class="hljs-number">24</span><br><span class="hljs-comment"># 实际output时的线程数</span><br><span class="hljs-attr">pipeline.output.workers:</span> <span class="hljs-number">24</span><br><span class="hljs-comment"># 每次发送的事件数</span><br><span class="hljs-attr">pipeline.batch.size:</span> <span class="hljs-number">3000</span><br><span class="hljs-comment"># 发送延时</span><br><span class="hljs-attr">pipeline.batch.delay:</span> <span class="hljs-number">5</span><br></code></pre></td></tr></table></figure><p>PS:由于我们的ES集群数据量较大（&gt;28T），所以具体配置数值视自身生产环境</p><h3 id="优化结果"><a href="#优化结果" class="headerlink" title="优化结果"></a>优化结果</h3><p>ES的吞吐由每秒9817/s提升到41183/s,具体可以通过x-pack的monitor查看。</p><h2 id="问题二"><a href="#问题二" class="headerlink" title="问题二##"></a>问题二##</h2><p>在查看logstash日志过程中，我们看到了大量的以下报错</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-attr">[2017-03-18T09:46:21,043]</span><span class="hljs-selector-attr">[INFO ]</span><span class="hljs-selector-attr">[logstash.outputs.elasticsearch]</span> retrying failed action with response <span class="hljs-selector-tag">code</span>: <span class="hljs-number">429</span> (&#123;<span class="hljs-string">&quot;type&quot;</span>=&gt;<span class="hljs-string">&quot;es_rejected_execution_exception&quot;</span>, <span class="hljs-string">&quot;reason&quot;</span>=&gt;<span class="hljs-string">&quot;rejected execution of org.elasticsearch.transport.TransportService$6@6918cf2e on EsThreadPoolExecutor[bulk, queue capacity = 50, org.elasticsearch.common.util.concurrent.EsThreadPoolExecutor@55337655[Running, pool size = 24, active threads = 24, queued tasks = 50, completed tasks = 1767887463]]&quot;</span>&#125;)<br><span class="hljs-selector-attr">[2017-03-18T09:46:21,043]</span><span class="hljs-selector-attr">[ERROR]</span><span class="hljs-selector-attr">[logstash.outputs.elasticsearch]</span> Retrying individual actions<br></code></pre></td></tr></table></figure><p>查询官网，确认为时ES的写入遇到了瓶颈</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">Make sure <span class="hljs-built_in">to</span> watch <span class="hljs-keyword">for</span> TOO_MANY_REQUESTS (<span class="hljs-number">429</span>) response codes (EsRejectedExecutionException <span class="hljs-keyword">with</span> <span class="hljs-keyword">the</span> Java client), which is <span class="hljs-keyword">the</span> way that Elasticsearch tells you that <span class="hljs-keyword">it</span> cannot keep up <span class="hljs-keyword">with</span> <span class="hljs-keyword">the</span> current indexing rate. When <span class="hljs-keyword">it</span> happens, you should pause indexing <span class="hljs-keyword">a</span> bit <span class="hljs-keyword">before</span> trying again, ideally <span class="hljs-keyword">with</span> randomized exponential backoff.<br></code></pre></td></tr></table></figure><p>我们首先想到的是来调整ES的线程数，但是官网写到”Don’t Touch There Settings!”, 那怎么办？于是乎官方建议我们修改logstash的参数pipeline.batch.size</p><p>在ES5.0以后，es将bulk、flush、get、index、search等线程池完全分离，自身的写入不会影响其他功能的性能。<br>来查询一下ES当前的线程情况：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET _nodes<span class="hljs-regexp">/stats/</span>thread_pool?pretty<br>&#123;<br>  <span class="hljs-string">&quot;_nodes&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;total&quot;</span>: <span class="hljs-number">6</span>,<br>    <span class="hljs-string">&quot;successful&quot;</span>: <span class="hljs-number">6</span>,<br>    <span class="hljs-string">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-string">&quot;cluster_name&quot;</span>: <span class="hljs-string">&quot;dev-elasticstack5.0&quot;</span>,<br>  <span class="hljs-string">&quot;nodes&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;nnfCv8FrSh-p223gsbJVMA&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;timestamp&quot;</span>: <span class="hljs-number">1489804973926</span>,<br>      <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;node-3&quot;</span>,<br>      <span class="hljs-string">&quot;transport_address&quot;</span>: <span class="hljs-string">&quot;192.168.3.***:9301&quot;</span>,<br>      <span class="hljs-string">&quot;host&quot;</span>: <span class="hljs-string">&quot;192.168.3.***&quot;</span>,<br>      <span class="hljs-string">&quot;ip&quot;</span>: <span class="hljs-string">&quot;192.168.3.***:9301&quot;</span>,<br>      <span class="hljs-string">&quot;roles&quot;</span>: [<br>        <span class="hljs-string">&quot;master&quot;</span>,<br>        <span class="hljs-string">&quot;data&quot;</span>,<br>        <span class="hljs-string">&quot;ingest&quot;</span><br>      ],<br>      <span class="hljs-string">&quot;attributes&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;rack&quot;</span>: <span class="hljs-string">&quot;r1&quot;</span><br>      &#125;,<br>      <span class="hljs-string">&quot;thread_pool&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;bulk&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;threads&quot;</span>: <span class="hljs-number">24</span>,<br>          <span class="hljs-string">&quot;queue&quot;</span>: <span class="hljs-number">214</span>,<br>          <span class="hljs-string">&quot;active&quot;</span>: <span class="hljs-number">24</span>,<br>          <span class="hljs-string">&quot;rejected&quot;</span>: <span class="hljs-number">30804543</span>,<br>          <span class="hljs-string">&quot;largest&quot;</span>: <span class="hljs-number">24</span>,<br>          <span class="hljs-string">&quot;completed&quot;</span>: <span class="hljs-number">1047606679</span><br>        &#125;,<br><br>        ......<br><br>        <span class="hljs-string">&quot;watcher&quot;</span>: &#123;<br>  <span class="hljs-string">&quot;threads&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;queue&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;active&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;rejected&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;largest&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;completed&quot;</span>: <span class="hljs-number">0</span><br>&#125;<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>其中：”bulk”模板的线程数24，当前活跃的线程数24，证明所有的线程是busy的状态，queue队列214，rejected为30804543。那么问题就找到了，所有的线程都在忙，队列堵满后再有进程写入就会被拒绝，而当前拒绝数为30804543。</p><h3 id="优化方案"><a href="#优化方案" class="headerlink" title="优化方案"></a>优化方案</h3><p>问题找到了，如何优化呢。官方的建议是提高每次批处理的数量，调节传输间歇时间。当batch.size增大，es处理的事件数就会变少，写入也就越快了。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">vim</span> /etc/logstash/logstash.yml<br><span class="hljs-comment">#</span><br><span class="hljs-attribute">pipeline</span>.workers: <span class="hljs-number">24</span><br><span class="hljs-attribute">pipeline</span>.output.workers: <span class="hljs-number">24</span><br><span class="hljs-attribute">pipeline</span>.batch.size: <span class="hljs-number">10000</span><br><span class="hljs-attribute">pipeline</span>.batch.delay: <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure><p>具体的worker/output.workers数量建议等于CPU数，batch.size/batch.delay根据实际的数据量逐渐增大来测试最优值。</p>]]></content>
    
    
    <categories>
      
      <category>ELK</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ELK</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>kafka性能调优</title>
    <link href="/2018/04/13/kafka%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/"/>
    <url>/2018/04/13/kafka%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/</url>
    
    <content type="html"><![CDATA[<h2 id="Kafka的配置详尽、复杂，想要进行全面的性能调优需要掌握大量信息，这里只记录一下我在日常工作使用中走过的坑和经验来对kafka集群进行优化常用的几点。"><a href="#Kafka的配置详尽、复杂，想要进行全面的性能调优需要掌握大量信息，这里只记录一下我在日常工作使用中走过的坑和经验来对kafka集群进行优化常用的几点。" class="headerlink" title="Kafka的配置详尽、复杂，想要进行全面的性能调优需要掌握大量信息，这里只记录一下我在日常工作使用中走过的坑和经验来对kafka集群进行优化常用的几点。##"></a>Kafka的配置详尽、复杂，想要进行全面的性能调优需要掌握大量信息，这里只记录一下我在日常工作使用中走过的坑和经验来对kafka集群进行优化常用的几点。##</h2><h3 id="1-JVM的优化"><a href="#1-JVM的优化" class="headerlink" title="1.JVM的优化"></a>1.JVM的优化</h3><p>java相关系统自然离不开JVM的优化。首先想到的肯定是Heap Size的调整。</p><p>vim bin/kafka-server-start.sh   </p><p>调整KAFKA_HEAP_OPTS=”-Xmx16G -Xms16G”的值<br>推荐配置：一般HEAP SIZE的大小不超过主机内存的50%。</p><h3 id="2-网络和ios操作线程配置优化："><a href="#2-网络和ios操作线程配置优化：" class="headerlink" title="2.网络和ios操作线程配置优化：###"></a>2.网络和ios操作线程配置优化：###</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># broker处理消息的最大线程数</span><br><span class="hljs-attr">num.network.threads</span>=<span class="hljs-number">9</span><br><span class="hljs-comment"># broker处理磁盘IO的线程数</span><br><span class="hljs-attr">num.io.threads</span>=<span class="hljs-number">16</span><br></code></pre></td></tr></table></figure><p>推荐配置：<br>num.network.threads主要处理网络io，读写缓冲区数据，基本没有io等待，配置线程数量为cpu核数加1。</p><p>num.io.threads主要进行磁盘io操作，高峰期可能有些io等待，因此配置需要大些。配置线程数量为cpu核数2倍，最大不超过3倍。</p><h3 id="3-socket-server可接受数据大小-防止OOM异常-："><a href="#3-socket-server可接受数据大小-防止OOM异常-：" class="headerlink" title="3.socket server可接受数据大小(防止OOM异常)：###"></a>3.socket server可接受数据大小(防止OOM异常)：###</h3><p>socket.request.max.bytes=2147483600</p><p>推荐配置：</p><p>根据自己业务数据包的大小适当调大。这里取值是int类型的，而受限于java int类型的取值范围又不能太大：</p><p>java int的取值范围为（-2147483648~2147483647），占用4个字节（-2的31次方到2的31次方-1，不能超出，超出之后报错：org.apache.kafka.common.config.ConfigException: Invalid value 8589934592 for configuration socket.request.max.bytes: Not a number of type INT。</p><h3 id="4-log数据文件刷盘策略"><a href="#4-log数据文件刷盘策略" class="headerlink" title="4.log数据文件刷盘策略"></a>4.log数据文件刷盘策略</h3><p>—每当producer写入10000条消息时，刷数据到磁盘—<br>log.flush.interval.messages=10000</p><p>—每间隔1秒钟时间，刷数据到磁盘—<br>log.flush.interval.ms=1000</p><p>推荐配置：</p><p>为了大幅度提高producer写入吞吐量，需要定期批量写文件。一般无需改动，如果topic的数据量较小可以考虑减少log.flush.interval.ms和log.flush.interval.messages来强制刷写数据，减少可能由于缓存数据未写盘带来的不一致。推荐配置分别message 10000，间隔1s。</p><h3 id="5-日志保留策略配置"><a href="#5-日志保留策略配置" class="headerlink" title="5.日志保留策略配置"></a>5.日志保留策略配置</h3><p>—日志保留时长—<br>log.retention.hours=72</p><p>—段文件配置—<br>log.segment.bytes=1073741824</p><p>推荐配置：</p><p>日志建议保留三天，也可以更短；段文件配置1GB，有利于快速回收磁盘空间，重启kafka加载也会加快（kafka启动时是单线程扫描目录(log.dir)下所有数据文件）。如果文件过小，则文件数量比较多。</p><h3 id="6-replica复制配置"><a href="#6-replica复制配置" class="headerlink" title="6.replica复制配置"></a>6.replica复制配置</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">num.<span class="hljs-keyword">replica</span>.fetchers=<span class="hljs-number">3</span><br><span class="hljs-keyword">replica</span>.<span class="hljs-keyword">fetch</span>.min.bytes=<span class="hljs-number">1</span><br><span class="hljs-keyword">replica</span>.<span class="hljs-keyword">fetch</span>.max.bytes=<span class="hljs-number">5242880</span><br></code></pre></td></tr></table></figure><p>推荐配置：</p><p>每个follow从leader拉取消息进行同步数据，follow同步性能由这几个参数决定，分别为:</p><p>拉取线程数(num.replica.fetchers):fetcher配置多可以提高follower的I/O并发度，单位时间内leader持有更多请求，相应负载会增大，需要根据机器硬件资源做权衡，建议适当调大；</p><p>最小字节数(replica.fetch.min.bytes):一般无需更改，默认值即可；</p><p>最大字节数(replica.fetch.max.bytes)：默认为1MB，这个值太小，推荐5M，根据业务情况调整</p><p>最大等待时间(replica.fetch.wait.max.ms):follow拉取频率，频率过高，leader会积压大量无效请求情况，无法进行数据同步，导致cpu飙升。配置时谨慎使用，建议默认值，无需配置。</p><h3 id="7-分区数量配置"><a href="#7-分区数量配置" class="headerlink" title="7.分区数量配置"></a>7.分区数量配置</h3><p>num.partitions=5</p><p>推荐配置：</p><p>默认partition数量1，如果topic在创建时没有指定partition数量，默认使用此值。Partition的数量选取也会直接影响到Kafka集群的吞吐性能，配置过小会影响消费性能，建议改为5。</p>]]></content>
    
    
    <categories>
      
      <category>kafka</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kafka</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ElasticSearch 索引查询使用指南</title>
    <link href="/2018/04/03/ELK%E7%B4%A2%E5%BC%95/"/>
    <url>/2018/04/03/ELK%E7%B4%A2%E5%BC%95/</url>
    
    <content type="html"><![CDATA[<p>1.我们通常用用<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cat.html">_cat API</a>检测集群是否健康。 确保9200端口号可用:<br>curl ‘localhost:9200/_cat/health?v’</p><p>绿色表示一切正常, 黄色表示所有的数据可用但是部分副本还没有分配,红色表示部分数据因为某些原因不可用.</p><p>2.通过如下语句，我们可以获取集群的节点列表：<br>curl ‘localhost:9200/_cat/nodes?v’</p><p>3.通过如下语句，列出所有索引：<br>curl ‘localhost:9200/_cat/indices?v’<br>返回结果：</p><p><img src="http://cos.leiyawu.com/img/elk_index_check_1.png" alt="图1"> 　　</p><p>4.创建索引<br>现在我们创建一个名为“customer”的索引，然后再查看所有的索引：<br> curl -XPUT ‘localhost:9200/customer?pretty’<br> curl ‘localhost:9200/_cat/indices?v’</p><p>结果如下：</p><p><img src="http://cos.leiyawu.com/img/elk_index_check_2.png" alt="图2"></p><p><img src="http://cos.leiyawu.com/img/elk_index_check_3.png" alt="图3"></p><p>上图中红框所表示的是：我们有一个叫customer的索引，它有五个私有的分片以及一个副本，在它里面有0个文档。</p><span id="more"></span><p>5.插入和获取<br>现在我么插入一些数据到集群索引。我们必须给ES指定所以的类型。如下语句：”external” type, ID：1:<br>主体为JSON格式的语句： { “name”: “John Doe” }</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs scilab">curl -XPUT <span class="hljs-string">&#x27;localhost:9200/customer/external/1?pretty&#x27;</span> -d <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">     　　  &quot;</span>name<span class="hljs-string">&quot;: &quot;</span>John Doe<span class="hljs-string">&quot;</span><br><span class="hljs-string">&#125;&#x27;</span><br></code></pre></td></tr></table></figure><p>返回结果为：create：true 表示插入成功。<br><img src="http://cos.leiyawu.com/img/elk_index_check_4.png" alt="图4"></p><p>获取GET，语句如下：</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">curl -XGET &#x27;localhost:<span class="hljs-number">9200</span>/customer/external/1?pretty&#x27;<br></code></pre></td></tr></table></figure><p>其中含义为：获取customer索引下类型为external，id为1的数据，pretty参数表示返回结果格式美观。</p><p><img src="http://cos.leiyawu.com/img/elk_index_check_5.png" alt="图5"></p><p>6.删除索引 DELETE</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs 1c">curl -XDELETE &#x27;localhost:<span class="hljs-number">9200</span>/customer?pretty&#x27;<br>curl &#x27;localhost:<span class="hljs-number">9200</span>/_cat/indices?v&#x27;<br></code></pre></td></tr></table></figure><p><img src="http://cos.leiyawu.com/img/elk_index_check_6.png" alt="图6"></p><p>表示索引删除成功。</p><p>7.通过以上命令语句的学习，我们发现索引的增删改查有一个类似的格式，总结如下：</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs elixir">curl -X&lt;REST Verb&gt; &lt;Node&gt;<span class="hljs-symbol">:&lt;Port&gt;/&lt;Index&gt;/&lt;Type&gt;/&lt;ID&gt;</span><br>&lt;REST Verb&gt;：REST风格的语法谓词<br>&lt;Node&gt;<span class="hljs-symbol">:</span>节点ip<br>&lt;port&gt;<span class="hljs-symbol">:</span>节点端口号，默认<span class="hljs-number">9200</span><br>&lt;Index&gt;<span class="hljs-symbol">:</span>索引名<br>&lt;Type&gt;<span class="hljs-symbol">:</span>索引类型<br>&lt;ID&gt;<span class="hljs-symbol">:</span>操作对象的ID号<br></code></pre></td></tr></table></figure><p>8 修改数据</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs scilab">curl -XPUT <span class="hljs-string">&#x27;localhost:9200/customer/external/1?pretty&#x27;</span> -d <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  &quot;</span>name<span class="hljs-string">&quot;: &quot;</span>John Doe<span class="hljs-string">&quot;</span><br><span class="hljs-string">&#125;&#x27;</span><br>curl -XPUT <span class="hljs-string">&#x27;localhost:9200/customer/external/1?pretty&#x27;</span> -d <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  &quot;</span>name<span class="hljs-string">&quot;: &quot;</span>Jane Doe<span class="hljs-string">&quot;</span><br><span class="hljs-string">&#125;&#x27;</span><br></code></pre></td></tr></table></figure><p>上述命令语句是：先新增id为1，name为John Doe的数据，然后将id为1的name修改为Jane Doe。</p><p>9.更新数据<br>9.1 这个例子展示如何将id为1文档的name字段更新为Jane Doe：</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs scilab">curl -XPOST <span class="hljs-string">&#x27;localhost:9200/customer/external/1/_update?pretty&#x27;</span> -d <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  &quot;</span>doc<span class="hljs-string">&quot;: &#123; &quot;</span>name<span class="hljs-string">&quot;: &quot;</span>Jane Doe<span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#125;&#x27;</span><br></code></pre></td></tr></table></figure><p>9.2 这个例子展示如何将id为1数据的name字段更新为Jane Doe同时增加字段age为20:</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs scilab">curl -XPOST <span class="hljs-string">&#x27;localhost:9200/customer/external/1/_update?pretty&#x27;</span> -d <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  &quot;</span>doc<span class="hljs-string">&quot;: &#123; &quot;</span>name<span class="hljs-string">&quot;: &quot;</span>Jane Doe<span class="hljs-string">&quot;, &quot;</span>age<span class="hljs-string">&quot;: 20 &#125;</span><br><span class="hljs-string">&#125;&#x27;</span><br></code></pre></td></tr></table></figure><p>9.3  也可以通过一些简单的scripts来执行更新。一下语句通过使用script将年龄增加5:</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs scilab">curl -XPOST <span class="hljs-string">&#x27;localhost:9200/customer/external/1/_update?pretty&#x27;</span> -d <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  &quot;</span>script<span class="hljs-string">&quot; : &quot;</span>ctx._source.age += <span class="hljs-number">5</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">&#125;&#x27;</span><br></code></pre></td></tr></table></figure><p>10 删除数据<br>删除数据那是相当的直接. 下面的语句将执行删除Customer中ID为2的数据：</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">curl -XDELETE &#x27;localhost:<span class="hljs-number">9200</span>/customer/external/2?pretty&#x27;<br></code></pre></td></tr></table></figure><p>11 批处理<br>举例:<br>下面语句将在一个批量操作中执行创建索引：</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs scilab">curl -XPOST <span class="hljs-string">&#x27;localhost:9200/customer/external/_bulk?pretty&#x27;</span> -d <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&#123;&quot;</span>index<span class="hljs-string">&quot;:&#123;&quot;</span>_id<span class="hljs-string">&quot;:&quot;</span><span class="hljs-number">1</span><span class="hljs-string">&quot;&#125;&#125;</span><br><span class="hljs-string">&#123;&quot;</span>name<span class="hljs-string">&quot;: &quot;</span>John Doe<span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123;&quot;</span>index<span class="hljs-string">&quot;:&#123;&quot;</span>_id<span class="hljs-string">&quot;:&quot;</span><span class="hljs-number">2</span><span class="hljs-string">&quot;&#125;&#125;</span><br><span class="hljs-string">&#123;&quot;</span>name<span class="hljs-string">&quot;: &quot;</span>Jane Doe<span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#x27;</span><br></code></pre></td></tr></table></figure><p>下面语句批处理执行更新id为1的数据然后执行删除id为2的数据</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs scilab">curl -XPOST <span class="hljs-string">&#x27;localhost:9200/customer/external/_bulk?pretty&#x27;</span> -d <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&#123;&quot;</span>update<span class="hljs-string">&quot;:&#123;&quot;</span>_id<span class="hljs-string">&quot;:&quot;</span><span class="hljs-number">1</span><span class="hljs-string">&quot;&#125;&#125;</span><br><span class="hljs-string">&#123;&quot;</span>doc<span class="hljs-string">&quot;: &#123; &quot;</span>name<span class="hljs-string">&quot;: &quot;</span>John Doe becomes Jane Doe<span class="hljs-string">&quot; &#125; &#125;</span><br><span class="hljs-string">&#123;&quot;</span>delete<span class="hljs-string">&quot;:&#123;&quot;</span>_id<span class="hljs-string">&quot;:&quot;</span><span class="hljs-number">2</span><span class="hljs-string">&quot;&#125;&#125;</span><br><span class="hljs-string">&#x27;</span><br></code></pre></td></tr></table></figure><p>12.导入数据集<br>你可以点击这里下载示例数据集:accounts.json<br>其中每个数据都是如下格式:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>   　　  <span class="hljs-attr">&quot;index&quot;</span>:&#123;<span class="hljs-attr">&quot;_id&quot;</span>:<span class="hljs-string">&quot;1&quot;</span>&#125;<br>&#125;<br>&#123;<br>    <span class="hljs-attr">&quot;account_number&quot;</span>: <span class="hljs-number">0</span>,<br>  　 <span class="hljs-attr">&quot;balance&quot;</span>: <span class="hljs-number">16623</span>,<br> 　  <span class="hljs-attr">&quot;firstname&quot;</span>: <span class="hljs-string">&quot;Bradshaw&quot;</span>,<br>  　 <span class="hljs-attr">&quot;lastname&quot;</span>: <span class="hljs-string">&quot;Mckenzie&quot;</span>,<br>  　 <span class="hljs-attr">&quot;age&quot;</span>: <span class="hljs-number">29</span>,<br>  　 <span class="hljs-attr">&quot;gender&quot;</span>: <span class="hljs-string">&quot;F&quot;</span>,<br>    <span class="hljs-attr">&quot;address&quot;</span>: <span class="hljs-string">&quot;244 Columbus Place&quot;</span>,<br> 　  <span class="hljs-attr">&quot;employer&quot;</span>: <span class="hljs-string">&quot;Euron&quot;</span>,<br>  　 <span class="hljs-attr">&quot;email&quot;</span>: <span class="hljs-string">&quot;bradshawmckenzie@euron.com&quot;</span>,<br>  　 <span class="hljs-attr">&quot;city&quot;</span>: <span class="hljs-string">&quot;Hobucken&quot;</span>,<br>  　 <span class="hljs-attr">&quot;state&quot;</span>: <span class="hljs-string">&quot;CO&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>导入示例数据集:</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs 1c">curl -XPOST &#x27;localhost:<span class="hljs-number">9200</span>/bank/account/_bulk?pretty&#x27; --data-binary <span class="hljs-string">&quot;@accounts.json&quot;</span><br>curl &#x27;localhost:<span class="hljs-number">9200</span>/_cat/indices?v&#x27;<br></code></pre></td></tr></table></figure><p><img src="http://cos.leiyawu.com/img/elk_index_check_7.png" alt="图7"></p><p>上图红框表示我们已经成功批量导入1000条数据索引到bank索引中。</p><p>13.查询<br>Sample:</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs ada">curl <span class="hljs-symbol">&#x27;localhost</span>:<span class="hljs-number">9200</span>/bank/_search?q=*&amp;pretty&#x27;<br>&#123;<br>　　  <span class="hljs-string">&quot;took&quot;</span> : 63,<br> 　　 <span class="hljs-string">&quot;timed_out&quot;</span> : <span class="hljs-type">false</span>,<br> 　　 <span class="hljs-string">&quot;_shards&quot;</span> : &#123;<br>    <span class="hljs-string">&quot;total&quot;</span> : 5,<br>    <span class="hljs-string">&quot;successful&quot;</span> : 5,<br>    <span class="hljs-string">&quot;failed&quot;</span> : 0<br>  &#125;,<br>  <span class="hljs-string">&quot;hits&quot;</span> : &#123;<br>  <span class="hljs-string">&quot;total&quot;</span> : 1000,<br>  <span class="hljs-string">&quot;max_score&quot;</span> : 1.0,<br>  <span class="hljs-string">&quot;hits&quot;</span> : [ &#123;<br>    <span class="hljs-string">&quot;_index&quot;</span> : &quot;<span class="hljs-type">bank</span><span class="hljs-string">&quot;,</span><br><span class="hljs-string">    &quot;</span>_type<span class="hljs-string">&quot; : &quot;</span>account<span class="hljs-string">&quot;,</span><br><span class="hljs-string">    &quot;</span>_id<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">1</span><span class="hljs-string">&quot;,</span><br><span class="hljs-string">    &quot;</span>_score<span class="hljs-string">&quot; : 1.0, &quot;</span>_source<span class="hljs-string">&quot; : &#123;&quot;</span>account_number<span class="hljs-string">&quot;:1,&quot;</span>balance<span class="hljs-string">&quot;:39225,&quot;</span>firstname<span class="hljs-string">&quot;:&quot;</span>Amber<span class="hljs-string">&quot;,&quot;</span>lastname<span class="hljs-string">&quot;:&quot;</span>Duke<span class="hljs-string">&quot;,&quot;</span>age<span class="hljs-string">&quot;:32,&quot;</span>gender<span class="hljs-string">&quot;:&quot;</span>M<span class="hljs-string">&quot;,&quot;</span>address<span class="hljs-string">&quot;:&quot;</span><span class="hljs-number">880</span> Holmes Lane<span class="hljs-string">&quot;,&quot;</span>employer<span class="hljs-string">&quot;:&quot;</span>Pyrami<span class="hljs-string">&quot;,&quot;</span>email<span class="hljs-string">&quot;:&quot;</span>amberduke@pyrami.com<span class="hljs-string">&quot;,&quot;</span>city<span class="hljs-string">&quot;:&quot;</span>Brogan<span class="hljs-string">&quot;,&quot;</span>state<span class="hljs-string">&quot;:&quot;</span>IL<span class="hljs-string">&quot;&#125;</span><br><span class="hljs-string">  &#125;, &#123;</span><br><span class="hljs-string">    &quot;</span>_index<span class="hljs-string">&quot; : &quot;</span>bank<span class="hljs-string">&quot;,</span><br><span class="hljs-string">    &quot;</span>_type<span class="hljs-string">&quot; : &quot;</span>account<span class="hljs-string">&quot;,</span><br><span class="hljs-string">    &quot;</span>_id<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">6</span><span class="hljs-string">&quot;,</span><br><span class="hljs-string">    &quot;</span>_score<span class="hljs-string">&quot; : 1.0, &quot;</span>_source<span class="hljs-string">&quot; : &#123;&quot;</span>account_number<span class="hljs-string">&quot;:6,&quot;</span>balance<span class="hljs-string">&quot;:5686,&quot;</span>firstname<span class="hljs-string">&quot;:&quot;</span>Hattie<span class="hljs-string">&quot;,&quot;</span>lastname<span class="hljs-string">&quot;:&quot;</span>Bond<span class="hljs-string">&quot;,&quot;</span>age<span class="hljs-string">&quot;:36,&quot;</span>gender<span class="hljs-string">&quot;:&quot;</span>M<span class="hljs-string">&quot;,&quot;</span>address<span class="hljs-string">&quot;:&quot;</span><span class="hljs-number">671</span> Bristol Street<span class="hljs-string">&quot;,&quot;</span>employer<span class="hljs-string">&quot;:&quot;</span>Netagy<span class="hljs-string">&quot;,&quot;</span>email<span class="hljs-string">&quot;:&quot;</span>hattiebond@netagy.com<span class="hljs-string">&quot;,&quot;</span>city<span class="hljs-string">&quot;:&quot;</span>Dante<span class="hljs-string">&quot;,&quot;</span>state<span class="hljs-string">&quot;:&quot;</span>TN<span class="hljs-string">&quot;&#125;</span><br><span class="hljs-string">  &#125;, &#123;</span><br><span class="hljs-string">    &quot;</span>_index<span class="hljs-string">&quot; : &quot;</span>bank<span class="hljs-string">&quot;,</span><br><span class="hljs-string">    &quot;</span>_type<span class="hljs-string">&quot; : &quot;</span>account<span class="hljs-string">&quot;,</span><br></code></pre></td></tr></table></figure><p>上面示例返回所有bank中的索引数据。其中 q=*  表示匹配索引中所有的数据。</p><p>等价于:</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs scilab">curl -XPOST <span class="hljs-string">&#x27;localhost:9200/bank/_search?pretty&#x27;</span> -d <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  &quot;</span>query<span class="hljs-string">&quot;: &#123; &quot;</span>match_all<span class="hljs-string">&quot;: &#123;&#125; &#125;</span><br><span class="hljs-string">&#125;&#x27;</span><br></code></pre></td></tr></table></figure><p>14 查询语言</p><p>匹配所有数据，但只返回1个:</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs scilab">curl -XPOST <span class="hljs-string">&#x27;localhost:9200/bank/_search?pretty&#x27;</span> -d <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string"> 　&quot;</span>query<span class="hljs-string">&quot;: &#123; &quot;</span>match_all<span class="hljs-string">&quot;: &#123;&#125; &#125;,</span><br><span class="hljs-string">  &quot;</span><span class="hljs-built_in">size</span><span class="hljs-string">&quot;: 1</span><br><span class="hljs-string">&#125;&#x27;</span><br></code></pre></td></tr></table></figure><p>注意：如果siez不指定，则默认返回10条数据。</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs scilab">curl -XPOST <span class="hljs-string">&#x27;localhost:9200/bank/_search?pretty&#x27;</span> -d <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string"> 　&quot;</span>query<span class="hljs-string">&quot;: &#123; &quot;</span>match_all<span class="hljs-string">&quot;: &#123;&#125; &#125;,</span><br><span class="hljs-string">  &quot;</span>from<span class="hljs-string">&quot;: 10,</span><br><span class="hljs-string">  &quot;</span><span class="hljs-built_in">size</span><span class="hljs-string">&quot;: 10</span><br><span class="hljs-string">&#125;&#x27;</span><br></code></pre></td></tr></table></figure><p>返回从11到20的数据。（索引下标从0开始）</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs scilab">curl -XPOST <span class="hljs-string">&#x27;localhost:9200/bank/_search?pretty&#x27;</span> -d <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  &quot;</span>query<span class="hljs-string">&quot;: &#123; &quot;</span>match_all<span class="hljs-string">&quot;: &#123;&#125; &#125;,</span><br><span class="hljs-string"> 　&quot;</span>sort<span class="hljs-string">&quot;: &#123; &quot;</span>balance<span class="hljs-string">&quot;: &#123; &quot;</span>order<span class="hljs-string">&quot;: &quot;</span>desc<span class="hljs-string">&quot; &#125; &#125;</span><br><span class="hljs-string">&#125;&#x27;</span><br></code></pre></td></tr></table></figure><p>上述示例匹配所有的索引中的数据，按照balance字段降序排序，并且返回前10条（如果不指定size，默认最多返回10条）。</p><p>15.执行搜索</p><p>下面例子展示如何返回两个字段（account_number balance）</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs scilab">curl -XPOST <span class="hljs-string">&#x27;localhost:9200/bank/_search?pretty&#x27;</span> -d <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  &quot;</span>query<span class="hljs-string">&quot;: &#123; &quot;</span>match_all<span class="hljs-string">&quot;: &#123;&#125; &#125;,</span><br><span class="hljs-string">  &quot;</span>_source<span class="hljs-string">&quot;: [&quot;</span>account_number<span class="hljs-string">&quot;, &quot;</span>balance<span class="hljs-string">&quot;]</span><br><span class="hljs-string">&#125;&#x27;</span><br></code></pre></td></tr></table></figure><p><img src="http://cos.leiyawu.com/img/elk_index_check_8.png" alt="图8"></p><p>返回account_number 为20 的数据:</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs scilab">curl -XPOST <span class="hljs-string">&#x27;localhost:9200/bank/_search?pretty&#x27;</span> -d <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  &quot;</span>query<span class="hljs-string">&quot;: &#123; &quot;</span>match<span class="hljs-string">&quot;: &#123; &quot;</span>account_number<span class="hljs-string">&quot;: 20 &#125; &#125;</span><br><span class="hljs-string">&#125;&#x27;</span><br></code></pre></td></tr></table></figure><p>返回address中包含mill的所有数据：</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs scilab">curl -XPOST <span class="hljs-string">&#x27;localhost:9200/bank/_search?pretty&#x27;</span> -d <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  &quot;</span>query<span class="hljs-string">&quot;: &#123; &quot;</span>match<span class="hljs-string">&quot;: &#123; &quot;</span>address<span class="hljs-string">&quot;: &quot;</span>mill<span class="hljs-string">&quot; &#125; &#125;</span><br><span class="hljs-string">&#125;&#x27;</span><br></code></pre></td></tr></table></figure><p>返回地址中包含mill或者lane的所有数据：</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs scilab">curl -XPOST <span class="hljs-string">&#x27;localhost:9200/bank/_search?pretty&#x27;</span> -d <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string"> 　&quot;</span>query<span class="hljs-string">&quot;: &#123; &quot;</span>match<span class="hljs-string">&quot;: &#123; &quot;</span>address<span class="hljs-string">&quot;: &quot;</span>mill lane<span class="hljs-string">&quot; &#125; &#125;</span><br><span class="hljs-string">&#125;&#x27;</span><br></code></pre></td></tr></table></figure><p>和上面匹配单个词语不同，下面这个例子是多匹配（match_phrase短语匹配），返回地址中包含短语 “mill lane”的所有数据：</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs scilab">curl -XPOST <span class="hljs-string">&#x27;localhost:9200/bank/_search?pretty&#x27;</span> -d <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  &quot;</span>query<span class="hljs-string">&quot;: &#123; &quot;</span>match_phrase<span class="hljs-string">&quot;: &#123; &quot;</span>address<span class="hljs-string">&quot;: &quot;</span>mill lane<span class="hljs-string">&quot; &#125; &#125;</span><br><span class="hljs-string">&#125;&#x27;</span><br></code></pre></td></tr></table></figure><p>以下是布尔查询，布尔查询允许我们将多个简单的查询组合成一个更复杂的布尔逻辑查询。<br>这个例子将两个查询组合，返回地址中含有mill和lane的所有记录数据：</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs scilab">curl -XPOST <span class="hljs-string">&#x27;localhost:9200/bank/_search?pretty&#x27;</span> -d <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  &quot;</span>query<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">    &quot;</span>bool<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">  　　  &quot;</span>must<span class="hljs-string">&quot;: [</span><br><span class="hljs-string">   　　   &#123; &quot;</span>match<span class="hljs-string">&quot;: &#123; &quot;</span>address<span class="hljs-string">&quot;: &quot;</span>mill<span class="hljs-string">&quot; &#125; &#125;,</span><br><span class="hljs-string">   　　   &#123; &quot;</span>match<span class="hljs-string">&quot;: &#123; &quot;</span>address<span class="hljs-string">&quot;: &quot;</span>lane<span class="hljs-string">&quot; &#125; &#125;</span><br><span class="hljs-string">  　　  ]</span><br><span class="hljs-string">  　　&#125;</span><br><span class="hljs-string"> 　&#125;</span><br><span class="hljs-string">&#125;&#x27;</span><br></code></pre></td></tr></table></figure><p>上述例子中，must表示所有查询必须都为真才被认为匹配。</p><p>相反, 这个例子组合两个查询，返回地址中含有mill或者lane的所有记录数据：</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs scilab">curl -XPOST <span class="hljs-string">&#x27;localhost:9200/bank/_search?pretty&#x27;</span> -d <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string"> 　&quot;</span>query<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string"> 　  &quot;</span>bool<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">  　　  &quot;</span>should<span class="hljs-string">&quot;: [</span><br><span class="hljs-string">   　　   &#123; &quot;</span>match<span class="hljs-string">&quot;: &#123; &quot;</span>address<span class="hljs-string">&quot;: &quot;</span>mill<span class="hljs-string">&quot; &#125; &#125;,</span><br><span class="hljs-string">    　　  &#123; &quot;</span>match<span class="hljs-string">&quot;: &#123; &quot;</span>address<span class="hljs-string">&quot;: &quot;</span>lane<span class="hljs-string">&quot; &#125; &#125;</span><br><span class="hljs-string">   　　 ]</span><br><span class="hljs-string">  　 &#125;</span><br><span class="hljs-string"> 　&#125;</span><br><span class="hljs-string">&#125;&#x27;</span><br></code></pre></td></tr></table></figure><p>上述例子中，bool表示查询列表中只要有任何一个为真则认为匹配。</p><p>下面例子组合两个查询，返回地址中既没有mill也没有lane的所有数据：</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs scilab">curl -XPOST <span class="hljs-string">&#x27;localhost:9200/bank/_search?pretty&#x27;</span> -d <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  &quot;</span>query<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string"> 　  &quot;</span>bool<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">  　　  &quot;</span>must_not<span class="hljs-string">&quot;: [</span><br><span class="hljs-string">    　　  &#123; &quot;</span>match<span class="hljs-string">&quot;: &#123; &quot;</span>address<span class="hljs-string">&quot;: &quot;</span>mill<span class="hljs-string">&quot; &#125; &#125;,</span><br><span class="hljs-string">     　　 &#123; &quot;</span>match<span class="hljs-string">&quot;: &#123; &quot;</span>address<span class="hljs-string">&quot;: &quot;</span>lane<span class="hljs-string">&quot; &#125; &#125;</span><br><span class="hljs-string">    　　]</span><br><span class="hljs-string">  　　&#125;</span><br><span class="hljs-string"> 　&#125;</span><br><span class="hljs-string">&#125;&#x27;</span><br></code></pre></td></tr></table></figure><p>上述例子中,must_not表示查询列表中没有为真的（也就是全为假）时则认为匹配。</p><p>我们可以组合must、should、must_not来实现更加复杂的多级逻辑查询。</p><p>下面这个例子返回年龄大于40岁、不居住在ID的所有数据：</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs scilab">curl -XPOST <span class="hljs-string">&#x27;localhost:9200/bank/_search?pretty&#x27;</span> -d <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  &quot;</span>query<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">  　 &quot;</span>bool<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">  　　  &quot;</span>must<span class="hljs-string">&quot;: [</span><br><span class="hljs-string">     　　 &#123; &quot;</span>match<span class="hljs-string">&quot;: &#123; &quot;</span>age<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">40</span><span class="hljs-string">&quot; &#125; &#125;</span><br><span class="hljs-string">   　　 ],</span><br><span class="hljs-string">   　　 &quot;</span>must_not<span class="hljs-string">&quot;: [</span><br><span class="hljs-string">     　　 &#123; &quot;</span>match<span class="hljs-string">&quot;: &#123; &quot;</span>state<span class="hljs-string">&quot;: &quot;</span>ID<span class="hljs-string">&quot; &#125; &#125;</span><br><span class="hljs-string">    　　]</span><br><span class="hljs-string">  　　&#125;</span><br><span class="hljs-string">  &#125;</span><br><span class="hljs-string">&#125;&#x27;</span><br></code></pre></td></tr></table></figure><p>16.过滤filter(查询条件设置)</p><p>下面这个例子使用了布尔查询返回balance在20000到30000之间的所有数据。</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs scilab">curl -XPOST <span class="hljs-string">&#x27;localhost:9200/bank/_search?pretty&#x27;</span> -d <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">　　  &quot;</span>query<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string"> 　　　  &quot;</span>bool<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">  　　　　  &quot;</span>must<span class="hljs-string">&quot;: &#123; &quot;</span>match_all<span class="hljs-string">&quot;: &#123;&#125; &#125;,</span><br><span class="hljs-string">   　　　　 &quot;</span>filter<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">      　　　　&quot;</span>range<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">        　　&quot;</span>balance<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">        　　  &quot;</span>gte<span class="hljs-string">&quot;: 20000,</span><br><span class="hljs-string">         　　 &quot;</span>lte<span class="hljs-string">&quot;: 30000</span><br><span class="hljs-string">       　　 &#125;</span><br><span class="hljs-string">     　　 &#125;</span><br><span class="hljs-string">   　　 &#125;</span><br><span class="hljs-string">  　 &#125;</span><br><span class="hljs-string"> 　&#125;</span><br><span class="hljs-string">&#125;&#x27;</span><br></code></pre></td></tr></table></figure><p>17 聚合 Aggregations<br>下面这个例子： 将所有的数据按照state分组（group），然后按照分组记录数从大到小排序，返回前十条（默认）：</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs scilab">curl -XPOST <span class="hljs-string">&#x27;localhost:9200/bank/_search?pretty&#x27;</span> -d <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string"> 　&quot;</span><span class="hljs-built_in">size</span><span class="hljs-string">&quot;: 0,</span><br><span class="hljs-string">  &quot;</span>aggs<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">  　 &quot;</span>group_by_state<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">  　　  &quot;</span>terms<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">   　　　   &quot;</span>field<span class="hljs-string">&quot;: &quot;</span>state<span class="hljs-string">&quot;</span><br><span class="hljs-string">  　　  &#125;</span><br><span class="hljs-string">  　 &#125;</span><br><span class="hljs-string"> 　&#125;</span><br><span class="hljs-string">&#125;&#x27;</span><br></code></pre></td></tr></table></figure><p>注意：我们设置size=0，不显示查询hits，因为我们只想看返回的聚合结果。<br><img src="http://cos.leiyawu.com/img/elk_index_check_9.png" alt="图9"></p><p><img src="http://cos.leiyawu.com/img/elk_index_check_10.png" alt="图10"></p><p>上述语句类似于以下SQL语句：<br>SELECT state, COUNT(<em>) FROM bank GROUP BY state ORDER BY COUNT(</em>) DESC</p><p>下面这个实例按照state分组，降序排序，返回balance的平均值：</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs scilab">curl -XPOST <span class="hljs-string">&#x27;localhost:9200/bank/_search?pretty&#x27;</span> -d <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string"> 　&quot;</span><span class="hljs-built_in">size</span><span class="hljs-string">&quot;: 0,</span><br><span class="hljs-string"> 　&quot;</span>aggs<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">  　 &quot;</span>group_by_state<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">  　　  &quot;</span>terms<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">     　　 &quot;</span>field<span class="hljs-string">&quot;: &quot;</span>state<span class="hljs-string">&quot;</span><br><span class="hljs-string">   　　 &#125;,</span><br><span class="hljs-string">  　　  &quot;</span>aggs<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">     　　 &quot;</span>average_balance<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">      　　  &quot;</span>avg<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">       　　   &quot;</span>field<span class="hljs-string">&quot;: &quot;</span>balance<span class="hljs-string">&quot;</span><br><span class="hljs-string">       　　 &#125;</span><br><span class="hljs-string">     　　 &#125;</span><br><span class="hljs-string">   　　 &#125;</span><br><span class="hljs-string">  　　&#125;</span><br><span class="hljs-string"> 　&#125;</span><br><span class="hljs-string">&#125;&#x27;</span><br></code></pre></td></tr></table></figure><p><img src="http://cos.leiyawu.com/img/elk_index_check_11.png" alt="图11"></p>]]></content>
    
    
    <categories>
      
      <category>ELK</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ELK</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ELK的一次吞吐量优化</title>
    <link href="/2018/04/03/elk/"/>
    <url>/2018/04/03/elk/</url>
    
    <content type="html"><![CDATA[<h2 id="问题一"><a href="#问题一" class="headerlink" title="问题一"></a>问题一</h2><p>  ● 最近发现kibana的日志传的很慢，常常查不到日志，由于所有的日志收集都只传输到了一个logstash进行收集和过滤，于是怀疑是否是由于logstash的吞吐量存在瓶颈。一看，还真是到了瓶颈。</p><p>  ● 优化过程</p><p>  ● 经过查询logstash完整配置文件，有几个参数需要调整</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># pipeline线程数，官方建议是等于CPU内核数</span><br><span class="hljs-attr">pipeline.workers:</span> <span class="hljs-number">24</span><br><span class="hljs-comment"># 实际output时的线程数</span><br><span class="hljs-attr">pipeline.output.workers:</span> <span class="hljs-number">24</span><br><span class="hljs-comment"># 每次发送的事件数</span><br><span class="hljs-attr">pipeline.batch.size:</span> <span class="hljs-number">3000</span><br><span class="hljs-comment"># 发送延时</span><br><span class="hljs-attr">pipeline.batch.delay:</span> <span class="hljs-number">5</span><br></code></pre></td></tr></table></figure><p>PS:由于我们的ES集群数据量较大（&gt;28T），所以具体配置数值视自身生产环境</p><h2 id="问题二"><a href="#问题二" class="headerlink" title="问题二"></a>问题二</h2><p>  ● 在查看logstash日志过程中，我们看到了大量的以下报错</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-attr">[2017-03-18T09:46:21,043]</span><span class="hljs-selector-attr">[INFO ]</span><span class="hljs-selector-attr">[logstash.outputs.elasticsearch]</span> retrying failed action with response <span class="hljs-selector-tag">code</span>: <span class="hljs-number">429</span> (&#123;<span class="hljs-string">&quot;type&quot;</span>=&gt;<span class="hljs-string">&quot;es_rejected_execution_exception&quot;</span>, <span class="hljs-string">&quot;reason&quot;</span>=&gt;<span class="hljs-string">&quot;rejected execution of org.elasticsearch.transport.TransportService$6@6918cf2e on EsThreadPoolExecutor[bulk, queue capacity = 50, org.elasticsearch.common.util.concurrent.EsThreadPoolExecutor@55337655[Running, pool size = 24, active threads = 24, queued tasks = 50, completed tasks = 1767887463]]&quot;</span>&#125;)<br><span class="hljs-selector-attr">[2017-03-18T09:46:21,043]</span><span class="hljs-selector-attr">[ERROR]</span><span class="hljs-selector-attr">[logstash.outputs.elasticsearch]</span> Retrying individual actions<br></code></pre></td></tr></table></figure><p>  ● 查询官网，确认为时ES的写入遇到了瓶颈</p><p>  ● Make sure to watch for TOO_MANY_REQUESTS (429) response codes (EsRejectedExecutionException with the Java client), which is the way that Elasticsearch tells you that it cannot keep up with the current indexing rate. When it happens, you should pause indexing a bit before trying again, ideally with randomized exponential backoff.</p><p>我们首先想到的是来调整ES的线程数，但是官网写到”Don’t Touch There Settings!”, 那怎么办？于是乎官方建议我们修改logstash的参数pipeline.batch.size</p><p>  ● 在ES5.0以后，es将bulk、flush、get、index、search等线程池完全分离，自身的写入不会影响其他功能的性能。<br>来查询一下ES当前的线程情况：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET _nodes<span class="hljs-regexp">/stats/</span>thread_pool?pretty<br><br>可以看到：<br>&#123;<br>  <span class="hljs-string">&quot;_nodes&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;total&quot;</span>: <span class="hljs-number">6</span>,<br>    <span class="hljs-string">&quot;successful&quot;</span>: <span class="hljs-number">6</span>,<br>    <span class="hljs-string">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-string">&quot;cluster_name&quot;</span>: <span class="hljs-string">&quot;dev-elasticstack5.0&quot;</span>,<br>  <span class="hljs-string">&quot;nodes&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;nnfCv8FrSh-p223gsbJVMA&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;timestamp&quot;</span>: <span class="hljs-number">1489804973926</span>,<br>      <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;node-3&quot;</span>,<br>      <span class="hljs-string">&quot;transport_address&quot;</span>: <span class="hljs-string">&quot;192.168.3.***:9301&quot;</span>,<br>      <span class="hljs-string">&quot;host&quot;</span>: <span class="hljs-string">&quot;192.168.3.***&quot;</span>,<br>      <span class="hljs-string">&quot;ip&quot;</span>: <span class="hljs-string">&quot;192.168.3.***:9301&quot;</span>,<br>      <span class="hljs-string">&quot;roles&quot;</span>: [<br>        <span class="hljs-string">&quot;master&quot;</span>,<br>        <span class="hljs-string">&quot;data&quot;</span>,<br>        <span class="hljs-string">&quot;ingest&quot;</span><br>      ],<br>      <span class="hljs-string">&quot;attributes&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;rack&quot;</span>: <span class="hljs-string">&quot;r1&quot;</span><br>      &#125;,<br>      <span class="hljs-string">&quot;thread_pool&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;bulk&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;threads&quot;</span>: <span class="hljs-number">24</span>,<br>          <span class="hljs-string">&quot;queue&quot;</span>: <span class="hljs-number">214</span>,<br>          <span class="hljs-string">&quot;active&quot;</span>: <span class="hljs-number">24</span>,<br>          <span class="hljs-string">&quot;rejected&quot;</span>: <span class="hljs-number">30804543</span>,<br>          <span class="hljs-string">&quot;largest&quot;</span>: <span class="hljs-number">24</span>,<br>          <span class="hljs-string">&quot;completed&quot;</span>: <span class="hljs-number">1047606679</span><br>        &#125;,<br><br>        ......<br><br>        <span class="hljs-string">&quot;watcher&quot;</span>: &#123;<br>  <span class="hljs-string">&quot;threads&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;queue&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;active&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;rejected&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;largest&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;completed&quot;</span>: <span class="hljs-number">0</span><br>&#125;<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>其中：”bulk”模板的线程数24，当前活跃的线程数24，证明所有的线程是busy的状态，queue队列214，rejected为30804543。那么问题就找到了，所有的线程都在忙，队列堵满后再有进程写入就会被拒绝，而当前拒绝数为30804543。<br>优化方案<br>问题找到了，如何优化呢。官方的建议是提高每次批处理的数量，调节传输间歇时间。当batch.size增大，es处理的事件数就会变少，写入也就愉快了。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">vim</span> /etc/logstash/logstash.yml<br><span class="hljs-comment">#</span><br><span class="hljs-attribute">pipeline</span>.workers: <span class="hljs-number">24</span><br><span class="hljs-attribute">pipeline</span>.output.workers: <span class="hljs-number">24</span><br><span class="hljs-attribute">pipeline</span>.batch.size: <span class="hljs-number">10000</span><br><span class="hljs-attribute">pipeline</span>.batch.delay: <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure><p>具体的worker/output.workers数量建议等于CPU数，batch.size/batch.delay根据实际的数据量逐渐增大来测试最优值。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>23种非常有用的ElasticSearch查询例子</title>
    <link href="/2018/04/02/asd/"/>
    <url>/2018/04/02/asd/</url>
    
    <content type="html"><![CDATA[<h2 id="一、新建索引"><a href="#一、新建索引" class="headerlink" title="一、新建索引"></a>一、新建索引</h2><p>为了展示Elasticsearch中不同查询的用法，先在Elasticsearch里面创建了book相关的documents，每本书主要涉及以下字段： title, authors, summary, publish_date(发行日期),publisher以及评论条数。</p><p>操作如下：</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">curl -XPUT &#x27;https://www.iteblog.com:9200/iteblog_book_index&#x27; -d &#x27;&#123; &quot;settings&quot;: &#123; &quot;number_of_shards&quot;: 1 &#125;&#125;&#x27;<br><br>curl -XPOST &#x27;https://www.iteblog.com:9200/iteblog_book_index/book/_bulk&#x27; -d &#x27;<br>&#123; &quot;<span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: 1 &#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-built_in">title</span><span class="hljs-string">&quot;: &quot;</span>Elasticsearch: The Definitive Guide<span class="hljs-string">&quot;, &quot;</span>authors<span class="hljs-string">&quot;: [&quot;</span>clinton gormley<span class="hljs-string">&quot;, &quot;</span>zachary tong<span class="hljs-string">&quot;], &quot;</span>summary<span class="hljs-string">&quot; : &quot;</span>A distibuted real-time search <span class="hljs-keyword">and</span> analytics engine<span class="hljs-string">&quot;, &quot;</span>publish_date<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2015</span><span class="hljs-number">-02</span><span class="hljs-number">-07</span><span class="hljs-string">&quot;, &quot;</span>num_reviews<span class="hljs-string">&quot;: 20, &quot;</span>publisher<span class="hljs-string">&quot;: &quot;</span>oreilly<span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: 2 &#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-built_in">title</span><span class="hljs-string">&quot;: &quot;</span>Taming Text: How <span class="hljs-keyword">to</span> Find, Organize, <span class="hljs-keyword">and</span> Manipulate It<span class="hljs-string">&quot;, &quot;</span>authors<span class="hljs-string">&quot;: [&quot;</span><span class="hljs-keyword">grant</span> ingersoll<span class="hljs-string">&quot;, &quot;</span>thomas morton<span class="hljs-string">&quot;, &quot;</span>drew farris<span class="hljs-string">&quot;], &quot;</span>summary<span class="hljs-string">&quot; : &quot;</span>organize text <span class="hljs-keyword">using</span> approaches such <span class="hljs-keyword">as</span> full-text search, proper name recognition, clustering, tagging, information extraction, <span class="hljs-keyword">and</span> summarization<span class="hljs-string">&quot;, &quot;</span>publish_date<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2013</span><span class="hljs-number">-01</span><span class="hljs-number">-24</span><span class="hljs-string">&quot;, &quot;</span>num_reviews<span class="hljs-string">&quot;: 12, &quot;</span>publisher<span class="hljs-string">&quot;: &quot;</span>manning<span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: 3 &#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-built_in">title</span><span class="hljs-string">&quot;: &quot;</span>Elasticsearch <span class="hljs-keyword">in</span> Action<span class="hljs-string">&quot;, &quot;</span>authors<span class="hljs-string">&quot;: [&quot;</span>radu gheorge<span class="hljs-string">&quot;, &quot;</span>matthew lee hinman<span class="hljs-string">&quot;, &quot;</span>roy russo<span class="hljs-string">&quot;], &quot;</span>summary<span class="hljs-string">&quot; : &quot;</span><span class="hljs-keyword">build</span> scalable search applications <span class="hljs-keyword">using</span> Elasticsearch without <span class="hljs-keyword">having</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">do</span> complex low-level programming <span class="hljs-keyword">or</span> understand advanced data science algorithms<span class="hljs-string">&quot;, &quot;</span>publish_date<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2015</span><span class="hljs-number">-12</span><span class="hljs-number">-03</span><span class="hljs-string">&quot;, &quot;</span>num_reviews<span class="hljs-string">&quot;: 18, &quot;</span>publisher<span class="hljs-string">&quot;: &quot;</span>manning<span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: 4 &#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-built_in">title</span><span class="hljs-string">&quot;: &quot;</span>Solr <span class="hljs-keyword">in</span> Action<span class="hljs-string">&quot;, &quot;</span>authors<span class="hljs-string">&quot;: [&quot;</span>trey grainger<span class="hljs-string">&quot;, &quot;</span>timothy potter<span class="hljs-string">&quot;], &quot;</span>summary<span class="hljs-string">&quot; : &quot;</span>Comprehensive guide <span class="hljs-keyword">to</span> implementing a scalable search engine <span class="hljs-keyword">using</span> Apache Solr<span class="hljs-string">&quot;, &quot;</span>publish_date<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2014</span><span class="hljs-number">-04</span><span class="hljs-number">-05</span><span class="hljs-string">&quot;, &quot;</span>num_reviews<span class="hljs-string">&quot;: 23, &quot;</span>publisher<span class="hljs-string">&quot;: &quot;</span>manning<span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#x27;</span><br><span class="hljs-string"></span><br></code></pre></td></tr></table></figure><p>通过dev tools来模拟则为：<br><a href="http://cos.leiyawu.com/img/elk_index_check_1.png">http://cos.leiyawu.com/img/elk_index_check_1.png</a></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">POST /iteblog_book_index/book/_bulk<br>&#123; &quot;<span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: 1 &#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-built_in">title</span><span class="hljs-string">&quot;: &quot;</span>Elasticsearch: The Definitive Guide<span class="hljs-string">&quot;, &quot;</span>authors<span class="hljs-string">&quot;: [&quot;</span>clinton gormley<span class="hljs-string">&quot;, &quot;</span>zachary tong<span class="hljs-string">&quot;], &quot;</span>summary<span class="hljs-string">&quot; : &quot;</span>A distibuted real-time search <span class="hljs-keyword">and</span> analytics engine<span class="hljs-string">&quot;, &quot;</span>publish_date<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2015</span><span class="hljs-number">-02</span><span class="hljs-number">-07</span><span class="hljs-string">&quot;, &quot;</span>num_reviews<span class="hljs-string">&quot;: 20, &quot;</span>publisher<span class="hljs-string">&quot;: &quot;</span>oreilly<span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: 2 &#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-built_in">title</span><span class="hljs-string">&quot;: &quot;</span>Taming Text: How <span class="hljs-keyword">to</span> Find, Organize, <span class="hljs-keyword">and</span> Manipulate It<span class="hljs-string">&quot;, &quot;</span>authors<span class="hljs-string">&quot;: [&quot;</span><span class="hljs-keyword">grant</span> ingersoll<span class="hljs-string">&quot;, &quot;</span>thomas morton<span class="hljs-string">&quot;, &quot;</span>drew farris<span class="hljs-string">&quot;], &quot;</span>summary<span class="hljs-string">&quot; : &quot;</span>organize text <span class="hljs-keyword">using</span> approaches such <span class="hljs-keyword">as</span> full-text search, proper name recognition, clustering, tagging, information extraction, <span class="hljs-keyword">and</span> summarization<span class="hljs-string">&quot;, &quot;</span>publish_date<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2013</span><span class="hljs-number">-01</span><span class="hljs-number">-24</span><span class="hljs-string">&quot;, &quot;</span>num_reviews<span class="hljs-string">&quot;: 12, &quot;</span>publisher<span class="hljs-string">&quot;: &quot;</span>manning<span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: 3 &#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-built_in">title</span><span class="hljs-string">&quot;: &quot;</span>Elasticsearch <span class="hljs-keyword">in</span> Action<span class="hljs-string">&quot;, &quot;</span>authors<span class="hljs-string">&quot;: [&quot;</span>radu gheorge<span class="hljs-string">&quot;, &quot;</span>matthew lee hinman<span class="hljs-string">&quot;, &quot;</span>roy russo<span class="hljs-string">&quot;], &quot;</span>summary<span class="hljs-string">&quot; : &quot;</span><span class="hljs-keyword">build</span> scalable search applications <span class="hljs-keyword">using</span> Elasticsearch without <span class="hljs-keyword">having</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">do</span> complex low-level programming <span class="hljs-keyword">or</span> understand advanced data science algorithms<span class="hljs-string">&quot;, &quot;</span>publish_date<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2015</span><span class="hljs-number">-12</span><span class="hljs-number">-03</span><span class="hljs-string">&quot;, &quot;</span>num_reviews<span class="hljs-string">&quot;: 18, &quot;</span>publisher<span class="hljs-string">&quot;: &quot;</span>manning<span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: 4 &#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-built_in">title</span><span class="hljs-string">&quot;: &quot;</span>Solr <span class="hljs-keyword">in</span> Action<span class="hljs-string">&quot;, &quot;</span>authors<span class="hljs-string">&quot;: [&quot;</span>trey grainger<span class="hljs-string">&quot;, &quot;</span>timothy potter<span class="hljs-string">&quot;], &quot;</span>summary<span class="hljs-string">&quot; : &quot;</span>Comprehensive guide <span class="hljs-keyword">to</span> implementing a scalable search engine <span class="hljs-keyword">using</span> Apache Solr<span class="hljs-string">&quot;, &quot;</span>publish_date<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2014</span><span class="hljs-number">-04</span><span class="hljs-number">-05</span><span class="hljs-string">&quot;, &quot;</span>num_reviews<span class="hljs-string">&quot;: 23, &quot;</span>publisher<span class="hljs-string">&quot;: &quot;</span>manning<span class="hljs-string">&quot; &#125;</span><br></code></pre></td></tr></table></figure><p>ES中的查询请求有两种方式，一种是简易版的查询，另外一种是使用JSON完整的请求体，叫做结构化查询（DSL）。<br>由于DSL查询更为直观也更为简易，所以大都使用这种方式。<br>DSL查询是POST过去一个json，由于post的请求是json格式的，所以存在很多灵活性，也有很多形式。</p><p>基本匹配查询主要形式：<br>（1）、使用Search Lite API，并将所有的搜索参数都通过URL传递<br>（2）、使用Elasticsearch DSL，其可以通过传递一个JSON请求来获取结果。Curl方式与其类似，只是提交方式不是POST，而是XGET，提交参数与DSL提交一致</p><p>二、基本匹配查询(Basic Match Query)<br>1、在所有的字段中搜索带有”guide”的结果：<br>通过dev tools:<br>GET /iteblog_book_index/book/_search?q=guide</p><p>通过curl方式：<br>curl -u elastic “<a href="http://10.104.37.115:9281/iteblog_book_index/book/_search?pretty&quot;">http://10.104.37.115:9281/iteblog_book_index/book/_search?pretty&quot;</a> -d ‘<br>{<br>    “query”: {<br>        “multi_match” : {<br>            “query” : “guide”,<br>            “fields” : [“_all”]<br>        }<br>    }<br>}’</p><p>通过DSL：(POST json方式)</p><p>其输出和上面使用/iteblog_book_index/book/_search?q=guide的输出一样。上面的multi_match关键字通常在查询多个fields的时候作为match关键字的简写方式。fields属性指定需要查询的字段，如果我们想查询所有的字段，这时候可以使用_all关键字，正如上面的一样。</p><p>如果只是查询summary字段，则为：</p><p>title的Guide则不会显示。</p><p>2、以上两种方式都允许我们指定查询哪些字段。比如，我们想查询title中出现in Action的图书，那么我们可以这么查询：</p><p>GET /iteblog_book_index/book/_search?q=title:in%20action</p><p>然而，DSL方式提供了更加灵活的方式来构建更加复杂的查询（我们将在后面看到），甚至指定你想要的返回结果。下面的例子中，我将指定需要返回结果的数量，开始的偏移量（这在分页的情况下非常有用），需要返回document中的哪些字段以及高亮关键字：</p><p>curl -XGET ‘<a href="https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;">https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;</a> -d ‘<br>{<br>    “query”: {<br>        “match” : {<br>            “title” : “in action”<br>        }<br>    },<br>    “size”: 2,   #返回结果的数量<br>    “from”: 0,  #开始的偏移量<br>    “_source”: [ “title”, “summary”, “publish_date” ],<br>    “highlight”: {<br>        “fields” : {<br>            “title” : {}<br>        }<br>    }<br>}’</p><span id="more"></span><p>三、Multi-field Search<br>正如我们之前所看到的，想在一个搜索中查询多个 document field （比如使用同一个查询关键字同时在title和summary中查询），你可以使用multi_match查询，使用如下：<br>curl -XGET ‘<a href="https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;">https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;</a> -d ‘<br>{<br>    “query”: {<br>        “multi_match” : {<br>            “query” : “elasticsearch guide”,<br>            “fields”: [“title”, “summary”]<br>        }<br>    }<br>}’</p><p>四、Boosting<br>上面使用同一个搜索请求在多个field中查询，你也许想提高某个field的查询权重。在下面的例子中，我们把summary field的权重调成3，这样就提高了其在结果中的权重，这样把_id=4的文档相关性大大提高了，如下：</p><p>curl -XGET ‘<a href="https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;">https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;</a> -d ‘<br>{<br>    “query”: {<br>        “multi_match” : {<br>            “query” : “elasticsearch guide”,<br>            “fields”: [“title”, “summary^3”]<br>        }<br>    },<br>    “_source”: [“title”, “summary”, “publish_date”]<br>}’</p><p>需要注意的是：Boosting不仅仅意味着计算出来的分数(calculated score)直接乘以boost factor，最终的boost value会经过归一化以及其他一些内部的优化</p><p>五、Bool Query<br>在查询条件中使用AND/OR/NOT操作符，这就是布尔查询(Bool Query)。布尔查询可以接受一个must参数(等价于AND)，一个must_not参数(等价于NOT)，以及一个should参数(等价于OR)。比如，我想查询title中出现Elasticsearch或者Solr关键字的图书，图书的作者是clinton gormley，但没有radu gheorge，可以这么来查询：</p><p>curl -XGET ‘<a href="https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;">https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;</a> -d ‘<br>{<br>    “query”: {<br>        “bool”: {<br>            “must”: {<br>                “bool” : { “should”: [<br>                      { “match”: { “title”: “Elasticsearch” }},<br>                      { “match”: { “title”: “Solr” }} ] }<br>            },<br>            “must”: { “match”: { “authors”: “clinton gormely” }},<br>            “must_not”: { “match”: {“authors”: “radu gheorge” }}<br>        }<br>    }<br>}’</p><p>六、Fuzzy Queries（模糊查询）<br>模糊查询可以在Match和 Multi-Match查询中使用以便解决拼写的错误，模糊度是基于Levenshtein distance计算与原单词的距离。使用如下：<br>curl -XGET ‘<a href="https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;">https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;</a> -d ‘<br>{<br>    “query”: {<br>        “multi_match” : {<br>            “query” : “comprihensiv guide”,<br>            “fields”: [“title”, “summary”],<br>            “fuzziness”: “AUTO”<br>        }<br>    },<br>    “_source”: [“title”, “summary”, “publish_date”],<br>    “size”: 1<br>}’</p><p>需要注意：上面我们将fuzziness的值指定为AUTO，其在term的长度大于5的时候相当于指定值为2。然而80%的人拼写错误的编辑距离(edit distance)为1，所有如果你将fuzziness设置为1可能会提高你的搜索性能。</p><p>七、Wildcard Query(通配符查询)<br>通配符查询允许我们指定一个模式来匹配，而不需要指定完整的term。?将会匹配一个字符；<em>将会匹配零个或者多个字符。比如我们想查找所有作者名字中以t字符开始的记录，我们可以如下使用：<br>curl -XGET ‘<a href="https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;">https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;</a> -d ‘<br>{<br>    “query”: {<br>        “wildcard” : {      #wildcard是通配符意思<br>            “authors” : “t</em>“<br>        }<br>    },<br>    “_source”: [“title”, “authors”],<br>    “highlight”: {<br>        “fields” : {<br>            “authors” : {}<br>        }<br>    }<br>}’</p><p>八、Regexp Query(正则表达式查询)<br>ElasticSearch还支持正则表达式查询，此方式提供了比通配符查询更加复杂的模式。比如我们先查找作者名字以t字符开头，中间是若干个a-z之间的字符，并且以字符y结束的记录，可以如下查询：</p><p>curl -XGET ‘<a href="https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;">https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;</a> -d ‘<br>{<br>    “query”: {<br>        “regexp” : {<br>            “authors” : “t[a-z]*y”<br>        }<br>    },<br>    “_source”: [“title”, “authors”],<br>    “highlight”: {<br>        “fields” : {<br>            “authors” : {}<br>        }<br>    }<br>}’</p><p>九、Match Phrase Query(匹配短语查询)<br>匹配短语查询要求查询字符串中的trems要么都出现Document中、要么trems按照输入顺序依次出现在结果中。在默认情况下，查询输入的trems必须在搜索字符串紧挨着出现，否则将查询不到。不过我们可以指定slop参数，来控制输入的trems之间有多少个单词仍然能够搜索到，如下所示：<br>curl -XGET ‘<a href="https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;">https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;</a> -d ‘<br>{<br>    “query”: {<br>        “multi_match”: {<br>            “query”: “search engine”,<br>            “fields”: [<br>                “title”,<br>                “summary”<br>            ],<br>            “type”: “phrase”,<br>            “slop”: 3<br>        }<br>    },<br>    “_source”: [<br>        “title”,<br>        “summary”,<br>        “publish_date”<br>    ]<br>}’</p><p>从上面的例子可以看出，id为4的document被搜索（summary字段里面精确匹配到了search engine），并且分数比较高；而id为1的document也被搜索到了，虽然其summary中的search和engine单词并不是紧挨着的，但是我们指定了slop属性，所以被搜索到了。如果我们将”slop”: 3条件删除，那么id为1的文档将不会被搜索到，如下：</p><p>十、Simple Query String(简单查询字符串)<br>simple_query_string是query_string的另一种版本，其更适合为用户提供一个搜索框中，因为其使用+/|/- 分别替换AND/OR/NOT，如果用输入了错误的查询，其直接忽略这种情况而不是抛出异常。使用如下：(注意是POST)<br>curl POST <a href="https://www.iteblog.com:9200/iteblog_book_index/book/_search">https://www.iteblog.com:9200/iteblog_book_index/book/_search</a><br>{<br>    “query”: {<br>        “simple_query_string” : {<br>            “query”: “(saerch<del>1 algorithm</del>1) + (grant ingersoll)  | (tom morton)”,<br>            “fields”: [“_all”, “summary^2”]<br>        }<br>    },<br>    “_source”: [ “title”, “summary”, “authors” ],<br>    “highlight”: {<br>        “fields” : {<br>            “summary” : {}<br>        }<br>    }<br>}</p><p>十一、Term/Terms Query<br>前面的例子中我们已经介绍了全文搜索(full-text search)，但有时候我们对结构化搜索中能够精确匹配并返回搜索结果更感兴趣。这种情况下我们可以使用term和terms查询。在下面例子中，我们想搜索所有曼宁出版社(Manning Publications)出版的图书：</p><p>curl POST <a href="https://www.iteblog.com:9200/iteblog_book_index/book/_search">https://www.iteblog.com:9200/iteblog_book_index/book/_search</a> -d ‘<br>{<br>    “query”: {<br>        “term” : {<br>            “publisher”: “manning”<br>        }<br>    },<br>    “_source” : [“title”,”publish_date”,”publisher”]<br>}’</p><p>还可以使用terms关键字来指定多个terms，如下：</p><p>{<br>    “query”: {<br>        “terms” : {<br>            “publisher”: [“oreilly”, “packt”]<br>        }<br>    }<br>}</p><p>十二、Term Query - Sorted<br>词查询结果和其他查询结果一样可以很容易地对其进行排序，而且我们可以对输出结果按照多层进行排序：<br>curl POST <a href="https://www.iteblog.com:9200/iteblog_book_index/book/_search">https://www.iteblog.com:9200/iteblog_book_index/book/_search</a><br>{<br>    “query”: {<br>        “term” : {<br>            “publisher”: “manning”<br>        }<br>    },<br>    “_source” : [“title”,”publish_date”,”publisher”],<br>    “sort”: [<br>        { “publish_date”: {“order”:”desc”}},<br>        { “title”: { “order”: “desc” }}<br>    ]<br>}</p><p>执行提示：<br>Fielddata is disabled on text fields by default. Set fielddata=true on [title] in order to load fielddata in memory by uninverting the inverted index</p><p>应该是5.x后对排序，聚合这些操作用单独的数据结构(fielddata)缓存到内存里了，需要单独开启</p><p>PUT /iteblog_book_index/_mapping/book<br>{<br>  “properties”: {<br>    “title”: {<br>      “type”: “text”,<br>      “fielddata”: true<br>    }<br>  }<br>}</p><p>再次执行：</p><p>十三、Range Query(范围查询)<br>另一种结构化查询就是范围查询。在下面例子中，我们搜索所有发行年份为2015的图书：<br>curl POST <a href="https://www.iteblog.com:9200/iteblog_book_index/book/_search">https://www.iteblog.com:9200/iteblog_book_index/book/_search</a><br>{<br>    “query”: {<br>        “range” : {<br>            “publish_date”: {<br>                “gte”: “2015-01-01”,<br>                “lte”: “2015-12-31”<br>            }<br>        }<br>    },<br>    “_source” : [“title”,”publish_date”,”publisher”]<br>}</p><p>十四、Filtered Query(过滤查询)<br>过滤查询允许我们对查询结果进行筛选。比如：我们查询标题和摘要中包含Elasticsearch关键字的图书，但是我们想过滤出评论大于20的结果，可以如下使用：</p><p>curl POST <a href="https://www.iteblog.com:9200/iteblog_book_index/book/_search">https://www.iteblog.com:9200/iteblog_book_index/book/_search</a><br>{<br>    “query”: {<br>        “filtered”: {<br>            “query” : {<br>                “multi_match”: {<br>                    “query”: “elasticsearch”,<br>                    “fields”: [“title”,”summary”]<br>                }<br>            },<br>            “filter”: {<br>                “range” : {<br>                    “num_reviews”: {<br>                        “gte”: 20<br>                    }<br>                }<br>            }<br>        }<br>    },<br>    “_source” : [“title”,”summary”,”publisher”, “num_reviews”]<br>}</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>hexo使用进阶</title>
    <link href="/2018/03/19/hexo%E4%BD%BF%E7%94%A8%E8%BF%9B%E9%98%B6/"/>
    <url>/2018/03/19/hexo%E4%BD%BF%E7%94%A8%E8%BF%9B%E9%98%B6/</url>
    
    <content type="html"><![CDATA[<h3 id="一、后端管理插件hexo-admin"><a href="#一、后端管理插件hexo-admin" class="headerlink" title="一、后端管理插件hexo-admin"></a>一、后端管理插件hexo-admin</h3><ul><li>插件可以直接在网页端创建、编辑markdown文章内容，并将内容发布到_posts里。</li><li>另外，对我而言，最方便的是可以很方便的给文章加标题、分类、打标签。</li></ul><p>参见：</p><ul><li>An Admin Interface for Hexo</li><li>hexo-admin in github</li></ul><h4 id="1-安装"><a href="#1-安装" class="headerlink" title="1.安装"></a>1.安装</h4><p>(1)npm install –save hexo-admin </p><p>(2)hexo server -d </p><p>(3)open <a href="http://localhost:4000/admin/">http://localhost:4000/admin/</a></p><h4 id="2-配置"><a href="#2-配置" class="headerlink" title="2.配置"></a>2.配置</h4><p>在_config.yml最后添加类似如下内容：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">admin</span>:<br>  <span class="hljs-attribute">username</span>: myfavoritename<br>  <span class="hljs-attribute">password_hash</span>: be<span class="hljs-number">121740</span>bf<span class="hljs-number">988</span>b<span class="hljs-number">2225</span>a<span class="hljs-number">313</span>fa<span class="hljs-number">1</span>f<span class="hljs-number">107</span>ca<span class="hljs-number">1</span><br>  <span class="hljs-attribute">secret</span>: a secret something<br><br><span class="hljs-attribute">username</span>：后端登录用户名<br><br><span class="hljs-attribute">password_hash</span>：后端登录用户密码对应的md<span class="hljs-number">5</span> hash值<br><br><span class="hljs-attribute">secret</span>：用于保证cookie安全<br></code></pre></td></tr></table></figure><h4 id="3-预览"><a href="#3-预览" class="headerlink" title="3.预览"></a>3.预览</h4>]]></content>
    
    
    <categories>
      
      <category>hexo</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>hexo fs.SyncWriteStream is deprecated</title>
    <link href="/2018/02/28/hexo-fs-SyncWriteStream-is-deprecated/"/>
    <url>/2018/02/28/hexo-fs-SyncWriteStream-is-deprecated/</url>
    
    <content type="html"><![CDATA[<p>fs.SyncWriteStream is deprecated 出现这个错误需要更新hexo-fs插件</p><p>使用</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ada">npm install hexo-fs <span class="hljs-comment">--save</span><br><br></code></pre></td></tr></table></figure><p>在执行hexo命令的时候，总会显示如下报错：</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">(<span class="hljs-keyword">node</span><span class="hljs-title">:7048</span>) [DEP0061] DeprecationWarning: fs.SyncWriteStream is deprecated.<br></code></pre></td></tr></table></figure><p>从报错信息来看是因为fs.SyncWriteStream is deprecated，node.js从8.0开始已经弃用了fs.SyncWriteStream方法，所以是因为我们node_modules中某个插件调用了这个方法，通过查看Hexo作者GitHub对应的项目，在issue中看到有人提到这个问题，在hexo项目中其中有一个hexo-fs的插件调用了这个方法，所以需要更新hexo-fs插件，更新方法如下：</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">npm install hexo-fs <span class="hljs-comment">--save</span><br></code></pre></td></tr></table></figure><p>更新插件后问题依然无法解决。</p><p>通过–debug来查看：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[root@server init]# hexo --<span class="hljs-builtin-name">debug</span><br>06:55:32.711 <span class="hljs-builtin-name">DEBUG</span> Hexo version: 3.5.0<br>06:55:32.714 <span class="hljs-builtin-name">DEBUG</span> Working directory: /data/wwwroot/init/<br>06:55:32.787 <span class="hljs-builtin-name">DEBUG</span><span class="hljs-built_in"> Config </span>loaded: /data/wwwroot/init/_config.yml<br>06:55:32.832 <span class="hljs-builtin-name">DEBUG</span> Plugin loaded: hexo-admin<br>(node:25414) [DEP0061] DeprecationWarning: fs.SyncWriteStream is deprecated.<br></code></pre></td></tr></table></figure><p>问题出在：hexo-admin的hexo-fs<br>因hexo-admin作为后台管理，无法npm uninstall hexo-admin卸载,则找到对应文件，注释：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@server init]# <span class="hljs-keyword">grep</span> -irn <span class="hljs-string">&quot;SyncWriteStream&quot;</span> .<span class="hljs-regexp">/node_modules/</span>hexo-admin/<br>.<span class="hljs-regexp">/node_modules/</span>hexo-admin<span class="hljs-regexp">/node_modules/</span>hexo-fs<span class="hljs-regexp">/lib/</span>fs.js:<span class="hljs-number">718</span>:exports.SyncWriteStream = fs.SyncWriteStream;<br>[root@lywserver init]# <br></code></pre></td></tr></table></figure><p>将对应的exports.SyncWriteStream = fs.SyncWriteStream;注释(前面 //)即可！</p>]]></content>
    
    
    <categories>
      
      <category>hexo</category>
      
    </categories>
    
    
    <tags>
      
      <tag>SyncWriteStream </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ELK x-pack 详细说明</title>
    <link href="/2018/02/26/name/"/>
    <url>/2018/02/26/name/</url>
    
    <content type="html"><![CDATA[<p>我还能说什么呢？？</p>]]></content>
    
    
    <categories>
      
      <category>ELK</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ELK</tag>
      
      <tag>x-pack</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Postman 入门</title>
    <link href="/2017/05/07/Postman-%E5%85%A5%E9%97%A8/"/>
    <url>/2017/05/07/Postman-%E5%85%A5%E9%97%A8/</url>
    
    <content type="html"><![CDATA[<ul><li>官网： <a href="https://www.getpostman.com/">https://www.getpostman.com</a>  </li><li><strong>可能是目前最好用的web接口调试工具</strong></li><li>无需注册（注册后可多终端同步用例）</li><li>免费（每年付费$60可用云服务，30天免费试用）</li><li>保存历史记录</li><li>支持录制请求</li><li>基于Chrome的V8引擎，支持JS脚本（基本支持ES6，浏览器相关对象和API和<code>require()</code> <code>import</code>等除外）</li><li>同样的代码和用例可用于自动化接口测试，见它的命令行版本<a href="https://www.getpostman.com/docs/newman_intro">Newman</a>介绍</li><li>能生成各种语言的HTTP请求代码模板</li><li>能生成比较好看的在线API文档</li><li>官网提供简易版持续集成环境（只支持公网IP的请求）</li></ul><p>限制：</p><ul><li>JS代码在沙盒里运行，需要读写文件和数据库的场景请用JMeter</li><li>非HTTP协议、需要引入第三方库、需要重用大量代码、需要……凡是稍微复杂点的请用JMeter</li></ul><hr><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p><a href="https://www.getpostman.com/apps">https://www.getpostman.com/apps</a></p><p>建议选择Mac/Windows app，比起Chrome app，下载不需要翻墙，功能更强大</p><hr><h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><blockquote><p><a href="https://www.getpostman.com/docs/">官方文档</a>  </p></blockquote><p>教程  </p><blockquote><p><a href="http://blog.qiji.tech/archives/6575">[API 测试]postman</a>, 2016-02-29<br><a href="http://www.bayescafe.com/tools/use-postman-to-test-api-automatically.html">API自动化测试利器——Postman</a>, 2015-09-26（教程里的版本比较旧了，但还是讲得不错）<br><a href="http://blog.getpostman.com/2015/09/03/how-to-write-powerful-automated-api-tests-with-postman-newman-and-jenkins/">How to write powerful automated API tests with Postman, Newman and Jenkins</a>, 2015-09-03<br><a href="http://blog.getpostman.com/2014/03/07/writing-automated-tests-for-apis-using-postman/">How to write automated tests for APIs using Postman – Part 1</a>, 2014-03-07<br><a href="http://blog.getpostman.com/2014/04/17/how-to-write-automated-tests-for-apis-with-postman-part-2/">How to write automated tests for APIs with Postman – Part 2</a>, 2014-04-17<br><a href="http://blog.getpostman.com/2014/05/09/writing-automated-tests-with-postman-part-3/">Writing automated tests with Postman – Part 3</a>, 2014-05-09</p><ul><li>有些早期文章会提到Jetpack，曾经收10美元，现在是Postman左上角的Runner，可以批量执行用例</li></ul></blockquote><p>示例</p><p><a href="https://echo.getpostman.com/">Postman Echo</a></p><blockquote><p><a href="http://blog.getpostman.com/2015/11/13/making-the-perfect-http-request-using-postman-echo/">Making the perfect HTTP request using Postman Echo</a>, 2015-11-13</p></blockquote><p><a href="https://documenter.getpostman.com/view/583/coopers-meal-plan/4u2">Cooper’s Meal Plan</a></p><blockquote><p><a href="http://blog.getpostman.com/2016/03/23/conditional-workflows-in-postman/">Conditional Workflows in Postman</a>, 2016-03-23</p></blockquote><p><a href="https://documenter.getpostman.com/view/583/spotify-playlist-generator-v1/2MtDWP">Spotify Playlist Generator</a></p><blockquote><p><a href="http://blog.getpostman.com/2016/11/09/generate-spotify-playlists-using-a-postman-collection/">Generate Spotify Playlists using a Postman Collection</a>, 2016-11-09</p></blockquote><p>CurencyCloud的<a href="https://www.getpostman.com/collections/43e4377fd2e9d187dd0e">Postman集合</a>和<a href="https://github.com/CurrencyCloud/postman">使用说明</a></p><hr><h3 id="录制接口"><a href="#录制接口" class="headerlink" title="录制接口"></a>录制接口</h3><blockquote><p><a href="https://www.getpostman.com/docs/capture_native">Capturing requests (native app)</a><br><a href="http://blog.getpostman.com/2016/06/26/using-postman-proxy-to-capture-and-inspect-api-calls-from-ios-or-android-devices/">Using Postman Proxy to Capture and Inspect API Calls from iOS or Android Devices</a>，2016-06-26</p></blockquote><p>接口调用方希望测试业务逻辑时，用不着Fiddler/Charles抓包再往里面一个个填这么麻烦<br>开启Postman的代理（默认5555端口），浏览器/手机设好对应的IP和端口就行，比JMeter的自带的代理方便 : )  </p><p>支持正则表达式过滤URL</p><p>可以设置保存的集合，<strong>建议保存到历史记录</strong>，因为会录到不想要的东西，只有历史记录有一键清空  </p><hr><h3 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h3><blockquote><p><a href="https://www.getpostman.com/docs/environments">Setting up an environment with variables</a>  </p></blockquote><p>分为 environment 和 global 2种</p><p>2种环境变量分别存到内建的<code>environment</code>、<code>globals</code>对象（字典）<br>变量名作为key，变量的值作为value（一律存储为字符串） </p><p>通过菜单设置，或在用例里通过代码设置且经Postman运行过的环境变量默认存到IndexedDB，设了就一直在，除非你把它删了<br>（这话很拗口，看到下文数据文件的部分就知道了）</p><h4 id="environment"><a href="#environment" class="headerlink" title="environment"></a>environment</h4><p>满足99%的需要，平时只用它就够了</p><ul><li>作用域为整个集合</li><li>能创建多个environment文件，方便切换不同测试环境</li></ul><p>在地址栏、header、请求参数、外部数据文件里，用 <code>&#123;&#123;变量名&#125;&#125;</code> 获取环境变量的值<br>如：<code>&#123;&#123;URL&#125;&#125;/register</code></p><p>还有以下内建变量，适合一次性使用：</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">$guid</span>&#125;&#125;</span><span class="xml">  生成GUID</span><br><span class="xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">$timestamp</span>&#125;&#125;</span><span class="xml">  当前时间戳</span><br><span class="xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">$randomInt</span>&#125;&#125;</span><span class="xml">  0-1000的随机整数</span><br></code></pre></td></tr></table></figure><h4 id="global"><a href="#global" class="headerlink" title="global"></a>global</h4><p>跟environment几乎完全一样，也是<code>&#123;&#123;&#125;&#125;</code>调用，除了：</p><ul><li>只有1个global文件</li><li>菜单藏得较深，在生成的API文档里也不解析，决定了它不适合做参数化</li><li>environment和global同名时，优先用environment</li></ul><p>global只建议用在1种场景：<strong>定义公共函数</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 先正常地写好函数，再缩成一行，可以考虑用在线压缩工具</span><br><span class="hljs-comment">// 在菜单里选 Bulk Edit，以每行一对 key:value 的形式编辑，变量名做key，函数做value</span><br><span class="hljs-attr">assertType</span>:<span class="hljs-keyword">var</span> assertType = <span class="hljs-function">(<span class="hljs-params">name, value, type</span>) =&gt;</span> &#123;<span class="hljs-keyword">if</span> (type === <span class="hljs-string">&#x27;array&#x27;</span>) &#123;tests[<span class="hljs-string">`Expect <span class="hljs-subst">$&#123;name&#125;</span> to be <span class="hljs-subst">$&#123;type&#125;</span>: <span class="hljs-subst">$&#123;value&#125;</span>`</span>] = <span class="hljs-built_in">Array</span>.isArray(value);&#125; <span class="hljs-keyword">else</span> &#123;tests[<span class="hljs-string">`Expect <span class="hljs-subst">$&#123;name&#125;</span> to be <span class="hljs-subst">$&#123;type&#125;</span>: <span class="hljs-subst">$&#123;value&#125;</span>`</span>] = <span class="hljs-keyword">typeof</span> value === type;&#125;&#125;;<br><span class="hljs-comment">// 注意在这里定义变量只有 var 的作用域够大，用 let 或 const 的话eval后就销毁了</span><br><br><span class="hljs-comment">// 在代码里用eval拿到</span><br><span class="hljs-built_in">eval</span>(globals.assertType);<br><br><span class="hljs-keyword">let</span> name = <span class="hljs-string">&#x27;张三&#x27;</span>;<br><span class="hljs-keyword">let</span> type = <span class="hljs-number">1</span>;<br>assertType(<span class="hljs-string">&#x27;user name&#x27;</span>, name, <span class="hljs-string">&#x27;string&#x27;</span>)  <span class="hljs-comment">// 输出： Expect user name to be string, actual: 张三</span><br>assertType(<span class="hljs-string">&#x27;user type&#x27;</span>, type, <span class="hljs-string">&#x27;number&#x27;</span>)  <span class="hljs-comment">// 输出： Expect user type to be number, actual: 1</span><br></code></pre></td></tr></table></figure><blockquote><p><a href="http://blog.getpostman.com/2015/09/29/writing-a-behaviour-driven-api-testing-environment-within-postman/">Writing a behaviour driven API testing environment within Postman</a></p></blockquote><p>在官方给出更方便的重用代码的方法前，这是除了复制粘贴外唯一的重用方法<br>如果不做自动化测试，且断言写得很简单，不建议这么搞  </p><p>如果不幸跳了自动化的坑，通常一个项目会有100~200个接口要做自动化测试，要仔细比较哪种方法成本更高<br>定义函数前要仔细考虑好，万一中途要改参数和返回值，已经写好的n份也得改……</p><p>建议定义的公共函数不超过个位数，并保留好没压缩的版本，不然别人没法接手</p><hr><h3 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h3><blockquote><p><a href="https://www.getpostman.com/docs/sandbox">Testing Sandbox</a>  内建对象、方法、变量和可用的第三方库介绍<br><a href="https://www.getpostman.com/docs/testing_examples">Testing examples</a><br><a href="http://blog.getpostman.com/2014/01/27/extracting-data-from-responses-and-chaining-requests/">Extracting data from responses and chaining requests</a>, 2014-10-27</p></blockquote><p>JavaScript的语法不再赘述，上例子</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 下面出现的environment、postman、tests、responseCode、request、responseTime、responseBody均为Postman内建</span><br><span class="hljs-comment">// 具体见上面链接里的文档</span><br><br><span class="hljs-comment">/* 获取环境变量 */</span><br><span class="hljs-keyword">let</span> foo = environment.yourVariableName;  <span class="hljs-comment">// 或 environment[&#x27;yourVariableName&#x27;]</span><br><br><span class="hljs-comment">// 多个可以用ES6的object destructuring语法：</span><br><span class="hljs-keyword">let</span> &#123;foo, bar, foobar&#125; = environment;<br><br><span class="hljs-comment">// 注意值都是字符串，想要其他类型要转换：</span><br><span class="hljs-keyword">let</span> num = <span class="hljs-built_in">Number</span>(environment.yourVariableName);<br><span class="hljs-keyword">let</span> bool = <span class="hljs-built_in">Boolean</span>(environment.yourVariableName);  <span class="hljs-comment">// 或 !!environment.yourVariableName</span><br><br><br><span class="hljs-comment">/* 设置环境变量 */</span><br>postman.setEnvironmentVariable(<span class="hljs-string">&#x27;yourVariableName&#x27;</span>, <span class="hljs-string">&#x27;value&#x27;</span>);  <span class="hljs-comment">// 值是字符串或能转成字符串的类型</span><br><br><span class="hljs-comment">/* 更新环境变量 */</span><br><span class="hljs-comment">// 就是再调一次上面的方法，赋不同的值</span><br><br><span class="hljs-comment">/* 清除环境变量 */</span><br>postman.clearEnvironmentVariable(<span class="hljs-string">&#x27;yourVariableName&#x27;</span>);<br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/* 断言 */</span><br><span class="hljs-comment">// tests的key会显示在界面上，value是可以解析为boolean的表达式，true显示为成功，false失败</span><br>tests[<span class="hljs-string">&#x27;Status code is 200&#x27;</span>] = responseCode.code === <span class="hljs-number">200</span>;  <span class="hljs-comment">// 推荐用全等 ===，确保类型和值都一致</span><br>tests[<span class="hljs-string">&#x27;Response time is less than 400ms&#x27;</span>] = responseTime &lt; <span class="hljs-number">400</span>;<br><br><span class="hljs-comment">// 变通：用总是为真的断言来显示信息</span><br>tests[<span class="hljs-string">`[INFO] Request params: <span class="hljs-subst">$&#123;<span class="hljs-built_in">JSON</span>.stringify(request.data)&#125;</span>`</span>] = <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 显示所有请求参数（在自动化测试里很有用）</span><br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/* 提取接口返回值 */</span><br><span class="hljs-comment">// 返回JSON：</span><br><span class="hljs-keyword">let</span> json = <span class="hljs-built_in">JSON</span>.parse(responseBody);  <span class="hljs-comment">// responseBody是包含整个返回内容的字符串</span><br><span class="hljs-comment">// 提取某字段的值：</span><br><span class="hljs-keyword">let</span> foobar = json.foo.bar[<span class="hljs-number">0</span>].foobar;  <span class="hljs-comment">// 假设结构为 &#123;&quot;foo&quot;: &#123;&quot;bar&quot;: [&#123;&quot;foobar&quot;: 1&#125;, &#123;&quot;baz&quot;: 2&#125;]&#125;&#125;</span><br><br><span class="hljs-comment">// 想用在自动化测试可以多写点：</span><br><span class="hljs-keyword">let</span> json;<br><span class="hljs-keyword">try</span> &#123;<br>  json = <span class="hljs-built_in">JSON</span>.parse(responseBody);<br>&#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>  tests[<span class="hljs-string">&#x27;Expect response body to be valid JSON&#x27;</span>] = <span class="hljs-literal">false</span>;<br>  tests[<span class="hljs-string">`Response body: <span class="hljs-subst">$&#123;responseBody&#125;</span>`</span>] = <span class="hljs-literal">true</span>;<br>  <span class="hljs-built_in">console</span>.error(err);<br>&#125;<br><br><span class="hljs-comment">// 返回HTML等：</span><br><span class="hljs-comment">// A. 用正则匹配</span><br><span class="hljs-keyword">let</span> foo = responseBody.match(<span class="hljs-regexp">/foo/g</span>);  <span class="hljs-comment">// g 全局 i 不分大小写 m 多行</span><br>tests[<span class="hljs-string">&#x27;blahblahblah&#x27;</span>] = foo[<span class="hljs-number">0</span>] === <span class="hljs-string">&#x27;bar&#x27;</span>;<br><span class="hljs-comment">// 正则表达式包含变量时：</span><br><span class="hljs-keyword">let</span> foo = <span class="hljs-string">&#x27;xxx&#x27;</span>;<br><span class="hljs-keyword">let</span> bar = responseBody.match(<span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">`^<span class="hljs-subst">$&#123;foo&#125;</span>.*$`</span>, <span class="hljs-string">&#x27;g&#x27;</span>);<br><br><span class="hljs-comment">// B. 用CheerioJS库</span><br><span class="hljs-keyword">let</span> html = cheerio(responseBody);<br><span class="hljs-keyword">let</span> titleText = html.find(<span class="hljs-string">&#x27;title&#x27;</span>).text();  <span class="hljs-comment">// 取 &lt;title&gt;标签里的文字</span><br><br><span class="hljs-comment">// C. 只要有文字就行，不管在哪、有几个</span><br><span class="hljs-keyword">let</span> foo = responseBody.has(<span class="hljs-string">&#x27;xxx&#x27;</span>);<br></code></pre></td></tr></table></figure><blockquote><p><a href="http://blog.getpostman.com/2016/08/30/jquery-replaced-by-cheeriojs-in-postman-sandbox/">jQuery replaced by CheerioJS in Postman Sandbox</a>, 2016-08-30</p></blockquote><p>其他请参考文档和界面右边的代码模板</p><p>PS：<br>Postman毕竟不是IDE，只有部分语法高亮和提示，没方法和参数的提示，全靠笔记和查文档</p><hr><h3 id="数据文件"><a href="#数据文件" class="headerlink" title="数据文件"></a>数据文件</h3><blockquote><p><a href="https://www.getpostman.com/docs/multiple_instances">Using data variables to run a collection multiple times</a><br><a href="http://blog.getpostman.com/2014/10/28/using-csv-and-json-files-in-the-postman-collection-runner/">Using CSV and JSON data files in the Postman Collection Runner</a>, 2014-10-28<br><a href="http://blog.getpostman.com/2014/02/20/using-variables-inside-postman-and-collection-runner/">Using variables inside Postman and Collection Runner</a>, 2014-02-20</p></blockquote><p>在Collection Runner或命令行的Newman里可以加载数据文件，适合做数据驱动测试（例如同一接口不同的参数组合）</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// JSON格式：</span><br><span class="hljs-comment">// 每条用例1个对象，变量名和值为键值对，整个文件为1个数组</span><br><span class="hljs-comment">// 文件里依然可以用 &#123;&#123;&#125;&#125; 拿到环境变量</span><br><span class="hljs-comment">// 例：</span><br>[<br>  &#123;<span class="hljs-string">&quot;mobile&quot;</span>: <span class="hljs-string">&quot;17000000001&quot;</span>, <span class="hljs-string">&quot;pwd&quot;</span>: <span class="hljs-string">&quot;123456&quot;</span>&#125;,<br>  &#123;<span class="hljs-string">&quot;mobile&quot;</span>: <span class="hljs-string">&quot;17000000002&quot;</span>, <span class="hljs-string">&quot;pwd&quot;</span>: <span class="hljs-string">&quot;654321&quot;</span>&#125;,<br>  &#123;<span class="hljs-string">&quot;mobile&quot;</span>: <span class="hljs-string">&quot;17000000003&quot;</span>, <span class="hljs-string">&quot;pwd&quot;</span>: <span class="hljs-string">&quot;&quot;</span>&#125;,<br>  &#123;<span class="hljs-string">&quot;mobile&quot;</span>: <span class="hljs-string">&quot;&#123;&#123;ADMIN_MOBILE&#125;&#125;&quot;</span>, <span class="hljs-string">&quot;pwd&quot;</span>: <span class="hljs-string">&quot;&#123;&#123;ADMIN_PWD&#125;&#125;&quot;</span>&#125;<br>]<br><br><span class="hljs-comment">// CSV格式：</span><br><span class="hljs-comment">// 第1行变量名，下面是值，每行1条用例，没有空格</span><br>mobile,pwd<br><span class="hljs-number">17000000001</span>,<span class="hljs-number">123456</span><br><span class="hljs-number">17000000002</span>,<span class="hljs-number">654321</span><br><span class="hljs-number">17000000003</span>,<br><br><br><span class="hljs-comment">// 用例的请求参数里照旧用 &#123;&#123;&#125;&#125; 拿到数据文件里定义的变量</span><br><span class="hljs-comment">// 如x-www-form-urlencoded的请求参数：</span><br>telephone  &#123;&#123;mobile&#125;&#125;<br>password   &#123;&#123;pwd&#125;&#125;<br><br><span class="hljs-comment">// 如果文件里定义的变量跟environment/global重名，优先用文件里的</span><br><br><span class="hljs-comment">// 代码里想得到当前循环次数，用 iteration（从0开始）  </span><br><span class="hljs-comment">// 想得到数据文件里的变量值，用 data.yourVariableName （data对象包含数据文件里第n条用例的所有变量）</span><br></code></pre></td></tr></table></figure><p>PS：<br>在用例里通过代码设置的环境变量，如果在Runner或Newman里运行，默认不保存，跑完用例就消失</p><hr><h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><p><code>cmd + alt + c</code>（windows <code>ctrl + alt + c</code>）打开Postman控制台，可以看请求和响应内容</p><p><code>console.log()</code>打印</p><hr><h3 id="mock"><a href="#mock" class="headerlink" title="mock"></a>mock</h3><blockquote><p><a href="http://blog.getpostman.com/2016/01/26/using-a-mocking-service-to-create-postman-collections/">Using a mocking service to create Postman Collections</a>，2016-01-26</p></blockquote><hr><h3 id="收费功能"><a href="#收费功能" class="headerlink" title="收费功能"></a>收费功能</h3><p>目前管理员不能解散自己创建的团队，不能删别人创建的环境变量模板，几乎残废  </p><h4 id="团队协作"><a href="#团队协作" class="headerlink" title="团队协作"></a>团队协作</h4><blockquote><p><a href="http://blog.getpostman.com/2016/10/27/new-more-useful-activity-feed-in-postman-collections/">New, More Useful Activity Feed in Postman Collections</a>, 2016-10-27<br><a href="http://blog.getpostman.com/2016/03/10/environment-sharing/">Announcing: Environment Sharing!</a>, 2016-03-10</p></blockquote><h4 id="发布"><a href="#发布" class="headerlink" title="发布"></a>发布</h4><blockquote><p><a href="http://blog.getpostman.com/2016/01/28/the-run-in-postman-button-for-improved-documentation/">Call for Partners: The Run in Postman Button for API documentation</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>postman</category>
      
    </categories>
    
    
    <tags>
      
      <tag>postman</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
