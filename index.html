<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 2px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="让一切随风" type="application/atom+xml" />






<meta name="description" content="Still Waters Run Deep">
<meta property="og:type" content="website">
<meta property="og:title" content="让一切随风">
<meta property="og:url" content="http://www.leiyawu.com/index.html">
<meta property="og:site_name" content="让一切随风">
<meta property="og:description" content="Still Waters Run Deep">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="让一切随风">
<meta name="twitter:description" content="Still Waters Run Deep">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.leiyawu.com/"/>





  <title>让一切随风</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?818040458700af5a2881ef01ecd8fd0a";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  
  <style>
  .forkMeOnGithub{
  display: none;
  }
  @media (min-width: 768px) {
  .forkMeOnGithub{
   display: inline;
   }
  }  
  </style>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>
  <div class="forkMeOnGithub">
  <a href="https://github.com/hannius"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"></a>
  </div>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">让一切随风</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Martin's Blog</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-message">
          <a href="/message" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-external-link"></i> <br />
            
            留言
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.leiyawu.com/2018/08/19/只在移动端网页内显示”Fork-me-on-Github”/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Martin Lei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="让一切随风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/19/只在移动端网页内显示”Fork-me-on-Github”/" itemprop="url">只在移动端网页内显示”Fork me on Github”</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-19T15:48:00+08:00">
                2018-08-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hexo/" itemprop="url" rel="index">
                    <span itemprop="name">hexo</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h6 id="1-修改文件hexo博客根目录-themes-next-layout-layout-swig-找到如下代码块"><a href="#1-修改文件hexo博客根目录-themes-next-layout-layout-swig-找到如下代码块" class="headerlink" title="1.修改文件hexo博客根目录\themes\next\layout_layout.swig 找到如下代码块"></a>1.修改文件hexo博客根目录\themes\next\layout_layout.swig 找到如下代码块</h6><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">class</span>=<span class="string">"</span></span></span><span class="template-variable">&#123;&#123; html_class | lower &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">"</span> <span class="attr">lang</span>=<span class="string">"</span></span></span><span class="template-variable">&#123;&#123; config.language &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">include</span></span> '_partials/head.swig' %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">title</span>&gt;</span></span><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> title %&#125;</span><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<h6 id="2-添加代码，结果如下："><a href="#2-添加代码，结果如下：" class="headerlink" title="2.添加代码，结果如下："></a>2.添加代码，结果如下：</h6><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">class</span>=<span class="string">"</span></span></span><span class="template-variable">&#123;&#123; html_class | lower &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">"</span> <span class="attr">lang</span>=<span class="string">"</span></span></span><span class="template-variable">&#123;&#123; config.language &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">include</span></span> '_partials/head.swig' %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">title</span>&gt;</span></span><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> title %&#125;</span><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">include</span></span> '_third-party/analytics/index.swig' %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">  </span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span></span><br><span class="line"><span class="xml">  .forkMeOnGithub&#123;</span></span><br><span class="line"><span class="xml">  display: none;</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml">  @media (min-width: 768px) &#123;</span></span><br><span class="line"><span class="xml">  .forkMeOnGithub&#123;</span></span><br><span class="line"><span class="xml">   display: inline;</span></span><br><span class="line"><span class="xml">   &#125;</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<h6 id="3-最后在之前引用代码块上套上div加上class就行了，代码如下"><a href="#3-最后在之前引用代码块上套上div加上class就行了，代码如下" class="headerlink" title="3.最后在之前引用代码块上套上div加上class就行了，代码如下"></a>3.最后在之前引用代码块上套上div加上class就行了，代码如下</h6><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;div <span class="attribute">class</span>=<span class="string">"forkMeOnGithub"</span>&gt;</span><br><span class="line">&lt;a <span class="attribute">href</span>=<span class="string">"https://github.com/hannius"</span>&gt;&lt;img <span class="attribute">style</span>=<span class="string">"position........&lt;/a&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.leiyawu.com/2018/06/27/ubernetes-RBAC-Detailed/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Martin Lei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="让一切随风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/27/ubernetes-RBAC-Detailed/" itemprop="url">Kubernetes RBAC  Detailed</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-27T18:47:00+08:00">
                2018-06-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/K8s/" itemprop="url" rel="index">
                    <span itemprop="name">K8s</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>RBAC - 基于角色的访问控制<br>RBAC使用：rbac.authorization.k8s.io API Group 来实现授权决策，允许管理员通过 Kubernetes API 动态配置策略，要启用RBAC，需要在 apiserver 中添加参数–authorization-mode=RBAC，如果使用的kubeadm安装的集群，1.6 版本以上的都默认开启了RBAC，可以通过查看 Master 节点上 apiserver 的静态Pod定义文件：</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cat /usr/<span class="class"><span class="keyword">lib</span>/<span class="title">systemd</span>/<span class="title">system</span>/<span class="title">kube</span>-<span class="title">apiserver</span>.<span class="title">service</span></span></span><br><span class="line">或者是：</span><br><span class="line">$ cat /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">...</span><br><span class="line">    - --authorization-mode=Node,RBAC</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>如果是二进制的方式搭建的集群，添加这个参数过后，记得要重启 apiserver 服务。</p>
<hr>
<h3 id="RBAC-API-对象"><a href="#RBAC-API-对象" class="headerlink" title="RBAC API 对象"></a>RBAC API 对象</h3><p>Kubernetes有一个很基本的特性就是它的所有资源对象都是模型化的 API 对象，允许执行 CRUD(Create、Read、Update、Delete)操作(也就是我们常说的增、删、改、查操作)，比如下面的这下资源：</p>
<ul>
<li>Pods</li>
<li>ConfigMaps</li>
<li>Deployments</li>
<li>Nodes</li>
<li>Secrets</li>
<li>Namespaces</li>
</ul>
<p>上面这些资源对象的可能存在的操作有：</p>
<ul>
<li>create</li>
<li>get</li>
<li>delete</li>
<li>list</li>
<li>update</li>
<li>edit</li>
<li>watch</li>
<li>exec</li>
</ul>
<p>在更上层，这些资源和API Group 进行关联，比如Pods属于Core API Group，而Deployements属于 apps API Group，要在Kubernetes中进行RBAC的管理，除了上面的这些资源和操作以外，我们还需要另外的一些对象：</p>
<ol>
<li>Rule：规则，规则是一组属于不同API Group 资源上的一组操作的集合</li>
<li>Role 和 ClusterRole：角色和集群角色，这两个对象都包含上面的Rules 元素，二者的区别在于，在Role 中，定义的规则只适用于单个命名空间，也就是和namespace 关联的，而ClusterRole 是集群范围内的，因此定义的规则不受命名空间的约束。另外Role和 ClusterRole在Kubernetes中都被定义为集群内部的API 资源，和Pod、ConfigMap 这些类似，都是集群的资源对象，所以同样的可以使用kubectl相关的命令来进行操作</li>
<li>Subject：主题，对应在集群中尝试操作的对象，集群中定义了3种类型的主题资源：<ul>
<li>User Account：用户，这是有外部独立服务进行管理的，管理员进行私钥的分配，用户可以使用KeyStone或者Goolge 帐号，甚至一个用户名和密码的文件列表也可以。对于用户的管理集群内部没有一个关联的资源对象，所以用户不能通过集群内部的API 来进行管理</li>
<li>Group：组，这是用来关联多个账户的，集群中有一些默认创建的组，比如cluster-admin</li>
<li>Service Account：服务帐号，通过Kubernetes API 来管理的一些用户帐号，和namespace 进行关联的，适用于集群内部运行的应用程序，需要通过API 来完成权限认证，所以在集群内部进行权限操作，都需要使用到 ServiceAccount</li>
</ul>
</li>
<li>RoleBinding和 ClusterRoleBinding：角色绑定和集群角色绑定，简单来说就是把声明的Subject和Role 进行绑定的过程(给某个用户绑定上操作的权限)，二者的区别也是作用范围的区别：RoleBinding只会影响到当前namespace 下面的资源操作权限，而ClusterRoleBinding会影响到所有的 namespace。</li>
</ol>
<hr>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p>通过如下示例来演示RBAC的配置方法：</p>
<h4 id="创建一个只能访问某个-namespace-的用户"><a href="#创建一个只能访问某个-namespace-的用户" class="headerlink" title="创建一个只能访问某个 namespace 的用户"></a>创建一个只能访问某个 namespace 的用户</h4><p>创建一个 User Account，只能访问 kube-system这个命名空间：</p>
<ul>
<li>username: martin</li>
<li>group: op</li>
</ul>
<h5 id="第一步：创建用户凭证"><a href="#第一步：创建用户凭证" class="headerlink" title="第一步：创建用户凭证"></a>第一步：创建用户凭证</h5><p>Kubernetes没有User Account的API 对象，不过要创建一个用户帐号的话也是挺简单的，利用管理员分配的一个私钥就可以创建了。<br>创建方法有两种:</p>
<h6 id="1-使用OpenSSL证书来创建User；"><a href="#1-使用OpenSSL证书来创建User；" class="headerlink" title="1. 使用OpenSSL证书来创建User；"></a>1. 使用OpenSSL证书来创建User；</h6><ul>
<li>给用户martin创建一个私钥，命名成：martin.key：</li>
</ul>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl genrsa -out martin.<span class="type">key</span> <span class="number">2048</span></span><br></pre></td></tr></table></figure>
<ul>
<li>使用刚刚创建的私钥创建一个证书签名请求文件：martin.csr，要注意需要确保在-subj参数中指定用户名和组(CN表示用户名，O表示组)：</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl req -new -key martin<span class="selector-class">.key</span> -out martin<span class="selector-class">.csr</span> -subj <span class="string">"/CN=martin/O=op"</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>然后找到Kubernetes集群的CA，我们使用的是kubeadm安装的集群，CA相关证书位于/etc/kubernetes/pki/目录下面，如果是二进制方式搭建的，应该在最开始搭建集群的时候就已经指定好了CA的目录(/data/kubernetes/ssl)，然后利用该目录下面的ca.crt和ca.key两个文件来批准上面的证书请求</p>
</li>
<li><p>生成最终的证书文件，这里设置证书的有效期为500天</p>
</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ openssl x509 -req -<span class="keyword">in</span> martin<span class="selector-class">.csr</span> -CA /data/kubernetes/ssl/ca<span class="selector-class">.crt</span> -CAkey /data/kubernetes/ssl/ca<span class="selector-class">.key</span> -CAcreateserial -out martin<span class="selector-class">.crt</span> -days <span class="number">500</span></span><br><span class="line">现在查看当前文件夹下面是否生成了一个证书文件：</span><br><span class="line">$ ls</span><br><span class="line">martin<span class="selector-class">.csr</span> martin<span class="selector-class">.key</span> martin.crt</span><br></pre></td></tr></table></figure>
<ul>
<li>现在可以使用刚刚创建的证书文件和私钥文件在集群中创建新的凭证和上下文(Context):</li>
</ul>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl<span class="built_in"> config </span>set-credentials martin <span class="attribute">--client-certificate</span>=martin.crt  <span class="attribute">--client-key</span>=martin.key</span><br></pre></td></tr></table></figure>
<ul>
<li>可以看到一个用户martin创建了，然后为这个用户设置新的 Context:</li>
</ul>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl<span class="built_in"> config </span>set-context martin-context <span class="attribute">--cluster</span>=kubernetes <span class="attribute">--namespace</span>=kube-system <span class="attribute">--user</span>=martin</span><br></pre></td></tr></table></figure>
<p>到这里，用户martin就已经创建成功了，现在使用当前的这个配置文件来操作kubectl命令的时候，应该会出现错误，因为还没有为该用户定义任何操作的权限：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="builtin-name">get</span> pods <span class="attribute">--context</span>=martin-context</span><br><span class="line"><span class="builtin-name">Error</span> <span class="keyword">from</span><span class="built_in"> server </span>(Forbidden): pods is forbidden:<span class="built_in"> User </span><span class="string">"martin"</span> cannot list pods <span class="keyword">in</span> the namespace <span class="string">"default"</span></span><br></pre></td></tr></table></figure>
<h6 id="2-使用cfssl工具来创建，也是参考官方文档中的方法。"><a href="#2-使用cfssl工具来创建，也是参考官方文档中的方法。" class="headerlink" title="2. 使用cfssl工具来创建，也是参考官方文档中的方法。"></a>2. 使用cfssl工具来创建，也是参考官方文档中的方法。</h6><ul>
<li><p>CFSSL是CloudFlare开源的一款PKI/TLS工具。 CFSSL 包含一个命令行工具和一个用于签名，验证并且捆绑TLS证书的HTTP API服务。使用Go语言编写。</p>
</li>
<li><p>CFSSL包括：</p>
<ul>
<li>一组用于生成自定义TLS PKI的工具</li>
<li>cfssl程序，是CFSSL的命令行工具</li>
<li>multirootca程序是可以使用多个签名密钥的证书颁发机构服务器</li>
<li>mkbundle程序用于构建证书池</li>
<li>cfssljson程序，从cfssl和multirootca程序获取JSON输出，并将证书，密钥，CSR和bundle写入磁盘</li>
</ul>
</li>
<li><p>PKI借助数字证书和公钥加密技术提供可信任的网络身份。通常，证书就是一个包含如下身份信息的文件：</p>
<ul>
<li>证书所有组织的信息</li>
<li>公钥</li>
<li>证书颁发组织的信息</li>
<li>证书颁发组织授予的权限，如证书有效期、适用的主机名、用途等</li>
<li>使用证书颁发组织私钥创建的数字签名</li>
</ul>
</li>
<li><p>cfssl工具，子命令介绍：</p>
<ul>
<li>bundle: 创建包含客户端证书的证书包</li>
<li>genkey: 生成一个key(私钥)和CSR(证书签名请求)</li>
<li>scan: 扫描主机问题</li>
<li>revoke: 吊销证书</li>
<li>certinfo: 输出给定证书的证书信息，跟cfssl-certinfo 工具作用一样</li>
<li>gencrl: 生成新的证书吊销列表</li>
<li>selfsign: 生成一个新的自签名密钥和签名证书</li>
<li>print-defaults: 打印默认配置，这个默认配置可以用作模板</li>
<li>serve: 启动一个HTTP API服务</li>
<li>gencert: 生成新的key(密钥)和签名证书</li>
<li>-ca：指明ca的证书</li>
<li>-ca-key：指明ca的私钥文件</li>
<li>-config：指明请求证书的json文件</li>
<li>-profile：与-config中的profile对应，是指根据config中的prof  ile段来生成证书的相关信息</li>
<li>ocspdump</li>
<li>ocspsign</li>
<li>info: 获取有关远程签名者的信息</li>
<li>sign: 签名一个客户端证书，通过给定的CA和CA密钥，和主机名</li>
<li>ocsprefresh</li>
<li>ocspserve</li>
</ul>
</li>
<li><p>创建认证中心(CA)，也就是Kubernetes集群的CA，上面用openssl时已经将其省略了，现cfssl操作说明下详细方法：</p>
<ol>
<li><p>CFSSL可以创建一个获取和操作证书的内部认证中心。运行认证中心需要一个CA证书和相应的CA私钥。任何知道私钥的人都可以充当CA颁发证书。因此，私钥的保护至关重要。</p>
</li>
<li><p>创建用来生成CA文件的JSON配置文件,配置证书生成策略，让CA软件知道颁发什么样的证书。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ssl]# vim ca-config.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"signing"</span>: &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">      <span class="string">"expiry"</span>: <span class="string">"8760h"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"profiles"</span>: &#123;</span><br><span class="line">      <span class="string">"kubernetes"</span>: &#123;</span><br><span class="line">        <span class="string">"usages"</span>: [</span><br><span class="line">            <span class="string">"signing"</span>,</span><br><span class="line">            <span class="string">"key encipherment"</span>,</span><br><span class="line">            <span class="string">"server auth"</span>,</span><br><span class="line">            <span class="string">"client auth"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"expiry"</span>: <span class="string">"8760h"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">这个策略，有一个默认的配置，和一个profile，可以设置多个profile，这里的profile   是kubernetes。</span><br><span class="line">默认策略，指定了证书的有效期是一年(8760h)</span><br><span class="line">kubernetes策略，指定了证书的用途</span><br><span class="line">signing, 表示该证书可用于签名其它证书；生成的ca.pem 证书中   <span class="attribute">CA</span>=<span class="literal">TRUE</span></span><br><span class="line">server auth：表示client可以用该CA对server提供的证书进行验证</span><br><span class="line">client auth：表示server可以用该CA对client提供的证书进行验证</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建用来生成CA证书签名请求（CSR）的JSON配置文件</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ssl]<span class="comment"># vim ca-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">术语介绍:</span></span><br><span class="line"><span class="section">CN: Common Name，浏览器使用该字段验证网站是否合法，一般写的是域名。非常重要。浏览器使用该字段验证网站是否合法</span></span><br><span class="line"><span class="section">C: Country， 国家</span></span><br><span class="line"><span class="section">L: Locality，地区，城市</span></span><br><span class="line"><span class="section">O: Organization Name，组织名称，公司名称</span></span><br><span class="line"><span class="section">OU: Organization Unit Name，组织单位名称，公司部门</span></span><br><span class="line"><span class="section">ST: State，州，省</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>生成CA证书（ca.pem）和私钥（ca-key.pem）  </p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@ linux-node1 ssl]<span class="comment"># cfssl gencert -initca ca-csr.json |   cfssljson -bare ca  </span></span><br><span class="line"><span class="comment">#初始化ca</span></span><br><span class="line">[root@ linux-node1 ssl]<span class="comment"># ls -l ca*</span></span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root <span class="number"> 290 </span>Mar <span class="number"> 4 </span>13:45 ca-config.json</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 1001 </span>Mar <span class="number"> 4 </span>14:09 ca.csr</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root <span class="number"> 208 </span>Mar <span class="number"> 4 </span>13:51 ca-csr.json</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root<span class="number"> 1679 </span>Mar <span class="number"> 4 </span>14:09 ca-key.pem</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 1359 </span>Mar <span class="number"> 4 </span>14:09 ca.pem</span><br><span class="line">该命令会生成运行CA所必需的文件ca-key.pem（私钥）和ca.pem（证书），还会生成ca.csr（证书签名请求），用于交叉签名或重新签名。</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>小提示：</p>
<ul>
<li><p>使用现有的CA私钥，重新生成：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca -<span class="keyword">ca</span>-key key.pem <span class="keyword">ca</span>-csr.json |     cfssljson -bare <span class="keyword">ca</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使用现有的CA私钥和CA证书，重新生成：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">cfssl</span> <span class="selector-tag">gencert</span> <span class="selector-tag">-renewca</span> <span class="selector-tag">-ca</span> <span class="selector-tag">cert</span><span class="selector-class">.pem</span> <span class="selector-tag">-ca-key</span> <span class="selector-tag">key</span><span class="selector-class">.pem</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查看cert(证书信息)：cfssl certinfo -cert ca.pem</p>
</li>
<li>查看CSR(证书签名请求)信息：cfssl certinfo -csr ca.csr</li>
</ul>
</li>
<li><p>创建martin证书签名请求(Kubernetes集群的CA创建好了，再根据该CA证书来创建一个只能访问某个namespace的用户)</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">➜  martin cat martin-csr.json </span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"martin"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"op"</span>, <span class="comment">#system:masters</span></span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">➜  martin </span><br><span class="line">后续kube-apiserver使用RBAC对客户端(如kubelet、kube-proxy、Pod)请求进行授权；</span><br><span class="line">kube-apiserver预定义了一些RBAC使用的RoleBindings，如cluster-admin将<span class="keyword">Group</span> <span class="title">op</span>(system:masters)与 <span class="keyword">Role</span> <span class="title">cluster-admin</span> 绑定，该Role授予了调用kube-apiserver的所有API的权限；</span><br><span class="line">OU指定该证书的Group为<span class="keyword">op</span>(system:masters)，kubelet使用该证书访问 kube-apiserver时,由于证书被CA签名，所以认证通过，同时由于证书用户组为经过预授权的<span class="keyword">op</span>(system:masters)，所以被授予访问所有 API 的权限；</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成martin证书和私钥</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="keyword">martin </span>ls -lth</span><br><span class="line"><span class="symbol">total</span> <span class="number">4</span>.<span class="number">0</span>K</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">218</span> Jun <span class="number">26</span> <span class="number">11</span>:<span class="number">59</span> <span class="keyword">martin-csr.json</span></span><br><span class="line"><span class="keyword">➜ </span> <span class="keyword">martin </span>cfssl gencert -ca=/<span class="meta">data</span>/kubernetes/ssl/ca.pem -ca-key=/<span class="meta">data</span>/kubernetes/ssl/ca-key.pem -config=/<span class="meta">data</span>/kubernetes/ssl/ca-config.json -profile<span class="symbol">=kubernetes</span> <span class="keyword">martin-csr.json|cfssljson </span>-<span class="keyword">bare </span><span class="keyword">martin</span></span><br><span class="line"><span class="keyword">2018/06/26 </span><span class="number">16</span>:<span class="number">20</span>:<span class="number">37</span> [<span class="meta">INFO</span>] generate received request</span><br><span class="line"><span class="number">2018</span>/<span class="number">06</span>/<span class="number">26</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">37</span> [<span class="meta">INFO</span>] received CSR</span><br><span class="line"><span class="number">2018</span>/<span class="number">06</span>/<span class="number">26</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">37</span> [<span class="meta">INFO</span>] generating key: rsa-<span class="number">2048</span></span><br><span class="line"><span class="number">2018</span>/<span class="number">06</span>/<span class="number">26</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">38</span> [<span class="meta">INFO</span>] encoded CSR</span><br><span class="line"><span class="number">2018</span>/<span class="number">06</span>/<span class="number">26</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">38</span> [<span class="meta">INFO</span>] signed certificate with serial number <span class="number">451530418945753741698899402739082416074910829402</span></span><br><span class="line"><span class="number">2018</span>/<span class="number">06</span>/<span class="number">26</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">38</span> [WARNING] This certificate lacks a <span class="string">"hosts"</span> <span class="meta">field</span>. This makes <span class="keyword">it </span>unsuitable for</span><br><span class="line"><span class="symbol">websites.</span> For more information see the <span class="keyword">Baseline </span>Requirements for the Issuance <span class="keyword">and </span>Management</span><br><span class="line"><span class="symbol">of</span> Publicly-Trusted Certificates, v.<span class="number">1</span>.<span class="number">1</span>.<span class="number">6</span>, from the CA/<span class="keyword">Browser </span>Forum (https://cabforum.org)<span class="comment">;</span></span><br><span class="line"><span class="symbol">specifically</span>, section <span class="number">10</span>.<span class="number">2</span>.<span class="number">3</span> (<span class="string">"Information Requirements"</span>).</span><br><span class="line">➜  <span class="keyword">martin </span>ls -lth</span><br><span class="line"><span class="symbol">total</span> <span class="number">16</span>K</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root  <span class="number">993</span> Jun <span class="number">26</span> <span class="number">16</span>:<span class="number">20</span> <span class="keyword">martin.csr</span></span><br><span class="line"><span class="keyword">-rw------- </span><span class="number">1</span> root root <span class="number">1</span>.<span class="number">7</span>K Jun <span class="number">26</span> <span class="number">16</span>:<span class="number">20</span> <span class="keyword">martin-key.pem</span></span><br><span class="line"><span class="keyword">-rw-r--r-- </span><span class="number">1</span> root root <span class="number">1</span>.<span class="number">4</span>K Jun <span class="number">26</span> <span class="number">16</span>:<span class="number">20</span> <span class="keyword">martin.pem</span></span><br><span class="line"><span class="keyword">-rw-r--r-- </span><span class="number">1</span> root root  <span class="number">218</span> Jun <span class="number">26</span> <span class="number">11</span>:<span class="number">59</span> <span class="keyword">martin-csr.json</span></span><br><span class="line"><span class="keyword">➜ </span> <span class="keyword">martin</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>设置集群参数</p>
</li>
</ul>
<p>本段主要设置了需要访问的集群的信息。使用set-cluster设置了需要访问的集群，如下为kubernetes，这只是个名称，实际为–server指向的apiserver；–certificate-authority设置了该集群的公钥；–embed-certs为true表示将–certificate-authority证书写入到kubeconfig中；–server则表示该集群的kube-apiserver地址<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl config set-cluster kubernetes --certificate-authority=/data/kubernetes/ssl/ca<span class="selector-class">.pem</span> --embed-certs=true --server=https:<span class="comment">//192.168.0.14:6443 --kubeconfig=martin.kubeconfig</span></span><br><span class="line">Cluster <span class="string">"kubernetes"</span> set.</span><br><span class="line">➜  martin ls -lth</span><br><span class="line">total <span class="number">20</span>K</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">2.0</span>K Jun <span class="number">26</span> <span class="number">16</span>:<span class="number">29</span> martin.kubeconfig</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root  <span class="number">993</span> Jun <span class="number">26</span> <span class="number">16</span>:<span class="number">20</span> martin.csr</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1.7</span>K Jun <span class="number">26</span> <span class="number">16</span>:<span class="number">20</span> martin-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1.4</span>K Jun <span class="number">26</span> <span class="number">16</span>:<span class="number">20</span> martin.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root  <span class="number">218</span> Jun <span class="number">26</span> <span class="number">11</span>:<span class="number">59</span> martin-csr.json</span><br><span class="line">生成了新的文件：martin.kubeconfig</span><br><span class="line">➜  martin cat martin<span class="selector-class">.kubeconfig</span> </span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: xxx</span><br><span class="line">    server: https:<span class="comment">//192.168.0.14:6443</span></span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts: []</span><br><span class="line">current-context: <span class="string">""</span></span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users: []</span><br><span class="line">➜  martin</span><br></pre></td></tr></table></figure></p>
<p>注意：–kubeconfig=martin.kubeconfig是将生成的相关信息全部写入martin.kubeconfig文件,如果不指定的话，默认是写入到“~/.kube/config ”</p>
<ul>
<li>设置客户端认证参数</li>
</ul>
<p>本段主要设置用户的相关信息，主要是用户证书。如下用户名为martin，证书为：/martin.pem，私钥为：./martin-key.pem。客户端的证书首先要经过集群CA的签署，否则不会被集群认可。此处使用的是ca认证方式，也可以使用token认证，如kubelet的TLS Boostrap机制下的bootstrapping使用的就是token认证方式。如下kubectl使用的是ca认证，不需要token字段</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl<span class="built_in"> config </span>set-credentials martin <span class="attribute">--client-certificate</span>=./martin.pem <span class="attribute">--client-key</span>=./martin-key.pem <span class="attribute">--embed-certs</span>=<span class="literal">true</span> <span class="attribute">--kubeconfig</span>=martin.kubeconfig                                      </span><br><span class="line">User <span class="string">"martin"</span> set.</span><br><span class="line">➜  martin </span><br><span class="line">可以看到martin.kubeconfig新增了如下内容：</span><br><span class="line">users:</span><br><span class="line">- name: martin</span><br><span class="line">  user:</span><br><span class="line">    xxx</span><br></pre></td></tr></table></figure>
<ul>
<li>设置上下文参数,指定命名空间为：kube-system</li>
</ul>
<p>集群参数和用户参数可以同时设置多对，在上下文参数中将集群参数和用户参数关联起来。下面的上下文名称为martin-context，集群为kubenetes，用户为martin，表示使用martin的用户凭证来访问kubenetes集群的kube-system命名空间(增加–namspace来指定访问的命名空间)。</p>
<p>执行之前先看下:martin.kubeconfig文件内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span>  <span class="string">martin</span> <span class="string">cat</span> <span class="string">martin.kubeconfig</span> </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="attr">- cluster:</span></span><br><span class="line"><span class="attr">    certificate-authority-data:</span> <span class="string">xxx</span></span><br><span class="line"><span class="attr">    server:</span> <span class="attr">https://192.168.0.14:6443</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">contexts:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">preferences:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">martin</span></span><br><span class="line"><span class="attr">  user:</span></span><br><span class="line"><span class="attr">    client-certificate-data:</span> <span class="string">xxx</span></span><br><span class="line"><span class="attr">    client-key-data:</span> <span class="string">xxx</span></span><br><span class="line"><span class="string">➜</span>  <span class="string">martin</span></span><br></pre></td></tr></table></figure>
<p>执行：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl<span class="built_in"> config </span>set-context martin-context <span class="attribute">--cluster</span>=kubernetes <span class="attribute">--namespace</span>=kube-system <span class="attribute">--user</span>=martin <span class="attribute">--kubeconfig</span>=martin.kubeconfig   </span><br><span class="line">Context <span class="string">"martin-context"</span> created.</span><br><span class="line">➜  martin</span><br></pre></td></tr></table></figure></p>
<p>再次查看martin.kubeconfig文件,发现内容做了如下改变：<br>之前：<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">contexts: <span class="string">[]</span></span><br></pre></td></tr></table></figure></p>
<p>现在：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">contexts</span>:</span><br><span class="line">- <span class="attribute">context</span>:</span><br><span class="line">    <span class="attribute">cluster</span>: kubernetes</span><br><span class="line">    <span class="attribute">namespace</span>: kube-system</span><br><span class="line">    <span class="attribute">user</span>: martin</span><br><span class="line">  <span class="attribute">name</span>: martin-context</span><br></pre></td></tr></table></figure></p>
<p>增加了上下文的相关信息。</p>
<ul>
<li>设置默认上下文</li>
</ul>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl<span class="built_in"> config </span>use-context martin-context <span class="attribute">--kubeconfig</span>=martin.kubeconfig</span><br><span class="line">Switched <span class="keyword">to</span> context <span class="string">"martin-context"</span>.</span><br></pre></td></tr></table></figure>
<p>如果配置了多个环境项，可以通过切换不同的环境项名字或指定kubeconfig文件来访问到不同的集群环境。</p>
<ul>
<li>现在martin用户通过cfssl创建成功,可以看到所有关于martin用户的信息都写入了配置文件：martin.kubeconfig,不指定”-kubeconfig=”的话，默认是写入到”~/.kube/config”，如果之前有admin的相关信息，会追加到后面。martin.kubeconfig配置文件描述了集群、用户和上下文</li>
</ul>
<p>kubectl只是个go编写的可执行程序，只要为kubectl配置合适的kubeconfig，就可以在集群中的任意节点使用。kubectl默认会从$HOME/.kube目录下查找文件名为config的文件，也可以通过设置环境变量KUBECONFIG或者通过设置–kubeconfig去指定其它kubeconfig文件,总之kubeconfig就是为访问集群所作的配置。</p>
<p>如果之前”~/.kube/config”下配置的是admin账号信息，要用martin账号，则指定kubeconfig文件即可：</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="string">martin </span><span class="string">kubectl </span><span class="string">config </span><span class="built_in">get-contexts</span>                               </span><br><span class="line"><span class="string">CURRENT </span>  <span class="string">NAME </span>        <span class="string">CLUSTER </span>     <span class="string">AUTHINFO </span>  <span class="string">NAMESPACE</span></span><br><span class="line"><span class="string">*</span>         <span class="string">kubernetes </span>  <span class="string">kubernetes </span>  <span class="string">admin </span>     </span><br><span class="line">➜  <span class="string">martin </span></span><br><span class="line">➜  <span class="string">martin </span><span class="string">kubectl </span><span class="string">config </span><span class="built_in">get-contexts</span> <span class="built_in">--kubeconfig</span> <span class="string">martin.</span><span class="string">kubeconfig</span></span><br><span class="line"><span class="string">CURRENT </span>  <span class="string">NAME </span>            <span class="string">CLUSTER </span>     <span class="string">AUTHINFO </span>  <span class="string">NAMESPACE</span></span><br><span class="line"><span class="string">*</span>         <span class="string">martin-context </span>  <span class="string">kubernetes </span>  <span class="string">martin </span>    <span class="string">kube-system</span></span><br><span class="line"><span class="string">➜</span>  <span class="string">martin</span></span><br></pre></td></tr></table></figure>
<p>现在使用当前的这个配置文件来操作kubectl命令的时候，应该会出现错误，因为还没有为该用户定义任何操作的权限呢：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl <span class="builtin-name">get</span> pods --kubeconfig martin.kubeconfig</span><br><span class="line"><span class="builtin-name">Error</span> <span class="keyword">from</span><span class="built_in"> server </span>(Forbidden): pods is forbidden:<span class="built_in"> User </span><span class="string">"martin"</span> cannot list pods <span class="keyword">in</span> the namespace <span class="string">"default"</span></span><br><span class="line">➜  martin</span><br></pre></td></tr></table></figure></p>
<p>如果提示：“kubectl error: You must be logged in to the server (Unauthorized)”<br>则是没有指定martin.kubeconfig文件或者默认的”~/.kube/config”里面没有martin用户的相关证书信息，因为前面设置客户端认证的时候没有指定password，而是用了证书。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl<span class="built_in"> config </span>set-credentials kubeuser/foo.kubernetes.com <span class="attribute">--username</span>=kubeuser <span class="attribute">--password</span>=kubepassword (用户名密码认证方式)</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-credentials martin <span class="attribute">--client-certificate</span>=./martin.pem <span class="attribute">--client-key</span>=./martin-key.pem <span class="attribute">--embed-certs</span>=<span class="literal">true</span> <span class="attribute">--kubeconfig</span>=martin.kubeconfig</span><br><span class="line">(证书认证方式)</span><br></pre></td></tr></table></figure>
<p>另外可以通过：”Cfssl-Certinfo“命令来查看martin证书信息</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="keyword">martin </span>cfssl-certinfo -cert <span class="keyword">martin.pem</span></span><br><span class="line"><span class="keyword">&#123;</span></span><br><span class="line"><span class="keyword"> </span> <span class="string">"subject"</span>: &#123;</span><br><span class="line">    <span class="string">"common_name"</span>: <span class="string">"martin"</span>,</span><br><span class="line">    <span class="string">"country"</span>: <span class="string">"CN"</span>,</span><br><span class="line">    <span class="string">"organization"</span>: <span class="string">"op"</span>,</span><br><span class="line">    <span class="string">"organizational_unit"</span>: <span class="string">"System"</span>,</span><br><span class="line">    <span class="string">"locality"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">    <span class="string">"province"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">      <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"op"</span>,</span><br><span class="line">      <span class="string">"System"</span>,</span><br><span class="line">      <span class="string">"martin"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"issuer"</span>: &#123;</span><br><span class="line">    <span class="string">"common_name"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="string">"country"</span>: <span class="string">"CN"</span>,</span><br><span class="line">    <span class="string">"organization"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">    <span class="string">"organizational_unit"</span>: <span class="string">"System"</span>,</span><br><span class="line">    <span class="string">"locality"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">    <span class="string">"province"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">      <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"System"</span>,</span><br><span class="line">      <span class="string">"kubernetes"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>
<h5 id="第二步：创建角色"><a href="#第二步：创建角色" class="headerlink" title="第二步：创建角色"></a>第二步：创建角色</h5><p>用户创建完成后，接下来就需要给该用户添加操作权限，定义一个YAML文件，创建一个允许用户操作Deployment、Pod、ReplicaSets 的角色，如下定义：(martin-role.yaml)</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  martin cat martin-role.yaml </span><br><span class="line"><span class="symbol">apiVersion:</span> rbac.authorization.k8s.io/v1</span><br><span class="line"><span class="symbol">kind:</span> Role</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> martin-role</span><br><span class="line"><span class="symbol">  namespace:</span> kube-system</span><br><span class="line"><span class="symbol">rules:</span></span><br><span class="line">- apiGroups: [<span class="string">""</span>, <span class="string">"extensions"</span>, <span class="string">"apps"</span>]</span><br><span class="line"><span class="symbol">  resources:</span> [<span class="string">"deployments"</span>, <span class="string">"replicasets"</span>, <span class="string">"pods"</span>]</span><br><span class="line"><span class="symbol">  verbs:</span> [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>, <span class="string">"create"</span>, <span class="string">"update"</span>, <span class="string">"patch"</span>, <span class="string">"delete"</span>] <span class="meta"># 也可以使用[<span class="string">'*'</span>]</span></span><br><span class="line">➜  martin</span><br></pre></td></tr></table></figure>
<p>其中Pod属于core这个API Group，在YAML中用空字符就可以，而Deployment属于apps 这个API Group，ReplicaSets属于extensions这个API Group(<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.10/" target="_blank" rel="noopener">点这里查文档</a>)，所以 rules下面的apiGroups 就综合了这几个资源的 API Group：[“”, “extensions”, “apps”]，其中verbs就是上面提到的可以对这些资源对象执行的操作，这里需要所有的操作方法，所以也可以使用[‘*’]来代替。</p>
<p>然后创建这个Role:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl create -f martin-role<span class="selector-class">.yaml</span> </span><br><span class="line">role<span class="selector-class">.rbac</span><span class="selector-class">.authorization</span><span class="selector-class">.k8s</span><span class="selector-class">.io</span> <span class="string">"martin-role"</span> created</span><br><span class="line">➜  martin</span><br></pre></td></tr></table></figure>
<p>注意这里没有使用上面的martin-context这个上下文，因为木有权限</p>
<h5 id="第三步：创建角色权限绑定"><a href="#第三步：创建角色权限绑定" class="headerlink" title="第三步：创建角色权限绑定"></a>第三步：创建角色权限绑定</h5><p>Role创建完成了，但是很明显现在这个Role和我们的用户martin 还没有任何关系，这里就需要创建一个RoleBinding对象，在 kube-system这个命名空间下面将上面的martin-role角色和用户 martin进行绑定:(martin-rolebinding.yaml)</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">➜  martin cat martin-rolebinding<span class="selector-class">.yaml</span> </span><br><span class="line">apiVersion: rbac<span class="selector-class">.authorization</span><span class="selector-class">.k8s</span><span class="selector-class">.io</span>/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: martin-rolebinding</span><br><span class="line">  namespace: kube-system</span><br><span class="line">roleRef:</span><br><span class="line">  <span class="selector-id">#apiGroup</span>: rbac<span class="selector-class">.authorization</span><span class="selector-class">.k8s</span><span class="selector-class">.io</span></span><br><span class="line">  <span class="selector-id">#kind</span>: ClusterRole</span><br><span class="line">  kind: Role</span><br><span class="line">  name: martin-role</span><br><span class="line">  apiGroup: <span class="string">""</span></span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: <span class="string">""</span></span><br><span class="line">  kind: User</span><br><span class="line">  name: martin</span><br><span class="line">  <span class="selector-id">#apiGroup</span>: <span class="string">""</span>  #会提示语法错误</span><br><span class="line">➜  martin</span><br></pre></td></tr></table></figure>
<p>上面的YAML文件中看到了subjects关键字，这里就是上面提到的用来尝试操作集群的对象，这里对应上面的 User帐号martin，使用kubectl创建上面的资源对象：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl create -f martin-rolebinding.yaml</span><br><span class="line">rolebinding<span class="selector-class">.rbac</span><span class="selector-class">.authorization</span><span class="selector-class">.k8s</span><span class="selector-class">.io</span> <span class="string">"martin-rolebinding"</span> created</span><br></pre></td></tr></table></figure>
<p>使用admin账号(martin账号无权限查看)查看role和rolebinding相关信息：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl <span class="built_in">get</span> rolebinding <span class="comment">--all-namespaces</span></span><br><span class="line">NAMESPACE     NAME                                             AGE</span><br><span class="line">kube-public   <span class="keyword">system</span>:controller:bootstrap-signer               <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   kubernetes-dashboard-minimal                     <span class="number">11</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   martin-rolebinding                               <span class="number">18</span>h</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>::leader-locking-kube-controller-manager   <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>::leader-locking-kube-scheduler            <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>:controller:bootstrap-signer               <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>:controller:cloud-provider                 <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>:controller:<span class="keyword">token</span>-cleaner                  <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   ui-admin-binding                                 <span class="number">11</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   ui-<span class="built_in">read</span>-binding                                  <span class="number">11</span>d</span><br><span class="line">➜  martin </span><br><span class="line">➜  martin kubectl <span class="built_in">get</span> role <span class="comment">--all-namespaces            </span></span><br><span class="line">NAMESPACE     NAME                                             AGE</span><br><span class="line">kube-public   <span class="keyword">system</span>:controller:bootstrap-signer               <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   extension-apiserver-authentication-reader        <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   kubernetes-dashboard-minimal                     <span class="number">11</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   martin-role                                      <span class="number">18</span>h</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>::leader-locking-kube-controller-manager   <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>::leader-locking-kube-scheduler            <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>:controller:bootstrap-signer               <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>:controller:cloud-provider                 <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>:controller:<span class="keyword">token</span>-cleaner                  <span class="number">19</span>d</span><br><span class="line">➜  martin</span><br></pre></td></tr></table></figure>
<h5 id="第四步：测试"><a href="#第四步：测试" class="headerlink" title="第四步：测试"></a>第四步：测试</h5><p>现在应该可以用上面的martin-context上下文来操作集群了：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl get pods                                          </span><br><span class="line">NAME                              READY     STATUS    RESTARTS   AGE</span><br><span class="line">nexus3<span class="number">-68</span>f55d9746-vfnf8           <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">5</span>d</span><br><span class="line">rbd-rest-api-registrykey-m262<span class="number">-1</span>   <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">4</span>d</span><br><span class="line">➜  martin </span><br><span class="line">➜  martin kubectl get pods -n <span class="section">default</span></span><br><span class="line">NAME                              READY     STATUS    RESTARTS   AGE</span><br><span class="line">nexus3<span class="number">-68</span>f55d9746-vfnf8           <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">5</span>d</span><br><span class="line">rbd-rest-api-registrykey-m262<span class="number">-1</span>   <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">4</span>d</span><br><span class="line">➜  martin </span><br><span class="line">➜  martin kubectl get pods --kubeconfig martin.kubeconfig</span><br><span class="line">NAME                                    READY     STATUS    RESTARTS   AGE</span><br><span class="line">coredns<span class="number">-77</span>c989547b-lcbfw                <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">1</span>          <span class="number">15</span>d</span><br><span class="line">coredns<span class="number">-77</span>c989547b-xq4dr                <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">1</span>          <span class="number">15</span>d</span><br><span class="line">heapster<span class="number">-77</span>b9c5bd7b-l5ms6               <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">11</span>d</span><br><span class="line">kubernetes-dashboard<span class="number">-66</span>c9d98865-g8l6l   <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">11</span>d</span><br><span class="line">monitoring-grafana<span class="number">-7</span>c674cb7f6-nqvlw     <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">11</span>d</span><br><span class="line">monitoring-influxdb<span class="number">-644</span>db5c5b6-llnp9    <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">11</span>d</span><br></pre></td></tr></table></figure>
<p>使用kubectl时并没有指定namespace，这是因为之前已经为该用户分配了权限，并且指定了kube-system命名空间写入到martin.kubeconfig文件中，如果使用default命名空间，在后面加上一个-n default，则会提示forbidden,如下：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl <span class="builtin-name">get</span> pods -n<span class="built_in"> default </span>--kubeconfig martin.kubeconfig </span><br><span class="line"><span class="builtin-name">Error</span> <span class="keyword">from</span><span class="built_in"> server </span>(Forbidden): pods is forbidden:<span class="built_in"> User </span><span class="string">"martin"</span> cannot list pods <span class="keyword">in</span> the namespace <span class="string">"default"</span></span><br><span class="line">➜  martin</span><br></pre></td></tr></table></figure></p>
<p>这是因为该用户并没有default这个命名空间的操作权限。</p>
<hr>
<h4 id="创建一个只能访问某个namespace的ServiceAccount"><a href="#创建一个只能访问某个namespace的ServiceAccount" class="headerlink" title="创建一个只能访问某个namespace的ServiceAccount"></a>创建一个只能访问某个namespace的ServiceAccount</h4><p>上面创建了一个只能访问某个命名空间下面的普通用户，前面也提到过subjects,下面还有一种类型的主题资源：ServiceAccount。</p>
<h5 id="第一步：创建一个集群内部的用户只能操作kube-system这个命名空间下面的pods和deployments"><a href="#第一步：创建一个集群内部的用户只能操作kube-system这个命名空间下面的pods和deployments" class="headerlink" title="第一步：创建一个集群内部的用户只能操作kube-system这个命名空间下面的pods和deployments"></a>第一步：创建一个集群内部的用户只能操作kube-system这个命名空间下面的pods和deployments</h5><p>首先来创建一个ServiceAccount对象：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount kubectl create sa martin-sa -n kube-system</span><br><span class="line">serviceaccount <span class="string">"martin-sa"</span> created</span><br><span class="line">➜  serviceaccount </span><br><span class="line">➜  serviceaccount kubectl <span class="builtin-name">get</span> sa </span><br><span class="line">NAME      SECRETS   AGE</span><br><span class="line">default   1         20d</span><br><span class="line">➜  serviceaccount kubectl <span class="builtin-name">get</span> sa -n kube-system</span><br><span class="line">NAME                   SECRETS   AGE</span><br><span class="line">admin-user             1         11d</span><br><span class="line">coredns                1         15d</span><br><span class="line">default                1         20d</span><br><span class="line">heapster               1         11d</span><br><span class="line">kubernetes-dashboard   1         11d</span><br><span class="line">martin-sa              1         13s</span><br><span class="line">➜  serviceaccount</span><br></pre></td></tr></table></figure>
<p>当然也可以定义成YAML文件的形式来创建:</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">kind:</span> ServiceAccount</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> martin-sa</span><br><span class="line"><span class="symbol">  namespace:</span> kube-system</span><br></pre></td></tr></table></figure>
<h5 id="第二步：创建一个Role对象：-martin-sa-role-yaml"><a href="#第二步：创建一个Role对象：-martin-sa-role-yaml" class="headerlink" title="第二步：创建一个Role对象：(martin-sa-role.yaml)"></a>第二步：创建一个Role对象：(martin-sa-role.yaml)</h5><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount <span class="keyword">cat</span> martin-<span class="keyword">sa</span>-role.yaml </span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadat<span class="variable">a:</span></span><br><span class="line">  name: martin-<span class="keyword">sa</span>-role</span><br><span class="line">  namespace: kube-<span class="built_in">system</span></span><br><span class="line">rule<span class="variable">s:</span></span><br><span class="line">- apiGroup<span class="variable">s:</span> [<span class="string">""</span>]</span><br><span class="line">  resource<span class="variable">s:</span> [<span class="string">"pods"</span>]</span><br><span class="line">  <span class="keyword">verb</span><span class="variable">s:</span> [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>] # 也可以使用[<span class="string">'*'</span>]</span><br><span class="line">- apiGroup<span class="variable">s:</span> [<span class="string">"apps"</span>]</span><br><span class="line">  resource<span class="variable">s:</span> [<span class="string">"deployments"</span>]</span><br><span class="line">  <span class="keyword">verb</span><span class="variable">s:</span> [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>, <span class="string">"create"</span>, <span class="string">"update"</span>, <span class="string">"patch"</span>, <span class="string">"delete"</span>]</span><br><span class="line">➜  serviceaccount</span><br></pre></td></tr></table></figure>
<p>可以看到这里定义的角色没有创建、删除、更新Pod的权限，等会可以重点测试一下。</p>
<p>创建该Role对象：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount kubectl create -f martin-sa-role<span class="selector-class">.yaml</span> </span><br><span class="line">role<span class="selector-class">.rbac</span><span class="selector-class">.authorization</span><span class="selector-class">.k8s</span><span class="selector-class">.io</span> <span class="string">"martin-sa-role"</span> created</span><br></pre></td></tr></table></figure></p>
<h5 id="第三步，创建一个RoleBinding对象，将上面的martin-sa和角色martin-sa-role进行绑定：-martin-sa-rolebinding-yaml"><a href="#第三步，创建一个RoleBinding对象，将上面的martin-sa和角色martin-sa-role进行绑定：-martin-sa-rolebinding-yaml" class="headerlink" title="第三步，创建一个RoleBinding对象，将上面的martin-sa和角色martin-sa-role进行绑定：(martin-sa-rolebinding.yaml)"></a>第三步，创建一个RoleBinding对象，将上面的martin-sa和角色martin-sa-role进行绑定：(martin-sa-rolebinding.yaml)</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span>  <span class="string">serviceaccount</span> <span class="string">cat</span> <span class="string">martin-sa-rolebinding.yaml</span> </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">martin-sa-rolebinding</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">martin-sa</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">martin-sa-role</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>
<p>创建这个资源对象：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount kubectl <span class="built_in">get</span> rolebinding -n kube-<span class="built_in">system</span></span><br><span class="line">NAME                                             AGE</span><br><span class="line">kubernetes-dashboard-minimal                     <span class="number">11</span>d</span><br><span class="line">martin-rolebinding                               <span class="number">22</span>h</span><br><span class="line">➜  serviceaccount </span><br><span class="line"></span><br><span class="line">➜  serviceaccount kubectl create -<span class="keyword">f</span> martin-<span class="keyword">sa</span>-rolebinding.yaml </span><br><span class="line">rolebinding.rbac.authorization.k8s.io <span class="string">"martin-sa-rolebinding"</span> created</span><br><span class="line">➜  serviceaccount </span><br><span class="line">➜  serviceaccount kubectl <span class="built_in">get</span> rolebinding               </span><br><span class="line">No resources found.</span><br><span class="line">➜  serviceaccount kubectl <span class="built_in">get</span> rolebinding -n kube-<span class="built_in">system</span></span><br><span class="line">NAME                                             AGE</span><br><span class="line">kubernetes-dashboard-minimal                     <span class="number">11</span>d</span><br><span class="line">martin-rolebinding                               <span class="number">23</span>h</span><br><span class="line">martin-<span class="keyword">sa</span>-rolebinding                            <span class="number">26</span>s</span><br><span class="line">可以看到martin-<span class="keyword">sa</span>-rolebinding已经添加</span><br></pre></td></tr></table></figure>
<h5 id="第四步，验证这个ServiceAccount"><a href="#第四步，验证这个ServiceAccount" class="headerlink" title="第四步，验证这个ServiceAccount"></a>第四步，验证这个ServiceAccount</h5><p>一个ServiceAccount会生成一个Secret对象和它进行映射，这个Secret里面包含一个token：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount kubectl <span class="builtin-name">get</span><span class="built_in"> secret </span>-n kube-system</span><br><span class="line">NAME                              <span class="built_in"> TYPE </span>                                 DATA      AGE</span><br><span class="line">admin-user-token-xszp7             kubernetes.io/service-account-token   3         11d</span><br><span class="line">coredns-token-9ppnq                kubernetes.io/service-account-token   3         15d</span><br><span class="line">default-token-fs7zj                kubernetes.io/service-account-token   3         20d</span><br><span class="line">heapster-token-gn8g5               kubernetes.io/service-account-token   3         11d</span><br><span class="line">kubernetes-dashboard-certs         Opaque                                0         11d</span><br><span class="line">kubernetes-dashboard-key-holder    Opaque                                2         15d</span><br><span class="line">kubernetes-dashboard-token-tg782   kubernetes.io/service-account-token   3         11d</span><br><span class="line">martin-sa-token-78s5j              kubernetes.io/service-account-token   3         41m  #新增</span><br><span class="line">➜  serviceaccount </span><br><span class="line">➜  serviceaccount kubectl describe<span class="built_in"> secret </span>martin-sa-token-78s5j -n kube-system</span><br><span class="line">Name:         martin-sa-token-78s5j</span><br><span class="line">Namespace:    kube-system</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.<span class="attribute">name</span>=martin-sa</span><br><span class="line">              kubernetes.io/service-account.<span class="attribute">uid</span>=576ef41d-79e2-11e8-bede-5254004f2222</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:     1359 bytes</span><br><span class="line">namespace:  11 bytes</span><br><span class="line">token:      xxx</span><br><span class="line">➜  serviceaccount</span><br></pre></td></tr></table></figure></p>
<p>==注意：查看时需要-n指定kube-system命名空间！==</p>
<p>然后可以利用这个token去登录Dashboard，就可以在Dashboard中来验证功能是否符合预期：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount kubectl <span class="builtin-name">get</span><span class="built_in"> secret </span>martin-sa-token-78s5j -o jsonpath=&#123;.data.token&#125; -n kube-system |base64 -d #会生成一串很长的base64后的字符串</span><br><span class="line">xxxxxxxxxxxxxxxx</span><br><span class="line">➜  serviceaccount</span><br></pre></td></tr></table></figure>
<p>使用这里的xxx token去Dashboard页面进行登录：<br>会出现如下提示信息：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">configmaps is forbidden:<span class="built_in"> User </span><span class="string">"system:serviceaccount:kube-system:martin-sa"</span> cannot list configmaps <span class="keyword">in</span> the namespace <span class="string">"default"</span></span><br><span class="line">close</span><br><span class="line">warning</span><br><span class="line">persistentvolumeclaims is forbidden:<span class="built_in"> User </span><span class="string">"system:serviceaccount:kube-system:martin-sa"</span> cannot list persistentvolumeclaims <span class="keyword">in</span> the namespace <span class="string">"default"</span></span><br></pre></td></tr></table></figure>
<p>这是因为登录进来后默认跳转到default命名空间，但是却没有改空间的权限，因此需要切换到kube-system命名空间下面:</p>
<p>原来url:<br><a href="https://xxx/#!/deployment?namespace=default" target="_blank" rel="noopener">https://xxx/#!/deployment?namespace=default</a></p>
<p>修改为新url:<br><a href="https://xxx/#!/deployment?namespace=kube-system" target="_blank" rel="noopener">https://xxx/#!/deployment?namespace=kube-system</a></p>
<p>可以看到能访问pod列表了，但是也会有一些其他额外的提示：events is forbidden: User “system:serviceaccount:kube-system:martin-sa” cannot list events in the namespace “kube-system”，这是因为当前登录用只被授权了访问pod和deployment的权限，同样的，访问下deployment看看可以了吗？</p>
<p>同样的，可以根据自己的需求来对访问用户的权限进行限制，可以自己通过Role定义更加细粒度的权限，也可以使用系统内置的一些权限……</p>
<hr>
<h4 id="创建一个可以访问所有-namespace-的ServiceAccount"><a href="#创建一个可以访问所有-namespace-的ServiceAccount" class="headerlink" title="创建一个可以访问所有 namespace 的ServiceAccount"></a>创建一个可以访问所有 namespace 的ServiceAccount</h4><p>刚刚创建的martin-sa这个ServiceAccount和一个Role角色进行绑定的，如果现在创建一个新的ServiceAccount，需要他操作的权限作用于所有的namespace，这个时候就需要使用到ClusterRole 和 ClusterRoleBinding 这两种资源对象了。</p>
<h5 id="第一步，同样，首先新建一个ServiceAcount对象：-martin-sa2-yaml"><a href="#第一步，同样，首先新建一个ServiceAcount对象：-martin-sa2-yaml" class="headerlink" title="第一步，同样，首先新建一个ServiceAcount对象：(martin-sa2.yaml)"></a>第一步，同样，首先新建一个ServiceAcount对象：(martin-sa2.yaml)</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount cat martin-sa2.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: martin-sa2</span><br><span class="line">  namespace: kube-system</span><br><span class="line">➜  serviceaccount </span><br><span class="line">➜  serviceaccount kubectl create -f martin-sa2.yaml </span><br><span class="line">serviceaccount <span class="string">"martin-sa2"</span> created</span><br><span class="line">➜  serviceaccount kubectl <span class="builtin-name">get</span> sa   </span><br><span class="line">NAME      SECRETS   AGE</span><br><span class="line">default   1         20d</span><br><span class="line">➜  serviceaccount kubectl <span class="builtin-name">get</span> sa -n kube-system</span><br><span class="line">NAME                   SECRETS   AGE</span><br><span class="line">admin-user             1         12d</span><br><span class="line">coredns                1         15d</span><br><span class="line">default                1         20d</span><br><span class="line">heapster               1         12d</span><br><span class="line">kubernetes-dashboard   1         12d</span><br><span class="line">martin-sa              1         1h</span><br><span class="line">martin-sa2             1         12s</span><br><span class="line">➜  serviceaccount</span><br></pre></td></tr></table></figure>
<h5 id="第二步，创建一个ClusterRoleBinding-对象-martin-clusterolebinding-yaml"><a href="#第二步，创建一个ClusterRoleBinding-对象-martin-clusterolebinding-yaml" class="headerlink" title="第二步，创建一个ClusterRoleBinding 对象(martin-clusterolebinding.yaml):"></a>第二步，创建一个ClusterRoleBinding 对象(martin-clusterolebinding.yaml):</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span>  <span class="string">serviceaccount</span> <span class="string">cat</span> <span class="string">martin-clusterolebinding.yaml</span>   </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">martin-sa2-clusterrolebinding</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">martin-sa2</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="string">➜</span>  <span class="string">serviceaccount</span></span><br></pre></td></tr></table></figure>
<p>对比下之前的”martin-sa-rolebinding.yaml”</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span>  <span class="string">serviceaccount</span> <span class="string">cat</span> <span class="string">martin-sa-rolebinding.yaml</span> </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">martin-sa-rolebinding</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">martin-sa</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">martin-sa-role</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="string">➜</span>  <span class="string">serviceaccount</span></span><br></pre></td></tr></table></figure>
<p>从上面可以看到没有为这个资源对象声明namespace，因为这是一个ClusterRoleBinding 资源对象，是作用于整个集群的，也没有单独新建一个ClusterRole对象，而是使用的 cluster-admin这个对象，这是Kubernetes集群内置的ClusterRole对象，可以使用kubectl get clusterrole 和kubectl get clusterrolebinding查看系统内置的一些集群角色和集群角色绑定，这里使用的 cluster-admin这个集群角色是拥有最高权限的集群角色，所以一般需要谨慎使用该集群角色。</p>
<p>创建上面集群角色绑定资源对象：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount kubectl create -f martin-clusterolebinding<span class="selector-class">.yaml</span> </span><br><span class="line">clusterrolebinding<span class="selector-class">.rbac</span><span class="selector-class">.authorization</span><span class="selector-class">.k8s</span><span class="selector-class">.io</span> <span class="string">"martin-sa2-clusterrolebinding"</span> created</span><br><span class="line">➜  serviceaccount</span><br></pre></td></tr></table></figure>
<p>通过ubectl get clusterrolebinding可以看到”martin-sa2-clusterrolebinding”已经加入其中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount kubectl get clusterrolebinding </span><br><span class="line">NAME                                                   AGE</span><br><span class="line">admin-user                                             <span class="number">12d</span></span><br><span class="line">cluster-admin                                          <span class="number">20d</span></span><br><span class="line">heapster                                               <span class="number">12d</span></span><br><span class="line">kubelet-bootstrap                                      <span class="number">19d</span></span><br><span class="line">martin-sa2-clusterrolebinding                          <span class="number">22s</span></span><br></pre></td></tr></table></figure></p>
<h5 id="第三步，使用-ServiceAccount对应的token去登录Dashboard验证："><a href="#第三步，使用-ServiceAccount对应的token去登录Dashboard验证：" class="headerlink" title="第三步，使用 ServiceAccount对应的token去登录Dashboard验证："></a>第三步，使用 ServiceAccount对应的token去登录Dashboard验证：</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount kubectl <span class="builtin-name">get</span><span class="built_in"> secret </span>-n kube-system|grep martin-sa2-token-q7bhr</span><br><span class="line">martin-sa2-token-q7bhr             kubernetes.io/service-account-token   3         34m</span><br><span class="line">➜  serviceaccount </span><br><span class="line">➜  serviceaccount kubectl <span class="builtin-name">get</span><span class="built_in"> secret </span>martin-sa2-token-q7bhr -o jsonpath=&#123;.data.token&#125; -n kube-system |base64 -d</span><br><span class="line">xxxxxxx</span><br><span class="line"><span class="comment">#会生成一串很长的base64后的字符串</span></span><br><span class="line">➜  serviceaccount</span><br></pre></td></tr></table></figure>
<p>在最开始接触到RBAC认证的时候，可能不太熟悉，特别是不知道应该怎么去编写rules规则，可以去分析系统自带的clusterrole、clusterrolebinding这些资源对象的编写方法，利用 kubectl的get、describe、-o yaml这些操作，所以kubectl最基本的操作一定要掌握好。</p>
<p>RBAC只是Kubernetes中安全认证的一种方式，当然也是现在最重要的一种方式。</p>
<hr>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.leiyawu.com/2018/06/22/基于k8s 动态配置及扩容maven nexus私服/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Martin Lei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="让一切随风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/22/基于k8s 动态配置及扩容maven nexus私服/" itemprop="url">基于k8s 动态配置及扩容maven nexus私服</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-22T10:36:00+08:00">
                2018-06-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/K8s/" itemprop="url" rel="index">
                    <span itemprop="name">K8s</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="配置nexus"><a href="#配置nexus" class="headerlink" title="配置nexus"></a>配置nexus</h3><p>从官网下载了nexus之后还需要进行一些配置。<br>编辑bin/nexus.vmoptions 调整后的如下：</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby">Xms600M</span></span><br><span class="line"><span class="ruby">-Xmx600M</span></span><br><span class="line"><span class="ruby">-<span class="symbol">XX:</span>MaxDirectMemorySize=<span class="number">1</span>G</span></span><br><span class="line"><span class="ruby">-<span class="symbol">XX:</span>+UnlockDiagnosticVMOptions</span></span><br><span class="line"><span class="ruby">-<span class="symbol">XX:</span>+UnsyncloadClass</span></span><br><span class="line"><span class="ruby">-<span class="symbol">XX:</span>+LogVMOutput</span></span><br><span class="line"><span class="ruby">-<span class="symbol">XX:</span>LogFile=<span class="regexp">/data/docker</span><span class="regexp">/soft/nexus</span><span class="regexp">/log/jvm</span>.log</span></span><br><span class="line"><span class="ruby">-<span class="symbol">XX:</span>-OmitStackTraceInFastThrow</span></span><br><span class="line"><span class="ruby">-Djava.net.preferIPv4Stack=<span class="literal">true</span></span></span><br><span class="line"><span class="ruby">-Dkaraf.home=.</span></span><br><span class="line"><span class="ruby">-Dkaraf.base=.</span></span><br><span class="line"><span class="ruby">-Dkaraf.etc=etc/karaf</span></span><br><span class="line"><span class="ruby">-Djava.util.logging.config.file=etc/karaf/java.util.logging.properties</span></span><br><span class="line"><span class="ruby">-Dkaraf.data=<span class="regexp">/data/docker</span><span class="regexp">/soft/nexus</span><span class="regexp">/data</span></span></span><br><span class="line"><span class="ruby">-Djava.io.tmpdir=<span class="regexp">/data/docker</span><span class="regexp">/soft/nexus</span><span class="regexp">/tmp</span></span></span><br><span class="line"><span class="ruby">-Dkaraf.startLocalConsole=<span class="literal">false</span></span></span><br></pre></td></tr></table></figure>
<p>其中除了1，2行的jvm内存配置之外，最关键的就是，以下几个属性配置：</p>
<ul>
<li>-XX:LogFile=/data/docker/soft/nexus/log/jvm.log       # 日志文件生成位置</li>
<li>-Dkaraf.data=/data/docker/soft/nexus/data             # 仓库数据存放位置(上传的jar包)</li>
<li>-Djava.io.tmpdir=/data/docker/soft/nexus/tmp          # 临时文件存放位置</li>
</ul>
<h3 id="制作Docker镜像"><a href="#制作Docker镜像" class="headerlink" title="制作Docker镜像"></a>制作Docker镜像</h3><p>配置好nexus之后，需要再制作自己的docker镜像，因为k8s就是调度镜像容器的。 </p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master nexus]<span class="comment"># pwd</span></span><br><span class="line">/data/docker/dockerfile/nexus</span><br><span class="line">[root@master nexus]<span class="comment"># ls -lth </span></span><br><span class="line">total 223M</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root <span class="number"> 146 </span>Jun<span class="number"> 21 </span>16:06 Dockerfile</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root 108M Jun<span class="number"> 21 </span>16:02 nexus3.tar.gz</span><br><span class="line">drwxr-xr-x<span class="number"> 3 </span>root root 4.0K Jun<span class="number"> 21 </span>15:53 sonatype-work</span><br><span class="line">drwxr-xr-x<span class="number"> 9 </span>root root 4.0K Jun<span class="number"> 21 </span>15:53 nexus-3.12.1-01</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root 115M Jun<span class="number"> 21 </span>15:36 nexus-3.12.1-01-unix.tar.gz.org</span><br></pre></td></tr></table></figure>
<p>docker镜像的制作很简单，新建一个Dockerfile文件：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master nexus]<span class="comment"># cat Dockerfile </span></span><br><span class="line"><span class="keyword">FROM</span> registry.cn-hangzhou.aliyuncs.com/luhaoyuan/oracle-jdk8:latest</span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> nexus3.tar.gz /opt</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">ENTRYPOINT [<span class="string">"/opt/nexus-3.12.1-01/bin/nexus"</span>, <span class="string">"run"</span>]</span></span><br></pre></td></tr></table></figure>
<ul>
<li>第一行：nexus的运行是依赖JDK环境的，所以我们这里就使用jdk作为基础镜像；(镜像是基于centos7，比较大，后续可以考虑修改为alpine_3.6)</li>
<li>第二行：将我们配置过后的nexus(nexus-3.12.1-01)再重新打包一下，添加到容器中； </li>
<li>第三行：启动容器时，执行的命令，nexus的启动命令有start和run，由于start默认是启动在后台进程的，这样容器一启动就退出了。所以这里必须要使用run命令启动了。</li>
</ul>
<p>最后构建Docker镜像：<br>docker build -t registry.martin.com:5000/tools/nexus:3.12.1 .<br>registry.martin.com:5000为我registry地址,构建之后将改image push到私库,当然也可以用harbor<br>如果有做ca校验，需要将证书拷贝到指定的:/etc/docker/certs.d/xxx/ca.crt,然后docker login校验<br>再docker push registry.martin.com:5000/tools/nexus:3.12.1，不然会提示x509认证失败</p>
<h3 id="配置k8s-PV-PVC"><a href="#配置k8s-PV-PVC" class="headerlink" title="配置k8s PV-PVC"></a>配置k8s PV-PVC</h3><p>为了避免容器重启数据丢失，需要挂载主机的卷空间。<br>在k8s中，pod挂载主机的存储卷，就需要使用到了PV（PersistentVolume）和PVC（PersistentVolumeClaim）。<br>新建nexus3-pv-pvc.yaml文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@master</span> <span class="string">nexus]#</span> <span class="string">pwd</span></span><br><span class="line"><span class="string">/data/k8s/nexus</span></span><br><span class="line"><span class="string">[root@master</span>  <span class="string">nexus]#</span> <span class="string">ls</span> <span class="bullet">-lth</span></span><br><span class="line"><span class="string">total</span> <span class="number">12</span><span class="string">K</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">777</span> <span class="string">Jun</span> <span class="number">21</span> <span class="number">18</span><span class="string">:49</span> <span class="string">nexus3-deployment.yaml</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">370</span> <span class="string">Jun</span> <span class="number">21</span> <span class="number">17</span><span class="string">:12</span> <span class="string">nexus3-service.yaml</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">525</span> <span class="string">Jun</span> <span class="number">21</span> <span class="number">16</span><span class="string">:49</span> <span class="string">nexus3-pv-pvc.yaml</span></span><br><span class="line"><span class="string">[root@master</span>  <span class="string">nexus]#</span> <span class="string">cat</span> <span class="string">nexus3-pv-pvc.yaml</span> </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nexus3-data-pv</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">nexus3-data-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  capacity:</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">500</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">  persistentVolumeReclaimPolicy:</span> <span class="string">Recycle</span></span><br><span class="line"><span class="attr">  hostPath:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/data/docker/soft/nexus</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nexus3-data-pvc</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">nexus3-data-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">500</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">nexus3-data-pv</span></span><br><span class="line"><span class="string">[root@master</span>  <span class="string">nexus]#</span></span><br></pre></td></tr></table></figure>
<p>==注意：PV中的hostPath，指定了宿主主机上的挂载路径(node节点最好全部先创建好)==</p>
<h3 id="配置k8s-Deployment"><a href="#配置k8s-Deployment" class="headerlink" title="配置k8s Deployment"></a>配置k8s Deployment</h3><p>在k8s早期更多的是使用ReplicationController (RC)来控制保障pod，不过后来又出现了Deployment。<br>Deployment不仅包含了RC的所有功能，还具有：版本记录、回滚、暂停和启动等多种额外的强大功能。<br>所以可以尽量都使用Deployment,新建nexus3-deployment.yaml文件：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@master nexus]<span class="meta"># cat nexus3-deployment.yaml </span></span><br><span class="line"><span class="symbol">kind:</span> Deployment</span><br><span class="line"><span class="symbol">apiVersion:</span> extensions/v1beta1</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  labels:</span></span><br><span class="line"><span class="symbol">    app:</span> nexus3</span><br><span class="line"><span class="symbol">  name:</span> nexus3</span><br><span class="line"><span class="symbol">spec:</span></span><br><span class="line"><span class="symbol">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="symbol">  selector:</span></span><br><span class="line"><span class="symbol">    matchLabels:</span></span><br><span class="line"><span class="symbol">      app:</span> nexus3</span><br><span class="line"><span class="symbol">  template:</span></span><br><span class="line"><span class="symbol">    metadata:</span></span><br><span class="line"><span class="symbol">      labels:</span></span><br><span class="line"><span class="symbol">        app:</span> nexus3</span><br><span class="line"><span class="symbol">    spec:</span></span><br><span class="line"><span class="symbol">      containers:</span></span><br><span class="line">        - name: nexus3</span><br><span class="line"><span class="symbol">          image:</span> registry.martin.com:<span class="number">5000</span><span class="meta-keyword">/tools/</span>nexus:<span class="number">3.12</span><span class="number">.1</span></span><br><span class="line"><span class="symbol">          imagePullPolicy:</span> IfNotPresent</span><br><span class="line"><span class="symbol">          ports:</span></span><br><span class="line">          - containerPort: <span class="number">9193</span></span><br><span class="line"><span class="symbol">            protocol:</span> TCP</span><br><span class="line"><span class="symbol">          volumeMounts:</span></span><br><span class="line">          - name: nexus-data</span><br><span class="line"><span class="symbol">            mountPath:</span> <span class="meta-keyword">/data/</span>docker<span class="meta-keyword">/soft/</span>nexus</span><br><span class="line"><span class="symbol">      volumes:</span></span><br><span class="line">        - name: nexus-data</span><br><span class="line"><span class="symbol">          persistentVolumeClaim:</span></span><br><span class="line"><span class="symbol">            claimName:</span> nexus3-data-pvc</span><br><span class="line"><span class="symbol">      nodeSelector:</span></span><br><span class="line">        kubernetes.io/hostname: <span class="number">192.168</span><span class="number">.0</span><span class="number">.15</span></span><br></pre></td></tr></table></figure>
<p>需要在volumes结点上引用之前创建的PVC：</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">volumes</span>:</span><br><span class="line">  - name: nexus-<span class="class"><span class="keyword">data</span></span></span><br><span class="line">    persistentVolumeClaim:</span><br><span class="line">      claimName: nexus3-<span class="class"><span class="keyword">data</span>-pvc</span></span><br></pre></td></tr></table></figure>
<p>在volumeMounts结点上，配置了挂载到容器中的路径：/data/docker/soft/nexus(node节点最好全部先创建好)</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">volumeMounts:</span></span><br><span class="line">  - name: nexus-data</span><br><span class="line"><span class="symbol">    mountPath:</span> <span class="meta-keyword">/data/</span>docker<span class="meta-keyword">/soft/</span>nexus</span><br></pre></td></tr></table></figure>
<p>最后的nodeSelector表示pod只在某个主机上运行,可以通过在k8s的master上使用:kubectl get nodes查看</p>
<h3 id="配置k8s-Service"><a href="#配置k8s-Service" class="headerlink" title="配置k8s Service"></a>配置k8s Service</h3><p>k8s中的pod的访问是不可靠的，随时可能发生pod停止-漂移-创建的过程。<br>所以要想能够稳定的访问，就必须要创建Service进行服务发现了，在Service中是根据selector来寻找pod的。<br>最后k8s上的Service只能在集群节点上访问，如果我们想要在集群外部进行访问的话，只有三种方式：</p>
<ul>
<li>NodePort、</li>
<li>LoadBalancer、</li>
<li>Ingress。 </li>
</ul>
<p>这里使用NodePort，绑定宿主机的端口来进行暴露服务。跟docker run -p 看上去效果相似。<br>新建nexus3-service.yaml文件：<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@master nexus]<span class="meta"># cat nexus3-service.yaml </span></span><br><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">kind:</span> Service</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  labels:</span></span><br><span class="line"><span class="symbol">    app:</span> nexus3</span><br><span class="line"><span class="symbol">  name:</span> nexus3</span><br><span class="line"><span class="symbol">spec:</span></span><br><span class="line"><span class="symbol">  type:</span> NodePort</span><br><span class="line"><span class="symbol">  ports:</span></span><br><span class="line">  - port: <span class="number">8081</span></span><br><span class="line"><span class="symbol">    targetPort:</span> <span class="number">8081</span></span><br><span class="line"><span class="symbol">    nodePort:</span> <span class="number">30031</span></span><br><span class="line"><span class="symbol">    name:</span> web-ui</span><br><span class="line"><span class="symbol">  selector:</span></span><br><span class="line"><span class="symbol">    app:</span> nexus3</span><br><span class="line">[root@master nexus]<span class="meta">#</span></span><br></pre></td></tr></table></figure></p>
<p>其中关键的地方就是spec.type节点配置NodePort类型了。<br>说明下的ports 端口的配置：</p>
<ul>
<li>port 属性定义了Service的虚端口；</li>
<li>targetPort 属性指定了后面pod上提供的端口，如果没有指定则默认与port相同(这里我们显视的指定了)；</li>
<li>nodePort 属性指定了绑定在宿主机(物理机)上的端口号，我们可以通过宿主机IP + 端口的形式访问到后方pod中的服。</li>
<li>name 如果有多个port配置的话，必须要为每个port指定一个名称。</li>
</ul>
<h3 id="k8s部署访问"><a href="#k8s部署访问" class="headerlink" title="k8s部署访问"></a>k8s部署访问</h3><h4 id="创建-PV-PVC"><a href="#创建-PV-PVC" class="headerlink" title="创建 PV-PVC"></a>创建 PV-PVC</h4><p>根据配置文件，创建PV-PVC：</p>
<p>kubectl create -f nexus3-pv-pvc.yaml</p>
<p>创建完成后，查看一下状态，是否正常： </p>
<p>kubectl get pv</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME             CAPACITY   ACCESS MODES   RECLAIM<span class="built_in"> POLICY </span>  STATUS    CLAIM                     STORAGECLASS   REASON    AGE</span><br><span class="line">nexus3-data-pv   500Gi      RWO            Recycle          Bound     default/nexus3-data-pvc                            17h</span><br></pre></td></tr></table></figure>
<h4 id="创建Deployment"><a href="#创建Deployment" class="headerlink" title="创建Deployment"></a>创建Deployment</h4><p>继续创建Deployment，创建完后会自动创建pod的，并维护pod数量始终为1。 </p>
<p>kubectl create -f nexus3-deployment.yaml </p>
<p>稍等几秒钟，查看pod状态： </p>
<p>kubectl get pod -o wide</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                      READY     STATUS    RESTARTS   AGE       IP           NODE</span><br><span class="line">nexus3<span class="number">-68</span>f55d9746-vfnf8   <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">12</span>h       <span class="number">10.20</span><span class="number">.7</span><span class="number">.12</span>   <span class="number">192.168</span><span class="number">.0</span><span class="number">.15</span></span><br></pre></td></tr></table></figure>
<p>==注意：默认不用-n指定namespace的都是用的default，-o wide可以看到详细的IP及node信息==</p>
<h4 id="创建Service"><a href="#创建Service" class="headerlink" title="创建Service"></a>创建Service</h4><p>创建Service，暴露服务：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">kubectl</span> <span class="selector-tag">create</span> <span class="selector-tag">-f</span> <span class="selector-tag">nexus3-service</span><span class="selector-class">.yaml</span></span><br></pre></td></tr></table></figure>
<p>查看状态：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> kubectl <span class="builtin-name">get</span> svc</span><br><span class="line">NAME           <span class="built_in"> TYPE </span>       CLUSTER-IP      EXTERNAL-IP   PORT(S)                                        AGE</span><br><span class="line">kubernetes      ClusterIP   10.10.0.1       &lt;none&gt;        443/TCP                                        13d</span><br><span class="line">nexus3          NodePort    10.10.165.3     &lt;none&gt;        8081:30031/TCP,5000:30032/TCP,8889:30033/TCP   12h</span><br><span class="line">nginx-service   ClusterIP   10.10.147.216   &lt;none&gt;        80/TCP                                         10d</span><br></pre></td></tr></table></figure>
<p>==注意这里的访问，是访问宿主机的IP+端口，至于CLUSTER-IP这些都是虚拟的IP，无法在外部进行访问的==。</p>
<h3 id="访问Nexus"><a href="#访问Nexus" class="headerlink" title="访问Nexus"></a>访问Nexus</h3><p><a href="http://192.168.1.2:30031" target="_blank" rel="noopener">http://192.168.1.2:30031</a> (pod内container端口为：8081)</p>
<h3 id="升级"><a href="#升级" class="headerlink" title="升级"></a>升级</h3><p>借用k8s Deployment的升级方式:</p>
<ol>
<li>从官网下载最新的nexus安装包；</li>
<li>修改nexus配置文件，将上面旧版本的配置覆盖过来就行了；</li>
<li>修改Dockerfile文件，构建新的Docker镜像，将新打包的nexus放入镜像中。<br>如：docker build -t registry.martin.com:5000/tools/nexus:3.12.2 .<br>Ps: 不要忘记启动命令路径也要调整!</li>
<li>使用k8s命令升级Deployment：<br>如：kubectl set image deployment/nexus3 nexus3=registry.martin.com:5000/tools/nexus:3.12.2</li>
<li>回滚升级，如果发现升级了的不好用，或者出现问题，也可以回滚：<br>如：kubectl rollout undo deployment/nexus3</li>
</ol>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>其实这个过程中里复杂了一部分，也简化了一部分。<br>复杂了pv-pvc过程，pv-pvc不用创建直接在Deployment中挂载hostPath也是可以的。<br>简化了Deployment，其实应该还需要加上cpu、内存等资源限制的。<br>这里只是在nexus配置文件中做了限制，如果出现内存泄漏问题，还是没办法解决!</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.leiyawu.com/2018/06/14/kubernetes-jenkins-ci-cd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Martin Lei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="让一切随风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/14/kubernetes-jenkins-ci-cd/" itemprop="url">kubernetes-jenkins-ci-cd</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-14T17:22:00+08:00">
                2018-06-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/K8s/" itemprop="url" rel="index">
                    <span itemprop="name">K8s</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="流程图："><a href="#流程图：" class="headerlink" title="流程图："></a>流程图：</h3><p>基于Jenkins的CI/CD流程如下所示:<br><img src="https://cos.leiyawu.com/docker/k8s/kubernetes-jenkins-ci-cd.png" alt="kubernetes-jenkins-ci-cd"></p>
<h3 id="流程说明："><a href="#流程说明：" class="headerlink" title="流程说明："></a>流程说明：</h3><ol>
<li>用户向Gitlab提交代码，代码中必须包含Dockerfile</li>
<li>将代码提交到远程仓库</li>
<li>用户在发布应用时需要填写git仓库地址和分支、服务类型、服务名称、资源数量、实例个数，确定后触发Jenkins自动构建</li>
<li>Jenkins的CI流水线自动编译代码并打包成docker镜像推送到Harbor镜像仓库</li>
<li>Jenkins的CI流水线中包括了自定义脚本，根据我们已准备好的kubernetes的YAML模板，将其中的变量替换成用户输入的选项</li>
<li>生成应用的kubernetes YAML配置文件</li>
<li>更新Ingress的配置，根据新部署的应用的名称，在ingress的配置文件中增加一条路由信息</li>
<li>更新PowerDNS，向其中插入一条DNS记录，IP地址是边缘节点的IP地址。关于边缘节点，请查看<a href="https://jimmysong.io/kubernetes-handbook/practice/edge-node-configuration.html" target="_blank" rel="noopener">边缘节点配置</a></li>
<li>Jenkins调用kubernetes的API，部署应用</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.leiyawu.com/2018/06/13/Pause容器/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Martin Lei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="让一切随风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/13/Pause容器/" itemprop="url">Pause容器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-13T16:50:00+08:00">
                2018-06-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/K8s/" itemprop="url" rel="index">
                    <span itemprop="name">K8s</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Pause容器定义"><a href="#Pause容器定义" class="headerlink" title="Pause容器定义"></a>Pause容器定义</h2><p>Pause容器，又叫Infra容器，本文将探究该容器的作用与原理。</p>
<p>在kubelet的配置中有这样一个参数：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KUBELET_POD_INFRA_CONTAINER=--pod-infra-container-image=registry<span class="selector-class">.access</span><span class="selector-class">.redhat</span><span class="selector-class">.com</span>/rhel7/pod-infrastructure:latest</span><br></pre></td></tr></table></figure>
<p>上面是openshift中的配置参数，kubernetes中默认的配置参数是：</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KUBELET_POD_INFRA_CONTAINER=--pod-infra-<span class="keyword">container</span>-<span class="keyword">image</span>=gcr.io/google_containers/<span class="keyword">pause</span>-amd64:<span class="number">3.0</span></span><br></pre></td></tr></table></figure>
<p>Pause容器，是可以自己来定义，官方使用的gcr.io/google_containers/pause-amd64:3.0容器的代码见Github，使用C语言编写。</p>
<h2 id="Pause容器的作用"><a href="#Pause容器的作用" class="headerlink" title="Pause容器的作用"></a>Pause容器的作用</h2><p>检查nod节点的时候会发现每个node上都运行了很多的pause容器，例如如下:</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@elk<span class="string">-02</span> bin]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE                                               COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">576c56bd6065        mirrorgooglecontainers/kubernetes-dashboard-amd64   "/dashboard --inse..."   2 hours ago         Up 2 hours                              k8s_kubernetes-dashboard_kubernetes-dashboard<span class="string">-66</span>c9d98865-jdbg8_kube-system_d2406f4f<span class="string">-6</span>de3<span class="string">-11</span>e8<span class="string">-8760</span><span class="string">-5254004</span>f2222_0</span><br><span class="line">c4985381c2b7        d4b7466213fe                                        "/coredns -conf /e..."   2 hours ago         Up 2 hours                              k8s_coredns_coredns<span class="string">-77</span>c989547b-xq4dr_kube-system_d23ef2c4<span class="string">-6</span>de3<span class="string">-11</span>e8<span class="string">-8760</span><span class="string">-5254004</span>f2222_1</span><br><span class="line">ba2fef1cbf00        mirrorgooglecontainers/pause-amd64:3.0              "/pause"                 2 hours ago         Up 2 hours                              k8s_POD_coredns<span class="string">-77</span>c989547b-xq4dr_kube-system_d23ef2c4<span class="string">-6</span>de3<span class="string">-11</span>e8<span class="string">-8760</span><span class="string">-5254004</span>f2222_1</span><br><span class="line">ea6c2994b397        d4b7466213fe                                        "/coredns -conf /e..."   2 hours ago         Up 2 hours                              k8s_coredns_coredns<span class="string">-77</span>c989547b-lcbfw_kube-system_0696926b<span class="string">-6</span>d79<span class="string">-11</span>e8<span class="string">-8760</span><span class="string">-5254004</span>f2222_1</span><br><span class="line">f61476c51230        mirrorgooglecontainers/pause-amd64:3.0              "/pause"                 2 hours ago         Up 2 hours                              k8s_POD_kubernetes-dashboard<span class="string">-66</span>c9d98865-jdbg8_kube-system_d2406f4f<span class="string">-6</span>de3<span class="string">-11</span>e8<span class="string">-8760</span><span class="string">-5254004</span>f2222_0</span><br><span class="line">b6f61200d5ea        mirrorgooglecontainers/pause-amd64:3.0              "/pause"                 2 hours ago         Up 2 hours                              k8s_POD_coredns<span class="string">-77</span>c989547b-lcbfw_kube-system_0696926b<span class="string">-6</span>d79<span class="string">-11</span>e8<span class="string">-8760</span><span class="string">-5254004</span>f2222_1</span><br></pre></td></tr></table></figure>
<p>kubernetes中的pause容器主要为每个业务容器提供以下功能：</p>
<ul>
<li>在pod中担任Linux命名空间共享的基础；</li>
<li>启用pid命名空间，开启init进程。</li>
</ul>
<p>pause容器的作用可以从这个例子中看出，首先见下图：<br><img src="https://cos.leiyawu.com/docker/k8s/pause-container.png" alt="map"></p>
<h2 id="Pause容器测试"><a href="#Pause容器测试" class="headerlink" title="Pause容器测试"></a>Pause容器测试</h2><p>首先在节点上运行一个pause容器。</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --<span class="keyword">name</span> <span class="keyword">pause</span> -p <span class="number">8880</span>:<span class="number">80</span> martin/<span class="keyword">pause</span>-amd64:<span class="number">3.0</span></span><br></pre></td></tr></table></figure>
<p>然后再运行一个nginx容器，nginx将为localhost:2398创建一个代理。</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">cat</span> &lt;&lt;EOF &gt;&gt; nginx.conff</span><br><span class="line">error_log stderr;</span><br><span class="line">events &#123; worker_connections  1024; &#125;</span><br><span class="line">http &#123;</span><br><span class="line">    access_log /dev/stdout combined;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80 default_server;</span><br><span class="line">        server_name example.com www.example.com;</span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http:<span class="comment">//127.0.0.1:2398;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">$ docker <span class="keyword">run</span> -<span class="keyword">d</span> --name nginx -v `<span class="keyword">pwd</span>`/nginx.<span class="keyword">conf</span>:/etc/nginx/nginx.<span class="keyword">conf</span> --<span class="keyword">net</span>=container:<span class="keyword">pause</span> --ipc=container:<span class="keyword">pause</span> --pid=container:<span class="keyword">pause</span> nginx</span><br></pre></td></tr></table></figure>
<p>然后再为ghost创建一个应用容器，这是一款博客软件。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="builtin-name">run</span> -d --name ghost <span class="attribute">--net</span>=container:pause <span class="attribute">--ipc</span>=container:pause <span class="attribute">--pid</span>=container:pause ghost</span><br></pre></td></tr></table></figure>
<p>现在访问<a href="http://localhost:8880/就可以看到ghost博客的界面了。" target="_blank" rel="noopener">http://localhost:8880/就可以看到ghost博客的界面了。</a></p>
<h2 id="Pause容器解析"><a href="#Pause容器解析" class="headerlink" title="Pause容器解析"></a>Pause容器解析</h2><p>pause容器将内部的80端口映射到宿主机的8880端口，pause容器在宿主机上设置好了网络namespace后，nginx容器加入到该网络namespace中，我们看到nginx容器启动的时候指定了–net=container:pause，ghost容器同样加入到了该网络namespace中，这样三个容器就共享了网络，互相之间就可以使用localhost直接通信，–ipc=contianer:pause –pid=container:pause就是三个容器处于同一个namespace中，init进程为pause，这时我们进入到ghost容器中查看进程情况。</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ps aux</span></span><br><span class="line">USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">root        <span class="number"> 1 </span> 0.0  0.0  <span class="number"> 1024 </span>   <span class="number"> 4 </span>?        Ss   13:49   0:00 /pause</span><br><span class="line">root        <span class="number"> 5 </span> 0.0  0.1 <span class="number"> 32432 </span><span class="number"> 5736 </span>?        Ss   13:51   0:00 nginx: master p</span><br><span class="line">systemd+    <span class="number"> 9 </span> 0.0  0.0 <span class="number"> 32980 </span><span class="number"> 3304 </span>?        S    13:51   0:00 nginx: worker p</span><br><span class="line">node       <span class="number"> 10 </span> 0.3  2.0<span class="number"> 1254200 </span>83788 ?       Ssl  13:53   0:03 node current/in</span><br><span class="line">root       <span class="number"> 79 </span> 0.1  0.0  <span class="number"> 4336 </span> <span class="number"> 812 </span>pts/0    Ss   14:09   0:00 sh</span><br><span class="line">root       <span class="number"> 87 </span> 0.0  0.0 <span class="number"> 17500 </span><span class="number"> 2080 </span>pts/0    R+   14:10   0:00 ps aux</span><br></pre></td></tr></table></figure>
<p>在ghost容器中同时可以看到pause和nginx容器的进程，并且pause容器的PID是1。而在kubernetes中容器的PID=1的进程即为容器本身的业务进程。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://o-my-chenjian.com/2017/10/17/The-Pause-Container-Of-Kubernetes/" target="_blank" rel="noopener">Kubernetes只Pause容器</a></p>
<p><a href="https://jimmysong.io/posts/what-is-a-pause-container/" target="_blank" rel="noopener">kubernetes中的infra容器——Pause容器探究</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.leiyawu.com/2018/05/24/crontab和anacron和logrotate-relation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Martin Lei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="让一切随风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/24/crontab和anacron和logrotate-relation/" itemprop="url">crontab、anacron、logrotate relationship</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-24T16:33:00+08:00">
                2018-05-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Logrotate/" itemprop="url" rel="index">
                    <span itemprop="name">Logrotate</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>服务器上的nginx使用logrotate来分割日志，设置为每天分割。但是logrotate似乎没有工作，日志并没有分割。服务器是CentOS 6。</p>
<p>为了找到原因，分析可能出错的地方。<br>如果是logrotate未执行，可能是crond没有启动，因为logrotate被/etc/cron.daily/logrotate脚本所启动，可以查看其中代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="built_in">test</span> ~]<span class="comment"># cat /etc/cron.daily/logrotate</span></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">/usr/sbin/logrotate /etc/logrotate.conf</span><br><span class="line">EXITVALUE=$?</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$EXITVALUE</span> != 0 ]; <span class="keyword">then</span></span><br><span class="line">    /usr/bin/logger -t logrotate <span class="string">"ALERT exited abnormally with [<span class="variable">$EXITVALUE</span>]"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>
<p>可以看到logrotate运行时加载配置文件logrotate.conf，而这个配置文件除了设定一些分割日志相关的选项，还包含分割日志的配置文件目录/etc/logrotate.d。</p>
<p>nginx的日志分割配置文件就保存在logrotate.d目录：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]<span class="meta"># cat !$</span></span><br><span class="line">cat <span class="meta-keyword">/etc/</span>logrotate.d/nginx</span><br><span class="line"><span class="meta-keyword">/root/</span>*.<span class="class">log </span>&#123;</span><br><span class="line">    Daily</span><br><span class="line">    Missingok</span><br><span class="line">    rotate <span class="number">52</span></span><br><span class="line">    compress</span><br><span class="line">    delaycompress</span><br><span class="line">    notifempty</span><br><span class="line">    dateext</span><br><span class="line">    create <span class="number">644</span> nobody nobody</span><br><span class="line">    sharedscripts</span><br><span class="line">    postrotate</span><br><span class="line">    [ -f <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/nginx/</span>logs/nginx.pid ] &amp;&amp; kill -USR1 `cat <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/nginx/</span>logs/nginx.pid`</span><br><span class="line">    endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>/root/*.log就是需要被分割的日志的目录，通配符*表示目录内的所有log文件都被分割，分割的规则就是{…}中的内容。这里把/root/*.log当做nginx日志只是为了测试。<br>在启动crond服务后，发现日志还是没有分割，于是想到会不会是/etc/logrotate.d/nginx配置文件的语法有问题，使用以下命令调试这个文件：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logrotate -vfd <span class="meta-keyword">/etc/</span>logrotate.d/nginx  <span class="meta"># -vfd 三个选项分别表示显示详情，强制分割日志，只是调试配置文件而不是真的分割日志</span></span><br></pre></td></tr></table></figure>
<p>输出结果表明有语法错误，Daily，Missingok 都应该是小写。改成daily，missingok。再次调试配置文件，可以正确分割日志：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# ls <span class="number">-1</span> /root/</span><br><span class="line">install<span class="number">-2017</span><span class="number">-5</span><span class="number">-14.</span>log</span><br><span class="line">install<span class="number">-2017</span><span class="number">-5</span><span class="number">-14.</span>log<span class="number">-20170521</span>  #logrotate归档的日志</span><br></pre></td></tr></table></figure>
<p>上面猜测是crond执行/etc/cron.daily/内的脚本，实现定时执行计划任务，包括执行logrotate日志分割。<br>为了验证是否正确，网上搜索一番后找到了答案。如果没有crontab命令，先安装：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install crontabs  <span class="comment">#安装crond，crond实际上来自cronie包，这个包作为crontabs包的依赖被安装</span></span><br><span class="line">chkconfig --<span class="keyword">add</span><span class="bash"> crond <span class="comment">#添加到开机启动列表</span></span></span><br><span class="line"><span class="bash">chkconfig crond on    <span class="comment">#开机启动crond服务</span></span></span><br><span class="line"><span class="bash">/etc/init.d/crond     <span class="comment">#立即启动crond</span></span></span><br></pre></td></tr></table></figure>
<p>以下文件或目录的作用：<br>cron计划任务有两种类型：</p>
<ul>
<li>1）系统cron任务：由crond服务执行，/etc/crontab配置系统级别的任务</li>
<li>2）用户cron任务：由crond服务执行，用crontab命令编辑用户级别的任务</li>
</ul>
<font color="#DC143C" size="3">属于系统cron任务的文件或目录：</font>

<ul>
<li>/etc/cron.d             #系统的任务脚本。执行 rpm -ql cronie 可以看到该目录被cronie包安装</li>
<li>/etc/cron.hourly     #每小时执行其内脚本。其中的0anacron文件调用anacron来执行任务，它被包cronie-anacron安装</li>
<li>/etc/cron.daily        #每天执行其内脚本。也被anacron执行其内脚本，logrotate调用脚本就在该目录内</li>
<li>/etc/cron.weekly     #每周执行其内脚本。</li>
<li>/etc/cron.monthly   #每月执行其内脚本。</li>
</ul>
<p><font color="#DC143C" size="3">控制用户cron任务的执行：</font></p>
<ul>
<li>/etc/cron.allow   #默认不存在，如果这个文件存在，只有用户在这个文件中才能使用crontab命令</li>
<li>/etc/cron.deny    #将不可以使用crontab命令的用户写入其中</li>
</ul>
<p>注意：cron.allow和cron.deny就是用户名的列表，每行一个用户名。比如 cron.deny中有一行jason，效果是如果当前登录用户是jason，执行 crontab -e会提示不允许使用crontab命令。</p>
<p>以下三个目录的作用：</p>
<p>/var/spool/cron/USER_NAME</p>
<p>#这个文件才是跟crontab -e/-l 关联的，这个文件保存了crontab -e编辑的任务内容</p>
<p>#比如执行 crontab -u root -e，编辑保存后，就会有/var/spool/cron/root 这个文件</p>
<p>/var/spool/anacron/{cron.daily,cron.monthly,cron.weekly}</p>
<p>#这三个文件记录了anacron上一次执行的时间（上一天，上一周或上一月）</p>
<p>#anacron任务执行时，对照这里的时间，决定是否执行anacron任务</p>
<p>/var/lib/logrotate.status</p>
<p>#这个文件记录logrotate执行情况，logrotate参考这个文件来决定是否需要rotate日志</p>
<p>crontab和anacron和logrotate的关系：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]<span class="comment"># cat /etc/cron.d/0hourly     #这个文件指定每小时的01分执行/etc/cron.hourly内的所有脚本</span></span><br><span class="line">SHELL=/bin/bash</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">MAILTO=root</span><br><span class="line">HOME=/</span><br><span class="line">01 * * * * root run-parts /etc/cron.hourly  <span class="comment">#这里的root指定执行任务的用户，run-parts其实是一个可执行脚本，在/usr/bin/run-parts，用来执行cron.hourly目录内的所有脚本</span></span><br></pre></td></tr></table></figure>
<p>说明：用crontab -e命令每次编辑完某个用户的cron设置后，cron自动在/var/spool/cron下生成一个与此用户同名的文件，此用户的cron信息都记录在这个文件中。cron启动后每过一份钟读一次这个文件，检查是否要执行里面的命令。因此此文件修改后不需要重新启动cron服务。cron服务每分钟不仅要读一次/var/spool/cron内的所有文件，还需要读一次/etc/crontab，因此我们配置这个文件也能运用cron服务做一些事情。用crontab命令配置是针对某个用户的，而编辑/etc/crontab是针对系统的任务。此文件的文件格式是：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SHELL=<span class="regexp">/bin/bash</span></span><br><span class="line">PATH=<span class="regexp">/sbin:/bin</span><span class="symbol">:/usr/sbin</span><span class="symbol">:/usr/bin</span>     <span class="comment">#可执行文件查找路径</span></span><br><span class="line">MAILTO=root      <span class="comment">#如果出现错误，或者有数据输出，数据作为邮件发给这个帐号</span></span><br><span class="line">HOME=<span class="regexp">/           #使用者运行的路径，这里是根目录</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="built_in">test</span> ~]<span class="comment"># cat /etc/cron.hourly/0anacron   #cron.hourly目录下的脚本，根据条件执行anacron命令</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Skip excecution unless the date has changed from the previous run</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -r /var/spool/anacron/cron.daily; <span class="keyword">then</span></span><br><span class="line">    day=`cat /var/spool/anacron/cron.daily`</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ `date +%Y%m%d` = <span class="string">"<span class="variable">$day</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">exit</span> 0;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Skip excecution unless AC powered</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -x /usr/bin/on_ac_power; <span class="keyword">then</span></span><br><span class="line">    /usr/bin/on_ac_power &amp;&gt; /dev/null</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">test</span> $? -eq 1; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">/usr/sbin/anacron -s</span><br></pre></td></tr></table></figure>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@test</span> ~]<span class="comment"># cat /etc/anacrontab   #如果执行anacron命令，那么接着查看anacron的配置文件</span></span><br><span class="line"><span class="comment"># /etc/anacrontab: configuration file for anacron</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># See anacron(8) and anacrontab(5) for details.</span></span><br><span class="line"></span><br><span class="line">SHELL=<span class="regexp">/bin/sh</span></span><br><span class="line">PATH=<span class="regexp">/sbin:/bin</span><span class="symbol">:/usr/sbin</span><span class="symbol">:/usr/bin</span></span><br><span class="line">MAILTO=root</span><br><span class="line"><span class="comment"># the maximal random delay added to the base delay of the jobs</span></span><br><span class="line">RANDOM_DELAY=<span class="number">45</span>     <span class="comment">#最大延迟时间</span></span><br><span class="line"><span class="comment"># the jobs will be started during the following hours only</span></span><br><span class="line">START_HOURS_RANGE=<span class="number">3</span>-<span class="number">22</span>     <span class="comment">#只有在3-22点之间执行任务</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#period in days   delay in minutes   job-identifier   command</span></span><br><span class="line"><span class="number">1</span>    <span class="number">5</span>    cron.daily        nice run-parts /etc/cron.daily</span><br><span class="line"><span class="number">7</span>    <span class="number">25</span>    cron.weekly        nice run-parts /etc/cron.weekly</span><br><span class="line"><span class="variable">@monthly</span> <span class="number">45</span>    cron.monthly        nice run-parts /etc/cron.monthly</span><br></pre></td></tr></table></figure>
<p>以上anacrontab配置文件最重要的是最后一部分，以这行为例：</p>
<p>1    5    cron.daily        nice run-parts /etc/cron.daily</p>
<p>表示每天都执行/etc/cront.daily/目录下的脚本文件，真实的延迟是RANDOM_DELAY+delay。这里的延迟是5分钟，加上上面的RANDOM_DELAY，所以实际的延迟时间是5-50之间，开始时间为03-22点，如果机器没关，那么一般就是在03:05-03:50之间执行。<font color="#DC143C" size="3">nice命令将该进程设置为nice=10，默认为0，即低优先级进程。</font>如果RANDOM_DELAY=0，那么表示准确延迟5min，即03:05执行cron.daily内的脚本。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="built_in">test</span> ~]<span class="comment"># cat /etc/cron.daily/logrotate  #最后在cron.daily内有logrotate的调用脚本</span></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">/usr/sbin/logrotate /etc/logrotate.conf       <span class="comment">#logrotate将会读取配置文件，最终会读取到/etc/logrotate.d/nginx</span></span><br><span class="line">EXITVALUE=$?</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$EXITVALUE</span> != 0 ]; <span class="keyword">then</span></span><br><span class="line">    /usr/bin/logger -t logrotate <span class="string">"ALERT exited abnormally with [<span class="variable">$EXITVALUE</span>]"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>
<p>当logrotate命令加载了/etc/logrotate.d/nginx配置文件时，还要比较nginx日志的归档日期：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# cat /var/lib/logrotate.status | grep /root</span><br><span class="line"><span class="string">"/root/install-2017-5-14.log"</span> <span class="number">2017</span><span class="number">-5</span><span class="number">-21</span>   #如果今天是<span class="number">2017</span><span class="number">-5</span><span class="number">-21</span>，这个文件里也是<span class="number">2017</span><span class="number">-5</span><span class="number">-21</span>，说明今天已经归档过了，否则就会归档（分割）nginx日志</span><br></pre></td></tr></table></figure>
<p>综上，整个逻辑流程为：</p>
<p>crond服务加载/etc/cron.d/0hourly —&gt;在每小时的01分执行/etc/cront.hourly/0anacron —&gt;执行anacron —&gt;根据/etc/anacrontab的配置执行/etc/cron.daily，/etc/cron.weekly，/etc/cron.monthly —&gt;执行/etc/cron.daily/下的logrotate脚本 —&gt;执行logrotate —&gt;根据/etc/logrotate.conf配置执行脚本/etc/logrotate.d/nginx —&gt;分割nginx日志成功</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.leiyawu.com/2018/05/21/ELK-Sentinl/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Martin Lei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="让一切随风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/21/ELK-Sentinl/" itemprop="url">ELK Sentinl</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-21T10:06:00+08:00">
                2018-05-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ELK/" itemprop="url" rel="index">
                    <span itemprop="name">ELK</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Sentinl简介"><a href="#Sentinl简介" class="headerlink" title="Sentinl简介"></a>Sentinl简介</h3><p>Sentinl 5扩展自Kibi / Kibana 5，具有警报和报告功能，可使用标准查询，可编程验证器和各种可配置操作来监控，通知和报告数据系列更改 - 将其视为一个独立的“观察者” “报告”功能（PNG / PDFs快照）。</p>
<p>SENTINEL还旨在通过直接在Kibana UI中整合来简化在Kibi / Kibana中创建和管理警报和报告的过程。</p>
<h3 id="功能模块"><a href="#功能模块" class="headerlink" title="功能模块"></a>功能模块</h3><p>Watchers<br>Alarms<br>Reports<br>Watchers是Sentinl核心，主要由 input,Condition,Transform,Actions几大块组成，可以和X-Pack一一对应，部分文档可参考X-Pack，但需要注意的是它和X-Pack还有一些区别，主要体现在input只实现了search，其他并未实现，Actions也并未都实现</p>
<h3 id="安装与配置"><a href="#安装与配置" class="headerlink" title="安装与配置"></a>安装与配置</h3><ul>
<li>安装</li>
</ul>
<p>/usr/share/kibana/bin/kibana-plugin install <a href="https://github.com/sirensolutions/sentinl/releases/download/tag-5.5/sentinl-v5.6.5.zip" target="_blank" rel="noopener">https://github.com/sirensolutions/sentinl/releases/download/tag-5.5/sentinl-v5.6.5.zip</a></p>
<ul>
<li>config</li>
</ul>
<p>kibana.yml config:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sentinl:</span></span><br><span class="line"><span class="attr">  es:</span></span><br><span class="line"><span class="attr">    timefield:</span> <span class="string">'@timestamp'</span></span><br><span class="line"><span class="attr">    default_index:</span> <span class="string">watcher</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">    alarm_index:</span> <span class="string">watcher_alarms</span></span><br><span class="line"><span class="attr">  sentinl:</span></span><br><span class="line"><span class="attr">    history:</span> <span class="number">20</span></span><br><span class="line"><span class="attr">    results:</span> <span class="number">50</span></span><br><span class="line"><span class="attr">  settings:</span></span><br><span class="line"><span class="attr">    email:</span></span><br><span class="line"><span class="attr">      active:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      user:</span> <span class="string">username</span></span><br><span class="line"><span class="attr">      password:</span> <span class="string">password</span></span><br><span class="line"><span class="attr">      host:</span> <span class="string">smtp.server.com</span></span><br><span class="line"><span class="attr">      ssl:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      timeout:</span> <span class="number">10000</span>  <span class="comment"># mail server connection timeout</span></span><br><span class="line"><span class="attr">    slack:</span></span><br><span class="line"><span class="attr">      active:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      username:</span> <span class="string">username</span></span><br><span class="line"><span class="attr">      hook:</span> <span class="string">'https://hooks.slack.com/services/&lt;token&gt;'</span></span><br><span class="line"><span class="attr">      channel:</span> <span class="string">'#channel'</span></span><br><span class="line"><span class="attr">    report:</span></span><br><span class="line"><span class="attr">      active:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      tmp_path:</span> <span class="string">/tmp/</span></span><br><span class="line"><span class="attr">    pushapps:</span></span><br><span class="line"><span class="attr">      active:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      api_key:</span> <span class="string">'&lt;pushapps API Key&gt;'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>raw</li>
</ul>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"input"</span>: &#123;</span><br><span class="line">      <span class="string">"search"</span>: &#123;</span><br><span class="line">        <span class="string">"request"</span>: &#123;</span><br><span class="line">          <span class="string">"index"</span>: [</span><br><span class="line">            <span class="string">"&lt;xxx-&#123;now/d&#125;&gt;"</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="string">"body"</span>: &#123;</span><br><span class="line">            <span class="string">"query"</span>: &#123;</span><br><span class="line">              <span class="string">"bool"</span>: &#123;</span><br><span class="line">                <span class="string">"should"</span>: [</span><br><span class="line">                  &#123;</span><br><span class="line">                    <span class="string">"match"</span>: &#123;</span><br><span class="line">                      <span class="string">"status"</span>: <span class="string">"502"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;,</span><br><span class="line">                  &#123;</span><br><span class="line">                    <span class="string">"match"</span>: &#123;</span><br><span class="line">                      <span class="string">"status"</span>: <span class="string">"404"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">"minimum_should_match"</span>: <span class="number">1</span>,  #must setup</span><br><span class="line">                <span class="string">"filter"</span>: &#123;</span><br><span class="line">                  <span class="string">"range"</span>: &#123;</span><br><span class="line">                    <span class="string">"@timestamp"</span>: &#123;</span><br><span class="line">                      <span class="string">"gte"</span>: <span class="string">"now-60s"</span>,</span><br><span class="line">                      <span class="string">"lte"</span>: <span class="string">"now"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"condition"</span>: &#123;</span><br><span class="line">      <span class="string">"script"</span>: &#123;</span><br><span class="line">        <span class="string">"script"</span>: <span class="string">"payload.hits.total &gt; 30"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.leiyawu.com/2018/05/07/es/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Martin Lei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="让一切随风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/07/es/" itemprop="url">ES内置账号密码修改、自定义角色自定义账号、ldap及AD认证</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-07T18:29:00+08:00">
                2018-05-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ELK/" itemprop="url" rel="index">
                    <span itemprop="name">ELK</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="自定义内置账号"><a href="#自定义内置账号" class="headerlink" title="自定义内置账号"></a>自定义内置账号</h2><ul>
<li>账户elastic为elasticsearch超级管理员，拥有所有权限</li>
<li>账户kibana用于kibana组件获取相关信息用于web展示</li>
<li>账户logstash_system用于logstash服务获取elasticsearch的监控数据</li>
<li>注意：此步骤需先启动elasticsearch服务</li>
</ul>
<p><img src="https://cos.leiyawu.com/img/elk/es_user.png" alt="es_user"></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch@elasticsearch elasticsearch-6.0.0]$ ./bin/x-pack/setup-passwords interactive</span><br><span class="line">Initiating the setup of reserved<span class="built_in"> user </span>elastic,kibana,logstash_system passwords.</span><br><span class="line">You will be prompted <span class="keyword">to</span> enter passwords as the process progresses.</span><br><span class="line">Please confirm that you would like <span class="keyword">to</span> continue [y/N]y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Enter password <span class="keyword">for</span> [elastic]: </span><br><span class="line">Reenter password <span class="keyword">for</span> [elastic]: </span><br><span class="line">Enter password <span class="keyword">for</span> [kibana]: </span><br><span class="line">Reenter password <span class="keyword">for</span> [kibana]: </span><br><span class="line">Enter password <span class="keyword">for</span> [logstash_system]: </span><br><span class="line">Reenter password <span class="keyword">for</span> [logstash_system]: </span><br><span class="line">Changed password <span class="keyword">for</span><span class="built_in"> user </span>[kibana]</span><br><span class="line">Changed password <span class="keyword">for</span><span class="built_in"> user </span>[logstash_system]</span><br><span class="line">Changed password <span class="keyword">for</span><span class="built_in"> user </span>[elastic]</span><br><span class="line">[elasticsearch@elasticsearch elasticsearch-6.0.0]$</span><br></pre></td></tr></table></figure>
<h2 id="验证内置账户访问"><a href="#验证内置账户访问" class="headerlink" title="验证内置账户访问"></a>验证内置账户访问</h2><ul>
<li>若不提供用户名密码则返回401</li>
</ul>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.<span class="number">0</span>]$ curl <span class="string">'http://10.59.30.96:9200/_cat/indices?pretty'</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"error"</span> : &#123;</span><br><span class="line">    <span class="string">"root_cause"</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"type"</span> : <span class="string">"security_exception"</span>,</span><br><span class="line">        <span class="string">"reason"</span> : <span class="string">"missing authentication token for REST request [/_cat/indices?pretty]"</span>,</span><br><span class="line">        <span class="string">"header"</span> : &#123;</span><br><span class="line">          <span class="string">"WWW-Authenticate"</span> : <span class="string">"Basic realm=\"</span>security\<span class="string">" charset=\"</span>UTF-<span class="number">8</span>\<span class="string">""</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"type"</span> : <span class="string">"security_exception"</span>,</span><br><span class="line">    <span class="string">"reason"</span> : <span class="string">"missing authentication token for REST request [/_cat/indices?pretty]"</span>,</span><br><span class="line">    <span class="string">"header"</span> : &#123;</span><br><span class="line">      <span class="string">"WWW-Authenticate"</span> : <span class="string">"Basic realm=\"</span>security\<span class="string">" charset=\"</span>UTF-<span class="number">8</span>\<span class="string">""</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"status"</span> : <span class="number">401</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>提供相应用户信息后可访问，若用户权限不足则返回403</p>
<p>使用logstash_system用户访问</p>
</li>
</ul>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.<span class="number">0</span>]$ curl <span class="symbol">'http</span>://<span class="number">10.59</span>.<span class="number">30.96</span>:<span class="number">9200</span>/_cat/indices?pretty' -u logstash_system:logstash_system</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"error"</span> : &#123;</span><br><span class="line">    <span class="string">"root_cause"</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"type"</span> : "<span class="type">security_exception</span><span class="string">",</span></span><br><span class="line"><span class="string">        "</span>reason<span class="string">" : "</span>action [indices:monitor/stats] <span class="keyword">is</span> unauthorized <span class="keyword">for</span> user [logstash_system]<span class="string">"</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    ],</span></span><br><span class="line"><span class="string">    "</span><span class="keyword">type</span><span class="string">" : "</span>security_exception<span class="string">",</span></span><br><span class="line"><span class="string">    "</span>reason<span class="string">" : "</span>action [indices:monitor/stats] <span class="keyword">is</span> unauthorized <span class="keyword">for</span> user [logstash_system]<span class="string">"</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  "</span>status<span class="string">" : 403</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">[elasticsearch@elasticsearch elasticsearch-6.0.0]$</span></span><br></pre></td></tr></table></figure>
<ul>
<li>使用kibana用户访问</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.<span class="number">0</span>]$ curl <span class="string">'http://10.59.30.96:9200/_cat/indices?pretty'</span> -u kibana:kibana</span><br><span class="line">yellow open <span class="selector-class">.monitoring-es-6-2018</span>.<span class="number">01.10</span>   nND6-i_rR5iLEYVccBGj8w <span class="number">1</span> <span class="number">1</span>    </span><br><span class="line">yellow open <span class="selector-class">.triggered_watches</span>            BtygGZisSDqiL3Y2TaQGqQ <span class="number">1</span> <span class="number">1</span>    </span><br><span class="line">green  open <span class="selector-class">.security-6</span>                   QVRL1mcFSAilryHGEhen7Q <span class="number">1</span> <span class="number">0</span>    </span><br><span class="line">yellow open <span class="selector-class">.watcher-history-6-2018</span>.<span class="number">01.10</span> SBGiHDAnTPiXFoHU65VY_g <span class="number">1</span> <span class="number">1</span>    </span><br><span class="line">yellow open <span class="selector-class">.watches</span>                      kMzN4j5cQySZQQSDVPww8w <span class="number">1</span> <span class="number">1</span>    </span><br><span class="line">yellow open <span class="selector-class">.monitoring-alerts-6</span>          VygY6VN9R3S0PR_jrGy50Q <span class="number">1</span> <span class="number">1</span>    </span><br><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.<span class="number">0</span>]$</span><br></pre></td></tr></table></figure>
<h2 id="添加自定义角色"><a href="#添加自定义角色" class="headerlink" title="添加自定义角色"></a>添加自定义角色</h2><ul>
<li><p>添加角色接口为 POST /_xpack/security/role/<rolename></rolename></p>
<p>下述示例为添加超级管理员角色的方法</p>
</li>
</ul>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.<span class="number">0</span>]$ curl -XPOST -H <span class="symbol">'Content</span>-<span class="keyword">type</span>: application/json' -u elastic:elastic <span class="symbol">'http</span>://<span class="number">10.59</span>.<span class="number">30.96</span>:<span class="number">9200</span>/_xpack/security/role/admin?pretty' -d '&#123;</span><br><span class="line">&gt;   <span class="string">"run_as"</span>: [ <span class="string">"elastic"</span> ],</span><br><span class="line">&gt;   <span class="string">"cluster"</span>: [ <span class="string">"all"</span> ],</span><br><span class="line">&gt;   <span class="string">"indices"</span>: [</span><br><span class="line">&gt;     &#123;</span><br><span class="line">&gt;       <span class="string">"names"</span>: [ <span class="string">"*"</span> ],</span><br><span class="line">&gt;       <span class="string">"privileges"</span>: [ <span class="string">"all"</span> ]</span><br><span class="line">&gt;     &#125;</span><br><span class="line">&gt;   ]</span><br><span class="line">&gt; &#125;'</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"role"</span> : &#123;</span><br><span class="line">    <span class="string">"created"</span> : <span class="type">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.<span class="number">0</span>]$ curl -XGET -H <span class="symbol">'Content</span>-<span class="keyword">type</span>: application/json' -u elastic:elastic <span class="symbol">'http</span>://<span class="number">10.59</span>.<span class="number">30.96</span>:<span class="number">9200</span>/_xpack/security/role/admin?pretty'</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"admin"</span> : &#123;</span><br><span class="line">    <span class="string">"cluster"</span> : [</span><br><span class="line">      <span class="string">"all"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"indices"</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"names"</span> : [</span><br><span class="line">          <span class="string">"*"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"privileges"</span> : [</span><br><span class="line">          <span class="string">"all"</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"run_as"</span> : [</span><br><span class="line">      <span class="string">"elastic"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"metadata"</span> : &#123; &#125;,</span><br><span class="line">    <span class="string">"transient_metadata"</span> : &#123;</span><br><span class="line">      <span class="string">"enabled"</span> : <span class="type">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.<span class="number">0</span>]$</span><br></pre></td></tr></table></figure>
<h2 id="添加自定义账户"><a href="#添加自定义账户" class="headerlink" title="添加自定义账户"></a>添加自定义账户</h2><ul>
<li><p>添加用户接口为 POST /_xpack/security/user/<username></username></p>
<p>下述为添加martin账户并添加至admin角色操作方法</p>
</li>
</ul>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$ curl -<span class="type">XPOST</span> -<span class="type">H</span> <span class="symbol">'Content</span>-<span class="class"><span class="keyword">type</span></span>: application/json' -u elastic:elastic <span class="symbol">'http</span>:<span class="comment">//10.59.30.96:9200/_xpack/security/user/martin?pretty' -d '&#123;</span></span><br><span class="line">&gt;   <span class="string">"password"</span> : <span class="string">"123456"</span>,</span><br><span class="line">&gt;   <span class="string">"full_name"</span> : <span class="string">"Martin Lei"</span>,</span><br><span class="line">&gt;   <span class="string">"roles"</span> : [<span class="string">"admin"</span>],</span><br><span class="line">&gt;   <span class="string">"email"</span> : <span class="string">"martin@martin.com"</span></span><br><span class="line">&gt; &#125;'</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"user"</span> : &#123;</span><br><span class="line">    <span class="string">"created"</span> : <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$ curl -<span class="type">XGET</span> -<span class="type">H</span> <span class="symbol">'Content</span>-<span class="class"><span class="keyword">type</span></span>: application/json' -u elastic:elastic <span class="symbol">'http</span>:<span class="comment">//10.59.30.96:9200/_xpack/security/user/martin?pretty'</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"rocshen"</span> : &#123;</span><br><span class="line">    <span class="string">"username"</span> : <span class="string">"martin"</span>,</span><br><span class="line">    <span class="string">"roles"</span> : [</span><br><span class="line">      <span class="string">"admin"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"full_name"</span> : <span class="string">"Martin Lei"</span>,</span><br><span class="line">    <span class="string">"email"</span> : <span class="string">"martin@martin.com"</span>,</span><br><span class="line">    <span class="string">"metadata"</span> : &#123; &#125;,</span><br><span class="line">    <span class="string">"enabled"</span> : <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$ curl -<span class="type">XGET</span> -<span class="type">H</span> <span class="symbol">'Content</span>-<span class="class"><span class="keyword">type</span></span>: application/json' -u martin:<span class="number">123456</span> <span class="symbol">'http</span>:<span class="comment">//10.59.30.96:9200/_cat/indices?pretty'</span></span><br><span class="line">yellow open .monitoring-es<span class="number">-6</span><span class="number">-2018.01</span><span class="number">.10</span>   nND6-i_rR5iLEYVccBGj8w <span class="number">1</span> <span class="number">1</span> <span class="number">4883</span> <span class="number">88</span>   <span class="number">2.5</span>mb   <span class="number">2.5</span>mb</span><br><span class="line">yellow open .triggered_watches            <span class="type">BtygGZisSDqiL3Y2TaQGqQ</span> <span class="number">1</span> <span class="number">1</span>    <span class="number">0</span>  <span class="number">0</span>  <span class="number">24.2</span>kb  <span class="number">24.2</span>kb</span><br><span class="line">green  open .security<span class="number">-6</span>                   <span class="type">QVRL1mcFSAilryHGEhen7Q</span> <span class="number">1</span> <span class="number">0</span>                        </span><br><span class="line">yellow open .watcher-history<span class="number">-6</span><span class="number">-2018.01</span><span class="number">.10</span> <span class="type">SBGiHDAnTPiXFoHU65VY_g</span> <span class="number">1</span> <span class="number">1</span>  <span class="number">630</span>  <span class="number">0</span> <span class="number">703.3</span>kb <span class="number">703.3</span>kb</span><br><span class="line">yellow open .watches                      kMzN4j5cQySZQQSDVPww8w <span class="number">1</span> <span class="number">1</span>    <span class="number">5</span>  <span class="number">0</span>  <span class="number">33.3</span>kb  <span class="number">33.3</span>kb</span><br><span class="line">yellow open .monitoring-alerts<span class="number">-6</span>          <span class="type">VygY6VN9R3S0PR_jrGy50Q</span> <span class="number">1</span> <span class="number">1</span>    <span class="number">1</span>  <span class="number">0</span>   <span class="number">6.5</span>kb   <span class="number">6.5</span>kb</span><br><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$</span><br></pre></td></tr></table></figure>
<h2 id="修改账户密码"><a href="#修改账户密码" class="headerlink" title="修改账户密码"></a>修改账户密码</h2><ol>
<li>修改密码需使用超级管理员权限即elastic账户，接口为POST _xpack/security/user/<username>/_password</username></li>
</ol>
<p>curl参数含义如下</p>
<ul>
<li>-XPOST 使用post方法传递参数</li>
<li>-H 指定http协议的header信息</li>
<li>-u 指定用于认证的用户信息用户名与密码使用冒号分隔</li>
<li>-d 指定具体要传递的参数信息</li>
</ul>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$ curl -<span class="type">XPOST</span> -<span class="type">H</span> <span class="symbol">'Content</span>-<span class="class"><span class="keyword">type</span></span>: application/json' -u elastic:elastic <span class="symbol">'http</span>:<span class="comment">//10.59.30.96:9200/_xpack/security/user/kibana/_password?pretty' -d '&#123;"password": "123456"&#125;'</span></span><br><span class="line">&#123; &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>密码修改后使用老密码访问则返回401，使用更新后的密码则正常</li>
</ol>
<figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.0]$ curl 'http:<span class="comment">//10.59.30.96:9200/_cat/indices?pretty' -u kibana:kibana</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"error"</span> : &#123;</span><br><span class="line">    <span class="string">"root_cause"</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"type"</span> : <span class="string">"security_exception"</span>,</span><br><span class="line">        <span class="string">"reason"</span> : <span class="string">"failed to authenticate user [kibana]"</span>,</span><br><span class="line">        <span class="string">"header"</span> : &#123;</span><br><span class="line">          <span class="string">"WWW-Authenticate"</span> : <span class="string">"Basic realm=\"</span>security\<span class="string">" charset=\"</span>UTF-<span class="number">8</span>\<span class="string">""</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"type"</span> : <span class="string">"security_exception"</span>,</span><br><span class="line">    <span class="string">"reason"</span> : <span class="string">"failed to authenticate user [kibana]"</span>,</span><br><span class="line">    <span class="string">"header"</span> : &#123;</span><br><span class="line">      <span class="string">"WWW-Authenticate"</span> : <span class="string">"Basic realm=\"</span>security\<span class="string">" charset=\"</span>UTF-<span class="number">8</span>\<span class="string">""</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"status"</span> : <span class="number">401</span></span><br><span class="line">&#125;</span><br><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.0]$ curl 'http:<span class="comment">//10.59.30.96:9200/_cat/indices?pretty' -u kibana:123456</span></span><br><span class="line">yellow <span class="keyword">open</span> .monitoring-es-<span class="number">6</span>-<span class="number">2018.01</span>.10   nND6-i_rR5iLEYVccBGj8w <span class="number">1</span> <span class="number">1</span>    </span><br><span class="line">yellow <span class="keyword">open</span> .triggered_watches            BtygGZisSDqiL3Y2TaQGqQ <span class="number">1</span> <span class="number">1</span>    </span><br><span class="line">green  <span class="keyword">open</span> .security-<span class="number">6</span>                   QVRL1mcFSAilryHGEhen7Q <span class="number">1</span> <span class="number">0</span>    </span><br><span class="line">yellow <span class="keyword">open</span> .watcher-history-<span class="number">6</span>-<span class="number">2018.01</span>.10 SBGiHDAnTPiXFoHU65VY_g <span class="number">1</span> <span class="number">1</span>    </span><br><span class="line">yellow <span class="keyword">open</span> .watches                      kMzN4j5cQySZQQSDVPww8w <span class="number">1</span> <span class="number">1</span>    </span><br><span class="line">yellow <span class="keyword">open</span> .monitoring-alerts-<span class="number">6</span>          VygY6VN9R3S0PR_jrGy50Q <span class="number">1</span> <span class="number">1</span>    </span><br><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.0]$</span><br></pre></td></tr></table></figure>
<h2 id="配置ldap帐号认证"><a href="#配置ldap帐号认证" class="headerlink" title="配置ldap帐号认证"></a>配置ldap帐号认证</h2><p>ldap服务安装可参考：<a href="https://segmentfault.com/a/11.." target="_blank" rel="noopener">https://segmentfault.com/a/11..</a>.</p>
<p>添加下述ldap相关述配置 bind_dn为ldap的管理DN</p>
<ul>
<li>bind_password为管理dn的密码</li>
<li>user_search.base_dn为linux系统账户信息导入ldap的信息</li>
<li>user_search.attribute为账户在ldap中的标识信息</li>
<li>group_search.base_dn为linux系统组信息导入ldap的信息</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.<span class="number">0</span>]$ vim config/elasticsearch<span class="selector-class">.yml</span> </span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">network<span class="selector-class">.host</span>: <span class="number">10.59</span>.<span class="number">30.96</span></span><br><span class="line">bootstrap<span class="selector-class">.system_call_filter</span>: false</span><br><span class="line"></span><br><span class="line">xpack<span class="selector-class">.ssl</span><span class="selector-class">.key</span>: elasticsearch/elasticsearch.key</span><br><span class="line">xpack<span class="selector-class">.ssl</span><span class="selector-class">.certificate</span>: elasticsearch/elasticsearch.crt</span><br><span class="line">xpack<span class="selector-class">.ssl</span><span class="selector-class">.certificate_authorities</span>: ca/ca.crt</span><br><span class="line">xpack<span class="selector-class">.security</span><span class="selector-class">.transport</span><span class="selector-class">.ssl</span><span class="selector-class">.enabled</span>: true</span><br><span class="line"></span><br><span class="line">xpack:</span><br><span class="line">  security:</span><br><span class="line">    authc:</span><br><span class="line">      realms:</span><br><span class="line">        ldap1:</span><br><span class="line">          type: ldap</span><br><span class="line">          <span class="attribute">order</span>: <span class="number">0</span></span><br><span class="line">          url: <span class="string">"ldap://10.59.30.95"</span></span><br><span class="line">          bind_dn: <span class="string">"cn=Manager, dc=martin, dc=com"</span></span><br><span class="line">          bind_password: <span class="number">123456</span></span><br><span class="line">          user_search:</span><br><span class="line">            base_dn: <span class="string">"ou=People,dc=martin,dc=com"</span></span><br><span class="line">            attribute: uid</span><br><span class="line">          group_search:</span><br><span class="line">            base_dn: <span class="string">"ou=Group,dc=martin,dc=com"</span></span><br><span class="line">          unmapped_groups_as_roles: false</span><br></pre></td></tr></table></figure>
<h2 id="配置AD域帐号认证"><a href="#配置AD域帐号认证" class="headerlink" title="配置AD域帐号认证"></a>配置AD域帐号认证</h2><p>添加下ldap相关述配置至elasticsearch.yml，此处为接着上述LDAP配置添加，如果只需配置AD认证请将ldap相关配置删除即可；</p>
<ul>
<li>domain_name为AD域的域名</li>
<li>url为AD域的地址</li>
<li>bind_dnw为随意的域账户名称（格式为user@domain）</li>
<li>bind_password为上述账户的密码</li>
</ul>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">xpack</span>:</span><br><span class="line">  <span class="attribute">security</span>:</span><br><span class="line">    <span class="attribute">authc</span>:</span><br><span class="line">      <span class="attribute">realms</span>:</span><br><span class="line">        <span class="attribute">ldap1</span>:</span><br><span class="line">          <span class="attribute">type</span>: ldap</span><br><span class="line">          <span class="attribute">order</span>: <span class="number">0</span></span><br><span class="line">          <span class="attribute">url</span>: <span class="string">"ldap://10.59.30.94"</span></span><br><span class="line">          <span class="attribute">bind_dn</span>: <span class="string">"cn=Manager, dc=martin, dc=com"</span></span><br><span class="line">          <span class="attribute">bind_password</span>: <span class="number">123456</span></span><br><span class="line">          <span class="attribute">user_search</span>:</span><br><span class="line">            <span class="attribute">base_dn</span>: <span class="string">"ou=People,dc=martin,dc=com"</span></span><br><span class="line">            <span class="attribute">attribute</span>: uid</span><br><span class="line">          <span class="attribute">group_search</span>:</span><br><span class="line">            <span class="attribute">base_dn</span>: <span class="string">"ou=Group,dc=martin,dc=com"</span></span><br><span class="line">          <span class="attribute">unmapped_groups_as_roles</span>: false</span><br><span class="line">        <span class="attribute">active_directory</span>:</span><br><span class="line">          <span class="attribute">type</span>: active_directory</span><br><span class="line">          <span class="attribute">order</span>: <span class="number">1</span></span><br><span class="line">          <span class="attribute">domain_name</span>: martin.com</span><br><span class="line">          <span class="attribute">url</span>: <span class="attribute">ldap</span>:<span class="comment">//ad.martin.com</span></span><br><span class="line">          <span class="attribute">bind_dn</span>: martin<span class="variable">@martin</span>.com</span><br><span class="line">          <span class="attribute">bind_password</span>: AD.<span class="number">123456</span></span><br></pre></td></tr></table></figure>
<p>重启elasticsearch服务并使用ldap域账户user01登录</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$ killall java</span><br><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$ .<span class="regexp">/bin/</span>elasticsearch -d</span><br><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$ curl -XGET -u <span class="string">user01:</span>user01 <span class="string">'http://10.59.30.96:9200/_cat?pretty'</span></span><br><span class="line">=^.^=</span><br><span class="line"><span class="regexp">/_cat/</span>allocation</span><br><span class="line"><span class="regexp">/_cat/</span>shards</span><br><span class="line"><span class="regexp">/_cat/</span>shards/&#123;index&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>master</span><br><span class="line"><span class="regexp">/_cat/</span>nodes</span><br><span class="line"><span class="regexp">/_cat/</span>tasks</span><br><span class="line"><span class="regexp">/_cat/</span>indices</span><br><span class="line"><span class="regexp">/_cat/</span>indices/&#123;index&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>segments</span><br><span class="line"><span class="regexp">/_cat/</span>segments/&#123;index&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>count</span><br><span class="line"><span class="regexp">/_cat/</span>count/&#123;index&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>recovery</span><br><span class="line"><span class="regexp">/_cat/</span>recovery/&#123;index&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>health</span><br><span class="line"><span class="regexp">/_cat/</span>pending_tasks</span><br><span class="line"><span class="regexp">/_cat/</span>aliases</span><br><span class="line"><span class="regexp">/_cat/</span>aliases/&#123;alias&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>thread_pool</span><br><span class="line"><span class="regexp">/_cat/</span>thread_pool/&#123;thread_pools&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>plugins</span><br><span class="line"><span class="regexp">/_cat/</span>fielddata</span><br><span class="line"><span class="regexp">/_cat/</span>fielddata/&#123;fields&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>nodeattrs</span><br><span class="line"><span class="regexp">/_cat/</span>repositories</span><br><span class="line"><span class="regexp">/_cat/</span>snapshots/&#123;repository&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>templates</span><br><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$</span><br></pre></td></tr></table></figure>
<p>使用AD域账户martin登录</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$ curl <span class="string">http:</span><span class="comment">//10.59.30.96:9200/_cat?pretty -u martin:AD.123456</span></span><br><span class="line">=^.^=</span><br><span class="line"><span class="regexp">/_cat/</span>allocation</span><br><span class="line"><span class="regexp">/_cat/</span>shards</span><br><span class="line"><span class="regexp">/_cat/</span>shards/&#123;index&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>master</span><br><span class="line"><span class="regexp">/_cat/</span>nodes</span><br><span class="line"><span class="regexp">/_cat/</span>tasks</span><br><span class="line"><span class="regexp">/_cat/</span>indices</span><br><span class="line"><span class="regexp">/_cat/</span>indices/&#123;index&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>segments</span><br><span class="line"><span class="regexp">/_cat/</span>segments/&#123;index&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>count</span><br><span class="line"><span class="regexp">/_cat/</span>count/&#123;index&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>recovery</span><br><span class="line"><span class="regexp">/_cat/</span>recovery/&#123;index&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>health</span><br><span class="line"><span class="regexp">/_cat/</span>pending_tasks</span><br><span class="line"><span class="regexp">/_cat/</span>aliases</span><br><span class="line"><span class="regexp">/_cat/</span>aliases/&#123;alias&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>thread_pool</span><br><span class="line"><span class="regexp">/_cat/</span>thread_pool/&#123;thread_pools&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>plugins</span><br><span class="line"><span class="regexp">/_cat/</span>fielddata</span><br><span class="line"><span class="regexp">/_cat/</span>fielddata/&#123;fields&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>nodeattrs</span><br><span class="line"><span class="regexp">/_cat/</span>repositories</span><br><span class="line"><span class="regexp">/_cat/</span>snapshots/&#123;repository&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>templates</span><br><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$</span><br></pre></td></tr></table></figure>
<h2 id="为域账户信息映射角色"><a href="#为域账户信息映射角色" class="headerlink" title="为域账户信息映射角色"></a>为域账户信息映射角色</h2><p>接口为：POST /_xpack/security/role_mapping/<name></name></p>
<p>下述为映射user1*账户为管理员角色的操作步骤</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$ curl -<span class="type">XPOST</span> -<span class="type">H</span> <span class="symbol">'Content</span>-<span class="class"><span class="keyword">type</span></span>: application/json' -u elastic:elastic <span class="symbol">'http</span>:<span class="comment">//10.59.30.96:9200/_xpack/security/role_mapping/ldap_user_admin?pretty' -d '&#123;</span></span><br><span class="line">&gt;   <span class="string">"roles"</span>: [ <span class="string">"admin"</span> ],</span><br><span class="line">&gt;   <span class="string">"enabled"</span>: <span class="literal">true</span>,</span><br><span class="line">&gt;   <span class="string">"rules"</span>: &#123;</span><br><span class="line">&gt;     <span class="string">"any"</span>: [</span><br><span class="line">&gt;       &#123;</span><br><span class="line">&gt;         <span class="string">"field"</span>: &#123;</span><br><span class="line">&gt;           <span class="string">"username"</span>: <span class="string">"/user1*/"</span></span><br><span class="line">&gt;         &#125;</span><br><span class="line">&gt;       &#125;</span><br><span class="line">&gt;     ]</span><br><span class="line">&gt;   &#125;</span><br><span class="line">&gt; &#125;'</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"role_mapping"</span> : &#123;</span><br><span class="line">    <span class="string">"created"</span> : <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$ curl -<span class="type">XGET</span> -<span class="type">H</span> <span class="symbol">'Content</span>-<span class="class"><span class="keyword">type</span></span>: application/json' -u elastic:elastic <span class="symbol">'http</span>:<span class="comment">//10.59.30.96:9200/_xpack/security/role_mapping/ldap_user_admin?pretty'</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"ldap_user_admin"</span> : &#123;</span><br><span class="line">    <span class="string">"enabled"</span> : <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"roles"</span> : [</span><br><span class="line">      <span class="string">"admin"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"rules"</span> : &#123;</span><br><span class="line">      <span class="string">"any"</span> : [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"field"</span> : &#123;</span><br><span class="line">            <span class="string">"username"</span> : <span class="string">"/user1*/"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"metadata"</span> : &#123; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$</span><br></pre></td></tr></table></figure>
<p>验证域账户权限，使用user01无权访问indices接口，使用user11可以访问；</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.<span class="number">0</span>]$ curl -XGET -u user01:user01 <span class="string">'http://10.59.30.96:9200/_cat/indices?pretty'</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"error"</span> : &#123;</span><br><span class="line">    <span class="string">"root_cause"</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"type"</span> : <span class="string">"security_exception"</span>,</span><br><span class="line">        <span class="string">"reason"</span> : <span class="string">"action [cluster:monitor/state] is unauthorized for user [user01]"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"type"</span> : <span class="string">"security_exception"</span>,</span><br><span class="line">    <span class="string">"reason"</span> : <span class="string">"action [cluster:monitor/state] is unauthorized for user [user01]"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"status"</span> : <span class="number">403</span></span><br><span class="line">&#125;</span><br><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.<span class="number">0</span>]$ curl -XGET -u user11:user11 <span class="string">'http://10.59.30.96:9200/_cat/indices?pretty'</span></span><br><span class="line">yellow open <span class="selector-class">.monitoring-es-6-2018</span>.<span class="number">01.10</span>   nND6-i_rR5iLEYVccBGj8w <span class="number">1</span> <span class="number">1</span> <span class="number">6178</span> <span class="number">44</span>  <span class="number">5.9</span>mb  <span class="number">5.9</span>mb</span><br><span class="line">yellow open <span class="selector-class">.triggered_watches</span>            BtygGZisSDqiL3Y2TaQGqQ <span class="number">1</span> <span class="number">1</span>    <span class="number">0</span>  <span class="number">0</span> <span class="number">11.7</span>kb <span class="number">11.7</span>kb</span><br><span class="line">green  open <span class="selector-class">.security-6</span>                   QVRL1mcFSAilryHGEhen7Q <span class="number">1</span> <span class="number">0</span>                      </span><br><span class="line">yellow open <span class="selector-class">.watcher-history-6-2018</span>.<span class="number">01.10</span> SBGiHDAnTPiXFoHU65VY_g <span class="number">1</span> <span class="number">1</span>  <span class="number">777</span>  <span class="number">0</span>  <span class="number">1.1</span>mb  <span class="number">1.1</span>mb</span><br><span class="line">yellow open <span class="selector-class">.watches</span>                      kMzN4j5cQySZQQSDVPww8w <span class="number">1</span> <span class="number">1</span>    <span class="number">5</span>  <span class="number">0</span> <span class="number">40.2</span>kb <span class="number">40.2</span>kb</span><br><span class="line">yellow open <span class="selector-class">.monitoring-alerts-6</span>          VygY6VN9R3S0PR_jrGy50Q <span class="number">1</span> <span class="number">1</span>    <span class="number">1</span>  <span class="number">0</span> <span class="number">12.8</span>kb <span class="number">12.8</span>kb</span><br><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.<span class="number">0</span>]$</span><br></pre></td></tr></table></figure>
<h2 id="常见报错"><a href="#常见报错" class="headerlink" title="常见报错"></a>常见报错</h2><p>No subject alternative names matching IP address</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[2018-01-10T19:19:35,483][WARN ][o.e.x.s.t.n.SecurityNetty4Transport] [fzP4t-4] exception caught on transport layer [[id: 0x5d97fe48, L:/0:0:0:0:0:0:0:1:49121 ! R:/0:0:0:0:0:0:0:1:9300]], closing connection</span><br><span class="line">    io.netty.handler.codec.DecoderException: javax.net.ssl.SSLHandshakeException: General SSLEngine problem</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span></span><br><span class="line">Caused by: java.security.cert.CertificateException: <span class="literal">No</span> subject alternative names matching<span class="built_in"> IP address </span>0:0:0:0:0:0:0:1 found</span><br></pre></td></tr></table></figure>
<p>解决方案为一种是关闭IPv6地址，另一种是修改ES_HOME/config/elasticsearch.yml中的network.host值为本机eth0的IP</p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul>
<li>官方安装步骤：<a href="https://www.elastic.co/guide/.." target="_blank" rel="noopener">https://www.elastic.co/guide/..</a>.</li>
<li>配置内置账户密码：<br><a href="https://www.elastic.co/guide/.." target="_blank" rel="noopener">https://www.elastic.co/guide/..</a>.</li>
<li>修改账户密码：<br><a href="https://www.elastic.co/guide/.." target="_blank" rel="noopener">https://www.elastic.co/guide/..</a>.</li>
<li>用户相关操作：<br><a href="https://www.elastic.co/guide/.." target="_blank" rel="noopener">https://www.elastic.co/guide/..</a>.</li>
<li>使用LDAP认证： <a href="https://www.elastic.co/guide/.." target="_blank" rel="noopener">https://www.elastic.co/guide/..</a>.</li>
<li>用户角色映射： <a href="https://www.elastic.co/guide/.." target="_blank" rel="noopener">https://www.elastic.co/guide/..</a>.</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.leiyawu.com/2018/05/07/Elasticsearch分片及集群说明/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Martin Lei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="让一切随风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/07/Elasticsearch分片及集群说明/" itemprop="url">Elasticsearch分片及集群说明</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-07T14:48:00+08:00">
                2018-05-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ELK/" itemprop="url" rel="index">
                    <span itemprop="name">ELK</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="replica的作用主要包括："><a href="#replica的作用主要包括：" class="headerlink" title="replica的作用主要包括："></a>replica的作用主要包括：</h2><ul>
<li><p>a.容灾:primary分片丢失，replica分片就会被顶上去成为新的主分片，同时根据这个新的主分片创建新的replica,集群数据安然无恙；</p>
</li>
<li><p>b.提高查询性能：replica和primary分片的数据是相同的，所以对于一个query既可以查主分片也可以查备分片，在合适的范围内多个replica性能会更优(但要考虑资源占用也会提升[cpu/disk/heap])，另外index request只能发生在主分片上，replica不能执行index request;</p>
</li>
</ul>
<h2 id="分片数目调整："><a href="#分片数目调整：" class="headerlink" title="分片数目调整："></a>分片数目调整：</h2><p>对于一个索引，除非重建索引否则不能调整分片的数目(主分片数，number_of_shards),但可以随时调整replica数(number_of_replicas)</p>
<h2 id="ES集群状态有三种："><a href="#ES集群状态有三种：" class="headerlink" title="ES集群状态有三种："></a>ES集群状态有三种：</h2><ul>
<li><p>Green: 所有主分片和备份分片都准备就绪(分配成功)，即使有一台机器挂了(假设一台机器一个实例)，数据都不会丢失，但会变成YELLOW状态；</p>
</li>
<li><p>Yellow: 所有主分片准备就绪，但存在至少一个主分片(假设是A)对应的备份分片没有就绪，此时集群属于告警状态，意味着集群高可用和容灾能力下降，如果刚好A所在的机器挂了，并且你只设置了一个备份(已处于未就绪状态),那么A的数据就会丢失(查询结果不完整)，此时集群进入Red状态；</p>
</li>
<li><p>Red: 至少有一个主分片没有就绪(直接原因是找不到对应的备份分片成为新的主分片),此时查询的结果会出现数据丢失(不完整)</p>
</li>
</ul>
<h2 id="Elasticsearch与关系数据的类比对应关系如下："><a href="#Elasticsearch与关系数据的类比对应关系如下：" class="headerlink" title="Elasticsearch与关系数据的类比对应关系如下："></a>Elasticsearch与关系数据的类比对应关系如下：</h2><p>Relational DB  ⇒ Databases ⇒ Tables ⇒ Rows  ⇒ Columns<br>Elasticsearch  ⇒ Indices  ⇒ Types ⇒ Documents ⇒ Fields</p>
<p>这里的document的可以理解为一个JSON序列对象。每个document可包含多个field。再来说说Shard，每个Index（对应Database）包含多个Shard，默认是5个，分散在不同的Node上，但不会存在两个相同的Shard存在一个Node上，这样就没有备份的意义了。Shard是一个最小的Lucene索引单元。当来一个document的时候，Elasticsearch通过对docid进行hash来确定其放在哪个shard上面，然后在shard上面进行索引存储。replicas就是备份，Elasticsearch采用的是Push Replication模式，当你往 master主分片上面索引一个文档，该分片会复制该文档(document)到剩下的所有 replica副本分片中，这些分片也会索引这个文档。</p>
<p>当进行查询时，如果提供了查询的DocID，Elasticsearch通过hash就知道Doc存在哪个shard上面，再通过routing table查询就知道再哪个node上面，让后去node上面去取就好了。如果不提供DocID,那么Elasticsearch会在该Index（indics）shards所在的所有node上执行搜索预警，然后返回搜索结果，由coordinating node gather之后返回给用户。</p>
<p>集群信息说明图如下：</p>
<p><img src="https://cos.leiyawu.com/img/elk/es_cluster_map.jpg" alt="map"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.leiyawu.com/2018/04/20/hexo修改默认端口/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Martin Lei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="让一切随风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/20/hexo修改默认端口/" itemprop="url">hexo修改默认端口</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-20T16:22:00+08:00">
                2018-04-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hexo/" itemprop="url" rel="index">
                    <span itemprop="name">hexo</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>默认使用4000端口，用hexo s -p 80 ，可以暂时修改启动端口。</p>
<p>但是每次启动都要写”-p 80”才行，过于繁琐。</p>
<p>修改方法：<br>找到node_modules\hexo-server\index.js文件，可以修改默认的port值！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/touxiang.jpg"
                alt="Martin Lei" />
            
              <p class="site-author-name" itemprop="name">Martin Lei</p>
              <p class="site-description motion-element" itemprop="description">Still Waters Run Deep</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/hannius" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:hanniusshine@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/hannius_lei" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/p/1005051904036855/home?from=page_100505&is_all=1" target="_blank" title="微博">
                      
                        <i class="fa fa-fw fa-weibo"></i>微博</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.liaoxuefeng.com/" title="老缪" target="_blank">老缪</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://jimmysong.io/" title="jimmysong" target="_blank">jimmysong</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://github.com/hannius" title="github" target="_blank">github</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Martin Lei</span>
  本站总访问量 <span id="busuanzi_value_site_pv"></span> 次, 访客数 <span id="busuanzi_value_site_uv"></span> 人次, 本文总阅读量 <span id="busuanzi_value_page_pv"></span> 次

  
</div>


<!--  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>
-->



<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
